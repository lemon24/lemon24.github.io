<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />











<title>why was it the right choice for my project - death and gravity</title>


<meta name="description" content="This is the third article in a series about writing an SQL query builder in 150 lines of Python, why I wrote it, how I thought about it, and the decisions I had to make. In this article, I talk about why I decided to write my own, what alternatives I considered, why I didn&#39;t use an existing library, and how I knew it wouldn&#39;t become a maintenance burden.
" />



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">why was it the right choice for my project</h1>

<p class="text-gray"><small>
<span>2021-06-23</span>



∙ four minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>This is the third article <a href="/query-builder">in a series</a> about
writing an SQL query builder in 150 lines of Python,
<strong>why I wrote it</strong>, <strong>how I thought about it</strong>, and <strong>the decisions I had to make</strong>.</p>
<p>Today, we'll talk about:</p>
<ul>
<li>why I decided to write my own</li>
<li>what alternatives I considered</li>
<li>why I didn't use an existing library</li>
<li>how I knew it wouldn't become a maintenance burden</li>
</ul>
<h2 id="background">background<span class="headerlink"> <a href="#background" title="permalink">#</a></span></h2>
<p><em><a href="https://github.com/lemon24/reader">reader</a></em> is a Python feed reader library –
it exposes a high-level API for building feed readers,
allowing users to retrieve, store, and manage Atom, RSS, and JSON feeds
without having to deal with feed-related details.</p>
<p>One of the main features is filtering articles in a number of ways:
by article metadata,
by user-set metadata (<em>read</em>, <em>important</em>, feeds tags),
by full-text search matches;
all these with various sort orders, and pagination support.</p>
<p>In May 2019,
less than half of the features above were implemented,
<a href="/query-builder-why#separation-of-concerns">the function</a> building the query was 100 lines long,
and there already was <a href="https://github.com/lemon24/reader/blob/7b47c88bb4e1388e7c5af1c269fb4a78e227120a/src/reader/_storage.py#L621">a comment</a> saying
&quot;this needs some sort of query builder so badly&quot;.</p>
<h2 id="the-first-prototype">the first prototype<span class="headerlink"> <a href="#the-first-prototype" title="permalink">#</a></span></h2>
<p>So I opened an issue, and did some research.</p>
<p>At some point I must have stumbled upon <a href="https://sqlbuilder.readthedocs.io/en/latest/#short-manual-for-sqlbuilder-mini">sqlbuilder.mini</a>,
which was built around an interesting insight:
you can represent a query as a relatively simple datastructure.</p>
<p>It used a hierarchical list of SQL strings, like so:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">sql</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>    <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;author.first_name&#39;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;WHERE&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;b.status&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">)],</span>
<span class="gp">... </span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># modify the query</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sql</span><span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;SELECT&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;author.age&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">compile</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="go">(&#39;SELECT author.first_name, author.age FROM author WHERE b.status == %s&#39;, [&#39;new&#39;])</span>
</code></pre></div>
<p>I didn't really like this way of modifying queries, because it was a bit too verbose.
But it should be possible to wrap this in a class that can express it
in something more like what SQLAlchemy etc. would do, <code>sql.SELECT('author.age')</code>, right?</p>
<p>So I took this query builder prototype for fun
– with no intention of using it, just to gauge how easy it is to do;
the result was about 80 lines.</p>
<p>I then proceeded to shelve it for half a year.</p>
<h2 id="requirements">requirements<span class="headerlink"> <a href="#requirements" title="permalink">#</a></span></h2>
<p>Whatever I used, it had to support the following SQL features:</p>
<ul>
<li>SELECTs with conditional WHERE, ORDER BY, JOIN etc.</li>
<li><a href="/query-builder-why#intermission-scrolling-window-queries">scrolling window queries</a></li>
<li>common table expressions (WITH)</li>
<li>arbitrary SQL (so I don't have to use the query builder for everything)</li>
</ul>
<p>Because <em>reader</em> is a library,
the number of (transitive) dependencies should be as small as possible,
since any extra dependency gets passed down to the users.</p>
<p>Also, the solution should be easy to understand and maintain,
and it should be possible to extend it to support additional SQL features, if needed.</p>
<p>At this point, I wasn't really sold on abstraction layer like SQLAlchemy Core.
Initially, raw SQL allowed me to move quicker, and I only needed to support SQLite anyway.
Now, SQLAlchemy core would be useful, but I still only need SQLite,
and don't really have time to make sure other datases work.
(It should be possible to switch to it relatively easily,
since all storage stuff happens through a DAO-style interface.)</p>
<h2 id="other-libraries">other libraries<span class="headerlink"> <a href="#other-libraries" title="permalink">#</a></span></h2>
<p>Because I was worried the temptation
to actually use my own query builder would be too great,
and would spiral into a project of its own with a huge maintenance burden,
I came up with the requirements above,
and did a more serious survey of existing libraries.</p>
<p>In the end, I didn't really like the existing libraries:</p>
<ul>
<li>they either came with a full-blown ORM,</li>
<li>either were an SQL builder with too many features,</li>
<li>either dind't really help with readability.</li>
</ul>
<p>So I decided to wait until the features would actually be implemented.</p>
<h2 id="deciding-to-write-my-own-the-second-prototype">deciding to write my own (the second prototype)<span class="headerlink"> <a href="#deciding-to-write-my-own-the-second-prototype" title="permalink">#</a></span></h2>
<p>By May 2020, the function building the query was 150 lines,
with another half of that duplicated for search.
Due to the size and complexity, I ended up abandoning an attempt to use indexes,
because trying various things simply took too long.</p>
<p>So I did a second, more detailed prototype,
aiming to support all the current use cases and a few future ones.
I integrated it, and that was that.
After doing this, the code went from 1400 to 1300 lines (excluding the 136 lines of the query builder itself).
I'd call this a win, since for the price of 36 lines I was able to reuse lots of logic, and enable future reuse and performance improvements (which did happen since).</p>
<p>I did a more detailed prototype,
with all the features I'd need and some I didn't,
using the exact queries I needed as tests.
This remained at around 110 lines.</p>
<ul>
<li>none of the existing libraries seemed appropriate</li>
<li>two prototypes offered an estimate of size, complexity, knew I could add more features; crucial to know it'd be easy to maintain, easy to undertand</li>
<li>already high test coverage, could rely on existing higher level tests</li>
</ul>
<h2 id="alternatives">alternatives<span class="headerlink"> <a href="#alternatives" title="permalink">#</a></span></h2>
<ul>
<li>from bullets above / #123</li>
<li>if this wasn't a library, or if i had time / needed to implement multi-db support, what would I use? SQLAlchemy, all the time!</li>
</ul>
<h2 id="lessons-learned">lessons learned<span class="headerlink"> <a href="#lessons-learned" title="permalink">#</a></span></h2>
<ul>
<li>doing nothing is sometimes the best option; wait until there's more info</li>
<li>prototyping!</li>
</ul>










<hr>
<p>This is part of a series:</p>

<ul>


<li>
    <a href="/query-builder">SQL query builder in 150 lines of Python</a>



<li>
    <a href="/query-builder-why">Why use an SQL query builder in the first place?</a>


</ul>







<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661&SIGNUP=not-invented-here"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"

>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">


        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>




</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>