<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />











<title>why was it the right choice for my project - death and gravity</title>


<meta name="description" content="This is the third article in a series about writing an SQL query builder in 150 lines of Python, why I wrote it, how I thought about it, and the decisions I had to make. In this article, I talk about why I decided to write my own, what alternatives I considered, why I didn&#39;t use an existing library, and how I knew it wouldn&#39;t become a maintenance burden.
" />



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">why was it the right choice for my project</h1>

<p class="text-gray"><small>
<span>2021-06-23</span>



∙ six minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>This is the third article <a href="/query-builder">in a series</a> about
writing an SQL query builder in 150 lines of Python,
<strong>why I wrote it</strong>, <strong>how I thought about it</strong>, and <strong>the decisions I had to make</strong>.</p>
<p>Today, we'll talk about:</p>
<ul>
<li>why I decided to write my own</li>
<li>what alternatives I considered</li>
<li>why I didn't use an existing library</li>
<li>how I knew it wouldn't become a maintenance burden</li>
</ul>
<p>This goes through the whole story in rough chronological order;
if you're only interested in the list of libraries I looked at,
you can find it <a href="#alternatives">at the end</a>.</p>
<h2 id="background">Background<span class="headerlink"> <a href="#background" title="permalink">#</a></span></h2>
<p><em><a href="https://github.com/lemon24/reader">reader</a></em> is a Python feed reader library –
it provides a high-level API for building feed readers,
allowing users to retrieve, store, and manage <a href="https://en.wikipedia.org/wiki/Web_feed">web feeds</a>
without having to deal with feed-related details.</p>
<p>It's mostly a passion and learning project,
so the time I can spend on it is limited.</p>
<p>One of <em>reader's</em> main features is filtering articles:
by article metadata,
by user-set metadata (read, important, feeds tags),
and by full-text search,
sorted in different ways,
and with cursor pagination.</p>
<p>In May 2019,
with less than half of the above implemented,
the function building the SQL query was over 100 lines,
and I had already added <a href="https://github.com/lemon24/reader/blob/7b47c88bb4e1388e7c5af1c269fb4a78e227120a/src/reader/_storage.py#L621">this comment</a>:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">612</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>        <span class="c1"># TODO: This needs some sort of query builder so badly.</span>
</code></pre></div>
</td></tr></table><h2 id="the-first-prototype">The first prototype<span class="headerlink"> <a href="#the-first-prototype" title="permalink">#</a></span></h2>
<p>So I opened <a href="https://github.com/lemon24/reader/issues/123">an issue</a>, and did some research.</p>
<p>At some point I stumbled upon <a href="https://sqlbuilder.readthedocs.io/en/latest/#short-manual-for-sqlbuilder-mini">sqlbuilder.mini</a>,
which was built around an interesting insight –
<em>queries can be represented as plain datastructures</em>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">sql</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>    <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;WHERE&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">)],</span>
<span class="gp">... </span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">compile</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="go">(&#39;SELECT first_name FROM author WHERE status == %s&#39;, [&#39;new&#39;])</span>
</code></pre></div>
<p>You can then modify the query directly:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">sql</span><span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;SELECT&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;last_name&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">compile</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="go">(&#39;SELECT first_name, last_name FROM author WHERE status == %s&#39;, [&#39;new&#39;])</span>
</code></pre></div>
<p>Or via a wrapper that simplifies navigation:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">sql</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sql</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">[</span><span class="s1">&#39;SELECT&#39;</span><span class="p">],</span>  <span class="c1"># path</span>
<span class="gp">... </span>    <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span>
<span class="gp">... </span><span class="p">)</span>  <span class="c1"># returns self to allow method chaining</span>
<span class="go">&lt;sqlbuilder.mini.Q object&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">compile</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="go">(&#39;SELECT first_name, last_name, age FROM author WHERE status == %s&#39;, [&#39;new&#39;])</span>
</code></pre></div>
<!--

sql = [
    'SELECT', ['first_name'],
    'FROM', ['author'],
    'WHERE', ['status', '==', P('new')],
]
compile(sql)
sql[sql.index('SELECT') + 1].append('last_name')
compile(sql)
sql = Q(sql)
sql.append_child(
    ['SELECT'],  # path
    ['age']
)  # returns self to allow method chaining
compile(sql)

-->
<p>I really liked how simple and flexible this is,
and the choice of not dealing with SQL correctness or dialects –
a middle ground between build-your-own-string
and &quot;proper&quot; query builders.
On the other hand,
modifying things seemed too verbose (even with the wrapper),
and the output SQL didn't look very readable either.</p>
<p>Surely, it would be possible to take this idea
and make it look like <code>sql.SELECT('age')</code>, right?</p>
<p>So I made a prototype,
with no real intention of using it, just to see how easy it is to do.
The result was about 80 lines, and I was quite happy with it;
my thoughts at the time:</p>
<blockquote>
<p>The end result looks nice, but using it would add ~150 lines of code (that need to be tested), and it's less useful for simpler queries.</p>
<p>Also, it looks nice <em>now</em>, when I just wrote it; 6 months from now it may be hard to understand.</p>
</blockquote>
<p>Afraid that I'm <em>too</em> happy with it, and with my curiosity satisfied,
I proceeded to do just that: wait six months.</p>
<h2 id="requirements-and-existing-libraries">Requirements, and existing libraries<span class="headerlink"> <a href="#requirements-and-existing-libraries" title="permalink">#</a></span></h2>
<p>My main concern with making my own was that over time,
with various additions and fixes,
the effort spent on it would be <em>greater</em> than
getting an existing library to do what I needed.</p>
<p>To deal with it, I did two things.</p>
<hr />
<p>First, I came up with detailed requirements.</p>
<p>Whatever I ended up using, it had to support the following SQL features:</p>
<ul>
<li>SELECT with conditional WHERE, ORDER BY, JOIN etc.
(<a href="/query-builder-why#separation-of-concerns">example</a>)</li>
<li><a href="/query-builder-why#intermission-scrolling-window-queries">scrolling window queries</a></li>
<li>common table expressions (WITH)</li>
<li>arbitrary SQL (so I don't have to use the query builder for everything)</li>
</ul>
<p>Because <em>reader</em> is a library,
I wanted to keep the number of (transitive) dependencies as small as possible,
since any extra dependency gets passed down to the users.</p>
<p>Also, the solution should be easy to understand and maintain,
and it should be possible to support additional SQL features, if needed.</p>
<p>Both to keep things simple and due to <a href="https://reader.readthedocs.io/en/latest/dev.html#why-use-sqlite-and-not-sqlalchemy">historical reasons</a>,
I didn't want to switch to an abstraction layer like SQLAlchemy Core
<em>just</em> for query building –
I needed (and still need) only SQLite support,
and already had code to deal with stuff like migrations.</p>
<hr />
<p>Second, I did a slightly more serious survey of existing libraries.</p>
<p>I didn't feel any of the ones I looked at was ideal,
for at least one of the following reasons.</p>
<ul>
<li>They came with a full abstraction layer.
This isn't bad in itself,
but meant I had to switch <em>everything</em>, eventually –
using a mix would make things worse long-term.</li>
<li>They had too many features.
Usually this is good, but it means there's more of everything:
more features, more documentation to go through,
more concepts to keep in your head,
more things contributors need to know/learn.</li>
<li>They didn't make things more readable or
more <a href="/query-builder-why#composition-and-reuse">composable</a>.</li>
</ul>
<hr />
<p>So I chose to do nothing, and wait until more features are implemented.</p>
<h2 id="the-second-prototype">The second prototype<span class="headerlink"> <a href="#the-second-prototype" title="permalink">#</a></span></h2>
<p>By May 2020, most of the features were implemented.
The function building the query was 150 lines,
with part that duplicated for the search query.
At some point, I tried to optimize the query by using indexes,
but gave up because trying various things simply took too long.</p>
<p>So, <em>a full year later</em>,
I made the prototype support all the required features
and a few extra (UNION, nested queries),
and tried it out on the full real-world queries.</p>
<p>It didn't take all that long,
and the whole thing remained around 100 lines.</p>
<h2 id="deciding-to-use-my-own">Deciding to use my own<span class="headerlink"> <a href="#deciding-to-use-my-own" title="permalink">#</a></span></h2>
<p>At this point, most of the work was already done, and integrating it took less than an hour.</p>
<p>Excluding the 136 lines of the builder itself with scrolling window query support,
the code went from 1400 to 1300 lines.
I took that as a win, since for the price of 36 lines I was able to reuse the filtering logic.
(Now, one year later, it enabled a lot more reuse, without growing significantly.)</p>
<p>I ended up keeping it, because:</p>
<ul>
<li>Using an existing library would take too much effort.
(I'll reconsider when the requirements change, though.)</li>
<li>It is tiny, which makes it relatively easy to understand and modify.
The two prototypes made me quite confident it's likely to stay that way.
Because it's only used internally,
I can leave out a lot of nice things that aren't actually needed.</li>
<li>It has 0 dependencies. That's even better than 1.</li>
<li><em>reader</em> already great test coverage,
so very little additional testing was required.</li>
</ul>
<h2 id="alternatives">alternatives<span class="headerlink"> <a href="#alternatives" title="permalink">#</a></span></h2>
<p>TBD; non-exhaustive</p>
<h3 id="do-nothing">do nothing<span class="headerlink"> <a href="#do-nothing" title="permalink">#</a></span></h3>
<p>do nothing</p>
<h3 id="disable-bits-of-the-query-with-booleans-and-hope-the-optimizer-sorts-it-out">disable bits of the query with booleans and hope the optimizer sorts it out<span class="headerlink"> <a href="#disable-bits-of-the-query-with-booleans-and-hope-the-optimizer-sorts-it-out" title="permalink">#</a></span></h3>
<p>Don't &quot;build&quot; the query; always shove everything into it and disable various bits through boolean parameters, and let the optimizer sort it out.</p>
<p>Cons:</p>
<ul>
<li>The optimizer may not be able to optimize everything away, especially if the query is optimized before the parameters are passed in (so it doesn't get a change to remove stuff).</li>
<li>Some things we may not be able to turn off at all.</li>
<li>Do we still need to provide values for parameters used in the disabled bits? Probably yes.</li>
<li>Passing more parameters may be more expensive. Would it be more expensive than the string building, though?</li>
</ul>
<p>lots of cons, not doing it</p>
<h3 id="sqlalchemy-core-peewee-query-builder">SQLAlchemy Core, Peewee query builder<span class="headerlink"> <a href="#sqlalchemy-core-peewee-query-builder" title="permalink">#</a></span></h3>
<p>https://docs.sqlalchemy.org/en/13/orm/query.html</p>
<ul>
<li>may be overkill</li>
<li>if we are to use an existing query builder, this is likely it (maintained, stable, tested, used, extensible, portable)</li>
<li>sqlakeyset for scrolling window https://github.com/djrobstep/sqlakeyset</li>
</ul>
<p>http://docs.peewee-orm.com/en/latest/peewee/query_builder.html</p>
<ul>
<li>if this wasn't a library, or if i had time / needed to implement multi-db support, what would I use? one of those, all the time!</li>
</ul>
<h3 id="sqlbuilder-pypika">sqlbuilder, pypika<span class="headerlink"> <a href="#sqlbuilder-pypika" title="permalink">#</a></span></h3>
<p>https://sqlbuilder.readthedocs.io/en/latest/</p>
<p>https://github.com/kayak/pypika looks like it follows the same philosophy as my prototype, but it's way more comprehensive; and it did exist when I first worked on this</p>
<h3 id="sqlbuilder-mini">sqlbuilder.mini<span class="headerlink"> <a href="#sqlbuilder-mini" title="permalink">#</a></span></h3>
<p><a href="https://sqlbuilder.readthedocs.io/en/latest/#short-manual-for-sqlbuilder-mini">sqlbuilder.mini</a></p>
<ul>
<li>seems very extensible while preserving some of the readability</li>
</ul>
<h3 id="jinjasql-sqlpy">JinjaSQL, sqlpy<span class="headerlink"> <a href="#jinjasql-sqlpy" title="permalink">#</a></span></h3>
<p>https://github.com/sripathikrishnan/jinjasql</p>
<p>JinjaSQL</p>
<ul>
<li>seems like overkill</li>
<li>I'm not convinced it improves readability</li>
</ul>
<p>https://github.com/9fin/sqlpy looks like a novel way of building queries</p>
<h2 id="lessons-learned">lessons learned<span class="headerlink"> <a href="#lessons-learned" title="permalink">#</a></span></h2>
<ul>
<li>doing nothing is sometimes the best option; wait until there's more info</li>
<li>research, requirements, prototyping!</li>
</ul>










<hr>
<p>This is part of a series:</p>

<ul>


<li>
    <a href="/query-builder">SQL query builder in 150 lines of Python</a>



<li>
    <a href="/query-builder-why">Why use an SQL query builder in the first place?</a>


</ul>







<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661&SIGNUP=not-invented-here"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"

>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">


        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>




</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>