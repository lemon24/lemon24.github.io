












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>Inheritance over composition, sometimes - death and gravity</title>



<meta property="og:title" content="Inheritance over composition, sometimes">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/over-composition">




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Inheritance over composition, sometimes</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2025-05-12">May 2025</span>
∙ 12 minute read
∙
</small><span class="share-icons">
<a
    class="share-icon pycoders"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/over-composition&t=Inheritance%20over%20composition%2C%20sometimes"
>HN</a>
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/over-composition&title=Inheritance%20over%20composition%2C%20sometimes"
>Reddit</a>
<a
    class="share-icon linkedin"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/over-composition"
>linkedin</a>
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Inheritance%20over%20composition%2C%20sometimes&url=https%3A//death.andgravity.com/over-composition&via=_andgravity"
>Twitter</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>In <a class="internal" href="/ptpe">Process​Thread​Pool​Executor: when I‍/‍O becomes CPU-bound</a>,
we built a hybrid <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.​futures</a> executor
that runs tasks in multiple threads on all available CPUs,
bypassing the limitations imposed by Python's global interpreter lock.</p>
<p>Here's some interesting reader feedback I got:</p>
<blockquote>
<p>Currently, the code is complex due to subclassing
and many layers of delegation like
<code>submit()</code> doing <code>super().submit(_submit, ...)</code>.</p>
<p>Could this solution be implemented using only functions, no classes?
Intuitively I feel classes would be hell to debug.</p>
</blockquote>
<p>Since a lot of advanced beginners struggle with structuring code,
we'll look at three ways of solving the same problem,
compare the solutions,
and reach some interesting conclusions.
Consider this a worked example.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>Today we're focusing on structure.
 While not required to understand this article,
 reading the <a class="internal" href="/ptpe">original one</a> will give you a better idea
 of <em>why</em> the code does what it does.</p>
</section>
<section class="toc">
<ul>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#concurrent-futures">concurrent.futures</a></li>
<li><a href="#three-solutions">Three solutions</a>
<ul>
<li><a href="#inheritance">Inheritance</a></li>
<li><a href="#composition">Composition</a></li>
<li><a href="#functions">Functions</a></li>
</ul>
</li>
<li><a href="#comparison">Comparison</a>
<ul>
<li><a href="#composition-over-inheritance">Composition over inheritance</a></li>
<li><a href="#forward-compatibility">Forward compatibility</a></li>
<li><a href="#global-state">Global state</a></li>
<li><a href="#complexity">Complexity</a></li>
<li><a href="#debugging">Debugging</a></li>
</ul>
</li>
<li><a href="#try-it-out">Try it out</a></li>
</ul>
</section>
<h2 id="requirements">Requirements<span class="headerlink">&nbsp;<a href="#requirements" title="permalink">#</a></span></h2>
<p>Before we delve into the code,
we should have some understanding of what we're building.
The orginal article <a class="internal" href="/ptpe#why-not-both">sets out</a>
the following functional requirements:</p>
<ol>
<li>Implement the <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a> interface;
we want a drop-in replacement
for existing <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.​futures</a> executors,
so that user code doesn't have to change.</li>
<li>Spread the work to one worker process per CPU,
and then further to multiple threads inside each worker,
to work around CPU becoming a bottleneck for I‍/‍O.</li>
</ol>
<p>Additionally, we have two implicit non-functional requirements:</p>
<ol start="3">
<li>Use the existing executors where possible
(less code means fewer bugs).</li>
<li>Only depend on stable, documented features;
we don't want our code to break
when <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.​futures</a> internals change.</li>
</ol>
<h2 id="concurrent-futures">concurrent.futures<span class="headerlink">&nbsp;<a href="#concurrent-futures" title="permalink">#</a></span></h2>
<p>Since we're building on top of <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.​futures</a>,
we should also get familiar with it;
the docs already provide a great introduction:</p>
<blockquote>
<p>The <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.​futures</a> module provides
a high-level interface for asynchronously executing callables.
[...this] can be performed with threads, using <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#threadpoolexecutor">Thread​Pool​Executor</a>,
or separate processes, using <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a>.
Both implement the same interface,
which is defined by the abstract <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a> class.</p>
</blockquote>
<p>Let's look at the classes in more detail.</p>
<!-- FIXME: all links should be to code! -->
<p><a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a> is an abstract base class<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup> defined in <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/_base.py#L569">concurrent.​futures.​_base</a>.
It provides dummy <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">submit()</a> and <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.shutdown">shutdown()</a> methods,
a concrete <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">map()</a> method implemented in terms of <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">submit()</a>,
and <a class="external" href="https://docs.python.org/3/glossary.html#term-context-management-protocol">context manager methods</a> that <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.shutdown">shutdown()</a> the executor on exit.
Notably, the documentation does not mention the concrete methods,
instead saying that the class
&quot;should not be used directly, but through its concrete subclasses&quot;.</p>
<p>The first subclass, <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#threadpoolexecutor">Thread​Pool​Executor</a>, is defined in <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/thread.py#L122">concurrent.​futures.​thread</a>;
it implements <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">submit()</a> and <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.shutdown">shutdown()</a>,
inheriting <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">map()</a> unchanged.</p>
<p>The second one, <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a>, is defined in <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/process.py#L630">concurrent.​futures.​process</a>;
as an optimization,
it <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/process.py#L808">overrides map()</a> to chop the input iterables
and pass the chunks to the superclass method with <a class="external" href="https://docs.python.org/3/library/functions.html#super">super()</a>.</p>
<h2 id="three-solutions">Three solutions<span class="headerlink">&nbsp;<a href="#three-solutions" title="permalink">#</a></span></h2>
<p>Now we're ready for code.</p>
<h3 id="inheritance">Inheritance<span class="headerlink">&nbsp;<a href="#inheritance" title="permalink">#</a></span></h3>
<p>First, the original implementation,<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup>
arguably a textbook example of inheritance.</p>
<p>We override <code>__init__</code>, <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">submit()</a>, and <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.shutdown">shutdown()</a>,
and do some extra stuff on top of the inherited behavior,
which we access through <a class="external" href="https://docs.python.org/3/library/functions.html#super">super()</a>.
We inherit
the context manager methods,
<a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">map()</a>,
and any public methods <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a> may get in the future,
assuming they use only other public methods
(more on this <a class="anchor" href="#forward-compatibility">below</a>).</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProcessThreadPoolExecutor</span><span class="p">(</span><span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">initializer</span><span class="o">=</span><span class="n">_init_process</span><span class="p">,</span>
            <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">initargs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__result_handler</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__handle_results</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__result_handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">outer</span>

        <span class="n">outer</span><span class="o">.</span><span class="n">set_running_or_notify_cancel</span><span class="p">()</span>
        <span class="n">inner</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_submit</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__handle_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">outer</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outer</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__result_handler</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<p>Because we're subclassing a class with private, undocumented attributes,
<em>our</em> private attributes
have to start with <a class="external" href="https://docs.python.org/3/tutorial/classes.html#tut-private">double underscores</a>
to avoid clashes with superclass ones
(such as <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/process.py#L736">_result_queue</a>).</p>
<p>In addition to the main class,
there are some global functions used in the worker processes
which remain unchanged
regardless of the solution:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="c1"># this code runs in each worker process</span>

<span class="n">_executor</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_result_queue</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_init_process</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">initargs</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_executor</span><span class="p">,</span> <span class="n">_result_queue</span>

    <span class="n">_executor</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_threads</span><span class="p">)</span>
    <span class="n">_result_queue</span> <span class="o">=</span> <span class="n">queue</span>

    <span class="k">if</span> <span class="n">initializer</span><span class="p">:</span>
        <span class="n">initializer</span><span class="p">(</span><span class="o">*</span><span class="n">initargs</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_submit</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
    <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">_put_result</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_put_result</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">exception</span> <span class="o">:=</span> <span class="n">task</span><span class="o">.</span><span class="n">exception</span><span class="p">():</span>
        <span class="n">_result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">()))</span>
</code></pre></div>

<p><a class="attachment" href="/_file/ptpe/ptpelite.py">The entire code.</a></p>
<h3 id="composition">Composition<span class="headerlink">&nbsp;<a href="#composition" title="permalink">#</a></span></h3>
<p>OK, now let's use <a class="external" href="https://en.wikipedia.org/wiki/Composition_over_inheritance">composition</a> –
instead of <a class="external" href="https://en.wikipedia.org/wiki/Is-a"><em>being</em></a> a <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a>,
our Process​Thread​Pool​Executor <a class="external" href="https://en.wikipedia.org/wiki/Has-a"><em>has</em></a> one.
At a first glance,
the result is the same as before,
with <code>super()</code> changed to <code>self._inner</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProcessThreadPoolExecutor</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_inner</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span>
</span>            <span class="n">initializer</span><span class="o">=</span><span class="n">_init_process</span><span class="p">,</span>
            <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">initargs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">outer</span>

        <span class="n">outer</span><span class="o">.</span><span class="n">set_running_or_notify_cancel</span><span class="p">()</span>
<span class="hll">        <span class="n">inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inner</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_submit</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span>
        <span class="k">return</span> <span class="n">outer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">outer</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outer</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_inner</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<p>Except, we need to implement the context manager protocol ourselves:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># concurrent.futures._base.Executor.__enter__</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="c1"># concurrent.futures._base.Executor.__exit__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<p>...and we need to copy <code>map()</code> from <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a>,
since it should use <em>our</em> <code>submit()</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">iterables</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># concurrent.futures._base.Executor.map</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="hll">        <span class="n">fs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">)]</span>
</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">result_iterator</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">fs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">_result_or_cancel</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">_result_or_cancel</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">())</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
                    <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result_iterator</span><span class="p">()</span>
</code></pre></div>

<p>...and the <code>chunksize</code> optimization from its <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a> version:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">iterables</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># concurrent.futures.process.ProcessPoolExecutor.map</span>

        <span class="k">if</span> <span class="n">chunksize</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chunksize must be &gt;= 1.&quot;</span><span class="p">)</span>

<span class="hll">        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">_process_chunk</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span>
</span>                            <span class="n">itertools</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">),</span> <span class="n">chunksize</span><span class="p">),</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_chain_from_iterable_of_lists</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

<details>
<summary>...and a bunch of private functions they use.</summary>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_result_or_cancel</span><span class="p">(</span><span class="n">fut</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># concurrent.futures._base._result_or_cancel</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fut</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">fut</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_process_chunk</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
    <span class="c1"># concurrent.futures.process._process_chunk</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_chain_from_iterable_of_lists</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="c1"># concurrent.futures.process._chain_from_iterable_of_lists</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">element</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">element</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">element</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div>

</details>
<p><em>And</em>, when the <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a> interface gets new methods,
we'll need to at least <a class="external" href="https://en.wikipedia.org/wiki/Forwarding_(object-oriented_programming)">forward</a> them to the inner executor,
although we may have to copy those too.</p>
<p>On the upside,
no base class means
we can name attributes however we want.</p>
<p><a class="attachment" href="/_file/ptpe/ptpelite_comp.py">The entire code.</a></p>
<hr />
<p>But this is Python,
why do we need to copy stuff?
In Python,
methods are just functions,
so we could <em>almost</em> get away with this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProcessThreadPoolExecutor</span><span class="p">:</span>
    <span class="o">...</span> <span class="c1"># __init__, submit(), and shutdown() just as before</span>
    <span class="fm">__enter__</span> <span class="o">=</span> <span class="n">ProcessPoolExecutor</span><span class="o">.</span><span class="fm">__enter__</span>
    <span class="fm">__exit__</span> <span class="o">=</span> <span class="n">ProcessPoolExecutor</span><span class="o">.</span><span class="fm">__exit__</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">ProcessPoolExecutor</span><span class="o">.</span><span class="n">map</span>
</code></pre></div>
<p>Alas, it won't work –
Process​Pool​Executor <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/process.py#L808">map()</a>
calls <code>super().​map()</code>,
and <a class="external" href="https://docs.python.org/3/library/functions.html#object">object</a>,
the superclass of our executor,
has no such method,
which is why we had to change it to <code>self.​_map()</code>
in our copy in the first place.</p>
<h3 id="functions">Functions<span class="headerlink">&nbsp;<a href="#functions" title="permalink">#</a></span></h3>
<p>Can this be done using only functions, though?</p>
<p>Theoretically no,
since we need to implement the executor interface.
Practically yes,
since this is Python,
where
an &quot;interface&quot; just means
having <a class="external" href="https://docs.python.org/3/glossary.html#term-duck-typing">specific attributes</a>,
usually functions with specific signatures.
For example, a <a class="internal" href="/same-functions#counter-example-modules">module</a> like this:</p>
<!-- TODO: link back from same-functions#counter-example-module -->
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">max_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">()):</span>
    <span class="k">global</span> <span class="n">_result_queue</span><span class="p">,</span> <span class="n">_inner</span><span class="p">,</span> <span class="n">_tasks</span><span class="p">,</span> <span class="n">_result_handler</span>
    <span class="n">_result_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">_inner</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span>
        <span class="n">initializer</span><span class="o">=</span><span class="n">_init_process</span><span class="p">,</span>
        <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">_result_queue</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">initargs</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_tasks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_result_handler</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_handle_results</span><span class="p">)</span>
    <span class="n">_result_handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
    <span class="n">_tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">outer</span>

    <span class="n">outer</span><span class="o">.</span><span class="n">set_running_or_notify_cancel</span><span class="p">()</span>
    <span class="n">inner</span> <span class="o">=</span> <span class="n">_inner</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_submit</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outer</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_handle_results</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">_result_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="n">_tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">outer</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outer</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_result_queue</span>
    <span class="n">_inner</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_result_queue</span><span class="p">:</span>
        <span class="n">_result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">_result_handler</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">_result_queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">_result_queue</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<details>
<summary>
Like before, we need to copy <code>map()</code> with minor tweaks.
</summary>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_map</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">iterables</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># concurrent.futures._base.Executor.map</span>

    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="n">fs</span> <span class="o">=</span> <span class="p">[</span><span class="n">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">result_iterator</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">fs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">_result_or_cancel</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">_result_or_cancel</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
                <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result_iterator</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">iterables</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># concurrent.futures.process.ProcessPoolExecutor.map</span>

    <span class="k">if</span> <span class="n">chunksize</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chunksize must be &gt;= 1.&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">_map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">_process_chunk</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span>
                   <span class="n">itertools</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">),</span> <span class="n">chunksize</span><span class="p">),</span>
                   <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_chain_from_iterable_of_lists</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

</details>
<p>Behold, we can use the module itself as an executor:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">ptpe</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ptpe</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="go">1</span>
</code></pre></div>
<p>Of note,
everything that was an instance variable before
is now a global variable;
as a consequence,
only one executor can exist at any given time,
since there's only the one module.<sup class="footnote-ref" id="fnref-3"><a href="#fn-3">3</a></sup>
But it gets worse – calling <code>init()</code> a second time
will clobber the state of the first executor,
leading to all sorts of bugs;
if we were serious,
we'd prevent it somehow.</p>
<p>Also, some interfaces are more complicated than having the right functions;
defining <code>__enter__</code> and <code>__exit__</code>
is not enough to use a module in a <code>with</code> statement, since
the interpreter <a class="external" href="https://snarky.ca/unravelling-the-with-statement/">looks them up on the class of the object</a>,
not on the object itself.
We can work around this with
an alternate &quot;constructor&quot;
that returns a context manager:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_cm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">init</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">shutdown</span><span class="p">()</span>
</code></pre></div>

<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">ptpe</span><span class="o">.</span><span class="n">init_cm</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">executor</span> <span class="ow">is</span> <span class="n">ptpe</span>
<span class="gp">... </span>    <span class="n">ptpe</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="gp">...</span>
<span class="go">2</span>
</code></pre></div>
<p><a class="attachment" href="/_file/ptpe/ptpelite_func.py">The entire code.</a></p>
<!--

# composition *and* inheritance

.. literalinclude:: //ptpe/ptpelite_both.py

Yet another option would be to use both inheritance *and* composition –
inherit the [Executor] base class directly for the [common methods]
(assuming they're defined there and not in subclasses),
and delegate to the inner executor only where needed
(likely just [map()] and [shutdown()]).
But, the only difference from the current code would be
that it'd say `self._inner` instead of `super()` in a few places,
so it's not really worth it, in my opinion.

-->
<h2 id="comparison">Comparison<span class="headerlink">&nbsp;<a href="#comparison" title="permalink">#</a></span></h2>
<p>So, how do the solutions stack up? Here's a summary:</p>
<table class="table">
  <thead>
    <tr>
      <th scope="col"></th>
      <th scope="col">pros</th>
      <th scope="col">cons</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td scope="row"><a href="#inheritance">inheritance</a></td>
      <td>
        <ul>
          <li>least amount of code
          <li>inherits new high level methods for free
        </ul>
      </td>
      <td>
        <ul>
          <li>assumes inherited high level methods use only the public API
          <li>attribute names have to start with double underscores (minor)
        </ul>
      </td>
    </tr>
    <tr>
      <td scope="row"><a href="#composition">composition</a></td>
      <td>
        <ul>
          <li>attributes can have any name (minor)
        </ul>
      </td>
      <td>
        <ul>
          <li>copies lots of code
          <li>must be kept in sync with the interface
        </ul>
      </td>
    </tr>
    <tr>
      <td scope="row"><a href="#functions">functions</a></td>
      <td>?</td>
      <td>
        <ul>
          <li>copies lots of code
          <li>must be kept in sync with the interface
          <li>only one global executor at a time
          <li>state is harder to discover
          <li>alternate "constructor" to use as context manager (minor)
        </ul>
      </td>
    </tr>
</table>
<p>I may be a bit biased, but inheritance looks like a clear winner.</p>
<h3 id="composition-over-inheritance">Composition over inheritance<span class="headerlink">&nbsp;<a href="#composition-over-inheritance" title="permalink">#</a></span></h3>
<p>Given that favoring <a class="external" href="https://en.wikipedia.org/wiki/Composition_over_inheritance">composition over inheritance</a>
is usually a good practice,
it's worth discussing why inheritance won this time.
I see three reasons:</p>
<ol>
<li>Composition helps most when
you have unrelated components
that need to be flexible
in response to an evolving business domain;
that's not the case here,
so we get all the <a class="external" href="https://en.wikipedia.org/wiki/Composition_over_inheritance#Drawbacks">drawbacks</a>
with none of the <a class="external" href="https://en.wikipedia.org/wiki/Composition_over_inheritance#Benefits">benefits</a>.</li>
<li>The existing code
is <a class="anchor" href="#concurrent-futures">designed for inheritance</a>.</li>
<li>We have a true <em><a class="external" href="https://en.wikipedia.org/wiki/Is-a">is-a</a></em> relationship –
Process​Thread​Pool​Executor really is a <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a>
with extra behavior,
and not just part of an arbitrary hierarchy.</li>
</ol>
<p>For a different line of reasoning involving subtyping,
check out <a class="external" href="https://www.hillelwayne.com/">Hillel Wayne</a>'s <a class="external" href="https://buttondown.email/hillelwayne/archive/when-to-prefer-inheritance-to-composition/">When to prefer inheritance to composition</a>;
he offers this rule of thumb:</p>
<blockquote>
<p>So, here's when you want to use inheritance:
<strong>when you need to instantiate both the parent and child classes
and pass them to the same functions</strong>.</p>
</blockquote>
<h3 id="forward-compatibility">Forward compatibility<span class="headerlink">&nbsp;<a href="#forward-compatibility" title="permalink">#</a></span></h3>
<p>The <a class="anchor" href="#inheritance">inheritance</a> solution
assumes <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">map()</a> and
any future public <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a> methods
are implemented only in terms of other public methods.
This assumption introduces a risk that updates may break our executor;
this is lowered by two things:</p>
<ol>
<li><a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.​futures</a> is in the standard library,
which rarely does major rewrites of existing code,
and never within a minor (X.Y) version;
concurrent.​futures exists in its current form
<a class="external" href="https://github.com/python/cpython/tree/v3.2/Lib/concurrent/futures">since Python 3.2</a>, released in 2011.</li>
<li><a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.​futures</a> is clearly <a class="anchor" href="#concurrent-futures">designed for inheritance</a>,
even if mainly to enable internal reuse,
and not explicitly documented.</li>
</ol>
<p>As active mitigations,
we can add a basic test suite
(which we should do anyway),
and <a class="external" href="https://packaging.python.org/en/latest/specifications/core-metadata/#core-metadata-classifier">document</a> the <a class="external" href="https://pypi.org/classifiers/#:~:text=Programming%20Language%20::%20Python%20::%203">supported Python versions</a> explicitly
(which we should do anyway if we were to release this on PyPI).</p>
<p>If <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.​futures</a> were not in the standard library,
I'd probably go with the <a class="anchor" href="#composition">composition</a> version instead,
although as already mentioned,
this wouldn't be free from upkeep either.
Another option would be to
upstream Process​Thread​Pool​Executor,
so that it is maintained together with the code it depends on.</p>
<h3 id="global-state">Global state<span class="headerlink">&nbsp;<a href="#global-state" title="permalink">#</a></span></h3>
<p>The <a class="anchor" href="#functions">functions-only</a> solution is probably the worst of the three,
since it has all the downsides of <a class="anchor" href="#composition">composition</a>,
<em>and</em> significant limitations due to its use of global state.</p>
<p>We could avoid using globals
by passing the state
(process pool executor instance, result queue, etc.)
as function arguments,
but this breaks the executor interface,
and makes for an awful user experience.
We could group common arguments into a single object
so there's only one argument to pass around;
if you call that argument <code>self</code>,
<a class="internal" href="/same-arguments">it becomes obvious</a> that's just a class instance with extra steps.</p>
<p>Having to keep track of a bunch of related globals has enough downsides
that even if you do want a module-level API,
it's still worth using a class to group them,
and exposing the methods of a global instance
at module-level (<a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/random.py#L917-L948">like so</a>);
Brandon Rhodes discusses this at length in <a class="external" href="https://python-patterns.guide/python/prebound-methods/">The Prebound Method Pattern</a>.</p>
<h3 id="complexity">Complexity<span class="headerlink">&nbsp;<a href="#complexity" title="permalink">#</a></span></h3>
<p>While the code is somewhat complex,
that's mostly intrinsic to the problem itself
(what runs in the main vs. worker processes,
passing results around, error handling, and so on),
rather than due to our of use classes,
which only affects
how we refer to <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a> methods
and how we store state.</p>
<p>One could argue that copying a bunch of code doesn't increase complexity,
but if you factor in keeping it up to date and tested,
it's not exactly free either.</p>
<p>One could also argue that building our executor on top of <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a>
is increasing complexity,
and in a way that's true –
for example, we have
<a class="internal" href="/ptpe#getting-results">two result queues</a>
and had to
<a class="internal" href="/ptpe#death-becomes-a-problem">deal with dead workers</a> too,
which wouldn't be the case if we wrote it from scratch;
but in turn, that would come with having to
understand, maintain, and test
<a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/process.py#L630">800+ lines of code</a>
of low level process management code.
Sometimes,
<em>complexity I have to care about</em>
is more important that <em>total complexity</em>.</p>
<h3 id="debugging">Debugging<span class="headerlink">&nbsp;<a href="#debugging" title="permalink">#</a></span></h3>
<p>I have to come clean at this point –
I use <a class="external" href="https://blog.startifact.com/posts/print-debugging/">print debugging</a> <em>a lot</em> 🙀
(especially if there are no tests yet,
and sometimes from tests too);
when that doesn't cut it,
IPython's <a class="external" href="https://ipython.readthedocs.io/en/stable/api/generated/IPython.terminal.embed.html#IPython.terminal.embed.embed">embed()</a> usually provides enough interactivity
to figure out what's going on.<sup class="footnote-ref" id="fnref-4"><a href="#fn-4">4</a></sup></p>
<p>With the <a class="internal" href="/ptpe#minimal-test">minimal test</a> at the end of the file
driving the executor,
I used temporary <a class="external" href="https://docs.python.org/3/library/functions.html#print">print()</a> calls
in <code>_submit()</code>, <code>_put_result()</code>, and <code>__handle_results()</code>
to check data is making its way through properly;
if I expected the code to change more often,
I'd replace them with permanent logging calls.</p>
<p>In addition,
there were two debugging scripts
in the <a class="attachment" href="/_file/ptpe/bench.py">benchmark</a> file
that I didn't show,
one to automate <a class="internal" href="/ptpe#death-becomes-a-problem">killing workers</a> at the right time,
and one to make sure <code>shutdown()</code> waits any pending tasks.</p>
<p>So, does how we wrote the code change any of this?
Not really, no;
all the techniques above (and using a debugger too)
apply equally well.
If anything,
using classes makes interactive debugging easier,
since it's easier to discover state via autocomplete
(with functions only, you have to know to look it up on the module).</p>
<h2 id="try-it-out">Try it out<span class="headerlink">&nbsp;<a href="#try-it-out" title="permalink">#</a></span></h2>
<p>As I've said before, <a class="internal" href="/same-functions#try-it-out">try it out</a> –
it only took ~10 minutes to convert the initial solution to the other two.
In part,
the right code structure is a matter feeling and taste,
and both are educated by <a class="internal" href="/stdlib">reading</a> and <strong>writing</strong> lots of code.
If you think there's a better way to do something,
do it and see how it looks;
it is a sort of deliberate practice.</p>
<section class="footnotes">
<ol>
<li id="fn-1"><p><a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a> is an <em>abstract base class</em> only by convention:
it is a <em>base class</em> (other classes are supposed to subclass it),
and it is <em>abstract</em> (other classes are supposed to provide
concrete implementations for some methods).</p>
<p>Python also allows formalizing <a class="external" href="https://docs.python.org/3/glossary.html#term-abstract-base-class">abstract base classes</a> using the <a class="external" href="https://docs.python.org/3/library/abc.html#module-abc">abc</a> module;
see <a class="internal" href="/same-functions#formalizing-this">When to use classes in Python? When you repeat similar sets of functions</a>
for an example of this and other ways of achieving the same goal. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p>For brevity, I'm using the version
before <a class="internal" href="/ptpe#death-becomes-a-problem">dealing with dead workers</a>;
the final code is similar,
but with a more involved <code>__handle_results</code>. <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-3"><p>This is <em>almost</em> true –
we could &quot;this is Python&quot; our way deeper
and <a class="external" href="https://docs.python.org/3/library/sys.html#sys.modules">reload the module</a>
while still keeping a reference to the old one,
but that's just a round-about, unholy way
of emulating class instances. <a href="#fnref-3" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-4"><p>Pro tip: you can use <a class="external" href="https://ipython.readthedocs.io/en/stable/api/generated/IPython.terminal.embed.html#IPython.terminal.embed.embed">embed()</a> as a <a class="external" href="https://docs.python.org/3/library/functions.html#breakpoint">breakpoint()</a> hook:
<code>PYTHONBREAKPOINT=IPython.embed python myscript.py</code>. <a href="#fnref-4" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>