












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>inheritance over composition, sometimes - death and gravity</title>



<meta property="og:title" content="inheritance over composition, sometimes">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/over-composition">




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">inheritance over composition, sometimes</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2025-05-12">May 2025</span>
∙ 11 minute read
∙
</small><span class="share-icons">
<a
    class="share-icon pycoders"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/over-composition&t=inheritance%20over%20composition%2C%20sometimes"
>HN</a>
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/over-composition&title=inheritance%20over%20composition%2C%20sometimes"
>Reddit</a>
<a
    class="share-icon linkedin"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/over-composition"
>linkedin</a>
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=inheritance%20over%20composition%2C%20sometimes&url=https%3A//death.andgravity.com/over-composition&via=_andgravity"
>Twitter</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<section class="toc">
<ul>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#existing-code">Existing code</a></li>
<li><a href="#three-approaches">Three approaches</a>
<ul>
<li><a href="#inheritance">Inheritance</a></li>
<li><a href="#composition">Composition</a></li>
<li><a href="#functions">Functions</a></li>
</ul>
</li>
<li><a href="#comparison">Comparison</a>
<ul>
<li><a href="#complexity">Complexity</a></li>
<li><a href="#composition-over-inheritance">Composition over inheritance</a></li>
<li><a href="#global-state">Global state</a></li>
<li><a href="#debugging">Debugging</a></li>
</ul>
</li>
<li><a href="#try-it-out">Try it out</a></li>
</ul>
</section>
<blockquote>
<p>Currently the code is complex due to subclassing and many layers of delegation like &quot;def submit&quot; doing
&quot;inner = super().submit(_submit&quot;</p>
<p>Could this whole solution be coded using functions only, no classes?
Intuitively I felt classes would be hell to debug.</p>
</blockquote>
<h2 id="requirements">Requirements<span class="headerlink">&nbsp;<a href="#requirements" title="permalink">#</a></span></h2>
<p>The orginal article <a class="internal" href="/ptpe#why-not-both">sets out</a>
the following functional requirements:</p>
<ol>
<li>Spread the work to one worker process per CPU,
and then further to multiple threads inside each worker,
to work around CPU becoming a bottleneck for I‍/‍O.</li>
<li>Implement the <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a> interface;
we want a drop-in replacement
for existing <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.futures</a> executors,
so that user code doesn't have to change.</li>
</ol>
<p>Additionally, we have two implicit non-functional requirements:</p>
<ol start="3">
<li>Use the existing executor classes where possible
(less code means fewer bugs).</li>
<li>Only depend on stable, documented features;
we don't want our code to break
when <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.futures</a> internals change.</li>
</ol>
<h2 id="existing-code">Existing code<span class="headerlink">&nbsp;<a href="#existing-code" title="permalink">#</a></span></h2>
<p>Before we delve into (writing) our own code,
it's probably a good idea to look at
how the existing <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.futures</a> code is structured.</p>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can read the code of stdlib modules
 by following the <strong>Source code:</strong> links
 at the top of each documentation page.</p>
</section>
<p><a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a> is an abstract base class<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup> defined in <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/_base.py#L569">concurrent.futures._base</a>.
It provides dummy <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">submit()</a> and <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.shutdown">shutdown()</a> methods,
as well as a concrete <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">map()</a> method implemented in terms of <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">submit()</a>,
and <a class="external" href="https://docs.python.org/3/glossary.html#term-context-management-protocol">context manager methods</a> that <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.shutdown">shutdown()</a> the executor on exit.
Notably, the docs do not mention the concrete methods,
instead saying that
&quot;it should not be used directly, but through its concrete subclasses&quot;.</p>
<p><a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#threadpoolexecutor">Thread​Pool​Executor</a> is defined in <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/thread.py#L122">concurrent.futures.thread</a>.
It subclasses <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a>
and implements <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">submit()</a> and <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.shutdown">shutdown()</a>,
inheriting <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">map()</a> unchanged.</p>
<p><a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a> is defined in <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/process.py#L630">concurrent.futures.process</a>.
Like its thread counterpart,
it implements <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">submit()</a> and <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.shutdown">shutdown()</a>.
However, it <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/process.py#L808">overrides map()</a> to chop the input iterables
and pass the chunks to the superclass method with <a class="external" href="https://docs.python.org/3/library/functions.html#super">super()</a>.</p>
<h2 id="three-approaches">Three approaches<span class="headerlink">&nbsp;<a href="#three-approaches" title="permalink">#</a></span></h2>
<h3 id="inheritance">Inheritance<span class="headerlink">&nbsp;<a href="#inheritance" title="permalink">#</a></span></h3>
<p>First, let's look at the original code, where I use inheritance.
For brevity, we'll use the version
right before <a class="internal" href="/ptpe#death-becomes-a-problem">dealing with dead workers</a>
(the final version is pretty much the same,
but with a more involved <code>__handle_results</code> method).</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProcessThreadPoolExecutor</span><span class="p">(</span><span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">initializer</span><span class="o">=</span><span class="n">_init_process</span><span class="p">,</span>
            <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">initargs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__result_handler</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__handle_results</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__result_handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">outer</span>

        <span class="n">outer</span><span class="o">.</span><span class="n">set_running_or_notify_cancel</span><span class="p">()</span>
        <span class="n">inner</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_submit</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__handle_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">outer</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outer</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__result_handler</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__result_queue</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<details>
<summary>
In addition,
there are some global functions used in the worker processes,
either directly by the process pool executor,
or indirectly as callbacks of the thread pool executor futures;
this code remains the same
regardless of the style we use for the main class.
</summary>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="c1"># this code runs in each worker process</span>

<span class="n">_executor</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_result_queue</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_init_process</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">initargs</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_executor</span><span class="p">,</span> <span class="n">_result_queue</span>

    <span class="n">_executor</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_threads</span><span class="p">)</span>
    <span class="n">_result_queue</span> <span class="o">=</span> <span class="n">queue</span>

    <span class="k">if</span> <span class="n">initializer</span><span class="p">:</span>
        <span class="n">initializer</span><span class="p">(</span><span class="o">*</span><span class="n">initargs</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_submit</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
    <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">_put_result</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_put_result</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">exception</span> <span class="o">:=</span> <span class="n">task</span><span class="o">.</span><span class="n">exception</span><span class="p">():</span>
        <span class="n">_result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">()))</span>
</code></pre></div>

</details>
<p>We override <code>__init__</code>, <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">submit()</a>, and <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.shutdown">shutdown()</a>
to extend the behavior of the original methods,
but we still use them via <a class="external" href="https://docs.python.org/3/library/functions.html#super">super()</a>.</p>
<p>The context manager methods and <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">map()</a>
we inherit for free,
including the <code>chunksize</code> optimization.
Of note,
this assumes they are implemented
only in terms of other public methods (i.e. the ones overrode);
this is true for now,
but at least for <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">map()</a> it is not guaranteed by the documentation.</p>
<p>An effect of subclassing a class with private internals
is that all the subclass attributes
have to start with double underscores
(i.e. rely on the <a class="external" href="https://docs.python.org/3/tutorial/classes.html#tut-private">name mangling</a> mechanism)
to avoid clashes with superclass ones
(such as <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/process.py#L736">_result_queue</a>).</p>
<h3 id="composition">Composition<span class="headerlink">&nbsp;<a href="#composition" title="permalink">#</a></span></h3>
<p>OK, now let's use <a class="external" href="https://en.wikipedia.org/wiki/Composition_over_inheritance">composition</a> –
instead of <em>being</em> a <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a>,
our Process​Thread​Pool​Executor <em>has</em> a Process​Pool​Executor.
At a first glance,
the result is mostly identical to the previous code,
with <code>super()</code> changed to <code>self._inner</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProcessThreadPoolExecutor</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inner</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span>
            <span class="n">initializer</span><span class="o">=</span><span class="n">_init_process</span><span class="p">,</span>
            <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">initargs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">outer</span>

        <span class="n">outer</span><span class="o">.</span><span class="n">set_running_or_notify_cancel</span><span class="p">()</span>
        <span class="n">inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inner</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_submit</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">outer</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outer</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inner</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_queue</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<p>Except, we need to implement the context manager protocol:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># concurrent.futures._base.Executor.__enter__</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="c1"># concurrent.futures._base.Executor.__exit__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<p>...and we need to copy <code>map()</code> from <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">iterables</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># concurrent.futures._base.Executor.map</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">)]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">result_iterator</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">fs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">_result_or_cancel</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">_result_or_cancel</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">())</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
                    <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result_iterator</span><span class="p">()</span>
</code></pre></div>

<p>...and the <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a> <code>chunksize</code> optimization:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">iterables</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># concurrent.futures.process.ProcessPoolExecutor.map</span>

        <span class="k">if</span> <span class="n">chunksize</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chunksize must be &gt;= 1.&quot;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">_process_chunk</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span>
                            <span class="n">itertools</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">),</span> <span class="n">chunksize</span><span class="p">),</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_chain_from_iterable_of_lists</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

<details>
<summary>...and a bunch of private functions they use.</summary>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_result_or_cancel</span><span class="p">(</span><span class="n">fut</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># concurrent.futures._base._result_or_cancel</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fut</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">fut</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_process_chunk</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
    <span class="c1"># concurrent.futures.process._process_chunk</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_chain_from_iterable_of_lists</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="c1"># concurrent.futures.process._chain_from_iterable_of_lists</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">element</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">element</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">element</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div>

</details>
<p><em>And</em>, when new high level methods get added to the <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a> interface,
we'll need to at least <a class="external" href="https://en.wikipedia.org/wiki/Forwarding_(object-oriented_programming)">forward</a> them to the inner Process​Pool​Executor,
although we may need to copy them anyway
if they're implemented in terms of other methods
for which we have a custom implementation –
for example, we can't forward <code>map()</code> to the inner executor,
because we want it to use <em>our</em> <code>submit()</code>.</p>
<p>One small benefit of not subclassing anything
is that we don't need to avoid name clashes
and we can name our attributes whatever we want.</p>
<hr />
<p>But this is Python, and in Python methods are just functions,
so we can <em>almost</em> get away with doing this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProcessThreadPoolExecutor</span><span class="p">:</span>
    <span class="o">...</span> <span class="c1"># __init__, submit(), and shutdown() just as before</span>
    <span class="fm">__enter__</span> <span class="o">=</span> <span class="n">ProcessPoolExecutor</span><span class="o">.</span><span class="fm">__enter__</span>
    <span class="fm">__exit__</span> <span class="o">=</span> <span class="n">ProcessPoolExecutor</span><span class="o">.</span><span class="fm">__exit__</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">ProcessPoolExecutor</span><span class="o">.</span><span class="n">map</span>
</code></pre></div>
<p>Alas, this won't work –
Process​Pool​Executor <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/process.py#L808">map()</a>
calls <code>super().​map(...)</code>,
and <a class="external" href="https://docs.python.org/3/library/functions.html#object">object</a>, the superclass of Process​Thread​Pool​Executor,
has no such method;
we had to change
<code>super().​map(...)</code> to <code>self.​_map(...)</code>
in our copy above because of this.</p>
<hr />
<p>Since we're getting <a class="external" href="https://twitter.com/s_k_hanselmann/status/1370607580620353536">weird</a>, let's look at a more exotic alternative.</p>
<h3 id="functions">Functions<span class="headerlink">&nbsp;<a href="#functions" title="permalink">#</a></span></h3>
<p>So, could we do this using functions only, no classes?</p>
<p>Well, theoretically no,
since we need to implement the executor interface.
But practically yes,
since this is Python,
and in Python an &quot;interface&quot; is just
something that has a set of functions with specific signatures,
so we could <a class="internal" href="/same-functions#counter-example-modules">use a module instead</a>.</p>
<!-- TODO: link back from same-functions#counter-example-module -->
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">max_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">()):</span>
    <span class="k">global</span> <span class="n">_result_queue</span><span class="p">,</span> <span class="n">_inner</span><span class="p">,</span> <span class="n">_tasks</span><span class="p">,</span> <span class="n">_result_handler</span>
    <span class="n">_result_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">_inner</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span>
        <span class="n">initializer</span><span class="o">=</span><span class="n">_init_process</span><span class="p">,</span>
        <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">_result_queue</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">initargs</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_tasks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_result_handler</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_handle_results</span><span class="p">)</span>
    <span class="n">_result_handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
    <span class="n">_tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">outer</span>

    <span class="n">outer</span><span class="o">.</span><span class="n">set_running_or_notify_cancel</span><span class="p">()</span>
    <span class="n">inner</span> <span class="o">=</span> <span class="n">_inner</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_submit</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outer</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_handle_results</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">_result_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="n">_tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">outer</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outer</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_result_queue</span>
    <span class="n">_inner</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_result_queue</span><span class="p">:</span>
        <span class="n">_result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">_result_handler</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">_result_queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">_result_queue</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<details>
<summary>
Like before, we copy <code>map()</code> with minor tweaks.
</summary>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_map</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">iterables</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># concurrent.futures._base.Executor.map</span>

    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="n">fs</span> <span class="o">=</span> <span class="p">[</span><span class="n">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">result_iterator</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">fs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">_result_or_cancel</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">_result_or_cancel</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
                <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result_iterator</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">iterables</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># concurrent.futures.process.ProcessPoolExecutor.map</span>

    <span class="k">if</span> <span class="n">chunksize</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chunksize must be &gt;= 1.&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">_map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">_process_chunk</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span>
                   <span class="n">itertools</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">),</span> <span class="n">chunksize</span><span class="p">),</span>
                   <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_chain_from_iterable_of_lists</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

</details>
<p>We can then use the module itself as an executor:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">ptpe</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ptpe</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="go">1</span>
</code></pre></div>
<p>Except, some interfaces are a bit more complicated than that.
Defining <code>__enter__</code> and <code>__exit__</code> functions
won't allow us to use the module in a <code>with</code> statement,
since they have to be methods –
the interpreter <a class="external" href="https://snarky.ca/unravelling-the-with-statement/">looks them up on the class of object</a>
(<code>&lt;class 'module'&gt;</code>),
rather than on the object itself
(<code>&lt;module 'ptpe' from 'ptpe.py'&gt;</code>).</p>
<p>For a vanilla work-around,<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup>
we can add an alternate &quot;constructor&quot;
that returns a context manager with the module itself as target:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_cm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">init</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">shutdown</span><span class="p">()</span>
</code></pre></div>

<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">ptpe</span><span class="o">.</span><span class="n">init_cm</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">executor</span> <span class="ow">is</span> <span class="n">ptpe</span>
<span class="gp">... </span>    <span class="n">ptpe</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="gp">...</span>
<span class="go">2</span>
</code></pre></div>
<p>Also, because we're using global state,
only one executor can exist at any given time.
(This is <em>almost</em> true –
we could &quot;this is Python&quot; our way deeper
and somehow <a class="external" href="https://docs.python.org/3/library/sys.html#sys.modules">reload the module</a>
while still keeping a reference to the old one,
but that sounds just like a round-about way
of making class instances.)</p>
<p>But it gets worse – accidentally calling <code>init()</code> a second time
will clobber the state of the first executor,
leading to all sorts of bugs;
if we were serious about this code,
we'd need some checks to prevent it
(and tests for that, and so on).</p>
<!--

# composition *and* inheritance

.. literalinclude:: //ptpe/ptpelite_both.py

Yet another option would be to use both inheritance *and* composition –
inherit the [Executor] base class directly for the [common methods]
(assuming they're defined there and not in subclasses),
and delegate to the inner executor only where needed
(likely just [map()] and [shutdown()]).
But, the only difference from the current code would be
that it'd say `self._inner` instead of `super()` in a few places,
so it's not really worth it, in my opinion.

-->
<h2 id="comparison">Comparison<span class="headerlink">&nbsp;<a href="#comparison" title="permalink">#</a></span></h2>
<p>So, how do the solutions stack up? Here's a summary:</p>
<table class="table">
  <thead>
    <tr>
      <th scope="col"></th>
      <th scope="col">pros</th>
      <th scope="col">cons</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td scope="row"><a href="#inheritance">inheritance</a></td>
      <td>
        <ul>
          <li>least amount of code
          <li>inherits new high level methods for free
        </ul>
      </td>
      <td>
        <ul>
          <li>assumes inherited high level methods use only the public API
          <li>attribute names have to start with double underscores (minor)
        </ul>
      </td>
    </tr>
    <tr>
      <td scope="row"><a href="#composition">composition</a></td>
      <td>
        <ul>
          <li>attributes can have any name (minor)
        </ul>
      </td>
      <td>
        <ul>
          <li>copies lots of code
          <li>must be kept in sync with the interface
        </ul>
      </td>
    </tr>
    <tr>
      <td scope="row"><a href="#functions">functions</a></td>
      <td>?</td>
      <td>
        <ul>
          <li>copies lots of code
          <li>must be kept in sync with the interface
          <li>only one global executor at a time
          <li>alternate "constructor" to use as context manager (minor)
        </ul>
      </td>
    </tr>
</table>
<h3 id="complexity">Complexity<span class="headerlink">&nbsp;<a href="#complexity" title="permalink">#</a></span></h3>
<p>While the code is somewhat complex,
that is arguably due to the problem itself,
rather than because of how we wrote the code,
the only differences between the three approaches being
how we refer to <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a>
and how we store state.</p>
<p>Having to keep track of what code runs 
in the main process vs. worker processes 
is definitely intrinsic complexity,
since it arises from the functional <a class="anchor" href="#requirements">requirements</a>,
and won't go away regardless of how we structure the code.</p>
<p>Carefully delegating
the high level work of spreading tasks across processes
to <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a> 
is probably not,
but might as well be 
if you consider the alternative of doing it yourself,
and <a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/concurrent/futures/process.py#L630">800+ lines</a> of low level stuff that come with that.</p>
<h3 id="composition-over-inheritance">Composition over inheritance<span class="headerlink">&nbsp;<a href="#composition-over-inheritance" title="permalink">#</a></span></h3>
<p>Favoring <a class="external" href="https://en.wikipedia.org/wiki/Composition_over_inheritance">composition over inheritance</a>
is usually a good practice,
but in our specific case
inheritance has more benefits and fewer <a class="external" href="https://en.wikipedia.org/wiki/Composition_over_inheritance#Drawbacks">drawbacks</a>,
for two main reasons:</p>
<ol>
<li>The <a class="anchor" href="#existing-code">existing code</a>
has been designed with inheritance in mind
– even if this is mainly to enable internal reuse,
and not explicitly documented.<!-- in part, this is enabled by [super()] -->
</li>
<li>We have a true <em><a class="external" href="https://en.wikipedia.org/wiki/Is-a">is-a</a></em> relationship –
our Process​Thread​Pool​Executor really is a <a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor">Process​Pool​Executor</a>
with a bunch of extra behavior,
rather than part of an arbitrary hierarchy 
created only to enable reuse.</li>
</ol>
<p>In addition, the <a class="external" href="https://en.wikipedia.org/wiki/Composition_over_inheritance#Benefits">benefits</a> of composition
are mainly about dealing with unrelated components 
in response to an evolving business domain,
neither of which is the case for the problem we're solving.</p>
<p>As <a class="external" href="https://www.hillelwayne.com/">Hillel Wayne</a> puts it in <a class="external" href="https://buttondown.email/hillelwayne/archive/when-to-prefer-inheritance-to-composition/">When to prefer inheritance to composition</a>:</p>
<blockquote>
<p>So here are the benefits of inheritance:</p>
<ul>
<li>Unlike composition, you can pass the subclass into functions expecting the parent class.</li>
<li>Unlike interfaces, you can reuse code from the parent class in the child class.</li>
</ul>
<p>So, here's when you want to use inheritance: <strong>when you need to instantiate both the parent and child classes and pass them to the same functions</strong>. That's it. That's the use case.</p>
</blockquote>
<h3 id="global-state">Global state<span class="headerlink">&nbsp;<a href="#global-state" title="permalink">#</a></span></h3>
<p>Of the three solutions, 
the <a class="anchor" href="#functions">functions</a> one is probably the worst,
since it has all the downsides of the <a class="anchor" href="#composition">composition</a> one,
<em>and</em> comes with significant limitations due to its use of global state.</p>
<p>To avoid using globals,
we'd have to pass the state 
(result queue, executor instance, etc.)
as function arguments,
which beside breaking the executor interface,
makes the executor module harder to use;
you could of course <a class="internal" href="/same-arguments">group common arguments into a single object</a>
so there's only one argument to pass around;
call that object <code>self</code>, 
and you're back to a round-about way of making an instance.</p>
<p>The downsides of having to keep track of a bunch of related global variables
are big enough that even if you do have a module-level API,
it's still worth keeping them together on a class,
and exposing the methods of a global instance 
at module-level (<a class="external" href="https://github.com/python/cpython/blob/ebe54d7ab7ccafbd0a8a6036fd12de971dd2f55b/Lib/random.py#L917-L948">like so</a>);
Brandon Rhodes discusses this at length in <a class="external" href="https://python-patterns.guide/python/prebound-methods/">The Prebound Method Pattern</a>.</p>
<h3 id="debugging">Debugging<span class="headerlink">&nbsp;<a href="#debugging" title="permalink">#</a></span></h3>
<ul>
<li><p>confession: print()</p>
<ul>
<li>you can do this regardless of soultion</li>
<li>debugger too</li>
</ul>
</li>
<li><p><a class="internal" href="/ptpe#minimal-test">minimal test</a> at the end of the file</p>
</li>
<li><p>the <a class="internal" href="/ptpe#establishing-a-baseline">benchmark code</a> also served as a sort of tests</p>
</li>
<li><p><a class="internal" href="/ptpe#death-becomes-a-problem">terminate_child</a> for the shutdown() behavior,
but only done that after i got tired of doing <code>pkill -fn '[Pp]ython'</code>;
worth automating, can be trivially transformed into a test</p>
</li>
</ul>
<h2 id="try-it-out">Try it out<span class="headerlink">&nbsp;<a href="#try-it-out" title="permalink">#</a></span></h2>
<p>As I've said before, <a class="internal" href="/same-functions#try-it-out">try it out</a>!
It only took around 10 minutes to convert the initial solution to the other two.
Getting the structure of the code right is partly a matter of <strong>gut feeling</strong> and <strong>taste</strong>,
and both are educated by <a class="internal" href="/stdlib">reading</a> and <em>writing</em> a lot of code.
If you're doing something and think there's a better way,
do it and see how it looks; 
it's a sort of deliberate practice.</p>
<section class="footnotes">
<ol>
<li id="fn-1"><p><a class="external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor">Executor</a> is an <em>abstract base class</em> in the literal sense,
and only by convention:
it is a <em>base class</em> (other classes are supposed to subclass it),
and it is <em>abstract</em> (other classes are supposed to provide
concrete implementations for some methods).</p>
<p>Python also allows formalizing <a class="external" href="https://docs.python.org/3/glossary.html#term-abstract-base-class">abstract base classes</a> using the <a class="external" href="https://docs.python.org/3/library/abc.html#module-abc">abc</a> module;
see <a class="internal" href="/same-functions#formalizing-this">When to use classes in Python? When you repeat similar sets of functions</a>
for an example of this and other ways of achieving the same goal. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p>There is another option,
but it's definitely overkill here –
we could subclass <code>type(module)</code>,
add the appropriate <code>__enter__</code> and <code>__exit__</code> methods,
and then replace our module in <a class="external" href="https://docs.python.org/3/library/sys.html#sys.modules">sys.modules</a>
with an instance of that subclass;
needless to say,
it's easier to just use a class for the executor itself. <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>