












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>This is not interview advice: building a priority-expiry LRU cache without heaps or trees in Python - death and gravity</title>
<meta name="description" content="Today we&#39;re implementing a least recently used cache with priorities and expiry, using only the Python standard library.
This is a bIG TEch CoDINg InTerVIEW problem, so we&#39;ll work hard to stay away from the correct™ data structures, but end up with a decent solution anyway!" />


<meta property="og:title" content="This is not interview advice: building a priority-expiry LRU cache without heaps or trees in Python">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/lru-cache">
<meta property="og:description" content="Today we&#39;re implementing a least recently used cache with priorities and expiry, using only the Python standard library.
This is a bIG TEch CoDINg InTerVIEW problem, so we&#39;ll work hard to stay away from the correct™ data structures, but end up with a decent solution anyway!">



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RY2QR580X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-4RY2QR580X");
</script>



<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">This is not interview advice: building a priority-expiry LRU cache without heaps or trees in Python</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2024-01-20">January 2024</span>
∙ 22 minute read
∙
</small><span class="share-icons">
<a
    class="share-icon pycoders"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/lru-cache&t=This%20is%20not%20interview%20advice%3A%20building%20a%20priority-expiry%20LRU%20cache%20without%20heaps%20or%20trees%20in%20Python"
>HN</a>
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/lru-cache&title=This%20is%20not%20interview%20advice%3A%20building%20a%20priority-expiry%20LRU%20cache%20without%20heaps%20or%20trees%20in%20Python"
>Reddit</a>
<a
    class="share-icon linkedin"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/lru-cache"
>linkedin</a>
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=This%20is%20not%20interview%20advice%3A%20building%20a%20priority-expiry%20LRU%20cache%20without%20heaps%20or%20trees%20in%20Python&url=https%3A//death.andgravity.com/lru-cache&via=_andgravity"
>Twitter</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p><em>It's not your fault I got nerdsniped,
but that doesn't matter.</em></p>
<p>Hi, I'm Adrian, and today we're implementing a
least recently used cache with priorities and expiry,
using <strong>only the Python standard library</strong>.</p>
<p>This is a bIG TEch CoDINg InTerVIEW problem,
so we'll work hard to stay away from the correct™ data structures –
<strong>no heaps</strong>, <strong>no binary search trees</strong> –
but end up with a decent solution anyway!</p>
<section class="toc">
<ul>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#a-minimal-plausible-solution">A minimal plausible solution</a></li>
<li><a href="#problem-expired-items-should-go-first">Problem: expired items should go first...</a>
<ul>
<li><a href="#problem-name-priorityqueue-is-not-defined">Problem: name PriorityQueue is not defined</a></li>
</ul>
</li>
<li><a href="#problem-low-priority-items-second">Problem: ...low priority items second</a>
<ul>
<li><a href="#problem-we-re-deleting-items-in-three-places">Problem: we're deleting items in three places</a></li>
</ul>
</li>
<li><a href="#problem-least-recently-used-items-last">Problem: ...least recently used items last</a>
<ul>
<li><a href="#functools-lru-cache">functools.lru_cache()</a></li>
<li><a href="#ordereddict">OrderedDict</a></li>
</ul>
</li>
<li><a href="#problem-our-priority-queue-is-slow">Problem: our priority queue is slow</a>
<ul>
<li><a href="#heapq">heapq</a></li>
<li><a href="#bisect">bisect</a></li>
<li><a href="#pop-optimization">pop() optimization</a></li>
<li><a href="#binary-search-trees">Binary search trees</a></li>
<li><a href="#sorted-containers">Sorted Containers</a></li>
</ul>
</li>
<li><a href="#problem-sorted-containers-is-not-in-stdlib">Problem: Sorted Containers is not in stdlib</a>
<ul>
<li><a href="#logarithmic-time">Logarithmic time</a></li>
<li><a href="#bisect-redux">bisect, redux</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</section>
<h2 id="requirements">Requirements<span class="headerlink">&nbsp;<a href="#requirements" title="permalink">#</a></span></h2>
<p>So you're at an interview and
have to implement a <em>priority-expiry LRU cache</em>.</p>
<p>Maybe you get more details,
but maybe the problem is deliberately vague;
either way,
we can reconstruct the requirements from the name alone.</p>
<p>A <em>cache</em> is something that stores data
for future reuse,
usually the result of a slow computation or retrieval.
Each piece of data has an associated <em>key</em>
used to retrieve it.
Most caches are <em>bounded</em> in some way,
for example by limiting the number of items.</p>
<p>The other words have to do with <em>eviction</em>
– how and when items are removed.</p>
<ul>
<li>Each item has a <em>priority</em> –
when the cache fills up,
we evict items with lower priority
before those with higher priority.</li>
<li>Each item has a maximum age –
if an item goes past that,
it is <em>expired</em>,
so we don't return it.
It stands to reason expired items are evicted
regardless of their priority or how full the cache is.</li>
<li>All other things being equal,
we evict items <em>least recently used</em>
relative to others.</li>
</ul>
<p>The problem may specify an API;
we can reconstruct that from first principles too.
Since the cache is basically a key-value store,
we can get away with two methods:</p>
<ul>
<li><code>set(key, value, maxage, priority)</code></li>
<li><code>get(key) -&gt; value or None</code></li>
</ul>
<p>The problem may also suggest:</p>
<ul>
<li><code>delete(key)</code> – allows users to invalidate items
for reasons external to the cache;
not strictly necessary,
but we'll end up with it as part of refactoring</li>
<li><code>evict(now)</code> – not strictly necessary either,
but hints eviction is a separate bit of logic,
and may come in handy for testing</li>
</ul>
<p>Types deserve their own discussion:</p>
<ul>
<li><code>key</code> – usually, the key is a string,
but we can relax this to any <a class="external" href="https://docs.python.org/3/glossary.html#term-hashable">hashable</a> value</li>
<li><code>value</code> – for an in-memory cache, any kind of object is fine</li>
<li><code>maxage</code> and <code>priority</code> – a number should do for these;
a float is more general, but an integer may allow a simpler solution;
limits on these are important too,
as we'll see soon enough</li>
</ul>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Your interviewer may be expecting you to uncover some of these details
 through clarifying questions.
 Be sure to think out loud and state your assumptions.</p>
</section>
<h2 id="a-minimal-plausible-solution">A minimal plausible solution<span class="headerlink">&nbsp;<a href="#a-minimal-plausible-solution" title="permalink">#</a></span></h2>
<p>I'm sure there are a lot smart people out there
that can Think Really Hard™
and just come up with a solution,
but I'm not one of them,
so we'll take an iterative, <a class="external" href="https://hintjens.gitbooks.io/scalable-c/content/chapter1.html#problem-what-do-we-do-next">problem-solution</a> approach to this.</p>
<p>Since right now we don't have <em>any</em> solution,
we start with <a class="external" href="https://wiki.c2.com/?DoTheSimplestThingThatCouldPossiblyWork">the simplest thing that could possibly work</a><sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>
– a basic cache with no fancy eviction and no priorities;
we can then write some tests against that,
to know if we break anything going forward.</p>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If during an interview you don't know what to do
 and choose to work up from the naive solution,
 make it very clear that's what you're doing.
 Your interviewer may give you hints to help you skip that.</p>
</section>
<!-- ## setup -->
<p>A class holds all the things we need
and gives us something to stick the API on:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Cache</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">=</span> <span class="n">maxsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>

<p>And this is our first algorithmic choice:
a <a class="external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a> (backed by a <a class="external" href="https://en.wikipedia.org/wiki/Hash_table">hash table</a>)
provides average <strong>O(1)</strong> search / insert / delete.</p>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Given the problem we're solving,
 and the context we're solving it in,
 we <em>have to</em> talk about <a class="external" href="https://en.wikipedia.org/wiki/Time_complexity">time complexity</a>.
 Ned Batchelder's
 <a class="external" href="https://nedbatchelder.com/text/bigo.html">Big-O: How Code Slows as Data Grows</a>
 provides an excellent introduction
 (text and video available).</p>
</section>
<!-- ## set -->
<p><code>set()</code> leads to more choices:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evict</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">maxage</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expires</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
</code></pre></div>

<p>First, we evict items only if there's no more room left.
(There are other ways of doing this;
for example,
evicting expired items periodically minimizes memory usage.)</p>
<p>Second, if the key is already in the cache,
we remove and insert it again,
instead of updating things in place.
This way, there's only one code path for setting items,
which will make it a lot easier to
keep multiple data structures in sync later on.</p>
<p>We use a named tuple to store the parameters associated with a key:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">object</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">object</span>
    <span class="n">expires</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div>

<!-- ## evict -->
<p>For now, we just evict an arbitrary item;
in a happy little coincidence,
<a class="external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>s preserve insertion order,
so when iterating over the cache, the oldest key is first.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">evict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">))</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</code></pre></div>

<!-- ## get -->
<p>Finally, <code>get()</code> is trivial:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">item</span><span class="o">.</span><span class="n">expires</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>

<hr />
<p>With everything in place, here's the first test:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_basic</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>
</code></pre></div>

<p>To make things predictable,
we inject a fake time implementation:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">FakeTime</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="n">now</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span>
</code></pre></div>

<!--

Also, we inject the time, so we can fake it during tests,
and we use [monotonic()] time
– [time()] can jump back and forth with system clock updates.

[time()]: https://docs.python.org/3/library/time.html#time.time
[monotonic()]: https://docs.python.org/3/library/time.html#time.monotonic

-->
<h2 id="problem-expired-items-should-go-first">Problem: expired items should go first...<span class="headerlink">&nbsp;<a href="#problem-expired-items-should-go-first" title="permalink">#</a></span></h2>
<p>Following from the <a class="anchor" href="#requirements">requirements</a>,
there's an order in which items get kicked out:
first expired (lowest expiry time),
then lowest priority,
and only then least recently used.
So, we need a data structure that
can efficiently remove the smallest element.</p>
<p>Turns out, there's an <a class="external" href="https://en.wikipedia.org/wiki/Abstract_data_type">abstract data type</a> for that
called a <a class="external" href="https://en.wikipedia.org/wiki/Priority_queue">priority queue</a>;<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup>
for now, we'll honor its abstract nature
and not bother with an implementation.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
</code></pre></div>

<!-- ## set -->
<p>Since we need the <em>item</em> with the lowest expiry time,
we need a way to get back to the item;
an <code>(expires, key)</code> tuple should do fine
– since tuples compare lexicographically,
it'll be like comparing by <code>expires</code> alone,
but with <code>key</code> along for the ride; in <code>set()</code>, we add:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div>

<p>You may be tempted  (like I was) to say
&quot;hey, the item's already a tuple,
if we make <code>expires</code> the first field,
we can use the item itself&quot;,
but let's delay optimizations
until we have and <em>understand</em> a full solution –
<a class="external" href="https://wiki.c2.com/?MakeItWorkMakeItRightMakeItFast">make it work, make it right, make it fast</a>.</p>
<p>Still in <code>set()</code>,
if the key is already in the cache,
we also remove and insert it from the expires queue,
so it's added back with the new expiry time.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="k">del</span> <span class="n">item</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evict</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
</code></pre></div>

<!-- ## evict -->
<p>Moving on to evicting things;
for this, we need two operations:
first peek at the item that expires next
to see if it's expired, then, if it is, pop it from the queue.
(Another choice: we only have to evict one item, but evict all expired ones.)</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">evict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">initial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">expires</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expires</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">==</span> <span class="n">initial_size</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</code></pre></div>

<p>If there are no expired items,
we still have to make room for the one item;
since we're not handling priorities yet,
we'll evict the item that expires next a little early.</p>
<p><a id="priority-queue"></a></p>
<h3 id="problem-name-priorityqueue-is-not-defined">Problem: name PriorityQueue is not defined<span class="headerlink">&nbsp;<a href="#problem-name-priorityqueue-is-not-defined" title="permalink">#</a></span></h3>
<p>OK, to get the code working again, we need a PriorityQueue class.
It doesn't need to be fast,
we can deal with that after we finish everything else;
for now, let's just keep our elements in a plain list.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">PriorityQueue</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

<p>The easiest way to get the smallest value is to keep the list sorted;
the downside is that <code>push()</code> is now <strong>O(n log n)</strong>
– although, because the list is always sorted,
it can be as good as <strong>O(n)</strong> depending on the <a class="external" href="https://en.wikipedia.org/wiki/Timsort">implementation</a>.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</code></pre></div>

<p>This makes <code>peek()</code> and <code>pop()</code> trivial;
still, <code>pop()</code> is <strong>O(n)</strong>,
because it shifts all the items left by one position.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">rv</span>
</code></pre></div>

<p><code>remove()</code> is just as simple, and just as <strong>O(N)</strong>,
because it first needs to find the item,
and then shift the ones after it to cover the gap.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</code></pre></div>

<p>We didn't use the <em>is empty</em> operation,
but it should be O(1) regardless of implementation,
so let's throw it in anyway:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>

<p>OK, let's wrap up with a quick test:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_priority_queue</span><span class="p">():</span>
    <span class="n">pq</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">pq</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">assert</span> <span class="n">pq</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">pq</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div>

<!-- ## more tests -->
<hr />
<p>Now the existing tests pass,
and we can add more –
first, that expired items are evicted
(note how we're moving the time forward):</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_expires</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>
</code></pre></div>

<p>Second, that setting an existing item changes its expire time:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_update_expires</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span>
</code></pre></div>

<h2 id="problem-low-priority-items-second">Problem: ...low priority items second<span class="headerlink">&nbsp;<a href="#problem-low-priority-items-second" title="permalink">#</a></span></h2>
<p>Next up, kick out items by priority –
shouldn't be too hard, right?</p>
<p>In <code>__init__()</code>, add another priority queue for priorities:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
</code></pre></div>

<p>In <code>set()</code>, add new items to the priorities queue:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div>

<p>...and remove already-cached items:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="k">del</span> <span class="n">item</span>
</code></pre></div>

<p>In <code>evict()</code>, remove expired items from the priorities queue:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">expires</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expires</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div>

<p>...and finally, if none are expired,
remove the one with the lowest priority:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">==</span> <span class="n">initial_size</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div>

<!-- ## tests -->
<p>Add one test for eviction by priority:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_priorities</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>
</code></pre></div>

<p>...and one for updating the priority of existing items:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_update_priorities</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>
</code></pre></div>

<h3 id="problem-we-re-deleting-items-in-three-places">Problem: we're deleting items in three places<span class="headerlink">&nbsp;<a href="#problem-we-re-deleting-items-in-three-places" title="permalink">#</a></span></h3>
<p>I said we'll postpone performance optimizations
until we have a complete solution,
but I have a different kind of optimization in mind – for readability.</p>
<p>We're deleting items in three slightly different ways,
careful to keep three data structures in sync each time;
it would be nice to do it only once.
While a bit premature,
through the magic of having written the article already,
I'm sure it will pay off.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">expires</span><span class="p">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div>

<p>Sure, eviction is twice as slow,
but the complexity stays the the same –
the constant factor in <strong>O(2n)</strong> gets removed, leaving us with <strong>O(n)</strong>.
If needed, we can go back to the unpacked version
once we have a reasonably efficient implementation
(that's what tests are for).</p>
<p>Deleting already-cached items is shortened to:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>

<p>Idem for the core eviction logic:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">expires</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expires</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">==</span> <span class="n">initial_size</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>

<p>Neat!</p>
<h2 id="problem-least-recently-used-items-last">Problem: ...least recently used items last<span class="headerlink">&nbsp;<a href="#problem-least-recently-used-items-last" title="permalink">#</a></span></h2>
<p>So, how does one implement a least recently used cache?</p>
<p>We could google it...
or, we could look at an existing implementation.</p>
<h3 id="functools-lru-cache">functools.lru_cache()<span class="headerlink">&nbsp;<a href="#functools-lru-cache" title="permalink">#</a></span></h3>
<p>Standard library <a class="external" href="https://docs.python.org/3/library/functools.html#functools.lru_cache">functools.lru_cache()</a> comes to mind first;
let's have a look.</p>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can read the code of stdlib modules
 by following the <strong>Source code:</strong> link
 at the top of each documentation page.</p>
</section>
<p><a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/functools.py#L479-L523">lru_cache()</a> delegates to <a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/functools.py#L525-L639">_lru_cache_wrapper()</a>,
which sets up a bunch of variables to be used by nested functions.<sup class="footnote-ref" id="fnref-3"><a href="#fn-3">3</a></sup>
Among the variables is
a <code>cache</code> dict
and a doubly linked list
where nodes are [prev, next, key, value] lists.<sup class="footnote-ref" id="fnref-4"><a href="#fn-4">4</a></sup></p>
<p><a id="dll"></a></p>
<p>And that's the answer –
a doubly linked list allows tracking item use in <strong>O(1)</strong>:
each time a node is used,
remove it from its current position and plop it at the &quot;recently used&quot; end;
whatever's at the other end will be the least recently used item.</p>
<p>Note that, unlike <a class="external" href="https://docs.python.org/3/library/functools.html#functools.lru_cache">lru_cache()</a>,
we need one doubly linked list <em>for each priority</em>.</p>
<p>But, before making <code>Item</code> mutable and giving it prev/next links,
let's dive deeper.</p>
<h3 id="ordereddict">OrderedDict<span class="headerlink">&nbsp;<a href="#ordereddict" title="permalink">#</a></span></h3>
<p>If you <a class="external" href="https://docs.python.org/3.12/search.html?q=LRU">search the docs for &quot;LRU&quot;</a>,
the next result after lru_cache()
is <a class="external" href="https://docs.python.org/3/library/collections.html#ordereddict-objects">OrderedDict</a>.</p>
<blockquote>
<p>Some differences from <a class="external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a> still remain:
[...]
The <a class="external" href="https://docs.python.org/3/library/collections.html#collections.OrderedDict">OrderedDict</a> algorithm can handle frequent reordering operations better than dict.
[...] this makes it suitable for implementing various kinds of LRU caches.</p>
</blockquote>
<p>Specifically:</p>
<blockquote>
<p><a class="external" href="https://docs.python.org/3/library/collections.html#collections.OrderedDict">OrderedDict</a> has a <code>move_to_end()</code> method to efficiently reposition an element to an endpoint.</p>
</blockquote>
<p>Since <a class="external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>s preserve insertion order,
you can use <code>d[k] = d.pop(k)</code> to move items to the end...
What makes <a class="external" href="https://docs.python.org/3/library/collections.html#collections.OrderedDict.move_to_end">move_to_end()</a> better, then?
<a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/collections/__init__.py#L90">This comment</a> may shed some light:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">90</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="c1"># The internal self.__map dict maps keys to links in a doubly linked list.</span>
</code></pre></div></td></tr></table></div>
<p>Indeed, move_to_end() <a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/collections/__init__.py#L188-L211">does exactly</a> what we described <a class="anchor" href="#dll">above</a> –
this is good news, it means we don't have to do it ourselves!</p>
<hr />
<p><a id="priority-buckets"></a></p>
<p>So, we need one OrderedDict (read: doubly linked list) for each priority,
but still need to keep track the lowest priority:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
</code></pre></div>

<p>Handling priorities in <code>set()</code> gets a bit more complicated:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">priority_bucket</span><span class="p">:</span>
            <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
        <span class="n">priority_bucket</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<p>But now we can finally evict the least recently used item:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">==</span> <span class="n">initial_size</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">priority_bucket</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>

<p>In <code>delete()</code>, we're careful to get rid of empty buckets:<sup class="footnote-ref" id="fnref-5"><a href="#fn-5">5</a></sup></p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">priority_bucket</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">priority_bucket</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
</code></pre></div>

<p>Existing tests pass again, and we can add a new (still failing) one:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_lru</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>
</code></pre></div>

<p>All that's needed to make it pass is to call <a class="external" href="https://docs.python.org/3/library/collections.html#collections.OrderedDict.move_to_end">move_to_end()</a> in <code>get()</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">priority</span><span class="p">]</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>




<div class="panel inline-panel" >
    <div class="panel-header text-large">
        Liking this so far? Here&#39;s another article you might like:
    </div>
    <div class="panel-body">
        <p><a href="/stdlib">
            Learn by reading code: Python standard library design decisions explained
        </a>
    </div>
</div>
<h2 id="problem-our-priority-queue-is-slow">Problem: our priority queue is slow<span class="headerlink">&nbsp;<a href="#problem-our-priority-queue-is-slow" title="permalink">#</a></span></h2>
<p>OK, we have a complete solution,
it's time to deal with the priority queue implementation.
Let's do a quick recap of the methods we need and why:</p>
<ul>
<li><code>push()</code> – to add items</li>
<li><code>peek()</code> – to get items / buckets with the lowest expiry time / priority</li>
<li><code>remove()</code> – to delete items</li>
<li><code>pop()</code> – not used, but would be without the <a class="anchor" href="#problem-we-re-deleting-items-in-three-places"><code>delete()</code> refactoring</a></li>
</ul>
<p>We make two related observations:
first, there's no <em>remove</em> operation on the  <a class="external" href="https://en.wikipedia.org/wiki/Priority_queue">priority queue</a> Wikipedia page;
second, even if we unpack <code>delete()</code>,
we only get to <code>pop()</code> an item/bucket from one of the queues,
and still have to <code>remove()</code> it from the other.</p>
<p>And <strong>this is what makes the problem tricky</strong> –
we need to maintain not one, but <em>two</em> independent priority queues.</p>
<h3 id="heapq">heapq<span class="headerlink">&nbsp;<a href="#heapq" title="permalink">#</a></span></h3>
<p>If you <a class="external" href="https://docs.python.org/3.12/search.html?q=priority+queue">search the docs for &quot;priority queue&quot;</a>,
you'll find <a class="external" href="https://docs.python.org/3/library/heapq.html">heapq</a>, which:</p>
<blockquote>
<p>[...] provides an implementation of the heap queue algorithm,
<strong>also known as the priority queue algorithm</strong>.</p>
</blockquote>
<!--

[Wikipedia][priority queue] mostly agrees:

> While priority queues are often implemented using [heaps][heap],
> they are conceptually distinct from heaps. [...]

-->
<p>Reading on,
we find extensive <a class="external" href="https://docs.python.org/3/library/heapq.html#priority-queue-implementation-notes">notes on implementing priority queues</a>;
particularly interesting are
using <em>(priority, item)</em> tuples (already doing this!)
and removing entries:</p>
<blockquote>
<p>Removing the entry or changing its priority is more difficult
because it would break the heap structure invariants.
So, a possible solution is to mark the entry as removed
and add a new entry with the revised priority.</p>
</blockquote>
<p>This workaround is needed because while
removing the i-th element <a class="external" href="https://stackoverflow.com/questions/10162679/python-delete-element-from-heap/10163422#10163422">can be done in <strong>O(log n)</strong></a>,
finding its index is <strong>O(n)</strong>.
To summarize, we have:</p>
<table class="table">
<thead>
<tr>
  <th></th>
  <th>sort</th>
  <th>heapq</th>
</tr>
</thead>
<tbody>
<tr>
  <td>push()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>peek()</td>
  <td>O(1)</td>
  <td>O(1)</td>
</tr>
<tr>
  <td>pop()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>remove()</td>
  <td>O(n)</td>
  <td>O(n)</td>
</tr>
</tbody>
</table>
<p>Still, with a few mitigating assumptions, it could work:</p>
<ul>
<li>we can assume priorities are static, so buckets never get removed</li>
<li>to-be-removed expiry times will get popped sooner or later anyway;
we can assume that most evictions are due to expired items,
and that items being evicted due to low priority (i.e. when the cache is full)
and item updates are rare
(both cause to-be-removed entries to accumulate in the expiry queue)</li>
</ul>
<!-- ...but, that's maybe too many assumptions for my liking. -->
<h3 id="bisect">bisect<span class="headerlink">&nbsp;<a href="#bisect" title="permalink">#</a></span></h3>
<p>One way of finding an element in better than O(n) is <a class="external" href="https://docs.python.org/3/library/bisect.html">bisect</a>, which:</p>
<blockquote>
<p>[...] provides support for maintaining a list in sorted order
without having to sort the list after each insertion.</p>
</blockquote>
<p>This may provide an improvement
to our <a class="anchor" href="#priority-queue">naive implementation</a>;
sadly, reading further to <a class="external" href="https://docs.python.org/3/library/bisect.html#performance-notes">Performance Notes</a>
we find that:</p>
<blockquote>
<p>The insort() functions are <strong>O(n)</strong> because the logarithmic search step
is dominated by the linear time insertion step.</p>
</blockquote>
<p>While in general that's better than just about any sort,
we happen to be hitting the best case of our sort <a class="external" href="https://en.wikipedia.org/wiki/Timsort">implementation</a>,
which has the same complexity.
(Nevertheless, shifting elements is likely cheaper than the same number of comparisons.)</p>
<table class="table">
<thead>
<tr>
  <th></th>
  <th>sort</th>
  <th>heapq</th>
  <th><mark>bisect</mark></th>
</tr>
</thead>
<tbody>
<tr>
  <td>push()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(n)</td>
</tr>
<tr>
  <td>peek()</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(1)</td>
</tr>
<tr>
  <td>pop()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(n)</td>
</tr>
<tr>
  <td>remove()</td>
  <td>O(n)</td>
  <td>O(n)</td>
  <td>O(n)</td>
</tr>
</tbody>
</table>
<p>Further down in the docs, there's a <em>see also</em> box:</p>
<blockquote>
<p><a class="external" href="https://grantjenks.com/docs/sortedcollections/">Sorted Collections</a> is a high performance module
that uses <em>bisect</em> to managed sorted collections of data.</p>
</blockquote>
<p>Not in stdlib, moving along... ¯\_(ツ)_/¯</p>
<h3 id="pop-optimization">pop() optimization<span class="headerlink">&nbsp;<a href="#pop-optimization" title="permalink">#</a></span></h3>
<p>There's an unrelated improvement that applies to both
the <a class="anchor" href="#priority-queue">naive solution</a> and <a class="anchor" href="#bisect">bisect</a>.
With a sorted list, pop() is <strong>O(n)</strong> because
it shifts all elements after the first;
if the order was reversed,
we'd pop() <em>from the end</em>,
<a class="external" href="https://wiki.python.org/moin/TimeComplexity">which is <strong>O(1)</strong></a>. So:</p>
<table class="table">
<thead>
<tr>
  <th></th>
  <th>sort</th>
  <th>heapq</th>
  <th>bisect</th>
</tr>
</thead>
<tbody>
<tr>
  <td>push()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(n)</td>
</tr>
<tr>
  <td>peek()</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(1)</td>
</tr>
<tr>
  <td>pop()</td>
  <td><mark>O(1)<a class="anchor" href="#pop-optimization">*</a></mark></td>
  <td>O(log n)</td>
  <td><mark>O(1)<a class="anchor" href="#pop-optimization">*</a></marr></td>
</tr>
<tr>
  <td>remove()</td>
  <td>O(n)</td>
  <td>O(n)</td>
  <td>O(n)</td>
</tr>
</tbody>
</table>
<h3 id="binary-search-trees">Binary search trees<span class="headerlink">&nbsp;<a href="#binary-search-trees" title="permalink">#</a></span></h3>
<p>OK, I'm out of ideas,
and there's nothing else <a class="external" href="https://docs.python.org/3/library/datatypes.html">in stdlib</a> that can help.</p>
<p>We can restate the problem as follows:
we need a sorted data structure
that can do better than <strong>O(n)</strong> for push() / remove().</p>
<p>We've already peeked at the Wikipedia <a class="external" href="https://en.wikipedia.org/wiki/Priority_queue">priority queue</a> page,
so let's keep reading –
skipping past the <a class="external" href="https://en.wikipedia.org/wiki/Priority_queue#Naive_implementations">naive implementations</a>,
to the <a class="external" href="https://en.wikipedia.org/wiki/Priority_queue#Usual_implementation">usual implementation</a>, we find that:</p>
<blockquote>
<p>To improve performance, priority queues are typically based on a <a class="external" href="https://en.wikipedia.org/wiki/Heap_(data_structure)">heap</a>, [...]</p>
</blockquote>
<p>Looked into that, didn't work; next:</p>
<blockquote>
<p>Alternatively, when a <a class="external" href="https://en.wikipedia.org/wiki/Self-balancing_binary_search_tree">self-balancing binary search tree</a> is used,
insertion and removal also take O(log n) time [...]</p>
</blockquote>
<p><em>There</em>, that's what we're looking for!
(And likely what your interviewer is, too.)</p>
<table class="table">
<thead>
<tr>
  <th></th>
  <th>sort</th>
  <th>heapq</th>
  <th>bisect</th>
  <th><mark>BST</mark></th>
</tr>
</thead>
<tbody>
<tr>
  <td>push()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(n)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>peek()</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>pop()</td>
  <td>O(1)<a class="anchor" href="#pop-optimization">*</a></td>
  <td>O(log n)</td>
  <td>O(1)<a class="anchor" href="#pop-optimization">*</a></td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>remove()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(n)</td>
  <td>O(log n)</td>
</tr>
</tbody>
</table>
<p>But there's no self-balancing BST in the standard library,
and I sure as hell am not implementing one right now
– I still have flashbacks from when I tried to do a red-black tree
and two hours later it still had bugs
(I mean, <a class="external" href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree#Operations">look at the length of this explanation!</a>).</p>
<!-- and there's other, more complicated data structures that mix trees with something else -->
<p>After a bit of googling we find, among others, <a class="external" href="https://pypi.org/project/bintrees/">bintrees</a>,
a mature library that provides all sorts of binary search trees... except:</p>
<blockquote>
<p>Bintrees Development Stopped</p>
<p>Use <em>sortedcontainers</em> instead: <a class="external" href="https://pypi.python.org/pypi/sortedcontainers">https://pypi.python.org/pypi/sortedcontainers</a></p>
</blockquote>
<p>Sounds familiar, doesn't it?</p>
<h3 id="sorted-containers">Sorted Containers<span class="headerlink">&nbsp;<a href="#sorted-containers" title="permalink">#</a></span></h3>
<p>Let's go back to that <a class="external" href="https://grantjenks.com/docs/sortedcollections/">Sorted Collections</a> library <a class="external" href="https://docs.python.org/3/library/bisect.html">bisect</a> was recommending:</p>
<blockquote>
<p>Depends on the <a class="external" href="https://grantjenks.com/docs/sortedcontainers/">Sorted Containers</a> module.</p>
</blockquote>
<p>(￢‿￢ )</p>
<p>I remember, I remember now...
I'm not salty because the red-black tree took two hours to implement.
I'm salty because after all that time,
I found <a class="external" href="https://grantjenks.com/docs/sortedcontainers/">Sorted Containers</a>,
a pure Python library
that is <em>faster</em> in practice than
fancy self-balancing binary search trees implemented in C!</p>
<p>It has <a class="external" href="https://grantjenks.com/docs/sortedcontainers/performance.html">extensive benchmarks</a> to prove it,
and simulated workload benchmarks for our own use case,
<a class="external" href="https://grantjenks.com/docs/sortedcontainers/performance-workload.html#priority-queue">priority queues</a>
– so yeah, while the interview answer is &quot;self-balancing BSTs&quot;,
the <em>actual</em> answer is <a class="external" href="https://grantjenks.com/docs/sortedcontainers/">Sorted Containers</a>.</p>
<p>How does it work? There's an <a class="external" href="https://grantjenks.com/docs/sortedcontainers/implementation.html">extensive explanation</a> too:<sup class="footnote-ref" id="fnref-6"><a href="#fn-6">6</a></sup></p>
<blockquote>
<p>The <a class="external" href="https://grantjenks.com/docs/sortedcontainers/">Sorted Containers</a> internal implementation is based on a couple observations. The first is that Python’s <em>list</em> is fast, <em>really fast</em>. [...] The second is that <em>bisect.insort</em><sup class="footnote-ref" id="fnref-7"><a href="#fn-7">7</a></sup> is fast. This is somewhat counter-intuitive since it involves shifting a series of items in a list. But modern processors do this really well. A lot of time has been spent optimizing mem-copy/mem-move-like operations both in hardware and software.</p>
<p>But using only one list and <em>bisect.insort</em> would produce sluggish behavior for lengths exceeding ten thousand. So the implementation of <a class="external" href="https://grantjenks.com/docs/sortedcontainers/sortedlist.html">Sorted List</a> uses a list of lists to store elements. [...]</p>
</blockquote>
<p>There's also a comparison with trees, which I'll summarize:
fewer memory allocations,
better cache locality,
lower memory overhead,
and faster iteration.</p>
<p>I think that gives you a decent idea of how and why it works,
enough that with a bit of tinkering
you might be able to implement it yourself.<sup class="footnote-ref" id="fnref-8"><a href="#fn-8">8</a></sup></p>
<h2 id="problem-sorted-containers-is-not-in-stdlib">Problem: Sorted Containers is not in stdlib<span class="headerlink">&nbsp;<a href="#problem-sorted-containers-is-not-in-stdlib" title="permalink">#</a></span></h2>
<p>But <a class="external" href="https://grantjenks.com/docs/sortedcontainers/">Sorted Containers</a> is not in the standard library either,
and we don't want to implement it ourselves.
We did learn something from it, though:</p>
<table class="table">
<thead>
<tr>
  <th></th>
  <th>sort</th>
  <th>heapq</th>
  <th>bisect</th>
  <th><mark>bisect &lt;10k</mark></th>
  <th>BST</th>
</tr>
</thead>
<tbody>
<tr>
  <td>push()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>peek()</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>pop()</td>
  <td>O(1)<a class="anchor" href="#pop-optimization">*</a></td>
  <td>O(log n)</td>
  <td>O(1)<a class="anchor" href="#pop-optimization">*</a></td>
  <td>O(1)<a class="anchor" href="#pop-optimization">*</a></td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>remove()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(log n)</td>
</tr>
</tbody>
</table>
<p>We still need to make some assumptions, though:</p>
<ol>
<li>Do we really need more than 10k priorities?
 <strong>Likely no</strong>, let's just cap them at 10k.</li>
<li>Do we really need more than 10k expiry times?
 <strong>Maybe?</strong> –
 with 1 second granularity
 we can represent only up to 2.7 hours;
 10 seconds takes us up to 27 hours,
 which may just work.</li>
</ol>
<p>OK, one more and we're done.
The other issue,
aside from the maximum time,
is that the granularity is too low,
especially for short times –
rounding 1 to 10 seconds is much worse than
rounding 2001 to 2010 seconds.
Which begs the question –</p>
<ol start="3">
<li>Does it really matter if items expire in 2010 seconds instead of 2001?
 <strong>Likely no</strong>,
 but we need a way to round
 small values with higher granularity than big ones.</li>
</ol>



<div class="panel inline-panel" >
    <div class="panel-header text-large">
        If you&#39;ve made it this far, you will definitely like:
    </div>
    <div class="panel-body">
        <p><a href="/pwned">
            Has your password been pwned? Or, how I almost failed to search a 37 GB text file in under 1 millisecond (in Python)
        </a>
    </div>
</div>
<h3 id="logarithmic-time">Logarithmic time<span class="headerlink">&nbsp;<a href="#logarithmic-time" title="permalink">#</a></span></h3>
<p>How about 1, 2, 4, 8, ...?
Rounding up to powers of 2 gets us decreasing granularity,
but time doesn't actually start at zero.
We fix this by rounding up to <em>multiples</em> of powers of 2 instead;
let's get an intuition of how it works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">ceil</span><span class="p">((</span><span class="mi">2000</span> <span class="o">+</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>  <span class="mi">1</span> <span class="o">=</span> <span class="mi">2001</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2000</span> <span class="o">+</span>  <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>  <span class="mi">2</span><span class="p">)</span> <span class="o">*</span>  <span class="mi">2</span> <span class="o">=</span> <span class="mi">2002</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2000</span> <span class="o">+</span>  <span class="mi">3</span><span class="p">)</span> <span class="o">/</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">*</span>  <span class="mi">4</span> <span class="o">=</span> <span class="mi">2004</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2000</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">/</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">*</span>  <span class="mi">4</span> <span class="o">=</span> <span class="mi">2004</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2000</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">=</span> <span class="mi">2016</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2000</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">=</span> <span class="mi">2016</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2000</span> <span class="o">+</span> <span class="mi">17</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">=</span> <span class="mi">2048</span>
</code></pre></div>
<p>So far so good, how about after some time has passed?</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">ceil</span><span class="p">((</span><span class="mi">2013</span> <span class="o">+</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>  <span class="mi">1</span> <span class="o">=</span> <span class="mi">2014</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2013</span> <span class="o">+</span>  <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>  <span class="mi">2</span><span class="p">)</span> <span class="o">*</span>  <span class="mi">2</span> <span class="o">=</span> <span class="mi">2016</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2013</span> <span class="o">+</span>  <span class="mi">3</span><span class="p">)</span> <span class="o">/</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">*</span>  <span class="mi">4</span> <span class="o">=</span> <span class="mi">2016</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2013</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">/</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">*</span>  <span class="mi">4</span> <span class="o">=</span> <span class="mi">2020</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2013</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">=</span> <span class="mi">2032</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2013</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">=</span> <span class="mi">2032</span>
<span class="n">ceil</span><span class="p">((</span><span class="mi">2013</span> <span class="o">+</span> <span class="mi">17</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">=</span> <span class="mi">2048</span>
</code></pre></div>
<p>The beauty of aligned powers is that
for a relatively constant number of expiry times,
the number of buckets remains roughly the same over time –
as closely packed buckets are removed from the beginning,
new ones fill the gaps between the sparser ones towards the end.</p>
<p>OK, let's put it into code:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">log_bucket</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">maxage</span><span class="p">):</span>
    <span class="n">next_power</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">maxage</span><span class="p">))</span>
    <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">maxage</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">expires</span> <span class="o">/</span> <span class="n">next_power</span><span class="p">)</span> <span class="o">*</span> <span class="n">next_power</span>
    <span class="k">return</span> <span class="n">bucket</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">]]</span>
<span class="go">[1, 2, 4, 4, 16, 16, 32]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">]]</span>
<span class="go">[2001, 2002, 2004, 2004, 2016, 2016, 2048]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">]]</span>
<span class="go">[2014, 2016, 2016, 2020, 2032, 2032, 2048]</span>
</code></pre></div>
<p>Looking good!</p>
<p>There are two sources of error –
first from rounding <code>maxage</code>,
worst when it's one more than a power of 2,
and second from rounding the expiry time,
also worst when it's one more than a power of two.
Together, they approach 200% of <code>maxage</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>  <span class="c1"># (32 - 17) / 17 ~= 88%</span>
<span class="go">32</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">)</span>  <span class="c1"># (64 - 33) / 33 ~= 94%</span>
<span class="go">64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>  <span class="c1"># (64 - 31) / 17 ~= 182%</span>
<span class="go">64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">)</span>  <span class="c1"># (128 - 64) / 33 ~= 191%</span>
<span class="go">128</span>
</code></pre></div>
<p>200% error is quite a lot;
before we set to fix it,
let's confirm our reasoning.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">maxage</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;log_bucket() error.&quot;&quot;&quot;</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">log_bucket</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">maxage</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">bucket</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span> <span class="o">/</span> <span class="n">maxage</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">max_error</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">max_maxage</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Worst log_bucket() error for all maxages up to max_maxage.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span>
        <span class="n">error</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">maxage</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">maxage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_maxage</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">max_error_random</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Worst log_bucket() error for random inputs, out of n tries.&quot;&quot;&quot;</span>
    <span class="n">max_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">max_maxage</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">31</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span>
        <span class="n">error</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="n">max_now</span><span class="p">),</span> <span class="n">rand</span><span class="p">(</span><span class="n">max_maxage</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>

<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">max_error</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">)</span>
<span class="go">0.9997558891736849</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">max_error</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">)</span>
<span class="go">1.9527896995708156</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">max_error_random</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">)</span>
<span class="go">1.9995498725910554</span>
</code></pre></div>
<p>Looks confirmed enough to me.</p>
<p>So, how do we make the error smaller?
Instead of rounding to the next power of 2,
we round to the next half of a power of 2,
or next quarter, or next eighth...</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">log_bucket</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">maxage</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">next_power</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">maxage</span><span class="p">)</span> <span class="o">-</span> <span class="n">shift</span><span class="p">))</span>
    <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">maxage</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">expires</span> <span class="o">/</span> <span class="n">next_power</span><span class="p">)</span> <span class="o">*</span> <span class="n">next_power</span>
    <span class="k">return</span> <span class="n">bucket</span>
</code></pre></div>

<p>It seems to be working:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">([</span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">]])</span>
<span class="gp">...</span>
<span class="go">[1, 2, 4, 4, 16, 16, 32]</span>
<span class="go">[1, 2, 4, 4, 16, 16, 32]</span>
<span class="go">[1, 2, 3, 4, 16, 16, 24]</span>
<span class="go">[1, 2, 3, 4, 16, 16, 20]</span>
<span class="go">[1, 2, 3, 4, 15, 16, 18]</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">e</span> <span class="o">=</span> <span class="n">max_error_random</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">e</span><span class="si">:</span><span class="s1">6.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">0 199.8%</span>
<span class="go">1  99.9%</span>
<span class="go">2  50.0%</span>
<span class="go">3  25.0%</span>
<span class="go">4  12.5%</span>
<span class="go">5   6.2%</span>
<span class="go">6   3.1%</span>
<span class="go">7   1.6%</span>
<span class="go">8   0.8%</span>
<span class="go">9   0.4%</span>
</code></pre></div>
<p>With <code>shift=7</code>, the error is less that two percent;
I wonder how many buckets that is...</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">max_buckets</span><span class="p">(</span><span class="n">max_maxage</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Number of buckets to cover all maxages up to max_maxage.&quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">buckets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">log_bucket</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">maxage</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">maxage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_maxage</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span>
</code></pre></div>

<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">max_buckets</span><span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="go">729</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">max_buckets</span><span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="go">1047</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">max_buckets</span><span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="go">1279</span>
</code></pre></div>
<p>A bit over a thousand buckets for the whole year, not bad!</p>
<!-- ## expires buckets -->
<hr />
<details>
<summary>
Before we can use any of that,
we need to convert expiry times to buckets;
that looks a lot like the <a href="#priority-buckets">priority buckets</a> code,
the only notable part being eviction.
</summary>
<p><code>__init__()</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires_order</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
</code></pre></div>

<p><code>set()</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="n">expires_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expires_bucket</span><span class="p">:</span>
            <span class="n">expires_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="p">[</span><span class="n">expires</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires_order</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>
        <span class="n">expires_bucket</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>

<p><code>delete()</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="n">expires_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="p">[</span><span class="n">expires</span><span class="p">]</span>
        <span class="n">expires_bucket</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expires_bucket</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="p">[</span><span class="n">expires</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>
</code></pre></div>

<p><code>evict()</code>:</p>
</details>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_order</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expires</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">expires_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="p">[</span><span class="n">expires</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="p">[</span><span class="n">expires</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>

<hr />
<p>And now we use <code>log_bucket()</code>.
Since we're at it,
why not have unlimited priorities too?
A hammer is a hammer and everything is a nail, after all.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="n">expires</span> <span class="o">=</span> <span class="n">log_bucket</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">maxage</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="n">log_bucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priority</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expires</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>
</code></pre></div>

<h3 id="bisect-redux">bisect, redux<span class="headerlink">&nbsp;<a href="#bisect-redux" title="permalink">#</a></span></h3>
<p>Time to fix that priority queue.</p>
<p>We use <a class="external" href="https://docs.python.org/3/library/bisect.html#bisect.insort">insort()</a> to add priorities
and <a class="external" href="https://docs.python.org/3/library/operator.html#operator.neg">operator.neg()</a> to keep the list <a class="anchor" href="#pop-optimization">reversed</a>:<sup class="footnote-ref" id="fnref-9"><a href="#fn-9">9</a></sup></p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">bisect</span><span class="o">.</span><span class="n">insort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">neg</span><span class="p">)</span>
</code></pre></div>

<p>We update <code>peek()</code> and <code>pop()</code> to handle the reverse order:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div>

<p>Finally, for <code>remove()</code> we adapt the <code>index()</code> recipe
from <a class="external" href="https://docs.python.org/3/library/bisect.html#searching-sorted-lists">Searching Sorted Lists</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="n">item</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">neg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">return</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
</code></pre></div>

<p>And that's it, we're done!</p>
<p>Here's <a class="attachment" href="/_file/lru-cache/50-bisect.py">the final version of the code</a>.</p>
<h2 id="conclusion">Conclusion<span class="headerlink">&nbsp;<a href="#conclusion" title="permalink">#</a></span></h2>
<p>Anyone expecting you to <em>implement</em> this in under an hour is delusional.
Explaining <strong>what you would use and why</strong> should be enough
for reasonable interviewers,
although that may prove difficult
if you haven't solved this kind of problem before.</p>
<p>Bullshit interviews aside,
it is useful to <strong>have basic knowledge of time complexity</strong>.
Again, can't recommend <a class="external" href="https://nedbatchelder.com/text/bigo.html">Big-O: How Code Slows as Data Grows</a> enough.</p>
<p>But, what big O notation says and what happens in practice can differ quite a lot.
Be sure to <strong><a class="internal" href="/fast-conway-cubes#conclusion">measure</a></strong>,
and be sure to think of limits –
sometimes, the <strong>n</strong> in <strong>O(n)</strong>
is or can be made <strong>small enough</strong>
you don't have to do the theoretically correct thing.</p>
<p>You don't need to know how to implement all the data structures,
that's what (software) libraries and Wikipedia are for
(and for that matter, book libraries too).
However, it is useful to have an idea of
<strong>what's available and when to use it</strong>.</p>
<p><strong><a class="internal" href="/output#good-libraries-educate">Good libraries educate</a></strong> –
the Python standard library docs
already cover a lot of the practical knowledge we needed,
and so did Sorted Containers.
But, that won't show up in the API reference you see in your IDE,
you have read the actual documentation.</p>
<p><strong>Learned something new today?</strong> Share this with others, it really helps! <span class="text-large">
<span class="share-icons">
<a
    class="share-icon pycoders color"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news color"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/lru-cache&t=This%20is%20not%20interview%20advice%3A%20building%20a%20priority-expiry%20LRU%20cache%20without%20heaps%20or%20trees%20in%20Python"
>HN</a>
<a
    class="share-icon reddit color"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/lru-cache&title=This%20is%20not%20interview%20advice%3A%20building%20a%20priority-expiry%20LRU%20cache%20without%20heaps%20or%20trees%20in%20Python"
>Reddit</a>
<a
    class="share-icon linkedin color"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/lru-cache"
>linkedin</a>
<a
    class="share-icon twitter color"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=This%20is%20not%20interview%20advice%3A%20building%20a%20priority-expiry%20LRU%20cache%20without%20heaps%20or%20trees%20in%20Python&url=https%3A//death.andgravity.com/lru-cache&via=_andgravity"
>Twitter</a>
</span>
</span></p>

<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661&SIGNUP=lru-cache"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"
>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">

        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>
<!--

# Bonus: this is not production code

# Bonus: is bisect really O(log n) for <10k elements?

-->
<section class="footnotes">
<ol>
<li id="fn-1"><p>Note the subtitle: <em>if you're not sure what to do yet</em>. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p>This early on, the name doesn't really matter,
but we'll go with the correct, descriptive one;
in the first draft of the code, it was called MagicDS. ✨ <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-3"><p>You have to admit this is at least a bit weird;
what you're looking at is an object in a trench coat,
at least if you think <a class="external" href="https://web.archive.org/web/20170512101417/http://wiki.c2.com/?ClosuresAndObjectsAreEquivalent">closures and objects are equivalent</a>. <a href="#fnref-3" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-4"><p>Another way of getting an &quot;object&quot; on the cheap. <a href="#fnref-4" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-5"><p>If we assume a relatively small number of buckets
that will be reused soon enough,
this isn't strictly necessary.
I'm partly doing it to release the memory held by the dict,
since <a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictnotes.txt#L93-L100">dicts are resized only when items are added</a>. <a href="#fnref-5" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-6"><p>There's even a <a class="external" href="https://www.youtube.com/watch?v=7z2Ki44Vs4E&amp;t=922s">PyCon talk</a>
with the same explanation, if you prefer that. <a href="#fnref-6" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-7"><p><a class="external" href="https://docs.python.org/3/library/bisect.html">bisect</a> itself has
<a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/bisect.py#L110-L114">a fast C implementation</a>,
so I guess <em>technically</em> it's not pure Python.
But given that stdlib is already there, does that count? <a href="#fnref-7" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-8"><p><a class="external" href="https://peps.python.org/pep-0020/">If the implementation is easy to explain, it may be a good idea.</a> <a href="#fnref-8" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-9"><p>This limits priorities to values that can be negated,
so tuples won't work anymore.
We could use a <a class="external" href="https://stackoverflow.com/a/24414594">&quot;reversed view&quot; wrapper</a>
if we really cared about that. <a href="#fnref-9" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>