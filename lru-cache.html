












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>Python stdlib only priority-expiry LRU cache - death and gravity</title>



<meta property="og:title" content="Python stdlib only priority-expiry LRU cache">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/lru-cache">




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Python stdlib only priority-expiry LRU cache</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2023-10-10">October 2023</span>
∙ 23 minute read
∙
</small><span class="share-icons">
<a
    class="share-icon pycoders"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/lru-cache&t=Python%20stdlib%20only%20priority-expiry%20LRU%20cache"
>HN</a>
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/lru-cache&title=Python%20stdlib%20only%20priority-expiry%20LRU%20cache"
>Reddit</a>
<a
    class="share-icon linkedin"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/lru-cache"
>linkedin</a>
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Python%20stdlib%20only%20priority-expiry%20LRU%20cache&url=https%3A//death.andgravity.com/lru-cache&via=_andgravity"
>Twitter</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p><em>It's not your fault I got nerdsniped,
but that doesn't matter.</em></p>
<p>Hi, I'm Adrian, and today we're implementing a
least recently used cache with priorities and expiry,
using <strong>only the Python standard library</strong>.</p>
<p>This is a common problem in bIG TEch CoDINg InTerVIEWS,
so we'll keep away from the correct™ data structures –
this means <!-- **no heaps**, --> <strong>no binary search trees</strong>.
But we'll end up with a decent solution anyway.</p>
<section class="toc">
<ul>
<li><a href="#intro-requirements-api-etc">intro, requirements, api etc.</a></li>
<li><a href="#basic">basic</a>
<ul>
<li><a href="#setup">setup</a></li>
<li><a href="#set">set</a></li>
<li><a href="#evict">evict</a></li>
<li><a href="#get">get</a></li>
<li><a href="#test">test</a></li>
</ul>
</li>
<li><a href="#expires">expires</a>
<ul>
<li><a href="#set-1">set</a></li>
<li><a href="#evict-1">evict</a></li>
<li><a href="#priority-queue">priority queue</a></li>
<li><a href="#more-tests">more tests</a></li>
</ul>
</li>
<li><a href="#priorities">priorities</a>
<ul>
<li><a href="#tests">tests</a></li>
<li><a href="#quality-of-life-refactoring">quality of life refactoring</a></li>
</ul>
</li>
<li><a href="#least-recently-used">least recently used</a>
<ul>
<li><a href="#functools-lru-cache">functools.lru_cache</a></li>
<li><a href="#collections-ordereddict">collections.OrderedDict</a></li>
<li><a href="#init">init</a></li>
<li><a href="#set-2">set</a></li>
<li><a href="#evict-2">evict</a></li>
<li><a href="#delete">delete</a></li>
<li><a href="#tests-1">tests</a></li>
<li><a href="#get-1">get</a></li>
</ul>
</li>
<li><a href="#make-it-fast">make it fast</a>
<ul>
<li><a href="#heapq">heapq</a></li>
<li><a href="#bisect">bisect</a></li>
<li><a href="#self-balancing-binary-trees">self-balancing binary trees</a></li>
<li><a href="#sorted-containers">Sorted Containers</a></li>
</ul>
</li>
<li><a href="#making-it-stdlib-only">making it stdlib only</a>
<ul>
<li><a href="#expires-buckets">expires buckets</a></li>
</ul>
</li>
</ul>
</section>
<h2 id="intro-requirements-api-etc">intro, requirements, api etc.<span class="headerlink"> <a href="#intro-requirements-api-etc" title="permalink">#</a></span></h2>
<p>todo, see notes</p>
<h2 id="basic">basic<span class="headerlink"> <a href="#basic" title="permalink">#</a></span></h2>
<ul>
<li>basic cache, no eviction, no priorities; cache holds objects directly; add test</li>
</ul>
<h3 id="setup">setup<span class="headerlink"> <a href="#setup" title="permalink">#</a></span></h3>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Cache</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">=</span> <span class="n">maxsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>

<ul>
<li>we inject the time, so we can change it during tests</li>
<li>we use monotonic time! time.time() returns wall clock, which can jump back and forth</li>
<li>first algorithmic choice: we use a <a class="external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a> / <a class="external" href="https://en.wikipedia.org/wiki/Hash_table">hash table</a>, which gives O(1) search/insert/delete<ul>
<li>note on theta</li>
<li>link to nedbat big o notation talk</li>
</ul>
</li>
</ul>
<h3 id="set">set<span class="headerlink"> <a href="#set" title="permalink">#</a></span></h3>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evict</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">maxage</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expires</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
</code></pre></div>

<p>more choices</p>
<ul>
<li>we evict items when there's no more room to add stuff, and no earlier<ul>
<li>specificaly, not in get() – we want it to be as fast as possible (optimize for cache hits)</li>
<li>other, more complicated strategies are possible (e.g. periodic eviction would minimize memory usage)</li>
</ul>
</li>
<li>if the key already is in the cache, we remove it and insert it again, instead of modifying things in-place<ul>
<li>this way, theres exactly one code path for adding elements (less code =&gt; fewer bugs)</li>
<li>will make thing a lot simpler later on when we have more than one data structure to keep track of</li>
</ul>
</li>
</ul>
<p>we store all the parameters associated with a key as a named tuple,
since we'll most likely need them later on</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">object</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">object</span>
    <span class="n">expires</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div>

<h3 id="evict">evict<span class="headerlink"> <a href="#evict" title="permalink">#</a></span></h3>
<p>we'll implement a dummy evict(), so we have something to write tests against</p>
<p>in a happy little coincidence,
<a class="external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>s preserve insertion order,
so when iterating over the cache,
the oldest key will be first</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">evict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">))</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</code></pre></div>

<h3 id="get">get<span class="headerlink"> <a href="#get" title="permalink">#</a></span></h3>
<p>finally, get() is trivial</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">item</span><span class="o">.</span><span class="n">expires</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>

<h3 id="test">test<span class="headerlink"> <a href="#test" title="permalink">#</a></span></h3>
<p>with everything in place, we can write a first test</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_basic</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>
</code></pre></div>

<p>even though there's no time-related logic yet,
we use a fake time callable, to keep things nice and predictable</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">FakeTime</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="n">now</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span>
</code></pre></div>

<h2 id="expires">expires<span class="headerlink"> <a href="#expires" title="permalink">#</a></span></h2>
<p>ok, most of the properties of our cache come from how and when stuff is evicted,
so let's start with that.
i'm sure there are smart people out there that can Think Really Hard™
for a bit and then just come up with a complete solution,
but I'm not one of them, so we'll do things one at a time.</p>
<p>an important observation is that before we even get to the least recently used part,
we have to kick out expired items (with the lowest expiry time),
and then those with the lowest priority.
so, we need a data structure that,
given a collection of elements,
can efficiently remove the smallest element.</p>
<p>turns out, there is an <a class="external" href="https://en.wikipedia.org/wiki/Abstract_data_type">abstract data type</a> that does this,
called a <a class="external" href="https://en.wikipedia.org/wiki/Priority_queue">priority queue</a>.<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>
for now,
let's honor its abstract nature,
and not bother with an implementation
– we'll just plug a yet to be defined priority queue class in,
and define it after we have a full inventory of the methods we need.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
</code></pre></div>

<h3 id="set-1">set<span class="headerlink"> <a href="#set-1" title="permalink">#</a></span></h3>
<p>First, adding things.
Since we need to get the <em>item</em> with the lowest expiry time,
we cannot store just the time itself,
we need a way to get back to the item.
An <code>(expires, key)</code> tuple will do just fine
– since tuples compare lexicographically,
it'll be just like comparing by <code>expires</code> alone,
but with <code>key</code> along for the ride.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div>

<p>Now, you may be tempted, as I was, to say
&quot;hey, <code>Item</code> already is a tuple,
if we make <code>expires</code> the first field,
we can just use that.
But let's be strong
and hold off on optimizations until we have and <em>understand</em> a complete solution
– <a class="external" href="https://wiki.c2.com/?MakeItWorkMakeItRightMakeItFast">make it work, make it right, make it fast</a>.</p>
<h3 id="evict-1">evict<span class="headerlink"> <a href="#evict-1" title="permalink">#</a></span></h3>
<p>Moving on to removing things.
If the item is already cached,
we also need to remove it from the expires queue,
so it can be added back with the new expiry time.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="k">del</span> <span class="n">item</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evict</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
</code></pre></div>

<p>And now, we can use the expiry time to actually evict things.
For this, we need two operations from our queue:
to peek at the item that will expire next,
so we can check if it's actually expired,
and if yes, to pop it from the queue.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">evict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">initial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">expires</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expires</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">==</span> <span class="n">initial_size</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</code></pre></div>

<p>If there are no expired items,
we still need to make room for at least one item;
this should be one with the lowest priority,
but we don't have that yet,
so until then
we just evict the item that will expire next a little early.</p>
<h3 id="priority-queue">priority queue<span class="headerlink"> <a href="#priority-queue" title="permalink">#</a></span></h3>
<p>ok, we need an implementation for the priority queue.
it doesn't need to be fast,
we'll think about that after we finish everything else;
for now, we'll just keep our elements in a plain list.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">PriorityQueue</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

<p>The easiest way to continually
get the smallest value from a list
is to keep the list sorted;
the downside is that push is now O(n log n) at best
(not sure we can say it's O(n) because the list is always sorted,
it kinda depends on the implementation, and doesn't really matter).</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</code></pre></div>

<p>This makes <code>peek()</code> and <code>pop()</code> trivial to write;
still, <code>pop()</code> is O(n),
because shifting all items left by one position is.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">rv</span>
</code></pre></div>

<p><code>remove()</code> is just as simple, and just as O(N),
because we need to find the item,
and then to shift the ones after it to cover the gap.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</code></pre></div>

<p>We didn't need <em>is_empty</em>,
but it's likely free in all implementations,
so let's throw it in there;
since it's a quasy-container,
we'll use <a class="external" href="https://docs.python.org/3/reference/datamodel.html#object.__bool__">__bool__()</a> for it,
so we can write stuff like <code>if pq: ...</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>

<p>OK, let's wrap this up with a quick test:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_priority_queue</span><span class="p">():</span>
    <span class="n">pq</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">pq</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">assert</span> <span class="n">pq</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">pq</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div>

<h3 id="more-tests">more tests<span class="headerlink"> <a href="#more-tests" title="permalink">#</a></span></h3>
<p>At this point, the original Cache test should pass again.
Let's add a few more to test expiry;
first, that expired items are evicted
(note how we're moving the time forward):</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_expires</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>
</code></pre></div>

<p>Second, that adding an exiting item changes its expire time:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_update_expires</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span>
</code></pre></div>

<h2 id="priorities">priorities<span class="headerlink"> <a href="#priorities" title="permalink">#</a></span></h2>
<p>ok, let's do priorities next.
once again, we need to kick out elements with the <em>lowest</em> priority;
we already know how to do that, right?</p>
<p>in <code>__init__()</code>, we also keep a priority queue of priorities:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
</code></pre></div>

<p>in <code>set()</code>, we also add new items to the priority priority queue:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div>

<p>and also remove already cached items:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="k">del</span> <span class="n">item</span>
</code></pre></div>

<p>in <code>evict()</code>, we also remove expired items from the priorities queue:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">expires</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expires</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div>

<p>and finally, if there are no expired items,
we remove one with the lowest priority:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">==</span> <span class="n">initial_size</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div>

<h3 id="tests">tests<span class="headerlink"> <a href="#tests" title="permalink">#</a></span></h3>
<p>At this point, the existing tests pass;
let's add a few more; one for eviction:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_priorities</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>
</code></pre></div>

<p>And one for updating the priority of existing items:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_update_priorities</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>
</code></pre></div>

<h3 id="quality-of-life-refactoring">quality of life refactoring<span class="headerlink"> <a href="#quality-of-life-refactoring" title="permalink">#</a></span></h3>
<p>I know I said we'll postpone performance work
to after we have a full implementation.</p>
<p>I have a different kind of optimization in mind – for readability.</p>
<p>We're now deleting things in three different places,
in slightly different ways,
being careful to keep the three data structures in sync.
Wouldn't it be nice to have all that logic in a single place?
This may seem a bit premature,
but through the magic of having written the entire code already,
I know this bit is going to change quite a lot.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">expires</span><span class="p">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div>

<p>Sure, it will be twice as slow during eviction,
but the complexity will stay the same –
the constant factor 2 in O(2n) gets removed, leaving us with O(n).
Once we settle on a reasonably efficient implementation,
we can go back to the unpacked version if needed (aren't tests nice?).</p>
<p>The logic for handling already-cached item gets reduced to:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>

<p>Likewise, the core of the eviction logic boils down to:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">expires</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expires</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">==</span> <span class="n">initial_size</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>

<p>Neat!</p>
<h2 id="least-recently-used">least recently used<span class="headerlink"> <a href="#least-recently-used" title="permalink">#</a></span></h2>
<p>Say we don't know how to implement a LRU cache.</p>
<p>We could google it.</p>
<p>Or, we could look at an existing implementation.</p>
<h3 id="functools-lru-cache">functools.lru_cache<span class="headerlink"> <a href="#functools-lru-cache" title="permalink">#</a></span></h3>
<p>The closest thing in the standard library I can think of is <a class="external" href="https://docs.python.org/3/library/functools.html#functools.lru_cache">functools.lru_cache</a>.</p>
<p>So, let's have a look.</p>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can read the code of most Python stdlib modules
 by following the <strong>Source code:</strong> link
 at the top of the documentation page.</p>
</section>
<p>We see that:</p>
<ul>
<li><a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/functools.py#L479-L523">lru_cache()</a> passes most of the work to <a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/functools.py#L525-L639">_lru_cache_wrapper()</a>.</li>
<li><a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/functools.py#L525-L639">_lru_cache_wrapper()</a> is ... weird. It sets up a bunch of variables,
which are then used (and updated) by nested functions;
what you're seeing here is an object in disguise,
because <a class="external" href="https://web.archive.org/web/20170512101417/http://wiki.c2.com/?ClosuresAndObjectsAreEquivalent">closures and objects are equivalent</a>.
But, let's not get distracted.</li>
<li><a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/functools.py#L525-L639">_lru_cache_wrapper()</a> sets up a <code>cache</code> dict,
and a doubly linked list,
where each node is a <code>[prev, next, key, value]</code> list
(another cheap way of defining an &quot;object&quot;).</li>
</ul>
<p>Indeed, the solution is a doubly linked list,
because it allows us to move recently used items to one end in O(1):
first, remove the node from its current position
and splice its neighbors together,
second, wedge it after the last element at the &quot;recently used&quot; end.</p>
<p>Of note is that unlike <a class="external" href="https://docs.python.org/3/library/functools.html#functools.lru_cache">lru_cache</a>,
we need not one linked list,
but one for each priority
(and we need to keep track of their ends).</p>
<p>But, before we turn our <code>Item</code> in a linked list node
by making it mutable and adding prev/next links,
let's look at another candidate.</p>
<h3 id="collections-ordereddict">collections.OrderedDict<span class="headerlink"> <a href="#collections-ordereddict" title="permalink">#</a></span></h3>
<p>If you search <a class="external" href="https://docs.python.org/3.12/search.html?q=LRU">for &quot;LRU&quot;</a> in the Python docs,
the second result points to <a class="external" href="https://docs.python.org/3/library/collections.html#ordereddict-objects">OrderedDict objects</a>.</p>
<blockquote>
<p>Some differences from <a class="external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a> still remain:
[...]
The <a class="external" href="https://docs.python.org/3/library/collections.html#collections.OrderedDict">OrderedDict</a> algorithm can handle frequent reordering operations better than dict.
[...] <strong>this makes it suitable for implementing various kinds of LRU caches</strong>.</p>
</blockquote>
<p>Specifically:</p>
<blockquote>
<p><a class="external" href="https://docs.python.org/3/library/collections.html#collections.OrderedDict">OrderedDict</a> has a <code>move_to_end()</code> method to efficiently reposition an element to an endpoint.</p>
</blockquote>
<p>Since regular <a class="external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>s preserve insertion order,
one can emulate that with <code>d[k] = d.pop(k)</code>,
and the docs say as much.
I wonder what makes <code>move_to_end()</code> efficient;
<a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/collections/__init__.py#L90">this comment</a> may shed some light:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">90</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="c1"># The internal self.__map dict maps keys to links in a doubly linked list.</span>
</code></pre></div></td></tr></table></div>
<p>Ha! Indeed, <code>move_to_end()</code> <a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/collections/__init__.py#L188-L211">does exactly what we described above</a>.
This is good news – it means we don't have to do it ourselves.</p>
<h3 id="init">init<span class="headerlink"> <a href="#init" title="permalink">#</a></span></h3>
<p>So, we need one OrderedDict (read: doubly linked list) for each priority,
but we still need to keep track of which priority is lowest:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
</code></pre></div>

<h3 id="set-2">set<span class="headerlink"> <a href="#set-2" title="permalink">#</a></span></h3>
<p>The part of <code>set()</code> having to do with priorities becomes a bit more complicated:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">priority_bucket</span><span class="p">:</span>
            <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
        <span class="n">priority_bucket</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<h3 id="evict-2">evict<span class="headerlink"> <a href="#evict-2" title="permalink">#</a></span></h3>
<p>The part of <code>evict()</code> that handles priorities needs to be updated as well,
to remove the element at the beginning of bucket with the lowest priority.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">==</span> <span class="n">initial_size</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">priority_bucket</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>

<h3 id="delete">delete<span class="headerlink"> <a href="#delete" title="permalink">#</a></span></h3>
<p>Deleting gets extra stuff too –
after we delete the key from the bucket,
we also clean up the bucket if it's empty.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">priority_bucket</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">priority_bucket</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
</code></pre></div>

<p>This isn't strictly needed,
I'm doing it to release the memory held by the dict,
since it seems <a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictnotes.txt#L93-L100">dicts are resized only when items are added, not removed</a>;
but, if it's likely a priority would be reused soon,
we could get away with doing nothing.</p>
<h3 id="tests-1">tests<span class="headerlink"> <a href="#tests-1" title="permalink">#</a></span></h3>
<p>At this point, existing tests should pass again,
and we can add a new (failing) one for the LRU part:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_lru</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>
</code></pre></div>

<h3 id="get-1">get<span class="headerlink"> <a href="#get-1" title="permalink">#</a></span></h3>
<p>... and with just one line at the end of <code>get()</code>,
we can get it to pass:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code>        <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">priority</span><span class="p">]</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>

<h2 id="make-it-fast">make it fast<span class="headerlink"> <a href="#make-it-fast" title="permalink">#</a></span></h2>
<p>Let's make a quick recap of the priority queue methods we need so far and why:</p>
<ul>
<li><code>push()</code> – to add items</li>
<li><code>peek()</code> – to check what items have the lowest expiry time or priority</li>
<li><code>remove()</code> – to delete items</li>
<li><code>pop()</code> – not used, but would be without <a class="anchor" href="#quality-of-life-refactoring">the <code>_delete()</code> refactoring</a></li>
</ul>
<p>There are two observations we can make on top of this.</p>
<p>First, the <a class="external" href="https://en.wikipedia.org/wiki/Priority_queue">priority queue</a> Wikipedia page does not mention any <code>remove()</code> operation.</p>
<p>Second, even if we unpack <code>_delete()</code>,
we'll only <code>pop()</code> an item from either the expiry <em>or</em> the priorities queue,
and still have to <code>remove()</code> it from the other.</p>
<p>Indeed, <strong>this is what makes the problem difficult</strong> –
we need to maintain not one, but <em>two</em> independent priority queues,
preventing us from using data structures commonly used to implement them.</p>
<h3 id="heapq">heapq<span class="headerlink"> <a href="#heapq" title="permalink">#</a></span></h3>
<p>if you search <a class="external" href="https://docs.python.org/3.12/search.html?q=priority+queue">for &quot;priority queue&quot;</a> in the Python docs,
you'll find <a class="external" href="https://docs.python.org/3/library/heapq.html">heapq</a>, which:</p>
<blockquote>
<p>[...] provides an implementation of the heap queue algorithm,
<strong>also known as the priority queue algorithm</strong>.</p>
</blockquote>
<!--

[Wikipedia][priority queue] mostly agrees:

> While priority queues are often implemented using [heaps][heap],
> they are conceptually distinct from heaps. [...]

-->
<p>ok, reading through the heapq documentation,
we find <em>extensive</em> <a class="external" href="https://docs.python.org/3/library/heapq.html#priority-queue-implementation-notes">notes on priority queues</a>
(<a class="internal" href="/output">good docs are nice like that</a>).
particularly interesting are
using <em>(priority, item)</em> tuples (we're already doing this!)
and <em>removing entries</em>:</p>
<blockquote>
<p>Removing the entry or changing its priority is more difficult
because it would break the heap structure invariants.
So, a possible solution is to mark the entry as removed
and add a new entry with the revised priority.</p>
</blockquote>
<p>This workaround is needed because while
<a class="external" href="https://stackoverflow.com/questions/10162679/python-delete-element-from-heap/10163422#10163422">removing the i-th element can be done in O(log n)</a>,
finding the index of the element is O(n).
To summarize, we have:</p>
<table class="table">
<thead>
<tr>
  <th></th>
  <th>naive (sort)</th>
  <th>heapq</th>
</tr>
</thead>
<tbody>
<tr>
  <td>push()</td>
  <td>O(n log n)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>peek()</td>
  <td>O(1)</td>
  <td>O(1)</td>
</tr>
<tr>
  <td>pop()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>remove()</td>
  <td>O(n)</td>
  <td>O(n)</td>
</tr>
</tbody>
</table>
<p>Nevertheless, with a few assumptions, the workaround could work:</p>
<ul>
<li>we can assume priorities are static,
so we never need to remove a bucket</li>
<li>marked-to-be-removed expiry times will eventually be
pop()-ed anyway when they expire;
we can assume expiry time doesn't change for a lot of items;
we can also assume most evictions are of expired items,
and not because of priority
(which causes removed entries to accumulate in the expiry queue)</li>
</ul>
<p>...but, that's maybe too many assumptions for my liking.</p>
<h3 id="bisect">bisect<span class="headerlink"> <a href="#bisect" title="permalink">#</a></span></h3>
<p>One way of finding an element in better than O(n) is <a class="external" href="https://docs.python.org/3/library/bisect.html">bisect</a>, which:</p>
<blockquote>
<p>[...] provides support for maintaining a list in sorted order
without having to sort the list after each insertion.</p>
</blockquote>
<p>This looks like it could provide an improvement
to our <a class="anchor" href="#priority-queue">naive implementation</a>;
however, reading further to <a class="external" href="https://docs.python.org/3/library/bisect.html#performance-notes">Performance Notes</a>,
we find that:</p>
<blockquote>
<p>The insort() functions are O(n) because the logarithmic search step
is dominated by the linear time insertion step.</p>
</blockquote>
<p>Now, that's still better than the naive solution.</p>
<p>While we're here, there's an unrelated improvement that applies to both.
With a sorted list, pop() is O(n) only because
we need to shift all elements after index 0 to cover the gap;
if the list was in <em>reverse</em> order,
we'd pop() <em>from the end</em>,
<a class="external" href="https://wiki.python.org/moin/TimeComplexity">which is O(1)</a>,
because there's no gap to cover. So:</p>
<table class="table">
<thead>
<tr>
  <th></th>
  <th>naive (sort)</th>
  <th>heapq</th>
  <th>bisect</th>
</tr>
</thead>
<tbody>
<tr>
  <td>push()</td>
  <td>O(n log n)</td>
  <td>O(log n)</td>
  <td>O(log n) + <strong>O(n)</strong></td>
</tr>
<tr>
  <td>peek()</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(1)</td>
</tr>
<tr>
  <td>pop()</td>
  <td>O(1)</td>
  <td>O(log n)</td>
  <td>O(1)</td>
</tr>
<tr>
  <td>remove()</td>
  <td>O(n)</td>
  <td>O(n)</td>
  <td>O(log n) + <strong>O(n)</strong></td>
</tr>
</tbody>
</table>
<p>Further down in the docs, there's a <em>see also</em> box:</p>
<blockquote>
<p><a class="external" href="https://grantjenks.com/docs/sortedcollections/">Sorted Collections</a> is a high performance module
that uses <em>bisect</em> to managed sorted collections of data.</p>
</blockquote>
<p>Not in stdlib, moving along... ¯\_(ツ)_/¯</p>
<h3 id="self-balancing-binary-trees">self-balancing binary trees<span class="headerlink"> <a href="#self-balancing-binary-trees" title="permalink">#</a></span></h3>
<p>OK, I kinda ran out of ideas,
the <a class="external" href="https://docs.python.org/3/library/datatypes.html">Data Types</a> section of the docs
doesn't seem to have anything else that may help.</p>
<p>We have two options.
We could try to find some data structure
that keeps some elements in sorted order
that can do better than <a class="anchor" href="#bisect">bisect</a>.
Or, we could cheat and
continue reading the Wikipedia <a class="external" href="https://en.wikipedia.org/wiki/Priority_queue">priority queue</a> page.
Both paths end up in the same place.</p>
<p>Skipping past the <a class="external" href="https://en.wikipedia.org/wiki/Priority_queue#Naive_implementations">naive implementations</a>,
to the <a class="external" href="https://en.wikipedia.org/wiki/Priority_queue#Usual_implementation">usual implementation</a>, we find that:</p>
<blockquote>
<p>To improve performance, priority queues are typically based on a <a class="external" href="https://en.wikipedia.org/wiki/Heap_(data_structure)">heap</a>, [...]</p>
</blockquote>
<p>Already looked into that, doesn't work for us. Next:</p>
<blockquote>
<p>Alternatively, when a <a class="external" href="https://en.wikipedia.org/wiki/Self-balancing_binary_search_tree">self-balancing binary search tree</a> is used,
insertion and removal also take O(log n) time [...]</p>
</blockquote>
<p>There, that's what we were looking for!
(In case you're actually preparing for an interview,
this is likely also what your interviewer is looking for.)</p>
<table class="table">
<thead>
<tr>
  <th></th>
  <th>naive (sort)</th>
  <th>heapq</th>
  <th>bisect</th>
  <th>self-balancing BST</th>
</tr>
</thead>
<tbody>
<tr>
  <td>push()</td>
  <td>O(n log n)</td>
  <td>O(log n)</td>
  <td>O(log n) + <strong>O(n)</strong></td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>peek()</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>pop()</td>
  <td>O(1)</td>
  <td>O(log n)</td>
  <td>O(1)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>remove()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(log n) + <strong>O(n)</strong></td>
  <td>O(log n)</td>
</tr>
</tbody>
</table>
<p>OK, but there's no self-balancing BST implementation in the stdlib,
and I sure as hell am not implementing one right now,
I still have flashbacks from when I tried to do a red-black tree
and two hours later it still had bugs
(I mean, <a class="external" href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree#Operations">just look at how long this explanation is!</a>).</p>
<!-- TODO and there's other, more complicated data structures that mix trees with something else -->
<p>After some googling we find, among others, <a class="external" href="https://pypi.org/project/bintrees/">bintrees</a>,
which looks like a mature library with various sorts of binary trees
...except:</p>
<blockquote>
<p>Bintrees Development Stopped</p>
<p>Use <em>sortedcontainers</em> instead: <a class="external" href="https://pypi.python.org/pypi/sortedcontainers">https://pypi.python.org/pypi/sortedcontainers</a></p>
</blockquote>
<p>Sounds familiar, doesn't it?</p>
<h3 id="sorted-containers">Sorted Containers<span class="headerlink"> <a href="#sorted-containers" title="permalink">#</a></span></h3>
<p>Let's go back to that <a class="external" href="https://grantjenks.com/docs/sortedcollections/">Sorted Collections</a> library <a class="external" href="https://docs.python.org/3/library/bisect.html">bisect</a> was recommending:</p>
<blockquote>
<p>Depends on the <a class="external" href="https://grantjenks.com/docs/sortedcontainers/">Sorted Containers</a> module.</p>
</blockquote>
<p>(￢‿￢ )</p>
<p>Oh, I remember, I remember now...</p>
<p>I'm not salty because the red-black tree took two hours to implement.</p>
<p>I'm salty because after spending all that time,
I find that <a class="external" href="https://grantjenks.com/docs/sortedcontainers/">Sorted Containers</a>,
a pure Python library,<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup>
is <em>faster</em> in practice than
fancy self-balancing binary search trees implemented in C!</p>
<p>It has <a class="external" href="https://grantjenks.com/docs/sortedcontainers/performance.html">extensive benchmarks</a> to prove it,
and simulated workload benchmarks for our own use case,
<a class="external" href="https://grantjenks.com/docs/sortedcontainers/performance-workload.html#priority-queue">priority queues</a>
– so yeah, while the interview answer is &quot;self-balancing BSTs&quot;,
the <em>actual</em> answer is <a class="external" href="https://grantjenks.com/docs/sortedcontainers/">Sorted Containers</a>.</p>
<hr />
<p>So, how does it work?</p>
<p>Well, there's an <a class="external" href="https://grantjenks.com/docs/sortedcontainers/implementation.html">extensive explanation</a> too
(<a class="internal" href="/output#good-libraries-educate">good libraries educate</a>);</p>
<blockquote>
<p>The <a class="external" href="https://grantjenks.com/docs/sortedcontainers/">Sorted Containers</a> internal implementation is based on a couple observations. The first is that Python’s <em>list</em> is fast, <em>really fast</em>. [...] The second is that <em>bisect.insort</em> is fast. This is somewhat counter-intuitive since it involves shifting a series of items in a list. But modern processors do this really well. A lot of time has been spent optimizing mem-copy/mem-move-like operations both in hardware and software.</p>
<p>But using only one list and <em>bisect.insort</em> would produce sluggish behavior for lengths exceeding ten thousand. So the implementation of <a class="external" href="https://grantjenks.com/docs/sortedcontainers/sortedlist.html">Sorted List</a> uses a list of lists to store elements. [...]</p>
</blockquote>
<p>There's also a comparison with trees, which I'll summarize:
fewer memory allocations,
better cache locality,
lower memory overhead,
and faster iteration.</p>
<p>Of course, there are more details,
but I think that gives you a decent idea of how and why it works,
enough that with a bit of tinkering
you might be able to implement it yourself.<sup class="footnote-ref" id="fnref-3"><a href="#fn-3">3</a></sup></p>
<p>Are you sold? I know I am!</p>
<h2 id="making-it-stdlib-only">making it stdlib only<span class="headerlink"> <a href="#making-it-stdlib-only" title="permalink">#</a></span></h2>
<p>But <a class="external" href="https://grantjenks.com/docs/sortedcontainers/">Sorted Containers</a> is not in stdlib,
and we don't want to implement it ourselves.</p>
<p>We did learn something, though – let's update that table one last time:</p>
<table class="table">
<thead>
<tr>
  <th></th>
  <th>naive (sort)</th>
  <th>heapq</th>
  <th>bisect</th>
  <th>bisect &lt;10k</th>
  <th>BST</th>
</tr>
</thead>
<tbody>
<tr>
  <td>push()</td>
  <td>O(n log n)</td>
  <td>O(log n)</td>
  <td>O(log n) + <strong>O(n)</strong></td>
  <td>O(log n)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>peek()</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>pop()</td>
  <td>O(1)</td>
  <td>O(log n)</td>
  <td>O(1)</td>
  <td>O(1)</td>
  <td>O(log n)</td>
</tr>
<tr>
  <td>remove()</td>
  <td>O(n)</td>
  <td>O(log n)</td>
  <td>O(log n) + <strong>O(n)</strong></td>
  <td>O(log n)</td>
  <td>O(log n)</td>
</tr>
</tbody>
</table>
<p>We're back to making assumptions,
but this time we'll work hard to make them reasonable.</p>
<ol>
<li>Do we really need more than 10k priorities in practice?
 <strong>Likely no</strong>, let's just cap them at 10k.</li>
<li>Do we really need more than 10k expiry times in practice?
 <strong>Maybe</strong> –
 with a granularity of 1 second,
 we get a maximum time of 2.7 hours,
 which seems a bit short;
 with 10 seconds,
 we get 27 hours,
 which may just work.</li>
</ol>
<p>OK, one more leap and we're done.</p>
<p>The main thing we don't like about the 10k expiry times,
aside from the short maximum time,
is that the granularity is too low;
this is especially a problem for short times –
rounding 1 to 10 seconds is much worse than
rounding 2001 to 2010 seconds.</p>
<p>Which begs the question –
does it really matter if an item expires in 2010 seconds instead of 2001?
<strong>Likely no</strong>, we just need a scheme that rounds in a predictable way.</p>
<p>1, 2, 4, 8, ...?</p>
<p>This gives us buckets with high granularity in the beginning
that gets lower the further you get.</p>
<p>OK, this may work, but our time does not start at zero;
in fact, we're in 1.7 billion seconds from the Unix epoch territory.</p>
<p>However, we can kinda pretend it starts at zero
by rounding up the expiry time to multiples of 1, 2, 4, 8, ...
where the multiple is the next power of two bigger than the max_age.</p>
<p>First, we should get an intuition of how that works.</p>
<p>now = 2000</p>
<ul>
<li>max_age =  1 =&gt; ceil(2001 /  1) *  1 = 2001</li>
<li>max_age =  2 =&gt; ceil(2002 /  2) *  2 = 2002</li>
<li>max_age =  3 =&gt; ceil(2003 /  4) *  4 = 2004</li>
<li>max_age =  4 =&gt; ceil(2004 /  4) *  4 = 2004</li>
<li>max_age = 15 =&gt; ceil(2015 / 16) * 16 = 2016</li>
<li>max_age = 16 =&gt; ceil(2016 / 16) * 16 = 2016</li>
<li>max_age = 17 =&gt; ceil(2017 / 32) * 32 = 2048</li>
</ul>
<p>now = 2013</p>
<ul>
<li>max_age =  1 =&gt; ceil(2014 /  1) *  1 = 2014</li>
<li>max_age =  2 =&gt; ceil(2015 /  2) *  2 = 2016</li>
<li>max_age =  3 =&gt; ceil(2016 /  4) *  4 = 2016</li>
<li>max_age =  4 =&gt; ceil(2017 /  4) *  4 = 2020</li>
</ul>
<p>The beauty of using aligned powers is that
for a constant number of expiry times,
the number of buckets remains roughly constant as time goes on –
as expired buckets are removed from the beginning,
new ones are added inbetween the existing sparser ones.</p>
<p>OK, let's put it into code.</p>
<p>First, rounding up <code>max_age</code> to the next power of two –
which can be done by rounding the logarithm to the next integer:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">log_bucket</span><span class="p">(</span><span class="n">max_age</span><span class="p">):</span>
    <span class="n">next_power</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">max_age</span><span class="p">))</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">next_power</span>
    <span class="k">return</span> <span class="n">bucket</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">log_bucket</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">]]</span>
<span class="go">[1, 2, 4, 4, 16, 16, 32]</span>
</code></pre></div>
<p>Second, rounding up the expires time to the next one that's
divisible by the rounded <code>max_age</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">log_bucket</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">max_age</span><span class="p">):</span>
    <span class="n">next_power</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">max_age</span><span class="p">))</span>
    <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">max_age</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">expires</span> <span class="o">/</span> <span class="n">next_power</span><span class="p">)</span> <span class="o">*</span> <span class="n">next_power</span>
    <span class="k">return</span> <span class="n">bucket</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">]]</span>
<span class="go">[1, 2, 4, 4, 16, 16, 32]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">]]</span>
<span class="go">[2001, 2002, 2004, 2004, 2016, 2016, 2048]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
<span class="go">[2014, 2016, 2016, 2020]</span>
</code></pre></div>
<p>Looking good!</p>
<p>The worst error from rounding <code>max_age</code> to the next power of two
happens when <code>max_age</code> is one more than a power of two
(approaching 100% as <code>max_age</code> increases):</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="go">16</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>  <span class="c1"># (32 - 17) / 17 ~= 88%</span>
<span class="go">32</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">)</span>  <span class="c1"># (64 - 33) / 33 ~= 94%</span>
<span class="go">64</span>
</code></pre></div>
<p>But that's not the worst possible error –
that's when the expiry time is one more than a multiple of that power of two,
thus adding another almost 100% to the error.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<span class="go">32</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>  <span class="c1"># (64 - 16 - 17) / 17 ~= 182%</span>
<span class="go">64</span>
</code></pre></div>
<p>200% error is quite a lot,
but before we set to fix it,
let's confirm our reasoning is correct.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">max_age</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">log_bucket</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">max_age</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">bucket</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_age</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">max_error</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">max_error_random</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">max_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">max_max_age</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">31</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span>
        <span class="n">error</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="n">max_now</span><span class="p">),</span> <span class="n">rand</span><span class="p">(</span><span class="n">max_max_age</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">max_error</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">)</span>
<span class="go">0.9997558891736849</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">max_error</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">)</span>
<span class="go">1.9527896995708156</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">max_error_random</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">)</span>
<span class="go">1.9995498725910554</span>
</code></pre></div>
<p>Looks confirmed enough to me.</p>
<p>So, how do we make the error smaller?</p>
<p>Instead of rounding to the next power of two,
we could round to the next half of a power of two,
or a quarter, or an eighth...</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">log_bucket</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">max_age</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">next_power</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">max_age</span><span class="p">)</span> <span class="o">-</span> <span class="n">shift</span><span class="p">))</span>
    <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">max_age</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">expires</span> <span class="o">/</span> <span class="n">next_power</span><span class="p">)</span> <span class="o">*</span> <span class="n">next_power</span>
    <span class="k">return</span> <span class="n">bucket</span>
</code></pre></div>
<p>It seems to be working:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">([</span><span class="n">log_bucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">]])</span>
<span class="gp">...</span>
<span class="go">[1, 2, 4, 4, 16, 16, 32]</span>
<span class="go">[1, 2, 4, 4, 16, 16, 32]</span>
<span class="go">[1, 2, 3, 4, 16, 16, 24]</span>
<span class="go">[1, 2, 3, 4, 16, 16, 20]</span>
<span class="go">[1, 2, 3, 4, 15, 16, 18]</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">e</span> <span class="o">=</span> <span class="n">max_error_random</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">e</span><span class="si">:</span><span class="s1">6.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">0 199.8%</span>
<span class="go">1  99.9%</span>
<span class="go">2  50.0%</span>
<span class="go">3  25.0%</span>
<span class="go">4  12.5%</span>
<span class="go">5   6.2%</span>
<span class="go">6   3.1%</span>
<span class="go">7   1.6%</span>
<span class="go">8   0.8%</span>
<span class="go">9   0.4%</span>
</code></pre></div>
<p>So, with <code>shift=7</code>, the error is less that two percent!</p>
<p>I wonder how many buckets that uses...</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">max_buckets</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">buckets</span> <span class="o">=</span> <span class="p">{</span><span class="n">log_bucket</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)}</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">max_buckets</span><span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="go">730</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">max_buckets</span><span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="go">1046</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">max_buckets</span><span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="go">1280</span>
</code></pre></div>
<p>So, that's 1.3k buckets for a whole year, way below 10k!</p>
<h3 id="expires-buckets">expires buckets<span class="headerlink"> <a href="#expires-buckets" title="permalink">#</a></span></h3>
<p>TODO</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">bisect</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>


<span class="k">class</span> <span class="nc">Cache</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">=</span> <span class="n">maxsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expires_order</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">item</span><span class="o">.</span><span class="n">expires</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">priority</span><span class="p">]</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evict</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="n">expires</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">maxage</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expires</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="n">expires_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expires_bucket</span><span class="p">:</span>
            <span class="n">expires_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="p">[</span><span class="n">expires</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires_order</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>
        <span class="n">expires_bucket</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">priority_bucket</span><span class="p">:</span>
            <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
        <span class="n">priority_bucket</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">evict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">initial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_order</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expires</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">expires_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="p">[</span><span class="n">expires</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="p">[</span><span class="n">expires</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">==</span> <span class="n">initial_size</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">priority_bucket</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">expires</span><span class="p">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">expires_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="p">[</span><span class="n">expires</span><span class="p">]</span>
        <span class="n">expires_bucket</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expires_bucket</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires_buckets</span><span class="p">[</span><span class="n">expires</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>

        <span class="n">priority_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">priority_bucket</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">priority_bucket</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_buckets</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">object</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">object</span>
    <span class="n">expires</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span> <span class="nc">PriorityQueue</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">class</span> <span class="nc">FakeTime</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="n">now</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span>


<span class="k">def</span> <span class="nf">test_basic</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>


<span class="k">def</span> <span class="nf">test_expires</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>


<span class="k">def</span> <span class="nf">test_update_expires</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span>


<span class="k">def</span> <span class="nf">test_priorities</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>


<span class="k">def</span> <span class="nf">test_update_priorities</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>


<span class="k">def</span> <span class="nf">test_lru</span><span class="p">():</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">FakeTime</span><span class="p">())</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span>


<span class="k">def</span> <span class="nf">test_priority_queue</span><span class="p">():</span>
    <span class="n">pq</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">pq</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">assert</span> <span class="n">pq</span>
    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">pq</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">pq</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div>

<!--     :lines: 201-212 -->
<!--     :linenos: no -->
<section class="footnotes">
<ol>
<li id="fn-1"><p>This early on, the name doesn't really matter,
but we'll go with the correct, descriptive one;
in my first draft of the code, it was called MagicDS ✨ <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p><a class="external" href="https://docs.python.org/3/library/bisect.html">bisect</a> itself has
<a class="external" href="https://github.com/python/cpython/blob/v3.12.0/Lib/bisect.py#L110-L114">a fast C implementation</a>,
so I guess <em>technically</em> it's not pure Python.
But given that stdlib is already there, does that count? <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-3"><p><a class="external" href="https://peps.python.org/pep-0020/">If the implementation is easy to explain, it may be a good idea.</a> <a href="#fnref-3" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>