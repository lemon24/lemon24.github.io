






<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>--output: clean architecture in Python, paying attention, and why you should read the docs - death and gravity</title>



<meta property="og:title" content="--output: clean architecture in Python, paying attention, and why you should read the docs">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/output">




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">--output: clean architecture in Python, paying attention, and why you should read the docs</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2023-03-23">March 2023</span>
∙ six minute read
∙
</small><span class="share-icons">
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=--output%3A%20clean%20architecture%20in%20Python%2C%20paying%20attention%2C%20and%20why%20you%20should%20read%20the%20docs&url=https%3A//death.andgravity.com/output&via=_andgravity"
>Twitter</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/output&t=--output%3A%20clean%20architecture%20in%20Python%2C%20paying%20attention%2C%20and%20why%20you%20should%20read%20the%20docs"
>HN</a>
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/output&title=--output%3A%20clean%20architecture%20in%20Python%2C%20paying%20attention%2C%20and%20why%20you%20should%20read%20the%20docs"
>Reddit</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>Do you feel like you're fighting your tools?</p>
<p>Or maybe not, but things are harder than they should be.</p>
<p>Do you feel you're <strong>relying too much on autocomplete</strong> and inline documentation?
...half-knowing, half-guessing at how you're using libraries?</p>
<!-- should this say "advanced beginners"? -->
<p>I've repeatedly seen junior developers struggle with this,
and not even fully aware they're struggling in the first place.
But as always, there must be a better way.</p>
<p>This is a story about:</p>
<ul>
<li>clean architecture in Python</li>
<li>paying attention to everyday things</li>
<li>command-line interfaces</li>
<li>finding the right way to do something</li>
<li>why you should still read the docs</li>
</ul>
<p>tl;dr:</p>
<ul>
<li>watch Brandon Rhodes' talk <a href="https://rhodesmill.org/brandon/talks/#clean-architecture-python">The Clean Architecture in Python</a></li>
<li>if you're building a CLI, check out <a href="https://clig.dev/">Command Line Interface Guidelines</a></li>
<li><strong>most <em>good</em> documentation won't show up in your IDE</strong> –
rather, it is about <em>how</em> to use the library,
and the <em>problem</em> the library is solving</li>
</ul>
<h2 id="setup">Setup<span class="headerlink"> <a href="#setup" title="permalink">#</a></span></h2>
<p>Say you're writing a CLI tool
that gets data from an API
and saves the results in a CSV file somewhere.
It might look something like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">click</span>

<span class="k">def</span> <span class="nf">get_data</span><span class="p">():</span>
    <span class="c1"># pretend some API calls happen here</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Chaos&quot;</span><span class="p">,</span> <span class="s2">&quot;short_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Chs&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Discord&quot;</span><span class="p">,</span> <span class="s2">&quot;short_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dsc&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Confusion&quot;</span><span class="p">,</span> <span class="s2">&quot;short_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Cfn&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bureaucracy&quot;</span><span class="p">,</span> <span class="s2">&quot;short_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bcy&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;The Aftermath&quot;</span><span class="p">,</span> <span class="s2">&quot;short_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Afm&quot;</span><span class="p">},</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">write_csv</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;calendar.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;short_name&#39;</span><span class="p">]])</span>

<span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the names of the Discordian seasons.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">()</span>
    <span class="n">write_csv</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>Here it is in action:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>seasons.py<span class="w"> </span>--help
<span class="go">Usage: seasons.py [OPTIONS]</span>

<span class="go">  Retrieve the names of the Discordian seasons to calendar.csv.</span>

<span class="go">Options:</span>
<span class="go">  --help  Show this message and exit.</span>
<span class="gp">$ </span>python<span class="w"> </span>seasons.py
<span class="gp">$ </span>cat<span class="w"> </span>calendar.csv
<span class="go">name,short_name</span>
<span class="go">Chaos,Chs</span>
<span class="go">Discord,Dsc</span>
<span class="go">Confusion,Cfn</span>
<span class="go">Bureaucracy,Bcy</span>
<span class="go">The Aftermath,Afm</span>
</code></pre></div>
<p>You're using <a href="https://click.palletsprojects.com/">Click</a>
because you've heard
it’s highly configurable but comes with sensible defaults out of the box.</p>
<p>There is some complexity with getting the data and generating the CSV file,
but you've hidden it neatly in <code>get_data()</code> and <code>write_csv()</code>.</p>
<p>Note we're passing the result of <code>get_data()</code> to <code>write_csv()</code>
instead of calling it from <code>write_csv()</code> for two reasons:</p>
<ul>
<li>so we don't have to pass any potential <code>get_data()</code> arguments through</li>
<li>so we can test <code>write_csv()</code> without having to monkeypatch <code>get_data()</code></li>
</ul>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">seasons</span>

<span class="n">DATA</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;short_name&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;short_name&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">},</span>
<span class="p">]</span>
<span class="n">CSV_BYTES</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;name,short_name</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="sa">b</span><span class="s2">&quot;one,1</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="sa">b</span><span class="s2">&quot;two,2</span><span class="se">\r\n</span><span class="s2">&quot;</span>

<span class="k">def</span> <span class="nf">test_write_csv</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
    <span class="n">seasons</span><span class="o">.</span><span class="n">write_csv</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">tmp_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;calendar.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span> <span class="o">==</span> <span class="n">CSV_BYTES</span>
</code></pre></div>

<p>In other words, instead of <em>hiding</em> I/O,
we're <em>decoupling</em> it by moving it outside.</p>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For a more fleshed out example of this,
 along with a discussion of how it affects testing,
 and some historical background,
 check out Brandon Rhodes' great talk
 <a href="https://rhodesmill.org/brandon/talks/#clean-architecture-python">The Clean Architecture in Python</a>.</p>
</section>
<!--

# Too much monkey patching

Hmm... that's a bit involved.

Think about it – get_data() is *hidden* away,
but is still *coupled* to the things around it;
when get_data() needs a new argument:

* write_csv() will need to pass the argument through,
  even though it only cares about get_data()'s output
* we'll have to update the test to check the argument is passed around

.. literalinclude:: 10-data/seasons.py
    :lines: 23-27
    :linenos: no

.. literalinclude:: 10-data/seasons.py
    :lines: 16-17
    :linenos: no

The test is already simpler now:

.. literalinclude:: 10-data/test_seasons.py
    :lines: 9-
    :linenos: no

-->
<h2 id="i-want-to-use-a-different-file">I want to use a different file<span class="headerlink"> <a href="#i-want-to-use-a-different-file" title="permalink">#</a></span></h2>
<p>OK, but forcing people to be in the right directory is a bit unfriendly;
also, what if they want to run it twice,
and save the output in different files
(one could easily imagine a --short option that only shows the short name)?</p>
<p>The obvious solution is to pass in the name of the file,
instead of hardcoding it:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--path&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the names of the Discordian seasons.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">()</span>
    <span class="n">write_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</code></pre></div>

<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">write_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</code></pre></div>

<p>Looks like we're on the right track here,
the test is shorter,
and we don't need to monkeypatch the current working directory
anymore:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_write_csv</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">tmp_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;out.csv&#39;</span><span class="p">)</span>
    <span class="n">seasons</span><span class="o">.</span><span class="n">write_csv</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">out_path</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">out_path</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span> <span class="o">==</span> <span class="n">CSV_BYTES</span>
</code></pre></div>

<h2 id="the-file-might-not-be-valid">The file might not be valid<span class="headerlink"> <a href="#the-file-might-not-be-valid" title="permalink">#</a></span></h2>
<p>What if we pass a directory instead?</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">time</span><span class="w"> </span>python<span class="w"> </span>seasons.py<span class="w"> </span>--path<span class="w"> </span>.
<span class="go">Traceback (most recent call last):</span>
<span class="go">  ...</span>
<span class="go">IsADirectoryError: [Errno 21] Is a directory: &#39;.&#39;</span>
<span class="go">python seasons.py --path .  0.07s user 0.02s system 4% cpu 2.104 total</span>
</code></pre></div>
<p>OK, it fails with a traceback.
But worse than that, we waited for the API calls to happen,
only to throw the output away, all due to a preventable error.</p>
<p>Thankfully, Click has fancy option types that can handle that, like <a href="https://click.palletsprojects.com/en/latest/api/#click.Path">Path</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">writable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</code></pre></div>

<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">time</span><span class="w"> </span>python<span class="w"> </span>seasons.py<span class="w"> </span>--path<span class="w"> </span>.
<span class="go">Usage: seasons.py [OPTIONS]</span>
<span class="go">Try &#39;seasons.py --help&#39; for help.</span>

<span class="go">Error: Invalid value for &#39;--path&#39;: File &#39;.&#39; is a directory.</span>
<span class="go">python seasons.py --path .  0.08s user 0.02s system 92% cpu 0.112 total</span>
</code></pre></div>
<p>Not only do we get a nice error message,
we get it instantly!</p>
<h2 id="standard-names">Standard names<span class="headerlink"> <a href="#standard-names" title="permalink">#</a></span></h2>
<p>Truth is, <code>--path</code> isn't really very descriptive.
I wonder if there are better names for it...</p>
<p>One thing I like to do is to look at what others are doing.</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>curl<span class="w"> </span>--help
<span class="go">Usage: curl [options...] &lt;url&gt;</span>
<span class="go"> -o, --output &lt;file&gt; Write to file instead of stdout</span>
<span class="go"> -O, --remote-name   Write output to a file named as the remote file</span>
<span class="go"> ...</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>wget<span class="w"> </span>--help
<span class="go">GNU Wget 1.21.2, a non-interactive network retriever.</span>
<span class="go">Usage: wget [OPTION]... [URL]...</span>
<span class="go">  -o,  --output-file=FILE          log messages to FILE</span>
<span class="go">  -O,  --output-document=FILE      write documents to FILE</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>sort<span class="w"> </span>--help
<span class="go">Usage: sort [OPTION]... [FILE]...</span>
<span class="go">  -o, --output=FILE         write result to FILE instead of standard output</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>pandoc<span class="w"> </span>--help
<span class="go">pandoc [OPTIONS] [FILES]</span>
<span class="go">  -o FILE               --output=FILE</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>tar<span class="w"> </span>--help
<span class="go">Usage: tar [OPTION...] [FILE]...</span>
<span class="go">  -f, --file=ARCHIVE         use archive file or device ARCHIVE</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>gcc<span class="w"> </span>--help
<span class="go">Usage: gcc [options] file...</span>
<span class="go">  -o &lt;file&gt;                Place the output into &lt;file&gt;.</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>rustc<span class="w"> </span>--help
<span class="go">Usage: rustc [OPTIONS] INPUT</span>
<span class="go">    -o FILENAME         Write output to &lt;filename&gt;</span>
<span class="go">        --out-dir DIR   Write output to compiler-chosen filename in &lt;dir&gt;</span>
</code></pre></div>
<p>Better yet, sometimes there's a comprehensive guide on a topic,
like <a href="https://clig.dev/">Command Line Interface Guidelines</a>
...and under <a href="https://clig.dev/#arguments-and-flags">Arguments and flags</a>,
we find this:</p>
<blockquote>
<p><strong>Use standard names for flags, if there is a standard.</strong> If another commonly used command uses a flag name, it’s best to follow that existing pattern. That way, a user doesn’t have to remember two different options (and which command it applies to), and users can even guess an option without having to look at the help text.</p>
<p>Here’s a list of commonly used options: [...]</p>
<ul>
<li><code>-o</code>, <code>--output</code>: Output file. For example, <code>sort</code>, <code>gcc</code>.</li>
</ul>
</blockquote>
<p>Hmm, this seems to match up with most of what we've seen above.</p>
<p>Further down below, there's another guideline:</p>
<blockquote>
<p><strong>If input or output is a file, support <code>-</code> to read from <code>stdin</code> or write to <code>stdout</code>.</strong> This lets the output of another command be the input of your command and vice versa, without using a temporary file. [...]</p>
</blockquote>
<p>I wonder how we could achieve that.</p>
<p>One way would be to check the value and if it's <code>-</code>, use <a href="https://docs.python.org/3/library/sys.html#sys.stdout">sys.stdout</a>.</p>
<p>But let's pause and look at the <a href="https://click.palletsprojects.com/en/latest/api/#click.Path">Path</a> docs a bit:</p>
<blockquote>
<ul>
<li>allow_dash (bool) – Allow a single dash as a value, which indicates a standard stream (but does not open it). Use <a href="https://click.palletsprojects.com/en/latest/api/#click.open_file">open_file()</a> to handle opening this value.</li>
</ul>
</blockquote>
<p>Following along, <a href="https://click.palletsprojects.com/en/latest/api/#click.open_file">open_file()</a> says:</p>
<blockquote>
<p>Open a file, with extra behavior to handle <code>'-'</code> to indicate a standard stream, lazy open on write, and atomic write. Similar to the behavior of the <a href="https://click.palletsprojects.com/en/latest/api/#click.File">File</a> param type.</p>
</blockquote>
<p>What's this File, eh?</p>
<blockquote>
<p>Declares a parameter to be a file for reading or writing. [...] The special value <code>-</code> indicates stdin or stdout depending on the mode. [...]</p>
<p>See <a href="https://click.palletsprojects.com/en/latest/arguments/#file-args">File Arguments</a> for more information.</p>
</blockquote>
<p>Which finally takes us away from the API reference to the actual <em>documentation</em>:<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup></p>
<blockquote>
<p>Since all the examples have already worked with filenames, it makes sense to explain how to deal with files properly. Command line tools are more fun if they work with files the Unix way, which is to accept <code>-</code> as a special file that refers to stdin/stdout.</p>
</blockquote>
<p>OK, OK, I get it, let's use it:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">atomic</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the names of the Discordian seasons.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">()</span>
    <span class="n">output</span><span class="o">.</span><span class="n">reconfigure</span><span class="p">(</span><span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">write_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</code></pre></div>

<p>Alas, File doesn't take a <code>newline</code> argument like <a href="https://docs.python.org/3/library/functions.html#open">open()</a> does,<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup>
but high-level text files do have a <a href="https://docs.python.org/3/library/io.html#io.TextIOWrapper.reconfigure">reconfigure()</a> method
which allows changing it on the fly.</p>
<p>With passing a file object to <code>write_csv()</code>,
the output in I/O is finally also decoupled:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">write_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;short_name&#39;</span><span class="p">]])</span>
</code></pre></div>

<p>Interestingly enough, <a href="https://docs.python.org/3/library/csv.html#csv.writer">csv.writer</a> already takes an open file
...was this a hint to do the same thing from the start?</p>
<p>Once again, the test gets simpler too –
instead of writing anything to disk,
we can use an <a href="https://docs.python.org/3/library/io.html#io.BytesIO">in-memory stream</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_write_csv</span><span class="p">():</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">seasons</span><span class="o">.</span><span class="n">write_csv</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">file</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">==</span> <span class="n">CSV_BYTES</span>
</code></pre></div>

<h2 id="standard-output">Standard output<span class="headerlink"> <a href="#standard-output" title="permalink">#</a></span></h2>
<p>&quot;instead of stdout&quot;</p>
<p>TODO: example: we already go this</p>
<p>The Basics
https://clig.dev/#the-basics</p>
<blockquote>
<p><strong>Send output to <code>stdout</code>.</strong> The primary output for your command should go to <code>stdout</code>. Anything that is machine readable should also go to <code>stdout</code>—this is where piping sends things by default.</p>
</blockquote>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">atomic</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</code></pre></div>

<section class="footnotes">
<ol>
<li id="fn-1"><p>Is it not written, &quot;A few hours of trial and error can save you five minutes of reading the docs&quot;? <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p><code>newline=''</code> is required <a href="https://docs.python.org/3/library/csv.html#id3">because of CSV reasons</a>. <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>