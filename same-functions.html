












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>When to use classes in Python? When you repeat similar sets of functions - death and gravity</title>
<meta name="description" content="TODO" />


<meta property="og:title" content="When to use classes in Python? When you repeat similar sets of functions">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/same-functions">
<meta property="og:description" content="TODO">



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">When to use classes in Python? When you repeat similar sets of functions</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2023-08-24">August 2023</span>
∙ eight minute read
∙
</small><span class="share-icons">
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=When%20to%20use%20classes%20in%20Python%3F%20When%20you%20repeat%20similar%20sets%20of%20functions&url=https%3A//death.andgravity.com/same-functions&via=_andgravity"
>Twitter</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/same-functions&t=When%20to%20use%20classes%20in%20Python%3F%20When%20you%20repeat%20similar%20sets%20of%20functions"
>HN</a>
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/same-functions&title=When%20to%20use%20classes%20in%20Python%3F%20When%20you%20repeat%20similar%20sets%20of%20functions"
>Reddit</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>Are you having trouble figuring out when to use classes or how to organize them?</p>
<p>Have you repeatedly searched for &quot;when to use classes in Python&quot;,
read all the articles and watched all the talks,
and <em>still</em>  don't know whether you should be using classes in any given situation?</p>
<p>Have you read discussions about it that for all you know <em>may be right</em>,
but they're <em>so academic</em> you can't parse the jargon?</p>
<p>Have you read articles that all treat the &quot;obvious&quot; cases,
leaving you with no clear answer when you try to apply them to your own code?</p>
<hr />
<p>My experience is that, <strong>unfortunately</strong>,
the best way to learn this <em>is</em> to <a href="/stdlib">look at lots of examples</a>.</p>
<p>Most guidelines tend to either be too vague <em>if you don't already know enough</em> about the subject,
or too specific and saying things you already know.</p>
<p>This is one of those things that once you get it seems obvious and intuitive,
<em>but it's not</em>, and is quite difficult to explain properly.</p>
<hr />
<p>So, instead of prescribing a general approach,
let's look at:</p>
<ul>
<li><strong>one specific case</strong> where you may want to use classes</li>
<li><strong>examples from real-world code</strong></li>
<li>some considerations you should keep in mind</li>
</ul>
<h2 id="the-heuristic">The heuristic<span class="headerlink"> <a href="#the-heuristic" title="permalink">#</a></span></h2>
<p><strong>If you repeat similar sets of functions, consider grouping them in a class.</strong></p>
<p>That's it.</p>
<p>In its most basic form,
a class is when you group data with functions that operate on that data;
sometimes, there is no data,
but it can still be useful to group the functions
into an <em>abstract object</em> that exists only
to make things easier to use / understand.</p>
<p>Depending on whether you choose which class to use at runtime,
this is sometimes called the <a href="https://en.wikipedia.org/wiki/Strategy_pattern">strategy pattern</a>.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>As Wikipedia <a href="https://simple.wikipedia.org/wiki/Heuristic">puts it</a>,
 &quot;A <strong>heuristic</strong> is a practical way to solve a problem.
 It is <em>better than chance</em>, but <em>does not always work</em>.
 A person develops a heuristic by using
 intelligence, experience, and common sense.&quot;</p>
<p>So, this is <strong>not</strong> the correct thing to do <strong>all the time</strong>,
 or even <em>most</em> of the time.</p>
<p>Instead, I hope that this and <em>other</em> heuristics
 can help <strong>build the right intuition</strong>
 for people on their way from
 &quot;I know the class syntax, now what?&quot; to
 &quot;proper&quot; object-oriented design.</p>
</section>
<h2 id="example-retrievers">Example: Retrievers<span class="headerlink"> <a href="#example-retrievers" title="permalink">#</a></span></h2>
<p>my feed reader library retrieves, parses and stores web feeds</p>
<p>feeds can come from multiple places;
most commonly, either download them from the internet, or read them from a local file</p>
<p>after being retrieved from either location,
they're passed along as an open file to the parser
that converts it to data structures corresponding to articles etc.</p>
<p>if supported by the server, reader will only retrieve a feed if it changed,
by storing the ETag header when it gets a response,
and then making a conditional request by passing it back as the If-None-Match on the second request;
the server has the option to respond with 304 Not Modified instead of sending the full content</p>
<p>we'll have a look at how this bit of code evolved in reader in response to new requirements
(it is a simplified version, but still does something useful and was not simplified where it matters)</p>
<p>the initial code looked something like this –
a retrieve function that takes the url to retrieve and an optional etag header from a previous request,
and returns the corresponding resource as an open file,
and a new value for the etag header to be stored</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="s1">&#39;https://&#39;</span><span class="p">)):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">etag</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;If-None-Match&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etag</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">304</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">etag</span>
        <span class="n">etag</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ETag&#39;</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode_content</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">etag</span>

    <span class="c1"># fall back to file</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">extract_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="kc">None</span>
</code></pre></div>

<p>if the URL is an HTTP one,
we get it using Requests, and return the underlying file-like object;<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>
if not, we assume it's the path to a file</p>
<p>for maximum flexibility, we also support file: URIs;
extract_path() does a bit of validation
(e.g. allow file:feed.xml and file://localhost/feed.xml,
but not file://invalid/feed.xml or unknown://host/path<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup>)
and returns a path we can pass to open</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">extract_path</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">url_parsed</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">netloc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown authority for file URI&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url2pathname</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown scheme for file URI&quot;</span><span class="p">)</span>
    <span class="c1"># no scheme, treat as a path</span>
    <span class="k">return</span> <span class="n">url</span>
</code></pre></div>

<h3 id="problem-can-t-add-new-feed-sources">problem: can't add new feed sources<span class="headerlink"> <a href="#problem-can-t-add-new-feed-sources" title="permalink">#</a></span></h3>
<p>reader allows plugins to extend its behavior,
but the code above makes it impossible to add new feed sources
e.g. an FTP server (<code>ftp://...</code>)
without chaging the code</p>
<p>one way to fix this is to extract the retrieve functionality for each protocol into separate functions,</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">http_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">etag</span>

<span class="k">def</span> <span class="nf">file_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">extract_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="kc">None</span>
</code></pre></div>

<p>and then route to them depending on the url prefix</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="c1"># sorted by key length (longest first)</span>
<span class="n">RETRIEVERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;https://&#39;</span><span class="p">:</span> <span class="n">http_retriever</span><span class="p">,</span>
    <span class="s1">&#39;http://&#39;</span><span class="p">:</span> <span class="n">http_retriever</span><span class="p">,</span>
    <span class="c1"># fall back to file</span>
    <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">file_retriever</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">get_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">retriever</span> <span class="ow">in</span> <span class="n">RETRIEVERS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
            <span class="k">return</span> <span class="n">retriever</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no retriever for URL&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="n">get_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retriever</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>
</code></pre></div>

<p>now, plugins can register additional retrievers by adding them to RETRIEVERS
(in practice, we actually provide method for that,
that also makes sure it stays sorted)</p>
<h3 id="problem-can-t-validate-an-url-without-retrieving-it">problem: can't validate an url without retrieving it<span class="headerlink"> <a href="#problem-can-t-validate-an-url-without-retrieving-it" title="permalink">#</a></span></h3>
<p>to add a feed, users call <code>add_feed(url)</code>,
which saves it in the database,
to be retrieved on the next update.</p>
<p>what happens when the user adds an invalid feed, e.g. unknown://host/path?
it gets saved to the database,
and on the next update we get an &quot;unknown scheme for file URI&quot; error.
that's good, but it would be way nicer if the user got it
when adding the feed.</p>
<p>for HTTP, we can use Requests to do the validation for us;
for files, we can call <code>extract_path()</code> and discard the result.
of course, we can't use an if statement to choose which to do,
since it would take us <a href="#problem-can-t-add-new-feed-sources">back where we started</a>
– we need to select the validation using the same mechanism we use to select retrievers</p>
<p>now, there's more than one way of doing this</p>
<p>we could keep a separate validator registry,
but this invites it to accidentally become out of sync with the retriever one.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">URL_VALIDATORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;https://&#39;</span><span class="p">:</span> <span class="n">http_url_validator</span><span class="p">,</span>
    <span class="s1">&#39;http://&#39;</span><span class="p">:</span> <span class="n">http_url_validator</span><span class="p">,</span>
    <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">file_url_validator</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>we could group the retriever and the corresponding validator
by storing a (retriever, validator) tuple in the retriever registry.
this is betetr, but results in less-than readable code during use
(especially if we later need to add a third thing);
also, it allows using a retriever with the wrong validator,
and makes it difficult to customize bits of behavior that affect both the retriever and validator</p>
<!-- TODO: link to so future "when to use classes" article -->
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">RETRIEVERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;https://&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">http_retriever</span><span class="p">,</span> <span class="n">http_url_validator</span><span class="p">),</span>
    <span class="s1">&#39;http://&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">http_retriever</span><span class="p">,</span> <span class="n">http_url_validator</span><span class="p">),</span>
    <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">file_retriever</span><span class="p">,</span> <span class="n">file_url_validator</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div>
<p>better still, we can make the grouping explicit by using a class:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">HTTPRetriever</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ...</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">etag</span>

    <span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">get_adapter</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">prepare_request</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">FileRetriever</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">extract_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">extract_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div>

<p>we're making the retriever instances <a href="https://docs.python.org/3/glossary.html#term-callable">callable</a>;
this allows us to
replace the original retriever functions with instances,
and leave both <code>retrieve()</code> and the retriever registry unchanged.<sup class="footnote-ref" id="fnref-3"><a href="#fn-3">3</a></sup></p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">http_retriever</span> <span class="o">=</span> <span class="n">HTTPRetriever</span><span class="p">()</span>
<span class="n">file_retriever</span> <span class="o">=</span> <span class="n">FileRetriever</span><span class="p">()</span>
</code></pre></div>

<p><code>validate_url()</code> works like <code>retrieve()</code>,
but it  delegates to the appropriate method:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="n">get_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">retriever</span><span class="o">.</span><span class="n">validate_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div>

<p>And here you have it – <strong>if you repeat similar sets of functions, consider grouping them in a class</strong>.</p>
<h3 id="not-just-functions-attributes-too">Not just functions, attributes too<span class="headerlink"> <a href="#not-just-functions-attributes-too" title="permalink">#</a></span></h3>
<p>say you want to update feeds in parallel, using multiple threads.</p>
<p>parsing is pure Python, CPU bound code,
so threads won't help because of the <a href="https://docs.python.org/3/glossary.html#term-global-interpreter-lock">global interpreter lock</a>;
more importantly, parsing is not the bottleneck –
we can parse feeds much faster than we retrieve them.</p>
<p>retrieving, however, is mostly waiting around for I/O –
it takes ages to connect to the server and for it to respond.</p>
<p>but, because we're <a href="https://requests.readthedocs.io/en/latest/user/advanced/#body-content-workflow">streaming the reponse</a>,
there's still I/O left to be done
after <code>retrieve()</code> passes the file to the parser
(unless the response is small enough to fit in the TCP receive buffer).
we need to make sure the response is consumed <em>before</em> <code>retrieve()</code> returns.
one solution is to read it into a temporary file, and return that instead
(reading it into memory defeats the purpose of streaming).</p>
<p>we could implement this directly in HTTPRetriever,
but it may be a good idea to do it in <code>retrieve()</code>,
so others retrievers can opt into this behavior;
we'll use a class attribute to allow them to do so:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">HTTPRetriever</span><span class="p">:</span>
    <span class="n">slow_to_read</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">FileRetriever</span><span class="p">:</span>
    <span class="n">slow_to_read</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>

<p>If the retriever is slow to read, we do the swap:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="n">get_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">file</span><span class="p">,</span> <span class="n">etag</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">retriever</span><span class="o">.</span><span class="n">slow_to_read</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="k">return</span> <span class="n">file</span><span class="p">,</span> <span class="n">etag</span>
</code></pre></div>

<h2 id="example-flask-s-tagged-json">Example: Flask's tagged JSON<span class="headerlink"> <a href="#example-flask-s-tagged-json" title="permalink">#</a></span></h2>
<p>The Flask web framework provides <a href="https://flask.palletsprojects.com/en/2.3.x/api/#tagged-json">tagged JSON</a> (<a href="https://github.com/pallets/flask/blob/2.3.x/src/flask/json/tag.py">code</a>),
an extendable compact representation for non-standard JSON types.</p>
<p>The main class, <a href="https://flask.palletsprojects.com/en/2.3.x/api/#flask.json.tag.TaggedJSONSerializer">TaggedJSONSerializer</a>,
delegates the conversion work to methods of a number of <a href="https://flask.palletsprojects.com/en/2.3.x/api/#flask.json.tag.JSONTag">JSONTag</a> subclasses
(one class for each supported type):</p>
<ul>
<li><code>check()</code> checks if a Python value should be tagged by that tag</li>
<li><code>tag()</code> converts it to tagged JSON</li>
<li><code>to_python()</code> converts a JSON value back to Python
(the serializer uses the <code>key</code> tag attribute to find the correct tag)</li>
</ul>
<p>An interesting thing is that
tag instances have a <code>serializer</code> instance attribute
pointing back to the serializer;
this is to allow recursion –
e.g. when (un)packing a collection like a dict,
you need to recursively (un)pack its values.
An instance attribute was not strictly required,
each method could receive it as an argument,
but <a href="/same-arguments">when your functions take the same arguments...</a></p>
<h2 id="formalizing-this">formalizing this<span class="headerlink"> <a href="#formalizing-this" title="permalink">#</a></span></h2>
<p>TODO:</p>
<ul>
<li>inheritance</li>
<li>protocols</li>
</ul>
<h2 id="counter-example-modules">counter-example: modules<span class="headerlink"> <a href="#counter-example-modules" title="permalink">#</a></span></h2>
<p>TODO:</p>
<p>if there's no state or need for inheritance, modules work too (also works with duck typing)</p>
<section class="footnotes">
<ol>
<li id="fn-1"><p>this code has a potential bug:
if we were using a <a href="https://requests.readthedocs.io/en/latest/user/advanced/#session-objects">persistent session</a> instead of a transient one,
the connection would never be released,
since we're never closing the response after we're done with it.
in the actual code, we're doing both,
but the only way do so reliably is to <a href="https://github.com/lemon24/reader/blob/3.8/src/reader/_parser/http.py#L39-L103">return a context manager</a>;
I omitted this detail because it doesn't add anything
to the point we're trying to make here. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p>the reason why we're doing this final validation here
is because files are uniquely allows to have an explicit file: scheme,
or no scheme at all.
also, once we add Windows support,
it'll also be able to accept paths like C:\feed.xml;
note that drive letter is undistinguishable from a scheme –
it's good to deal with this in the code that cares about it <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-3"><p>if callable instances are too <a href="https://docs.python.org/3/glossary.html#term-magic-method">magic</a> for you,
you can  name those methods <code>retrieve()</code>;
here, I think it makes sense for retriever to be callable,
since retrieving is its main job, everything else is scondary. <a href="#fnref-3" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>










<hr>
<p>This is part of a series:</p>

<ul>


<li>
    <a href="/same-arguments">When to use classes in Python? When your functions take the same arguments</a>



<li>
    <a href="/more-arguments">When your functions take the same arguments, consider using a class: counter-examples</a>


</ul>





</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>