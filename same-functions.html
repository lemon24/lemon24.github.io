












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>When to use classes in Python? When you repeat similar sets of functions - death and gravity</title>
<meta name="description" content="TODO" />


<meta property="og:title" content="When to use classes in Python? When you repeat similar sets of functions">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/same-functions">
<meta property="og:description" content="TODO">



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">When to use classes in Python? When you repeat similar sets of functions</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2023-08-24">August 2023</span>
∙ 11 minute read
∙
</small><span class="share-icons">
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=When%20to%20use%20classes%20in%20Python%3F%20When%20you%20repeat%20similar%20sets%20of%20functions&url=https%3A//death.andgravity.com/same-functions&via=_andgravity"
>Twitter</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/same-functions&t=When%20to%20use%20classes%20in%20Python%3F%20When%20you%20repeat%20similar%20sets%20of%20functions"
>HN</a>
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/same-functions&title=When%20to%20use%20classes%20in%20Python%3F%20When%20you%20repeat%20similar%20sets%20of%20functions"
>Reddit</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>Are you having trouble figuring out when to use classes or how to organize them?</p>
<p>Have you repeatedly searched for &quot;when to use classes in Python&quot;,
read all the articles and watched all the talks,
and <em>still</em>  don't know whether you should be using classes in any given situation?</p>
<p>Have you read discussions about it that for all you know <em>may be right</em>,
but they're <em>so academic</em> you can't parse the jargon?</p>
<p>Have you read articles that all treat the &quot;obvious&quot; cases,
leaving you with no clear answer when you try to apply them to your own code?</p>
<hr />
<p>My experience is that, <strong>unfortunately</strong>,
the best way to learn this <em>is</em> to <a class="internal" href="/stdlib">look at lots of examples</a>.</p>
<p>Most guidelines tend to either be too vague <em>if you don't already know enough</em> about the subject,
or too specific and saying things you already know.</p>
<p>This is one of those things that once you get it seems obvious and intuitive,
<em>but it's not</em>, and is quite difficult to explain properly.</p>
<hr />
<p>So, instead of prescribing a general approach,
let's look at:</p>
<ul>
<li><strong>one specific case</strong> where you may want to use classes</li>
<li><strong>examples from real-world code</strong></li>
<li>some considerations you should keep in mind</li>
</ul>
<h2 id="the-heuristic">The heuristic<span class="headerlink"> <a href="#the-heuristic" title="permalink">#</a></span></h2>
<p><strong>If you repeat similar sets of functions, consider grouping them in a class.</strong></p>
<p>That's it.</p>
<p>In its most basic form,
a class is when you group data with functions that operate on that data;
sometimes, there is no data,
but it can still be useful to group the functions
into an <em>abstract object</em> that exists only
to make things easier to use / understand.</p>
<p>Depending on whether you choose which class to use at runtime,
this is sometimes called the <a class="external" href="https://en.wikipedia.org/wiki/Strategy_pattern">strategy pattern</a>.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>As Wikipedia <a class="external" href="https://simple.wikipedia.org/wiki/Heuristic">puts it</a>,
 &quot;A <strong>heuristic</strong> is a practical way to solve a problem.
 It is <em>better than chance</em>, but <em>does not always work</em>.
 A person develops a heuristic by using
 intelligence, experience, and common sense.&quot;</p>
<p>So, this is <strong>not</strong> the correct thing to do <strong>all the time</strong>,
 or even <em>most</em> of the time.</p>
<p>Instead, I hope that this and <em>other</em> heuristics
 can help <strong>build the right intuition</strong>
 for people on their way from
 &quot;I know the class syntax, now what?&quot; to
 &quot;proper&quot; object-oriented design.</p>
</section>
<h2 id="example-retrievers">Example: Retrievers<span class="headerlink"> <a href="#example-retrievers" title="permalink">#</a></span></h2>
<p>My <a class="external" href="https://github.com/lemon24/reader">feed reader library</a> retrieves and stores <a class="external" href="https://en.wikipedia.org/wiki/Web_feed">web feeds</a>
(Atom, RSS and so on).</p>
<p>Usually, feeds come from the internet,
but you can also use local files.
The parsers for various formats don't really care where a feed is coming from,
so they always take as input an open file.</p>
<p><a class="external" href="https://github.com/lemon24/reader">reader</a> supports conditional requests –
that is, only retrieve a feed if it changed.
To do this, it stores the <a class="external" href="https://en.wikipedia.org/wiki/HTTP_ETag">ETag</a> HTTP header from a response,
and passes it back as the If-None-Match header of the next request;
if nothing changed,
the server can respond with <a class="external" href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#304">304 Not Modified</a>
instead of sending back the full content.</p>
<p>Let's have a look at how the code to retrieve feeds evolved over time;
this version omits a few details,
but it will end up with a structure similar to that of the <a class="external" href="https://github.com/lemon24/reader/blob/3.9/src/reader/_parser/_lazy.py#L190-L268">full version</a>.
In the beginning, there was a function
– URL and old ETag in, file and new ETag out:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="s1">&#39;https://&#39;</span><span class="p">)):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">etag</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;If-None-Match&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etag</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">304</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">etag</span>
        <span class="n">etag</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ETag&#39;</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode_content</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">etag</span>

    <span class="c1"># fall back to file</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">extract_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="kc">None</span>
</code></pre></div>

<p>We use <a class="external" href="https://requests.readthedocs.io/">Requests</a> to get HTTP URLs,
and return the underlying file-like object.<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup></p>
<p>For local files, we suport both bare paths and <a class="external" href="https://en.wikipedia.org/wiki/File_URI_scheme">file URIs</a>;
for the latter, we need to do a bit of validation –
<em>file:feed</em> and <em>file://localhost/feed</em> are OK,
but <em>file://invalid/feed</em> and <em>unknown:feed</em><sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup> are not:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">extract_path</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">url_parsed</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">netloc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown authority for file URI&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url2pathname</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown scheme for file URI&quot;</span><span class="p">)</span>
    <span class="c1"># no scheme, treat as a path</span>
    <span class="k">return</span> <span class="n">url</span>
</code></pre></div>

<h3 id="problem-can-t-add-new-feed-sources">problem: can't add new feed sources<span class="headerlink"> <a href="#problem-can-t-add-new-feed-sources" title="permalink">#</a></span></h3>
<p>reader allows plugins to extend its behavior,
but the code above makes it impossible to add new feed sources
e.g. an FTP server (<code>ftp://...</code>)
without chaging the code</p>
<p>one way to fix this is to extract the retrieve functionality for each protocol into separate functions,</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">http_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">etag</span>

<span class="k">def</span> <span class="nf">file_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">extract_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="kc">None</span>
</code></pre></div>

<p>and then route to them depending on the url prefix</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="c1"># sorted by key length (longest first)</span>
<span class="n">RETRIEVERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;https://&#39;</span><span class="p">:</span> <span class="n">http_retriever</span><span class="p">,</span>
    <span class="s1">&#39;http://&#39;</span><span class="p">:</span> <span class="n">http_retriever</span><span class="p">,</span>
    <span class="c1"># fall back to file</span>
    <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">file_retriever</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">get_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">retriever</span> <span class="ow">in</span> <span class="n">RETRIEVERS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
            <span class="k">return</span> <span class="n">retriever</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no retriever for URL&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="n">get_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retriever</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>
</code></pre></div>

<p>now, plugins can register additional retrievers by adding them to RETRIEVERS
(in practice, we actually provide method for that,
that also makes sure it stays sorted)</p>
<h3 id="problem-can-t-validate-an-url-without-retrieving-it">problem: can't validate an url without retrieving it<span class="headerlink"> <a href="#problem-can-t-validate-an-url-without-retrieving-it" title="permalink">#</a></span></h3>
<p>to add a feed, users call <code>add_feed(url)</code>,
which saves it in the database,
to be retrieved on the next update.</p>
<p>what happens when the user adds an invalid feed, e.g. unknown://host/path?
it gets saved to the database,
and on the next update we get an &quot;unknown scheme for file URI&quot; error.
that's good, but it would be way nicer if the user got it
when adding the feed.</p>
<p>for HTTP, we can use Requests to do the validation for us;
for files, we can call <code>extract_path()</code> and discard the result.
of course, we can't use an if statement to choose which to do,
since it would take us <a class="anchor" href="#problem-can-t-add-new-feed-sources">back where we started</a>
– we need to select the validation using the same mechanism we use to select retrievers</p>
<p>now, there's more than one way of doing this</p>
<p>we could keep a separate validator registry,
but this invites it to accidentally become out of sync with the retriever one.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">URL_VALIDATORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;https://&#39;</span><span class="p">:</span> <span class="n">http_url_validator</span><span class="p">,</span>
    <span class="s1">&#39;http://&#39;</span><span class="p">:</span> <span class="n">http_url_validator</span><span class="p">,</span>
    <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">file_url_validator</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>we could group the retriever and the corresponding validator
by storing a (retriever, validator) tuple in the retriever registry.
this is betetr, but results in less-than readable code during use
(especially if we later need to add a third thing);
also, it allows using a retriever with the wrong validator,
and makes it difficult to customize bits of behavior that affect both the retriever and validator</p>
<!-- TODO: link to future "when to use classes" article -->
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">RETRIEVERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;https://&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">http_retriever</span><span class="p">,</span> <span class="n">http_url_validator</span><span class="p">),</span>
    <span class="s1">&#39;http://&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">http_retriever</span><span class="p">,</span> <span class="n">http_url_validator</span><span class="p">),</span>
    <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">file_retriever</span><span class="p">,</span> <span class="n">file_url_validator</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div>
<p>better still, we can make the grouping explicit by using a class:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">HTTPRetriever</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ...</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">etag</span>

    <span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">get_adapter</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">prepare_request</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">FileRetriever</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">extract_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">extract_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div>

<p>we then create retriever instances,
and update <code>retrieve()</code> to call their methods:<sup class="footnote-ref" id="fnref-3"><a href="#fn-3">3</a></sup></p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">http_retriever</span> <span class="o">=</span> <span class="n">HTTPRetriever</span><span class="p">()</span>
<span class="n">file_retriever</span> <span class="o">=</span> <span class="n">FileRetriever</span><span class="p">()</span>
</code></pre></div>

<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="n">get_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retriever</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>
</code></pre></div>

<p><code>validate_url()</code> works like <code>retrieve()</code>,
but delegates accordingly:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="n">get_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">retriever</span><span class="o">.</span><span class="n">validate_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div>

<p>And here you have it – <strong>if you repeat similar sets of functions, consider grouping them in a class</strong>.</p>
<h3 id="not-just-functions-attributes-too">Not just functions, attributes too<span class="headerlink"> <a href="#not-just-functions-attributes-too" title="permalink">#</a></span></h3>
<p>say you want to update feeds in parallel, using multiple threads.</p>
<p>parsing is pure Python, CPU bound code,
so threads won't help because of the <a class="external" href="https://docs.python.org/3/glossary.html#term-global-interpreter-lock">global interpreter lock</a>;
more importantly, parsing is not the bottleneck –
we can parse feeds much faster than we retrieve them.</p>
<p>retrieving, however, is mostly waiting around for I/O –
it takes ages to connect to the server and for it to respond.</p>
<p>but, because we're <a class="external" href="https://requests.readthedocs.io/en/latest/user/advanced/#body-content-workflow">streaming the reponse</a>,
there's still I/O left to be done
after <code>retrieve()</code> passes the file to the parser
(unless the response is small enough to fit in the TCP receive buffer).
we need to make sure the response is consumed <em>before</em> <code>retrieve()</code> returns.
one solution is to read it into a temporary file, and return that instead
(reading it into memory defeats the purpose of streaming).</p>
<p>we could implement this directly in HTTPRetriever,
but it may be a good idea to do it in <code>retrieve()</code>,
so others retrievers can opt into this behavior;
we'll use a class attribute to allow them to do so:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">HTTPRetriever</span><span class="p">:</span>
    <span class="n">slow_to_read</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">FileRetriever</span><span class="p">:</span>
    <span class="n">slow_to_read</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>

<p>If the retriever is slow to read, we do the swap:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="n">get_retriever</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">file</span><span class="p">,</span> <span class="n">etag</span> <span class="o">=</span> <span class="n">retriever</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">retriever</span><span class="o">.</span><span class="n">slow_to_read</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="k">return</span> <span class="n">file</span><span class="p">,</span> <span class="n">etag</span>
</code></pre></div>

<h2 id="example-flask-s-tagged-json">Example: Flask's tagged JSON<span class="headerlink"> <a href="#example-flask-s-tagged-json" title="permalink">#</a></span></h2>
<p>The Flask web framework provides <a class="external" href="https://flask.palletsprojects.com/en/2.3.x/api/#tagged-json">tagged JSON</a> (<a class="external" href="https://github.com/pallets/flask/blob/2.3.x/src/flask/json/tag.py">code</a>),
an extendable compact representation for non-standard JSON types.</p>
<p>The main class, <a class="external" href="https://flask.palletsprojects.com/en/2.3.x/api/#flask.json.tag.TaggedJSONSerializer">TaggedJSONSerializer</a>,
delegates the conversion work to methods of a number of <a class="external" href="https://flask.palletsprojects.com/en/2.3.x/api/#flask.json.tag.JSONTag">JSONTag</a> subclasses
(one class for each supported type):</p>
<ul>
<li><code>check()</code> checks if a Python value should be tagged by that tag</li>
<li><code>tag()</code> converts it to tagged JSON</li>
<li><code>to_python()</code> converts a JSON value back to Python
(the serializer uses the <code>key</code> tag attribute to find the correct tag)</li>
</ul>
<p>An interesting thing is that
tag instances have a <code>serializer</code> instance attribute
pointing back to the serializer;
this is to allow recursion –
e.g. when (un)packing a collection like a dict,
you need to recursively (un)pack its values.
An instance attribute was not strictly required,
each method could receive it as an argument,
but <a class="internal" href="/same-arguments">when your functions take the same arguments...</a></p>
<h2 id="formalizing-this">formalizing this<span class="headerlink"> <a href="#formalizing-this" title="permalink">#</a></span></h2>
<p>OK, we're more or less done, the code works.</p>
<p>But, how would you communicate to others
(readers, implementers, interpreters, type checkers)
that an HTTPRetriever is the same kind of thing as FileRetriever,
and as everything else that's intended to be a value in RETRIEVERS?</p>
<h3 id="duck-typing">Duck typing<span class="headerlink"> <a href="#duck-typing" title="permalink">#</a></span></h3>
<p>Here's the definition of <a class="external" href="https://docs.python.org/3/glossary.html#term-duck-typing">duck typing</a>:</p>
<blockquote>
<p>A programming style which does not look at an object's type to determine if it has the right interface; instead, the method or attribute is simply called or used (&quot;If it looks like a duck and quacks like a duck, it must be a duck.&quot;) By emphasizing interfaces rather than specific types, well-designed code improves its flexibility by allowing polymorphic substitution. Duck-typing avoids tests using <a class="external" href="https://docs.python.org/3/library/functions.html#type">type()</a> or <a class="external" href="https://docs.python.org/3/library/functions.html#isinstance">isinstance()</a>. [...] Instead, it typically employs <a class="external" href="https://docs.python.org/3/library/functions.html#hasattr">hasattr()</a> tests or <a class="external" href="https://docs.python.org/3/glossary.html#term-EAFP">EAFP</a> programming.</p>
</blockquote>
<p>We're already doing this -
if it retrieves like a retriever and it validates URLs like a retriever,
it is a retriever.</p>
<p>You see this all the time in Python.
For example, <a class="external" href="https://docs.python.org/3/library/json.html#json.dump">json.dump()</a> takes a <a class="external" href="https://docs.python.org/3/glossary.html#term-file-object">file-like object</a>;
now, the full <a class="external" href="https://docs.python.org/3/glossary.html#term-text-file">text file</a> <a class="external" href="https://docs.python.org/3/library/io.html#io.TextIOBase">interface</a>
has a non-trivial number of methods and attributes,
but dump() only cares about one, <a class="external" href="https://docs.python.org/3/library/io.html#io.TextIOBase.write">write()</a>,
and will accept <em>any</em> object implementing it:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyFile</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="gp">... </span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;writing: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">MyFile</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s1">&#39;one&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
<span class="go">writing: {</span>
<span class="go">writing: &quot;one&quot;</span>
<span class="go">writing: :</span>
<span class="go">writing: 1</span>
<span class="go">writing: }</span>
</code></pre></div>
<p>Sometimes, this is made explicit in the <a class="external" href="https://docs.python.org/3/library/json.html#json.dump">documentation</a>:</p>
<blockquote>
<p>Serialize <em>obj</em> [...] to <em>fp</em> (a <code>.write()</code>-supporting <a class="external" href="https://docs.python.org/3/glossary.html#term-file-object">file-like object</a>)</p>
</blockquote>
<h3 id="inheritance">Inheritance<span class="headerlink"> <a href="#inheritance" title="permalink">#</a></span></h3>
<p>Nevertheless, you may want to express (and enforce) this in a more formal way.</p>
<p>The next easiest option is to use a base class:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Retriever</span><span class="p">:</span>
    <span class="n">slow_to_read</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div>

<p>This allows you to provide default attributes and methods,
use <a class="external" href="https://docs.python.org/3/library/functions.html#isinstance">isinstance()</a> to check you got a retriever,
and will help type checkers and autocompletion,
at the expense of requiring all retrievers to inherit the base class:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyRetriever</span><span class="p">(</span><span class="n">Retriever</span><span class="p">):</span> <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">retriever</span> <span class="o">=</span> <span class="n">MyRetriever</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">retriever</span><span class="o">.</span><span class="n">slow_to_read</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">retriever</span><span class="p">,</span> <span class="n">Retriever</span><span class="p">)</span>
<span class="go">True</span>
</code></pre></div>
<p>What it won't do is to force subclasses to actually define the methods:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">retriever</span><span class="o">.</span><span class="n">validate_url</span><span class="p">(</span><span class="s1">&#39;myurl&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
<span class="gr">NotImplementedError</span>
</code></pre></div>
<h3 id="abstract-base-classes">Abstract base classes<span class="headerlink"> <a href="#abstract-base-classes" title="permalink">#</a></span></h3>
<p>And this is where <a class="external" href="https://docs.python.org/3/glossary.html#term-abstract-base-class">abstract base classes</a> come in.</p>
<p>The decorators in the <a class="external" href="https://docs.python.org/3/library/abc.html">abc</a> module allow you to define abstract methods:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Retriever</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">slow_to_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div>

<p>... which have to be overriden by subclasses:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyRetriever</span><span class="p">(</span><span class="n">Retriever</span><span class="p">):</span> <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">MyRetriever</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">Can&#39;t instantiate abstract class MyRetriever with abstract methods retrieve, slow_to_read, validate_url</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyRetriever</span><span class="p">(</span><span class="n">Retriever</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">slow_to_read</span> <span class="o">=</span> <span class="kc">False</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span> <span class="o">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span> <span class="o">...</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">MyRetriever</span><span class="p">()</span>
<span class="go">&lt;__main__.MyRetriever object at 0x1037aac50&gt;</span>
</code></pre></div>
<p>Note however that this will check
only the presence of the required methods or attributes,
not their type signatures or types.</p>
<p>You can also register arbitrary classes as &quot;virtual subclasses&quot;,
so they pass <a class="external" href="https://docs.python.org/3/library/functions.html#isinstance">isinstance()</a> checks,
but this won't check for required methods:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyRetriever</span><span class="p">:</span> <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Retriever</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyRetriever</span><span class="p">)</span>
<span class="go">&lt;class &#39;__main__.MyRetriever&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">MyRetriever</span><span class="p">(),</span> <span class="n">Retriever</span><span class="p">)</span>
<span class="go">True</span>
</code></pre></div>
<h3 id="protocols">Protocols<span class="headerlink"> <a href="#protocols" title="permalink">#</a></span></h3>
<p>Finally, we have protocols, aka structural subtyping, aka static duck typing.</p>
<p>Introduced in <a class="external" href="https://peps.python.org/pep-0544/">PEP 544</a>,
protocols go in the other direction from inheritance –
what if instead of having things declare what type they are,
we could declare what methods something has to have to <em>be</em> of that type?</p>
<p>you declare a protocol using <a class="external" href="https://docs.python.org/3/library/typing.html#typing.Protocol">typing.Protocol</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Retriever</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">slow_to_read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">etag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">IO</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>
</code></pre></div>

<p>in some other place,
you define an implementation:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">MyRetriever</span><span class="p">:</span>
    <span class="n">slow_to_read</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>

<p>...which you can then use
(note that in practice,
<code>retriever</code> will be declared to be a Retriever
far away from where MyRetriever is actually instantiated,
even different code bases):</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">retriever</span><span class="p">:</span> <span class="n">Retriever</span> <span class="o">=</span> <span class="n">MyRetriever</span><span class="p">()</span>
</code></pre></div>

<p>a type checker <a class="external" href="https://mypy.readthedocs.io/en/stable/protocols.html">like mypy</a> will then check if the provided instance conforms to the protocol
– not only that methods exist, but that their signatures are correct too!</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>mypy<span class="w"> </span>myproto.py
<span class="go">myproto.py:11: error: Incompatible types in assignment (expression has type &quot;MyRetriever&quot;, variable has type &quot;Retriever&quot;)  [assignment]</span>
<span class="go">myproto.py:11: note: &quot;MyRetriever&quot; is missing following &quot;Retriever&quot; protocol member:</span>
<span class="go">myproto.py:11: note:     retrieve</span>
<span class="go">myproto.py:11: note: Following member(s) of &quot;MyRetriever&quot; have conflicts:</span>
<span class="go">myproto.py:11: note:     Expected:</span>
<span class="go">myproto.py:11: note:         def validate_url(self, url: str) -&gt; None</span>
<span class="go">myproto.py:11: note:     Got:</span>
<span class="go">myproto.py:11: note:         def validate_url(self, url: int) -&gt; None</span>
<span class="go">Found 1 error in 1 file (checked 1 source file)</span>
</code></pre></div>
<p>If you decorate your protocol with <a class="external" href="https://docs.python.org/3/library/typing.html#typing.runtime_checkable">runtime_checkable</a>,
you can also use it at runtime to do <code>isinstance(retriever, Retriever)</code> checks,
but just like <a class="external" href="https://docs.python.org/3/library/abc.html">abc</a>, that only checks for the presence of required methods.</p>
<!-- TODO: zope.interface: https://peps.python.org/pep-0544/#existing-approaches-to-structural-subtyping -->
<h2 id="counter-example-modules">counter-example: modules<span class="headerlink"> <a href="#counter-example-modules" title="permalink">#</a></span></h2>
<p>If the class has no state<sup class="footnote-ref" id="fnref-4"><a href="#fn-4">4</a></sup>
and you don't need inheritance,
modules work too:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="c1"># module.py</span>

<span class="n">slow_to_read</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<span class="k">def</span> <span class="nf">validate_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div>

<p>From a <a class="anchor" href="#duck-typing">duck typing</a> perspective,
this is a valid retriever,
since it has all the expected methods and attributes.
So much so, that it is also compatible with <a class="anchor" href="#protocols">protocols</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">module</span>

<span class="n">retriever</span><span class="p">:</span> <span class="n">Retriever</span> <span class="o">=</span> <span class="n">module</span>
</code></pre></div>

<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>mypy<span class="w"> </span>module.py
<span class="go">Success: no issues found in 1 source file</span>
</code></pre></div>
<p>The caveat is that, of course,
you can have exactly one implementation per module.</p>
<!-- TODO: type checking that -->
<section class="footnotes">
<ol>
<li id="fn-1"><p>This code has a potential bug:
if we were using a <a class="external" href="https://requests.readthedocs.io/en/latest/user/advanced/#session-objects">persistent session</a> instead of a transient one,
the connection would never be released,
since we're not closing the response after we're done with it.
In the actual code, we're doing both,
but the only way do so reliably is to <a class="external" href="https://github.com/lemon24/reader/blob/3.9/src/reader/_parser/http.py#L39-L103">return a context manager</a>;
I omitted this because it doesn't add anything
to our discussion about classes. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p>We're handling unknown URI schemes here 
because bare paths don't have a scheme,
so anything that didn't match a known scheme must be a bare path.
Also, on Windows (not supported yet),
the drive letter in a path like <em>c:\feed.xml</em> 
is indistinguishable from a scheme. <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-3"><p>we could've avoided this last change
by making the retriever instances <a class="external" href="https://docs.python.org/3/glossary.html#term-callable">callable</a>.
<!-- TODO: talk about symmetry, and meta-retriever --> <a href="#fnref-3" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-4"><p>I tried to keep the example above stateless,
but the real world isn't so clear cut most of the time. <a href="#fnref-4" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>










<hr>
<p>This is part of a series:</p>

<ul>


<li>
    <a href="/same-arguments">When to use classes in Python? When your functions take the same arguments</a>



<li>
    <a href="/more-arguments">When your functions take the same arguments, consider using a class: counter-examples</a>


</ul>





</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>