












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>Deterministic hashing of Python data objects - death and gravity</title>
<meta name="description" content="In this article, you&#39;ll learn how to calculate deterministic hashes for arbitrary Python data objects, stable across interpreter versions and implementations." />


<meta property="og:title" content="Deterministic hashing of Python data objects">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/stable-hashing">
<meta property="og:description" content="In this article, you&#39;ll learn how to calculate deterministic hashes for arbitrary Python data objects, stable across interpreter versions and implementations.">



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RY2QR580X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-4RY2QR580X");
</script>



<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Deterministic hashing of Python data objects</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2021-03-19">March 2021</span>
‚àô 10 minute read
‚àô
</small><span class="share-icons">
<a
    class="share-icon pycoders"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/stable-hashing&t=Deterministic%20hashing%20of%20Python%20data%20objects"
>HN</a>
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/stable-hashing&title=Deterministic%20hashing%20of%20Python%20data%20objects"
>Reddit</a>
<a
    class="share-icon linkedin"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/stable-hashing"
>linkedin</a>
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Deterministic%20hashing%20of%20Python%20data%20objects&url=https%3A//death.andgravity.com/stable-hashing&via=_andgravity"
>Twitter</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>... in which we calculate deterministic hashes for Python data objects,
stable across interpreter versions and implementations.</p>
<p>If you're in a hurry,
you can find the final version of the code <a class="anchor" href="#conclusion">at the end</a>.</p>
<details>
<summary>Contents</summary>
<section class="toc">
<ul>
<li><a href="#why-is-this-useful">Why is this useful?</a></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#problem-we-need-a-stable-hash-function">Problem: we need a stable hash function</a>
<ul>
<li><a href="#hash-not-stable-too-restrictive">hash(): not stable, too restrictive</a></li>
<li><a href="#hashlib-still-restrictive">hashlib: still restrictive</a></li>
</ul>
</li>
<li><a href="#problem-we-need-a-deterministic-way-of-serializing-objects">Problem: we need a deterministic way of serializing objects</a>
<ul>
<li><a href="#pickle-not-stable">pickle: not stable</a></li>
<li><a href="#str-and-repr-not-stable-not-safe">str() and repr(): not stable, not safe</a></li>
<li><a href="#json">json üëç</a></li>
</ul>
</li>
<li><a href="#problem-we-need-to-ignore-empty-values">Problem: we need to ignore empty values</a></li>
<li><a href="#problem-we-need-to-skip-some-fields">Problem: we need to skip some fields</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</section>
</details>
<h2 id="why-is-this-useful">Why is this useful?<span class="headerlink">&nbsp;<a href="#why-is-this-useful" title="permalink">#</a></span></h2>
<p>Let's say you have a <a class="external" href="https://github.com/lemon24/reader">feed reader library</a>;
one of its main features is retrieving and storing <a class="external" href="https://en.wikipedia.org/wiki/Web_feed">web feeds</a>
(Atom, RSS, and so on).</p>
<p>Entries (articles) usually have an <code>updated</code> date,
indicating the last time the entry was modified in a significant way.
An entry is updated only if its <code>updated</code> in the feed
is newer than the one we have stored for it.</p>
<p>However, you notice the content of some entries changes
without <code>updated</code> changing,
so you decide to update entries whenever they change,
regardless of <code>updated</code>.</p>
<p>After the feed is retrieved,
entries are converted to data objects like these
(the real ones have <a class="external" href="https://github.com/lemon24/reader/blob/d2aaf418f8c4d45a97cabaa7eb76498239d0503b/src/reader/_types.py#L97-L114">more attributes</a>, though):</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Content</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">language</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Entry</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">updated</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Content</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
</code></pre></div>
<p>A naive approach is to get the stored entry data
and compare it with the feed version,
but that's pretty inefficient.</p>
<p>A better solution is to use a hash function
‚Äì a way to map data of arbitrary size (the message)
to a fixed-size chunk of data (the hash value),
such that:</p>
<ul>
<li>it is quick to compute the hash value for any given message</li>
<li>the same message always results in the same hash</li>
<li>it is extremely unlikely two slightly different messages have the same hash</li>
</ul>
<p>Then, instead of getting the full entry data from storage,
we just get its (previously computed) hash,
and compare it with the hash of the one we just retrieved.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="external" href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">Cryptographic hash functions</a> have more properties,
 but the three listed above are everything we need.</p>
</section>
<h2 id="requirements">Requirements<span class="headerlink">&nbsp;<a href="#requirements" title="permalink">#</a></span></h2>
<p>Looking at our use case, we need a hash function that:</p>
<ol>
<li>supports (almost) arbitrary data objects;
 in our case, the various built-in types, datetimes,
 and dataclass instances should be enough</li>
<li>is safe; passing an unsupported object should be an error</li>
<li>is stable across interpreter versions and implementations,
 operating systems, and host machines</li>
<li>ignores &quot;empty&quot; values, to allow adding new fields without the hash changing</li>
<li>can skip some of the fields (I actually realized this is needed much later)</li>
</ol>
<p>Because I'm using it in an existing library, I have some additional requirements:</p>
<ol start="6">
<li>it should not have other dependencies outside the standard library,
 since any extra dependency gets passed down to the users</li>
<li>it should be minimally invasive to existing code</li>
<li>it should work with static typing</li>
</ol>
<h2 id="problem-we-need-a-stable-hash-function">Problem: we need a stable hash function<span class="headerlink">&nbsp;<a href="#problem-we-need-a-stable-hash-function" title="permalink">#</a></span></h2>
<h3 id="hash-not-stable-too-restrictive">hash(): not stable, too restrictive<span class="headerlink">&nbsp;<a href="#hash-not-stable-too-restrictive" title="permalink">#</a></span></h3>
<p>An easy solution seems to be the built-in <a class="external" href="https://docs.python.org/3/library/functions.html#hash">hash()</a> function,
which returns the integer hash of an object.
However, it has a couple of issues.</p>
<p>By default, the hashes of str and bytes objects
are randomized for security reasons (<a class="external" href="https://docs.python.org/3/reference/datamodel.html#object.__hash__">details</a>, second note),
so they're not predictable between Python processes:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;print(hash(&quot;abc&quot;))&#39;</span>
<span class="go">-4743820898567001518</span>
<span class="gp">$ </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;print(hash(&quot;abc&quot;))&#39;</span>
<span class="go">-6699381079787346150</span>
</code></pre></div>
<p>Also, hash() only supports <a class="external" href="https://docs.python.org/3/glossary.html#term-hashable">hashable</a> objects;
this means no lists, dicts, or non-<a class="external" href="https://docs.python.org/3/library/dataclasses.html#frozen-instances">frozen</a> dataclasses.
For my specific use case, this wasn't actually a problem, but
it already puts huge constraints on how arbitrary the input can be.</p>
<h3 id="hashlib-still-restrictive">hashlib: still restrictive<span class="headerlink">&nbsp;<a href="#hashlib-still-restrictive" title="permalink">#</a></span></h3>
<p><a class="external" href="https://docs.python.org/3/library/hashlib.html">hashlib</a> contains many different secure hash algorithms,
which are by definition deterministic.</p>
<p>But it has one big problem ‚Äì it only takes bytes:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="go">&#39;900150983cd24fb0d6963f7d28e17f72&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">TypeError</span>: <span class="n">Unicode-objects must be encoded before hashing</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">TypeError</span>: <span class="n">object supporting the buffer API required</span>
</code></pre></div>
<p>This is something we can work with, though: it changes our problem
from <em>we need a stable hash function</em>
to <em>we need a deterministic way of serializing objects to bytes</em>.</p>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you're curious <em>why</em> it only takes bytes,
 check out <a class="internal" href="/hashlib-buffer-required">this article</a>.</p>
</section>
<h2 id="problem-we-need-a-deterministic-way-of-serializing-objects">Problem: we need a deterministic way of serializing objects<span class="headerlink">&nbsp;<a href="#problem-we-need-a-deterministic-way-of-serializing-objects" title="permalink">#</a></span></h2>
<h3 id="pickle-not-stable">pickle: not stable<span class="headerlink">&nbsp;<a href="#pickle-not-stable" title="permalink">#</a></span></h3>
<p><a class="external" href="https://docs.python.org/3/library/pickle.html">pickle</a> can turn most Python objects into bytes.</p>
<p>It does have multiple protocols,
and the default one can change with the Python version;
but we can select one and stick with it ‚Äì
we'll use version 4, added in Python 3.4.</p>
<p>Again, the easy solution is deceiving, since it seems to work:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="k">function</span><span class="w"> </span>pickle<span class="w"> </span><span class="o">{</span>
<span class="gp">$</span><span class="m">1</span><span class="w"> </span>&lt;&lt;EOD
<span class="go">import pickle</span>
<span class="go">from datetime import datetime</span>
<span class="go">print(pickle.dumps($3, protocol=$2))</span>
<span class="go">EOD</span>
<span class="go">}</span>
<span class="gp">$ </span>pickle<span class="w"> </span>python3.6<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="s1">&#39;[1, &quot;abc&quot;]&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>md5sum
<span class="go">02fa88b9fea0912efe731ed56906b251  -</span>
<span class="gp">$ </span>pickle<span class="w"> </span>python3.7<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="s1">&#39;[1, &quot;abc&quot;]&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>md5sum
<span class="go">02fa88b9fea0912efe731ed56906b251  -</span>
<span class="gp">$ </span>pickle<span class="w"> </span>python3.8<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="s1">&#39;[1, &quot;abc&quot;]&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>md5sum
<span class="go">02fa88b9fea0912efe731ed56906b251  -</span>
<span class="gp">$ </span>pickle<span class="w"> </span>pypy3.6<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="s1">&#39;[1, &quot;abc&quot;]&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>md5sum
<span class="go">02fa88b9fea0912efe731ed56906b251  -</span>
</code></pre></div>
<p>... until it doesn't:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>pickle<span class="w"> </span>python3.6<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="s1">&#39;datetime(1, 1, 1)&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>md5sum
<span class="go">9c4423b791578d865d8fbeb070a1b934  -</span>
<span class="gp">$ </span>pickle<span class="w"> </span>pypy3.6<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="s1">&#39;datetime(1, 1, 1)&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>md5sum
<span class="go">3c7c834cb2f1cf4aba8be5c326bb9ddd  -</span>
</code></pre></div>
<p>Version 0 isn't stable either, but in a different way:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>pickle<span class="w"> </span>python3.6<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="s1">&#39;datetime(1, 1, 1)&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>md5sum
<span class="go">01acd91b95556a09f5ff9b7495e120da  -</span>
<span class="gp">$ </span>pickle<span class="w"> </span>pypy3.6<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="s1">&#39;datetime(1, 1, 1)&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>md5sum
<span class="go">01acd91b95556a09f5ff9b7495e120da  -</span>
<span class="gp">$ </span>pickle<span class="w"> </span>python3.7<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="s1">&#39;datetime(1, 1, 1)&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>md5sum
<span class="go">a6c815eca494dbf716cd4a7e5556d779  -</span>
</code></pre></div>
<p>Version 3 does <em>seem</em> to work fine across all of the above,
on both macOS and Linux (I also tested it with more complicated data).
But what's to say it'll remain that way?</p>
<p>In fairness, <em>this is not an issue with pickle</em> ‚Äì
it guarantees you'll get the same object back after unpickling,
not that you'll get the same binary stream after pickling.</p>
<p>And it's easy to explain why: pickles are actually <em>programs</em>.
Some relevant and quite interesting comments from <a class="external" href="https://github.com/python/cpython/blob/3.9/Lib/pickletools.py">pickletools</a>:</p>
<blockquote>
<p>&quot;A pickle&quot; is a program for a virtual pickle machine (PM, but more accurately
called an unpickling machine). It's a sequence of opcodes, interpreted by the
PM, building an arbitrarily complex Python object.</p>
</blockquote>
<blockquote>
<p>Historically, many enhancements
have been made to the pickle protocol in order to do a better (faster,
and/or more compact) job on
[builtin scalar and container types, like ints and tuples].</p>
</blockquote>
<blockquote>
<p>As explained below [for compatibility],
pickle opcodes never go away, not even when better ways to do a thing
get invented. The repertoire of the PM just keeps growing over time.</p>
</blockquote>
<p>This means there can be multiple pickles
that unpickle to the same object<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>,
even within the bounds of a specific protocol version.</p>
<h3 id="str-and-repr-not-stable-not-safe">str() and repr(): not stable, not safe<span class="headerlink">&nbsp;<a href="#str-and-repr-not-stable-not-safe" title="permalink">#</a></span></h3>
<p><a class="external" href="https://docs.python.org/3/library/functions.html#func-str">str()</a> and <a class="external" href="https://docs.python.org/3/library/functions.html#repr">repr()</a> might seem like valid solutions,
but neither of them are.</p>
<p>First, they're not stable, and not guaranteed
to have all the information we may care about:</p>
<blockquote>
<p><code>str(object)</code> returns <code>object.__str__()</code>, which is the &quot;informal&quot; or nicely printable string representation of object. [...] If object does not have a <code>__str__()</code> method, then <code>str()</code> falls back to returning <code>repr(object)</code>.</p>
</blockquote>
<blockquote>
<p>For many types, [<code>repr()</code>] makes an attempt to return a string that would yield an object with the same value when passed to <code>eval()</code>, otherwise the representation is a string enclosed in angle brackets that contains the name of the type of the object together with additional information often including the name and address of the object.</p>
</blockquote>
<p>More importantly, they're not safe ‚Äì <em>all</em> Python objects have them,
even some that we would not want to serialize at all:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Content</span><span class="p">(</span><span class="nb">object</span><span class="p">())</span>
<span class="go">Content(value=&lt;object object at 0x7f993cd5ff40&gt;, language=None)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Content</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">Content(value=&lt;function &lt;lambda&gt; at 0x7f993e96ec10&gt;, language=None)</span>
</code></pre></div>
<h3 id="json">json üëç<span class="headerlink">&nbsp;<a href="#json" title="permalink">#</a></span></h3>
<p><a class="external" href="https://docs.python.org/3/library/json.html">json</a> might be just what we need;
even the pickle documentation recommends it,
although for <a class="external" href="https://docs.python.org/3/library/pickle.html#comparison-with-json">different reasons</a>.</p>
<p>Compared to the previous solutions, json has the opposite problem:
it <a class="external" href="https://docs.python.org/3/library/json.html#json.JSONEncoder">only supports</a> dicts (with string/number keys only),
lists, strings, and a few other basic types.</p>
<p>But that's not that big of an issue as you may think,
since the json module makes it really easy to support other types:
we just have to convert them to something it already understands.</p>
<p>Let's start with datetimes:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">json_default</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">thing</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="s1">&#39;microseconds&#39;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> not serializable&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="n">json_default</span><span class="p">)</span>
<span class="go">&#39;&quot;0001-01-01T00:00:00.000000&quot;&#39;</span>
</code></pre></div>
<p>Dataclasses aren't much harder to add either, thanks to <a class="external" href="https://docs.python.org/3/library/dataclasses.html#dataclasses.asdict">asdict()</a>,
which converts them to dicts and recurses into any nested dataclasses,
dicts, lists and tuples along the way:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">json_default</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">thing</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="s1">&#39;microseconds&#39;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> not serializable&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">Entry</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">Content</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)]),</span> <span class="n">default</span><span class="o">=</span><span class="n">json_default</span><span class="p">)</span>
<span class="go">&#39;{&quot;id&quot;: &quot;id&quot;, &quot;updated&quot;: &quot;0001-01-01T00:00:00.000000&quot;, &quot;content&quot;: [{&quot;value&quot;: &quot;value&quot;, &quot;language&quot;: null}]}&#39;</span>
</code></pre></div>
<p>You may notice the dataclass type does not appear in the result,
which for our use case is actually fine:
dataclasses <code>One(value=1)</code> and <code>Two(value=1)</code> will both get converted
to the dict <code>{'value': 1}</code>, resulting in the same hash.
To make them different, we can include the type name:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="p">{</span><span class="s1">&#39;__type&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="o">**</span><span class="n">asdict</span><span class="p">(</span><span class="n">thing</span><span class="p">)}</span>
<span class="p">{</span><span class="s1">&#39;__type&#39;</span><span class="p">:</span> <span class="s1">&#39;Content&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</code></pre></div>
<p>To ensure the output remains stable across Python versions,
we'll force all of the <a class="external" href="https://docs.python.org/3/library/json.html#json.dumps">dumps()</a> default arguments to known values,
and require it to sort dict keys:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">json_dumps</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="n">thing</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">json_default</span><span class="p">,</span>
        <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
<p>One more wrapper to hash the serialized value, and we're done:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">get_hash</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">json_dumps</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">get_hash</span><span class="p">(</span><span class="n">Entry</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">Content</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)]))</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
<span class="go">&#39;78b4b8120af5f832b7ecfc34db1fe02b&#39;</span>
</code></pre></div>
<h2 id="problem-we-need-to-ignore-empty-values">Problem: we need to ignore empty values<span class="headerlink">&nbsp;<a href="#problem-we-need-to-ignore-empty-values" title="permalink">#</a></span></h2>
<p>Say we have a dataclass like the following:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Data</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_hash</span><span class="p">(</span><span class="n">Data</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
<span class="go">&#39;5d872de403edb944a7b10450eda2f46a&#39;</span>
</code></pre></div>
<p>Which in time evolves to get another attribute:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Data</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>
<span class="gp">... </span>    <span class="n">another</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_hash</span><span class="p">(</span><span class="n">Data</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
<span class="go">&#39;e54ad2c961239bd70da9a603cd078e18&#39;</span>
</code></pre></div>
<p>The old and new versions result in different dicts,
so they have different hashes.</p>
<p>But should they?
The only &quot;real&quot; data <code>Data(2)</code> contains is <code>value=2</code>.
Likewise, there's not much of a difference
in actual information between <code>None</code> and <code>[]</code>
(for our use case, at least).</p>
<p>We can ignore &quot;empty&quot; values quite easily
by using the asdict() <code>dict_factory</code> argument.
I overlooked it initially, thinking it has to be a mapping class;
it turns out any function that takes a key-value pair iterable works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Collection</span>

<span class="k">def</span> <span class="nf">dict_drop_empty</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">v</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Collection</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">json_default</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">dict_factory</span><span class="o">=</span><span class="n">dict_drop_empty</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>
<p>We now get the same hash as for the first version of the object:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Data</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">Data(value=2, another=None)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_hash</span><span class="p">(</span><span class="n">Data</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
<span class="go">&#39;5d872de403edb944a7b10450eda2f46a&#39;</span>
</code></pre></div>
<p>Note that we are specific about the <em>falsy</em> values we ignore:
an empty string, list, or dict are empty, but <code>0</code> or <code>False</code> are not.</p>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p><a class="external" href="https://docs.python.org/3/library/collections.abc.html">collections.abc</a> provides abstract base classes
 that can be used to test whether a class provides a particular interface,
 without requiring it to subclass anything.</p>
<p><code>isinstance(v, (str, tuple, list, dict))</code> works in our example,
 but <code>isinstance(v, Collection)</code> checks for other collections
 we may have failed to think about that don't inherit from them;
 for example: <a class="external" href="https://docs.python.org/3/library/stdtypes.html#set-types-set-frozenset">sets</a>, <a class="external" href="https://docs.python.org/3/library/collections.html#collections.deque">deques</a>, <a class="external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html">numpy arrays</a>,
 and even ones that don't exist yet.</p>
</section>
<h2 id="problem-we-need-to-skip-some-fields">Problem: we need to skip some fields<span class="headerlink">&nbsp;<a href="#problem-we-need-to-skip-some-fields" title="permalink">#</a></span></h2>
<p>Let's look at a more advanced version of our Entry class:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Entry</span><span class="p">:</span>
    <span class="n">feed_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">updated</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Content</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
</code></pre></div>
<p>It the <a class="external" href="https://reader.readthedocs.io/en/latest/guide.html#changing-feed-urls">feed URL changes</a>, does the data of the entry change?
That is, would we want to update the entry next time we retrieve it?</p>
<p>No, in our context, both <code>feed_url</code> and <code>id</code> are <em>metadata;</em>
changing them should not change the hash,
since the actual data does not change.</p>
<p>We could deal with it by changing json_default()
to remove specific keys from the asdict() result.</p>
<p>However, this moves class-specific logic away from the class,
and into json_default(),
which forces us to change it whenever we add a new class, or
the list of metadata attributes changes.
Passing the list as an argument to get_hash() just moves the problem elsewhere.</p>
<p>A better way is to allow classes to tell json_default()
what attributes to remove via a well-known class attribute.</p>
<p>Neither of these approaches work with asdict() and nested dataclasses,
since asdict() is recursive, and we only get to look at the top-level class.
We cannot do anything in <code>dict_factory</code> either,
since we don't know which class the attribute pairs belong to.</p>
<p>To work around it, we'll implement a non-recursive version of asdict(),
and rely on json.dumps() for recursion (it's cool like that):</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">dataclass_dict</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;got dataclass type, expected instance&quot;</span><span class="p">)</span>

    <span class="n">exclude</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="s1">&#39;_hash_exclude_&#39;</span><span class="p">,</span> <span class="p">())</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Collection</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">rv</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">rv</span>

<span class="k">def</span> <span class="nf">json_default</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataclass_dict</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>We're using <code>_hash_exclude_</code> (with an underscore at the end) to mimic
 the <code>__double_underscore__</code> convention Python uses for magic methods;
 we are <em>not</em> using double underscores because <a class="external" href="https://docs.python.org/3/reference/lexical_analysis.html#reserved-classes-of-identifiers">they are reserved</a> by Python.</p>
</section>
<p>To exclude some fields from the hash,
we just need to set <code>_hash_exclude_</code> to a tuple containing their names:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Entry</span><span class="p">:</span>
    <span class="n">feed_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">updated</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Content</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">_hash_exclude_</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;feed_url&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">get_hash</span><span class="p">(</span><span class="n">Entry</span><span class="p">(</span><span class="s1">&#39;feed one&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
<span class="go">&#39;4f97b1e8e99d3304f50cd3c4428f224e&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_hash</span><span class="p">(</span><span class="n">Entry</span><span class="p">(</span><span class="s1">&#39;feed two&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
<span class="go">&#39;4f97b1e8e99d3304f50cd3c4428f224e&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_hash</span><span class="p">(</span><span class="n">Entry</span><span class="p">(</span><span class="s1">&#39;feed one&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
<span class="go">&#39;0c739e158792c5a91ec1632804d905c1&#39;</span>
</code></pre></div>
<h2 id="conclusion">Conclusion<span class="headerlink">&nbsp;<a href="#conclusion" title="permalink">#</a></span></h2>
<p>By leveraging <a class="external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a> and the <a class="external" href="https://docs.python.org/3/library/json.html">json</a> module,
we've managed to get stable, deterministic hashes
for (almost) arbitrary Python data objects,
with a decent trade-off between generality and safety,
and two additional features,
<em>all in under 50 lines of code!</em></p>
<p>It's true that the solution is pretty specific to my use case,
but with this little code, it should be trivial to adapt to something else.</p>
<p>If you're interested in using it, have a look at:</p>
<ul>
<li>the <a class="external" href="https://github.com/lemon24/reader/blob/1efcd38c78f70dcc4e0d279e0fa2a0276749111e/src/reader/_hash_utils.py">commented, type-annotated code</a>, and</li>
<li>the <a class="external" href="https://github.com/lemon24/reader/blob/1efcd38c78f70dcc4e0d279e0fa2a0276749111e/tests/test_hash_utils.py">test suite</a>.</li>
</ul>
<p><strong>Learned something new today?</strong> Share this with others, it really helps! <span class="text-large">
<span class="share-icons">
<a
    class="share-icon pycoders color"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news color"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/stable-hashing&t=Deterministic%20hashing%20of%20Python%20data%20objects"
>HN</a>
<a
    class="share-icon reddit color"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/stable-hashing&title=Deterministic%20hashing%20of%20Python%20data%20objects"
>Reddit</a>
<a
    class="share-icon linkedin color"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/stable-hashing"
>linkedin</a>
<a
    class="share-icon twitter color"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Deterministic%20hashing%20of%20Python%20data%20objects&url=https%3A//death.andgravity.com/stable-hashing&via=_andgravity"
>Twitter</a>
</span>
</span></p>

<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661&SIGNUP=stable-hashing"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"
>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">

        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>
<section class="footnotes">
<ol>
<li id="fn-1"><p>I found this idea somewhere on Stack Overflow,
but I can't seem to find that specific post again. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
‚àô <a href="/_feed/index.xml">feed</a>
‚àô <a href="/about">about</a>

‚àô ¬© 2021 lemon24



</footer>


</div>