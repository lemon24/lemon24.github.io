<!doctype html>

<meta name="viewport" content="width=device-width" />


<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />











<title>An SQL query builder in 150 lines of Python: Introduction - death and gravity</title>


<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1>An SQL query builder in 150 lines of Python: Introduction</h1>

<p class="text-gray"><small>





</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>In this series,
we'll look at an SQL query builder
I wrote for my <a href="https://github.com/lemon24/reader">feed reader library</a>.
<em>Yes, you read that right, the whole thing is just under 150 lines of Python.</em></p>
<p>Read on for a summary of what you can expect from the rest of the series.</p>
<hr />
<p>While the code is interesting in its own right,
in the first few articles we'll discuss
<strong>why I did it</strong>, <strong>what I didn't do</strong>, and <strong>how I thought about it</strong>:</p>
<ul>
<li>why use a query builder in the first place</li>
<li>why I decided to write my own<ul>
<li>what existing libraries I looked at, and why I didn't use one</li>
<li>how I knew it wouldn't become too big and/or a maintenance burden</li>
</ul>
</li>
<li>how I modeled the problem</li>
</ul>
<p>After that, we'll rewrite the builder <strong>from scratch</strong>, iteratively,
and talk about:</p>
<ul>
<li>API design</li>
<li>data stuctures</li>
<li>metaprogramming</li>
<li>worse ways of doing things</li>
<li>why I removed a bunch of features</li>
</ul>
<hr />
<p>So, what does it look like?</p>
<p>You create a <code>Query</code> object,
and then chain-call <code>KEYWORD</code> methods to add stuff to it:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;feeds&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span>
<span class="go">&lt;builder.Query object at 0x7fad40935a30&gt;</span>
</code></pre></div>
<p>To get the SQL, you convert it to a string:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="go">SELECT</span>
<span class="go">    url,</span>
<span class="go">    title</span>
<span class="go">FROM</span>
<span class="go">    feeds</span>
</code></pre></div>
<p>Repeated calls modify the query in-place:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">SELECT</span><span class="p">((</span><span class="s2">&quot;title_sort&quot;</span><span class="p">,</span> <span class="s2">&quot;lower(coalesce(user_title, title))&quot;</span><span class="p">))</span>  <span class="c1"># alias</span>
<span class="go">&lt;builder.Query object at 0x7fad40935a30&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">ORDER_BY</span><span class="p">(</span><span class="s1">&#39;title_sort&#39;</span><span class="p">)</span>
<span class="go">&lt;builder.Query object at 0x7fad40935a30&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="go">SELECT</span>
<span class="go">    url,</span>
<span class="go">    title,</span>
<span class="go">    lower(coalesce(user_title, title)) AS title_sort</span>
<span class="go">FROM</span>
<span class="go">    feeds</span>
<span class="go">ORDER BY</span>
<span class="go">    title_sort</span>
</code></pre></div>
<!-- TBD -->
<p>If you're curious to see the code,
you can find the final version <em>here</em>,
and the &quot;productized&quot;, type-annotated version <em>here</em>.</p>
<!-- TODO: clean up constructor -->
<p>As new articles appear,
the bullets above will point to the specific articles.
If you wanna keep up with them, subscribe and hit the bell.</p>
<p>Note:
This is my first <em>planned</em> series,
so I haven't actually written the articles yet.
If you have comments, questions or suggestions,
drop me a line.</p>














<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661"
    method="post"
    id="mc-embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"

>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">


        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>




</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>