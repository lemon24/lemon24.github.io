<!doctype html>

<meta name="viewport" content="width=device-width" />


<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />











<title>An SQL query builder in 150 lines of Python - death and gravity</title>


<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1>An SQL query builder in 150 lines of Python</h1>

<p class="text-gray"><small>





</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>In this series,
we'll take a look at the SQL query builder
I wrote for my feed aggregator library, <a href="https://github.com/lemon24/reader">reader</a>
(this is just a teaser).</p>
<p>While the code itself is interesting in its own right
(if for no other reason other than how small it turned out),
in the first few articles we'll discuss something more important:
<strong>why I did it</strong>, <strong>what I didn't do</strong>, and <strong>how I thought about it</strong>.</p>
<p>We'll cover:</p>
<ul>
<li>Why (and when) does one need a query builder in the first place.</li>
<li>Why was this the right decision in my case.<ul>
<li>What existing libraries I looked at, and why I didn't use one.</li>
<li>Why (and when) I decided to write my own.</li>
<li>How I knew it wouldn't spiral out into a huge project,
what I did to decrease the likelihood of it happening,
what I did to decrease the maintenance burden.</li>
</ul>
</li>
<li>How I thought about the problem.<ul>
<li>The crucial insight, and how the initial research was essential in getting it.</li>
</ul>
</li>
</ul>
<p>After that, we'll write the thing from scratch, iteratively;
along the way, we'll discuss:</p>
<ul>
<li>The data structures and techniques I used.</li>
<li>The API choices I made.</li>
<li>How I tested the thing (and how I avoided testing it too much).</li>
<li>The things I changed my mind after the initial implementation, and why.</li>
<li>When and why I stopped adding, and even removed, features.<ul>
<li>How to implement a few other features.</li>
</ul>
</li>
</ul>
<p>So, what does it look like?</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">builder</span> <span class="kn">import</span> <span class="n">Query</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;feeds&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="go">SELECT</span>
<span class="go">    url,</span>
<span class="go">    title</span>
<span class="go">FROM</span>
<span class="go">    feeds</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">SELECT</span><span class="p">((</span><span class="s2">&quot;title_sort&quot;</span><span class="p">,</span> <span class="s2">&quot;lower(coalesce(user_title, title))&quot;</span><span class="p">))</span>
<span class="go">&lt;builder.Query object at 0x7fad40935a30&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">ORDER_BY</span><span class="p">(</span><span class="s1">&#39;title_sort&#39;</span><span class="p">)</span>
<span class="go">&lt;builder.Query object at 0x7fad40935a30&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="go">SELECT</span>
<span class="go">    url,</span>
<span class="go">    title,</span>
<span class="go">    lower(coalesce(user_title, title)) AS title_sort</span>
<span class="go">FROM</span>
<span class="go">    feeds</span>
<span class="go">ORDER BY</span>
<span class="go">    title_sort</span>
</code></pre></div>
<p>If you're curious to see the code,
you can find the final version <em>here</em>,
and the &quot;productized&quot;, type-annotated version <em>here</em>.</p>
<p>As new articles appear,
the bullets above will point to the specific articles.
If you wanna keep up with them, subscribe and hit the bell.</p>
<p>Note:
This is my first <em>planned</em> series,
so I haven't actually written the articles yet.
If you have comments, questions or suggestions,
drop me a line.</p>













</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>