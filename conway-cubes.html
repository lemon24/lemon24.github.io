<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />











<title>Solving Advent of Code 2020 day 17 by not solving it - death and gravity</title>


<meta name="description" content="... in which we solve the day 17 problem from Advent of Code 2020, Conway Cubes, in a generic way, focusing on testing, refactoring, and idiomatic Python, in a way that helps you translate those skills to your regular, non-puzzle coding.
" />



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RY2QR580X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-4RY2QR580X");
</script>



<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Solving Advent of Code 2020 day 17 by not solving it</h1>

<p class="text-gray"><small>
<span class="tooltip" data-tooltip="updated on 2021-02-08">2021-01-22</span>



âˆ™ 16 minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>... in which we take a look at <a href="https://adventofcode.com/2020/day/17">the day 17 problem from
Advent of Code 2020</a>, Conway Cubes.
We will end up solving it <em>eventually</em>,
but in a very roundabout way; you will see why <a href="#the-problem">shortly</a>.</p>
<p>Along the way, we will:</p>
<ul>
<li>test and refactor,</li>
<li>avoid hard problems, and</li>
<li>write some idiomatic Python, from scratch.</li>
</ul>
<p>There are both shorter and faster ways of solving this,
but we'll take the scenic route, in a way that helps you
translate those skills to your regular, non-puzzle coding.</p>
<p>You can read this without having solved the problem,
but to get the most from it, I recommend you do it on your own first,
and then follow along as we do it again here.</p>
<details>
<summary>Contents</summary>
<section class="toc">
<ul>
<li><a href="#the-problem">The problem</a></li>
<li><a href="#parsing-the-input">Parsing the input</a></li>
<li><a href="#the-world">The world</a></li>
<li><a href="#simulation">Simulation</a></li>
<li><a href="#cleaning-up">Cleaning up</a></li>
<li><a href="#going-multidimensional">Going multidimensional</a></li>
<li><a href="#3d">3D</a></li>
<li><a href="#4d">4D</a></li>
<li><a href="#conclusions">Conclusions</a></li>
<li><a href="#bonus-cli-and-tests">Bonus: CLI and tests</a></li>
<li><a href="#bonus-more-tests">Bonus: more tests</a></li>
</ul>
</section>
</details>
<h2 id="the-problem">The problem<span class="headerlink"> <a href="#the-problem" title="permalink">#</a></span></h2>
<p>The problem might look familiar
(if you didn't read it yet, <a href="https://adventofcode.com/2020/day/17">go do that first</a>):</p>
<ul>
<li>we have a grid of cells that can be either <em>active</em> or <em>inactive</em></li>
<li>cells change state at each step in time depending on their neighbors</li>
</ul>
<p>These things are called <a href="https://en.wikipedia.org/wiki/Cellular_automaton">cellular automata</a>,
the most famous of which is probably Conway's <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Game of Life</a>.
Our problem seems to have the same rules as Life:</p>
<ul>
<li>any <em>active</em> cell with 2 or 3 <em>active</em> neighbors remains <em>active</em></li>
<li>any <em>inactive</em> cell with 3 <em>active</em> neighbors becomes <em>active</em></li>
<li>all other cells become/remain <em>inactive</em></li>
</ul>
<p>... except the grid is 3-dimensional.</p>
<details>
<summary>Minor spoiler alert:</summary>
<p>In part two of the problem, the grid is <em>4-dimensional</em>.</p>
</details>
<p>You might notice that this is relatively hard to visualize:
the example output has 5 layers after 3 cycles in 3 dimensions,
and 25 layers after only 2 cycles in 4 dimensions!
Understanding what's happening in 4D seems difficult
even assuming the number of planes remains 25 for future iterations.<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup></p>
<p>The normal flow of solving the problem would be something like this:</p>
<ul>
<li>implement the 3D version; then,</li>
<li>after seeing the second part, either<ul>
<li>do 4D in a similar fashion, or</li>
<li>generalize 3D to an arbitrary number of dimensions.</li>
</ul>
</li>
</ul>
<p><strong>We'll do the opposite</strong>:
implement 2D, which is trivial to check by hand,
and once we have some tests, generalize <em>that</em>.</p>
<h2 id="parsing-the-input">Parsing the input<span class="headerlink"> <a href="#parsing-the-input" title="permalink">#</a></span></h2>
<p>First, let's parse the input.</p>
<p>We'll transform the input string into a list of lists of integers,
where 0 and 1 represent inactive and active cubes, respectively.
For the test input, it should look like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</code></pre></div>
<p>Using numbers <a href="https://en.wikipedia.org/wiki/Separation_of_concerns">separates concerns</a>, but also allows for nicer code:
we can write <code>if active</code> instead of <code>if active == '#'</code>, and
<code>sum(cubes)</code> instead of <code>sum(active == '#' for active in cubes)</code>.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">CHARACTERS</span> <span class="o">=</span> <span class="s1">&#39;.#&#39;</span>
<span class="n">CHR_TO_NUM</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">CHARACTERS</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">parse_input</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">CHR_TO_NUM</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="p">]</span>
</code></pre></div>
</td></tr></table><p>Later on, we'll need to turn that back into a string; let's take care of it now:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">NUM_TO_CHR</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">CHARACTERS</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">format_2d</span><span class="p">(</span><span class="n">plane</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NUM_TO_CHR</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">plane</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table><p>We're not bothering to minimize the output like the example does
(hide empty rows/columns),
since we won't be looking at more than one layer per cycle anyway.</p>
<p>Having both functions, we can write a basic round-trip test:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">TEST_INPUT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">.#.</span>
<span class="s2">..#</span>
<span class="s2">###</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">assert</span> <span class="n">format_2d</span><span class="p">(</span><span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span> <span class="o">==</span> <span class="n">TEST_INPUT</span>
</code></pre></div>
</td></tr></table><h2 id="the-world">The world<span class="headerlink"> <a href="#the-world" title="permalink">#</a></span></h2>
<p>There's more than one way to represent the world,
but most straightforward should be the same we did the input,
as a nested list of integers.</p>
<p>The grid is supposed to be infinite;
there are no infinite lists in Python, so we have to cheat:
we'll make a big enough world, and check if we've reached the edges.</p>
<p>For now, 8 cubes ought to be enough for anyone:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">x_size</span> <span class="o">=</span> <span class="n">y_size</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">world</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_size</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_size</span><span class="p">)]</span>
</code></pre></div>
</td></tr></table><section class="admonition note">
<div class="admonition-text">
<p><code>[[0] * x_size] * y_size</code> won't work, because the outer list
 will contain the (same) inner list y_size times:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span>
<span class="go">[[0, 0, 0], [0, 0, 0], [0, 0, 0]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span>
<span class="go">[[1, 0, 0], [1, 0, 0], [1, 0, 0]]</span>
</code></pre></div>
</div>
</section>
<p>We'll place the input in the middle, to give it room to grow in all directions:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="nb">input</span> <span class="o">=</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">)</span>
<span class="n">x_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">y_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>

<span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="n">world</span><span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">][</span><span class="n">x</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">active</span>

<span class="nb">print</span><span class="p">(</span><span class="n">format_2d</span><span class="p">(</span><span class="n">world</span><span class="p">))</span>
</code></pre></div>
</td></tr></table><p>At this point, the script should output this:</p>
<pre class="code code-container"><code>........
........
...#....
....#...
..###...
........
........
........
</code></pre>
<h2 id="simulation">Simulation<span class="headerlink"> <a href="#simulation" title="permalink">#</a></span></h2>
<p>Let's simulate one cycle.</p>
<p>There are <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life#Algorithms">many optimizations</a> to this,
but again, we'll do the <a href="http://wiki.c2.com/?DoTheSimplestThingThatCouldPossiblyWork">straightforward thing</a>:
go through each cell, count its neighbors,
and change its state according to the rules.</p>
<p>The cube state changes <em>simultaneously</em> for all cubes,
so we cannot update the world in-place:
given two neighboring cubes updated in order,
the first cube's old state will be gone when we get to the second one.
To avoid this, we will use two worlds,
always reading from the old world and changing the new one.</p>
<p>We'll put the logic in a function that takes the two worlds as arguments:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">27</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
</code></pre></div>
</td></tr></table><p>Going through each cell:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">28</span>
<span class="normal">29</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
</code></pre></div>
</td></tr></table><p>The cell's neighbors are all the cells in a 3x3 square centered on it,
<em>except</em> the cell itself:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>            <span class="n">active_neighbors</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">i</span>
                    <span class="n">ny</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">j</span>
</code></pre></div>
</td></tr></table><p><code>old[ny][nx]</code> should now get us the neighbor's state;
however, there are a couple of (literal) edge cases:</p>
<ul>
<li>The current cell has one of the coordinates 0 (is on the top or left edge).
Due to how list indexing works, the neighbors to the top/left
(coordinate -1) will be cells from the opposite edge of the world.
We don't want this: the world is supposed to be infinite, not wrap around.</li>
<li>The current cell has one of the coordinates <code>size - 1</code>
(is on the bottom or right edge).
We'll get an IndexError when trying to get the bottom/right neighbor.</li>
</ul>
<p>In both cases, we want to know when the current cube is active,
since it's possible one of its out of bounds neighbors should become active:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>                    <span class="k">if</span> <span class="n">nx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ny</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">active_neighbors</span> <span class="o">+=</span> <span class="n">old</span><span class="p">[</span><span class="n">ny</span><span class="p">][</span><span class="n">nx</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
</code></pre></div>
</td></tr></table><section class="admonition note">
<div class="admonition-text">
<p>For now, the exceptions will remain unhandled,
 and we'll make the world bigger by hand when required.
 We <em>could</em> do something else, like catch the exception,
 scale the world by some constant factor, and continue simulating.</p>
</div>
</section>
<p>Having that, we set the cell's new state according to the rules:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>            <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                <span class="n">new_active</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">active_neighbors</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_active</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">active_neighbors</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>

            <span class="n">new</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_active</span>
</code></pre></div>
</td></tr></table><p>Let's call that 6 times.
Instead instead of creating a new world on each iteration,
we can reuse the old one from the previous iteration,
since we'd be throwing it away anyway.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">old</span> <span class="o">=</span> <span class="n">world</span>
<span class="n">new</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_size</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_size</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
    <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="o">=</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;after cycle #</span><span class="si">{</span><span class="n">cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">format_2d</span><span class="p">(</span><span class="n">old</span><span class="p">))</span>
</code></pre></div>
</td></tr></table><details>
<summary>Running the script should output this:</summary>
<pre class="code code-container"><code>........
........
...#....
....#...
..###...
........
........
........

after cycle #1
........
........
........
..#.#...
...##...
...#....
........
........

after cycle #2
........
........
........
....#...
..#.#...
...##...
........
........

after cycle #3
........
........
........
...#....
....##..
...##...
........
........

after cycle #4
........
........
........
....#...
.....#..
...###..
........
........

after cycle #5
........
........
........
........
...#.#..
....##..
....#...
........

after cycle #6
........
........
........
........
.....#..
...#.#..
....##..
........
</code></pre>
</details>
<p>A quick visual inspection confirms our simulation is correct.</p>
<section class="admonition note">
<div class="admonition-text">
<p>You may notice that after 4 cycles, we have the initial pattern,
 but moved one cell to the bottom and right;
 this pattern is called a <a href="https://en.wikipedia.org/wiki/Glider_(Conway%27s_Life)">glider</a>.</p>
</div>
</section>
<p>To wrap up, we'll calculate the puzzle answer
(the number of cubes left in the active state after the sixth cycle),
and add a test to make sure we won't break anything later on:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">world</span> <span class="o">=</span> <span class="n">old</span>

<span class="n">active_cubes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">active</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">world</span> <span class="k">for</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the result is&quot;</span><span class="p">,</span> <span class="n">active_cubes</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">active_cubes</span> <span class="o">==</span> <span class="mi">5</span>
<span class="k">assert</span> <span class="n">world</span> <span class="o">==</span> <span class="n">parse_input</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">........</span>
<span class="s2">........</span>
<span class="s2">........</span>
<span class="s2">........</span>
<span class="s2">.....#..</span>
<span class="s2">...#.#..</span>
<span class="s2">....##..</span>
<span class="s2">........</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p><a href="/_file/conway-cubes/10-simulation/conway_cubes.py">The script up to this point.</a></p>
<h2 id="cleaning-up">Cleaning up<span class="headerlink"> <a href="#cleaning-up" title="permalink">#</a></span></h2>
<p>Now that our 2D implementation is correct, we can make it more general.</p>
<p>We won't do that straight away, though;
to make it possible to call in multiple ways and generalize incrementally,
we'll split the script into functions.</p>
<section class="admonition tip">
<div class="admonition-text">
<p>Throughout these changes, our test suite should keep passing.</p>
<p>While working on the script, I used <a href="https://eradman.com/entrproject/">entr</a> to re-run it
 automatically on every save:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash"><span></span><code><span class="nb">echo</span> conway_cubes.py <span class="p">|</span> entr -rc python3 conway_cubes.py
</code></pre></div>
<p>Your editor may have have a &quot;save and run&quot; function;
 if it doesn't, <em>entr</em> is a nifty editor-independent way
 of achieving the same thing.</p>
</div>
</section>
<p>First, let's extract the neighbor-counting logic:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">get_active_neighbors</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">active_neighbors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">i</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">j</span>

            <span class="k">if</span> <span class="n">nx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ny</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">active_neighbors</span> <span class="o">+=</span> <span class="n">world</span><span class="p">[</span><span class="n">ny</span><span class="p">][</span><span class="n">nx</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="n">active_neighbors</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">active_neighbors</span> <span class="o">=</span> <span class="n">get_active_neighbors</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="c1"># ...</span>
</code></pre></div>
</td></tr></table><p>Then, the construction of worlds:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">66</span>
<span class="normal">67</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">make_world</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">72</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">world</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">87</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">new</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p>Then, the input copying:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">copy_centered_2d</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
    <span class="n">y_offset</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">x_offset</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">dst</span><span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">][</span><span class="n">x</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">84</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">copy_centered_2d</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">world</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p>Finally, let's wrap the whole solution in a function.</p>
<p>Again, to separate logic from presentation,
we'll split this into a generator that yields new states, forever;
it yields the initial state first for convenience:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate_forever</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="n">copy_centered_2d</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">old</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span>
        <span class="k">yield</span> <span class="n">old</span>
</code></pre></div>
</td></tr></table><p>... and a function that drives it for 6 cycles, printing the resulting worlds.</p>
<p>Since we want to use the function for more dimensions,
but don't want to implement formatting for anything except 2D,
we'll make printing optional through the magic of <a href="https://python-patterns.guide/gang-of-four/factory-method/#dodge-use-dependency-injection">dependency injection</a>.</p>
<p>Also, to keep the tests working,
we'll return the final state and the number of active cubes.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">format_world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">worlds</span> <span class="o">=</span> <span class="n">simulate_forever</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">world</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">worlds</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;after cycle #</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">format_world</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_world</span><span class="p">(</span><span class="n">world</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>

    <span class="n">active_cubes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">active</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">world</span> <span class="k">for</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the result is&quot;</span><span class="p">,</span> <span class="n">active_cubes</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">world</span><span class="p">,</span> <span class="n">active_cubes</span>


<span class="n">world</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">),</span> <span class="n">format_world</span><span class="o">=</span><span class="n">format_2d</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p><a href="/_file/conway-cubes/20-cleaning-up/conway_cubes.py">The script up to this point.</a></p>
<h2 id="going-multidimensional">Going multidimensional<span class="headerlink"> <a href="#going-multidimensional" title="permalink">#</a></span></h2>
<p>OK, we're ready now:
let's follow <code>simulate_forever</code> and make it work with N dimensions.</p>
<p>First, we'll fix <code>make_world</code>.</p>
<p>Instead of one size argument per dimension,
it will take a single argument, a tuple of sizes.
Using <code>size</code> or <code>sizes</code> as the name might be confusing
(since they are different <em>kinds</em> of sizes);
how about we call it <code>shape</code>?</p>
<p>To handle the arbitrary number of dimensions, <code>make_world</code> will be recursive:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">make_world</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
    <span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">shape</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rest</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">head</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">make_world</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">head</span><span class="p">)]</span>
</code></pre></div>
</td></tr></table><p>We now need to bubble this change up to <code>run</code>.
For convenience, it will keep its <code>size</code>, but get a new <code>dimensions</code> argument,
so we can have an n-dimensional &quot;square&quot; world.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate_forever</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">format_world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">worlds</span> <span class="o">=</span> <span class="n">simulate_forever</span><span class="p">((</span><span class="n">size</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dimensions</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">112</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">world</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">),</span> <span class="n">format_world</span><span class="o">=</span><span class="n">format_2d</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p>Next, input copying. For 2D, the destination was the world itself;
for higher dimensions, the destination is the (2D) plane in the middle
of each higher dimension:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate_forever</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">copy_dst</span> <span class="o">=</span> <span class="n">old</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">copy_dst</span> <span class="o">=</span> <span class="n">copy_dst</span><span class="p">[(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">copy_centered_2d</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">copy_dst</span><span class="p">)</span>

    <span class="c1"># ...</span>
</code></pre></div>
</td></tr></table><p>Continuing with <code>simulate</code>.
We need a generic version of the nested loop that goes over all the cells.
We'll write a version of <a href="https://docs.python.org/3/library/functions.html#enumerate">enumerate</a> that works with nested lists,
and instead of <em>i, value</em> pairs, yields <em>(..., k, j, i), value</em> pairs:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">ndenumerate</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dimensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">world</span>
        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">dimensions</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dimensions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">world</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">i</span><span class="p">,),</span> <span class="n">value</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">world</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ndenumerate</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">dimensions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">i</span><span class="p">,)</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="n">value</span>
</code></pre></div>
</td></tr></table><section class="admonition note">
<div class="admonition-text">
<p>You may notice we stole the function name <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndenumerate.html">from numpy</a>.
 In the first draft of this article it was called <code>coord_enumerate</code>
 and it generated <em>..., k, j, i, value</em> tuples,
 but I changed it to make things easier for people already familiar with numpy.</p>
<p>Unlike with numpy arrays, we have to infer the number of dimensions,
 since our world doesn't have an explicit shape.</p>
<p>Also unlike the numpy version, ours only works with lists;
 to make it work with other sequences,
 we could use something like:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nb">isinstance</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span>
</code></pre></div>
</div>
</section>
<p>We'll leave <code>get_active_neighbors</code> last, and finish <code>simulate</code> first:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">coords</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">ndenumerate</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
        <span class="n">active_neighbors</span> <span class="o">=</span> <span class="n">get_active_neighbors</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="o">*</span><span class="nb">reversed</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">new_active</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">active_neighbors</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_active</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">active_neighbors</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span>
        <span class="n">target</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">new_active</span>
</code></pre></div>
</td></tr></table><p><code>run</code> also goes through all the cubes to count the active ones,
so we'll change it to use <code>ndenumerate</code> as well:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">128</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">active_cubes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">active</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">ndenumerate</span><span class="p">(</span><span class="n">world</span><span class="p">))</span>
</code></pre></div>
</td></tr></table><p>Finally, let's do <code>get_active_neighbors</code>.</p>
<p>First, we need to flatten the loop that generates neighbor coordinates.</p>
<p>We could use recursion, like we did with <code>make_world</code> and <code>ndenumerate</code>,
but the standard library already has a tool for this:
<a href="https://docs.python.org/3/library/itertools.html#itertools.product">itertools.product</a> generates the cartesian product of some iterables;
even better, it can generate the product of an iterable with <em>itself</em>.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>


<span class="c1"># ...</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">make_directions</span><span class="p">(</span><span class="n">dimensions</span><span class="p">):</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">product</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="n">dimensions</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dimensions</span><span class="p">]</span>
</code></pre></div>
</td></tr></table><section class="admonition tip">
<div class="admonition-text">
<p>Even if itertools.product did not have a <code>repeat</code> argument,
 we could still emulate it with argument unpacking:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">product</span><span class="p">(</span><span class="o">*</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="n">dimensions</span><span class="p">)</span>
</code></pre></div>
</div>
</section>
<p>After using <code>make_directions</code>,
and making the neighbor counting parts generic as well,
<code>get_active_neighbors</code> becomes:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">get_active_neighbors</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
    <span class="n">active_neighbors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">offsets</span> <span class="ow">in</span> <span class="n">make_directions</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>

        <span class="n">neighbor_coords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">coord</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">offsets</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">coord</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">neighbor_coords</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="n">coords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">neighbor</span> <span class="o">=</span> <span class="n">world</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">neighbor_coords</span><span class="p">:</span>
                <span class="n">neighbor</span> <span class="o">=</span> <span class="n">neighbor</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="n">coords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">active_neighbors</span> <span class="o">+=</span> <span class="n">neighbor</span>

    <span class="k">return</span> <span class="n">active_neighbors</span>
</code></pre></div>
</td></tr></table><p>The last remaining thing is to fix its call site in <code>simulate</code>:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">83</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>        <span class="n">active_neighbors</span> <span class="o">=</span> <span class="n">get_active_neighbors</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p>We're done!</p>
<h2 id="3d">3D<span class="headerlink"> <a href="#3d" title="permalink">#</a></span></h2>
<p>After 6 cycles with the test input, there should be 112 active cubes:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">159</span>
<span class="normal">160</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">active_cubes</span> <span class="o">==</span> <span class="mi">112</span>
</code></pre></div>
</td></tr></table><p>It turns out 8 cubes is not enough:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python Traceback"><span></span><code><span class="x">after cycle #0: ...</span>
<span class="x">after cycle #1: ...</span>
<span class="x">after cycle #2: ...</span>
<span class="x">after cycle #3: ...</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;conway_cubes.py&quot;</span>, line <span class="m">161</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span>
  File <span class="nb">&quot;conway_cubes.py&quot;</span>, line <span class="m">131</span>, in <span class="n">run</span>
    <span class="k">for</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">world</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">worlds</span><span class="p">):</span>
  File <span class="nb">&quot;conway_cubes.py&quot;</span>, line <span class="m">123</span>, in <span class="n">simulate_forever</span>
    <span class="n">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
  File <span class="nb">&quot;conway_cubes.py&quot;</span>, line <span class="m">84</span>, in <span class="n">simulate</span>
    <span class="n">active_neighbors</span> <span class="o">=</span> <span class="n">get_active_neighbors</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
  File <span class="nb">&quot;conway_cubes.py&quot;</span>, line <span class="m">47</span>, in <span class="n">get_active_neighbors</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="n">coords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gr">RuntimeError</span>: <span class="n">active on edge: (2, 3, 0)</span>
</code></pre></div>
<p>Good thing we're checking for that.
Bumping the world size to 16 fixes it:</p>
<pre class="code code-container"><code>after cycle #0: ...
after cycle #1: ...
after cycle #2: ...
after cycle #3: ...
after cycle #4: ...
after cycle #5: ...
after cycle #6: ...
the result is 112
</code></pre>
<p>Time to plug the puzzle input; I assume they are different for everyone,
so feel free to use yours instead.</p>
<p>At first I got another <code>active on edge</code> error;
since running with the test input already takes about a second,
I increased the world size by smaller increments instead of doubling it;
20 is enough for my input:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">INPUT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">.##...#.</span>
<span class="s2">.#.###..</span>
<span class="s2">..##.#.#</span>
<span class="s2">##...#.#</span>
<span class="s2">#..#...#</span>
<span class="s2">#..###..</span>
<span class="s2">.##.####</span>
<span class="s2">..#####.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">INPUT</span><span class="p">))</span>
</code></pre></div>
</td></tr></table><p><code>the result is 386</code>, which unlocks the second part of the problem.</p>
<h2 id="4d">4D<span class="headerlink"> <a href="#4d" title="permalink">#</a></span></h2>
<p>Moving on to even higher dimensions:</p>
<p>The 4D cube count for the test input should be 848:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">active_cubes</span> <span class="o">==</span> <span class="mi">848</span>

<span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">INPUT</span><span class="p">))</span>
</code></pre></div>
</td></tr></table><p>... and after 10 seconds the first cycle hasn't ended yet.</p>
<p>Let's add some timings in <code>run</code> before we let this run any further.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">2</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">time</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">format_world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">worlds</span> <span class="o">=</span> <span class="n">simulate_forever</span><span class="p">((</span><span class="n">size</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dimensions</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>

    <span class="n">total_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">world</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">worlds</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;after cycle #</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s): &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">format_world</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_world</span><span class="p">(</span><span class="n">world</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>

        <span class="n">total_time</span> <span class="o">+=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">active_cubes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">active</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">ndenumerate</span><span class="p">(</span><span class="n">world</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the result is </span><span class="si">{</span><span class="n">active_cubes</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">world</span><span class="p">,</span> <span class="n">active_cubes</span>
</code></pre></div>
</td></tr></table><section class="admonition note">
<div class="admonition-text">
<p>We use <a href="https://docs.python.org/3/library/time.html#time.perf_counter">time.perf_counter</a> because it is the
 &quot;clock with the highest available resolution to measure a short duration&quot;;
 since the timescales we're dealing with don't probably need it,
 we could have used <a href="https://docs.python.org/3/library/time.html#time.monotonic">time.monotonic</a> (on Unix, they're <a href="https://github.com/python/cpython/blob/ae6cd7cfdab0599139002c526953d907696d9eef/Python/pytime.c#L1056-L1064">actually the same</a>).</p>
<p>In general, you should avoid <a href="https://docs.python.org/3/library/time.html#time.time">time.time</a> for measuring durations,
 because it can skip backward or forward (e.g. <a href="https://en.wikipedia.org/wiki/Daylight_saving_time">daylight saving time</a>),
 or move slower or faster than real time (e.g. <a href="https://en.wikipedia.org/wiki/Leap_second#Workarounds_for_leap_second_problems">leap smearing</a>).</p>
</div>
</section>
<p>After about 1 minute, I get the (correct) result for the test input.</p>
<p>After 2 more minutes, <code>the result is 2276</code>; this is also correct.</p>
<p><a href="/_file/conway-cubes/30-4d/conway_cubes.py">The script up to this point.</a></p>
<h2 id="conclusions">Conclusions<span class="headerlink"> <a href="#conclusions" title="permalink">#</a></span></h2>
<p>What have we learned?</p>
<p><strong>Sometimes, it's easier to start with a simpler problem,
and iterate towards the real one</strong>:
we did most of the coding for 2D, which was easier to understand and debug;
once we got that general enough, 3D and 4D <em>just worked</em>.</p>
<p><strong>Tests make refactoring quicker.</strong>
Even for &quot;exploratory&quot; coding like this,
when you don't know exactly what the final code will look like,
or even what you're trying to achieve,
some parts &quot;settle&quot; earlier than others;
once that happens,
a simple high-level test allows you to focus on the <em>next thing</em>
without having to constantly check
that stuff that <em>was</em> working is <em>still</em> working.</p>
<p>The 4D simulation is really slow ... <em>exponentially</em> slow.
We'll see at least one way of improving that in a future post.</p>
<h2 id="bonus-cli-and-tests">Bonus: CLI and tests<span class="headerlink"> <a href="#bonus-cli-and-tests" title="permalink">#</a></span></h2>
<p>When run, the script goes through all the tests
and then prints the results for the two parts of the problem
(3 and 4 dimensions).</p>
<p>Let's make it a bit easier to run a single simulation
with a specific world size, dimension, and number of cycles;
this will be useful when profiling.</p>
<p>First, we'll move the formatting test (line 22) and the other tests
to a new file, <code>test_conway_cubes.py</code>, and into test functions;
we leave <code>TEST_INPUT</code> in the module since we'll use it from the CLI as well.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>

<span class="kn">from</span> <span class="nn">conway_cubes</span> <span class="kn">import</span> <span class="n">TEST_INPUT</span><span class="p">,</span> <span class="n">format_2d</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">,</span> <span class="n">run</span>


<span class="k">def</span> <span class="nf">test_parse_roundtrip</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">format_2d</span><span class="p">(</span><span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span> <span class="o">==</span> <span class="n">TEST_INPUT</span>

<span class="k">def</span> <span class="nf">test_2</span><span class="p">():</span>
    <span class="n">world</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">),</span> <span class="n">format_world</span><span class="o">=</span><span class="n">format_2d</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">active_cubes</span> <span class="o">==</span> <span class="mi">5</span>
    <span class="k">assert</span> <span class="n">world</span> <span class="o">==</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        ........</span>
<span class="s2">        ........</span>
<span class="s2">        ........</span>
<span class="s2">        ........</span>
<span class="s2">        .....#..</span>
<span class="s2">        ...#.#..</span>
<span class="s2">        ....##..</span>
<span class="s2">        ........</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">test_3</span><span class="p">():</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">active_cubes</span> <span class="o">==</span> <span class="mi">112</span>

<span class="k">def</span> <span class="nf">test_4</span><span class="p">():</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">active_cubes</span> <span class="o">==</span> <span class="mi">848</span>
</code></pre></div>
</td></tr></table><p>We want to be able to run fewer cycles, so we add a new argument to <code>run</code>:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">120</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">format_world</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">125</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">for</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">world</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cycles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">worlds</span><span class="p">):</span>
</code></pre></div>
</td></tr></table><p>And then remove the rest of the top level code
in favor of a rudimentary CLI:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">TEST_INPUT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">.#.</span>
<span class="s2">..#</span>
<span class="s2">###</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">INPUT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">.##...#.</span>
<span class="s2">.#.###..</span>
<span class="s2">..##.#.#</span>
<span class="s2">##...#.#</span>
<span class="s2">#..#...#</span>
<span class="s2">#..###..</span>
<span class="s2">.##.####</span>
<span class="s2">..#####.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">TEST_INPUT</span><span class="p">,</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span> <span class="n">INPUT</span><span class="p">}[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">size</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">cycles</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">run</span><span class="p">(</span>
        <span class="n">size</span><span class="p">,</span>
        <span class="n">dimensions</span><span class="p">,</span>
        <span class="n">parse_input</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span>
        <span class="n">format_world</span><span class="o">=</span><span class="n">format_2d</span> <span class="k">if</span> <span class="n">dimensions</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cycles</span><span class="o">=</span><span class="n">cycles</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</code></pre></div>
</td></tr></table><p>We now can run the tests using <a href="https://docs.pytest.org/en/stable/">pytest</a>.
The 4D one takes a while; we use <code>-k</code> to skip it:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>pytest test_conway_cubes.py -q -k <span class="s1">&#39;not 4&#39;</span>
<span class="go">...                                                                      [100%]</span>
<span class="go">3 passed, 1 deselected in 1.14s</span>
</code></pre></div>
<p>The script is invoked like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python3 conway_cubes.py real <span class="m">20</span> <span class="m">4</span> <span class="m">6</span>
<span class="go">after cycle #0 (0.01s): ...</span>
<span class="go">after cycle #1 (24.15s): ...</span>
<span class="go">after cycle #2 (23.45s): ...</span>
<span class="go">after cycle #3 (23.79s): ...</span>
<span class="go">after cycle #4 (24.31s): ...</span>
<span class="go">after cycle #5 (24.15s): ...</span>
<span class="go">after cycle #6 (24.07s): ...</span>
<span class="go">the result is 2276 (143.94s)</span>
</code></pre></div>
<h2 id="bonus-more-tests">Bonus: more tests<span class="headerlink"> <a href="#bonus-more-tests" title="permalink">#</a></span></h2>
<p>Our tests cover the most common cases,
but there's something we neglected entirely:
edge cases.</p>
<p>At the moment, that's not necessarily an issue:
the code dealing with it is straightforward,
and the puzzle itself is testing it for us â€“
if we go over the edge and the script doesn't fail,
we won't get the right result.</p>
<p>However, the code <em>may</em> become less straightforward after optimizing it,
and we don't want to rely on the website for validation
every time we make a change.</p>
<p>Let's fix that.</p>
<p>The first test checks we get errors when there are active cells on the edges:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">3</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        #..</span>
<span class="sd">        ...</span>
<span class="sd">        ...</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        .#.</span>
<span class="sd">        ...</span>
<span class="sd">        ...</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        ...</span>
<span class="sd">        ..#</span>
<span class="sd">        ...</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        ...</span>
<span class="sd">        ...</span>
<span class="sd">        .#.</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;dimensions&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_edge_errors</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">dedent</span><span class="p">(</span><span class="nb">input</span><span class="p">)),</span> <span class="n">cycles</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p>Here, the <a href="https://docs.pytest.org/en/stable/parametrize.html#pytest-mark-parametrize">parametrize</a> decorator defines
4 different <code>input</code> and 3 different <code>dimensions</code> arguments,
so that the <code>test_edge_errors</code> function will run using them in turn,
in all possible combinations.</p>
<p>The second test checks that the new world can have active cells on the edges,
as long as the old one didn't:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;input, expected_output&#39;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">            .....</span>
<span class="sd">            .#...</span>
<span class="sd">            .#...</span>
<span class="sd">            .#...</span>
<span class="sd">            .....</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">            .....</span>
<span class="sd">            .....</span>
<span class="sd">            ###..</span>
<span class="sd">            .....</span>
<span class="sd">            .....</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">            .....</span>
<span class="sd">            .....</span>
<span class="sd">            .....</span>
<span class="sd">            .###.</span>
<span class="sd">            .....</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">            .....</span>
<span class="sd">            .....</span>
<span class="sd">            ..#..</span>
<span class="sd">            ..#..</span>
<span class="sd">            ..#..</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">),</span>

    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_edge_ok</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">expected_output</span><span class="p">):</span>
    <span class="n">world</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">dedent</span><span class="p">(</span><span class="nb">input</span><span class="p">)),</span> <span class="n">cycles</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">format_2d</span><span class="p">(</span><span class="n">world</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span><span class="n">expected_output</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p>Because of parametrization, we get 14 actual tests:
12 for <code>test_edge_errors</code>, and 2 for <code>test_edge_ok</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>pytest test_conway_cubes.py -q -k edge
<span class="go">..............                                                           [100%]</span>
<span class="go">14 passed, 4 deselected in 0.06s</span>
</code></pre></div>
<p>The <a href="/_file/conway-cubes/99-end/conway_cubes.py">final version of the script</a>
and <a href="/_file/conway-cubes/99-end/test_conway_cubes.py">test file</a>.</p>
<section class="footnotes">
<ol>
<li id="fn-1"><p>If you think that's a very conservative assumption, trust your instincts. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>










<hr>
<p>This is part of a series:</p>

<ul>


<li>
    <a href="/conway-cubes">Solving Advent of Code 2020 day 17 by not solving it</a> <small class="text-gray">(this article)</small>



<li>
    <a href="/fast-conway-cubes">Optimizing Advent of Code 2020 day 17</a>


</ul>







<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"

>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">


        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>




</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
âˆ™ <a href="/_feed/index.xml">feed</a>
âˆ™ <a href="/about">about</a>

âˆ™ Â© 2021 lemon24



</footer>


</div>