<!doctype html>

<meta name="viewport" content="width=device-width" />


<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />




<title>untitled - death and gravity</title>


<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RY2QR580X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-4RY2QR580X");
</script>



<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1>untitled</h1>

<p class="text-gray"><small>
2021-01-11


</small></p>

</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>... in which we'll take a look at <a href="https://adventofcode.com/2020/day/17">the day 17 problem from
Advent of Code 2020</a>, Conway Cubes.
We will end up solving it <em>eventually</em>,
but in a very roundabout way; you will see why <a href="#the-problem">shortly</a>.</p>
<p>Along the way, we will:</p>
<ul>
<li>test and refactor,</li>
<li>avoid hard problems, and</li>
<li>write some idiomatic Python.</li>
</ul>
<p>You can read this without having solved the problem,
but to get the most from it, I recommend you do it on your own first,
and then follow along as we do it again here.</p>
<details>
<summary>Contents</summary>
<section class="toc">
<ul>
<li><a href="#the-problem">The problem</a></li>
<li><a href="#parsing-the-input">Parsing the input</a></li>
<li><a href="#the-world">The world</a></li>
<li><a href="#simulation">Simulation</a></li>
<li><a href="#cleaning-up">Cleaning up</a></li>
<li><a href="#going-multidimensional">Going multidimensional</a></li>
<li><a href="#3d">3D</a></li>
<li><a href="#4d">4D</a></li>
<li><a href="#conclusions">Conclusions</a></li>
</ul>
</section>
</details>
<h2 id="the-problem">The problem<span class="headerlink"> <a href="#the-problem" title="permalink">#</a></span></h2>
<p>The problem might look familiar
(if you didn't read it yet, <a href="https://adventofcode.com/2020/day/17">go do that first</a>):</p>
<ul>
<li>we have a grid of cells that can be either <em>active</em> or <em>inactive</em></li>
<li>cells change state at each step in time depending on their neighbors</li>
</ul>
<p>These things are called <a href="https://en.wikipedia.org/wiki/Cellular_automaton">cellular automata</a>,
the most famous of which is probably Conway's <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Game of Life</a>.
Our problem seems to have the same rules as Life:</p>
<ul>
<li>any <em>active</em> cell with 2 or 3 <em>active</em> neighbors remains <em>active</em></li>
<li>any <em>inactive</em> cell with 3 <em>active</em> neighbors becomes <em>active</em></li>
<li>all other cells become/remain <em>inactive</em></li>
</ul>
<p>... except the grid is 3-dimensional.</p>
<details>
<summary>Minor spoiler alert:</summary>
<p>In part two of the problem, the grid is <em>4-dimensional</em>.</p>
</details>
<p>You might notice that this is relatively hard to visualize:
the example output has 5 layers after 3 cycles in 3 dimensions,
and 25 layers after only 2 cycles in 4 dimensions!
Understanding what's happening in 4D seems difficult
even assuming the number of planes remains 25 for future iterations.<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup></p>
<p>The normal flow of solving the problem would be something like this:</p>
<ul>
<li>implement the 3D version; then,</li>
<li>after seeing the second part, either<ul>
<li>do 4D in a similar fashion, or</li>
<li>generalize 3D to an arbitrary number of dimensions.</li>
</ul>
</li>
</ul>
<p><strong>We'll do the opposite</strong>:
implement 2D, which is trivial to check by hand,
and once we have some tests, generalize <em>that</em>.</p>
<h2 id="parsing-the-input">Parsing the input<span class="headerlink"> <a href="#parsing-the-input" title="permalink">#</a></span></h2>
<p>First, let's parse the input.</p>
<p>We'll transform the input string into a list of lists of integers,
where 0 and 1 represent inactive and active cubes, respectively.
For the test input, it should look like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</code></pre></div>
<p>Using numbers <a href="https://en.wikipedia.org/wiki/Separation_of_concerns">separates concerns</a>, but also allows for nicer code:
we can write <code>if active</code> instead of <code>if active == '#'</code>, and
<code>sum(cubes)</code> instead of <code>sum(active == '#' for active in cubes)</code>.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>1
2
3
4
5
6
7
8</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">CHARACTERS</span> <span class="o">=</span> <span class="s1">&#39;.#&#39;</span>
<span class="n">CHR_TO_NUM</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">CHARACTERS</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">parse_input</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">CHR_TO_NUM</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="p">]</span>
</code></pre></div>
</td></tr></table><p>Later on, we'll need to turn that back into a string; let's take care of it now:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>10
11
12
13
14
15
16</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">NUM_TO_CHR</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">CHARACTERS</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">format_2d</span><span class="p">(</span><span class="n">plane</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NUM_TO_CHR</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">plane</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table><p>We're not bothering to minimize the output like the example does
(hide empty rows/columns),
since we won't be looking at more than one layer per cycle anyway.</p>
<p>Having both functions, we can write a basic round-trip test:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>18
19
20
21
22
23
24</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">TEST_INPUT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">.#.</span>
<span class="s2">..#</span>
<span class="s2">###</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">assert</span> <span class="n">format_2d</span><span class="p">(</span><span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span> <span class="o">==</span> <span class="n">TEST_INPUT</span>
</code></pre></div>
</td></tr></table><h2 id="the-world">The world<span class="headerlink"> <a href="#the-world" title="permalink">#</a></span></h2>
<p>There's more than one way to represent the world,
but most straightforward should be the same we did the input,
as a nested list of integers.</p>
<p>The grid is supposed to be infinite;
there are no infinite lists in Python, so we have to cheat:
we'll make a big enough world, and check if we've reached the edges.</p>
<p>For now, 8 cubes ought to be enough for anyone:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>27
28
29</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">x_size</span> <span class="o">=</span> <span class="n">y_size</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">world</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_size</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_size</span><span class="p">)]</span>
</code></pre></div>
</td></tr></table><section class="admonition note">
<div class="admonition-text">
<p><code>[[0] * x_size] * y_size</code> won't work, because the outer list
 will contain the (same) inner list y_size times:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span>
<span class="go">[[0, 0, 0], [0, 0, 0], [0, 0, 0]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span>
<span class="go">[[1, 0, 0], [1, 0, 0], [1, 0, 0]]</span>
</code></pre></div>
</div>
</section>
<p>We'll place the input in the middle, to give it room to grow in all directions:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>32
33
34
35
36
37
38
39
40</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="nb">input</span> <span class="o">=</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">)</span>
<span class="n">x_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">y_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>

<span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="n">world</span><span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">][</span><span class="n">x</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">active</span>

<span class="nb">print</span><span class="p">(</span><span class="n">format_2d</span><span class="p">(</span><span class="n">world</span><span class="p">))</span>
</code></pre></div>
</td></tr></table><p>At this point, the script should output this:</p>
<pre class="code code-container"><code>........
........
...#....
....#...
..###...
........
........
........
</code></pre>
<h2 id="simulation">Simulation<span class="headerlink"> <a href="#simulation" title="permalink">#</a></span></h2>
<p>Let's simulate one cycle.</p>
<p>There are <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life#Algorithms">many optimizations</a> to this,
but again, we'll do the <a href="http://wiki.c2.com/?DoTheSimplestThingThatCouldPossiblyWork">straightforward thing</a>:
go through each cell, count its neighbors,
and change its state according to the rules.</p>
<p>The cube state changes <em>simultaneously</em> for all cubes,
so we cannot update the world in-place:
given two neighboring cubes updated in order,
the first cube's old state will be gone when we get to the second one.
To avoid this, we will use two worlds,
always reading from the old world and changing the new one.</p>
<p>We'll put the logic in a function that takes the two worlds as arguments:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>27</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
</code></pre></div>
</td></tr></table><p>Going through each cell:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>28
29</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
</code></pre></div>
</td></tr></table><p>The cell's neighbors are all the cells in a 3x3 square centered on it,
<em>except</em> the cell itself:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>31
32
33
34
35
36
37
38
39</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>            <span class="n">active_neighbors</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">i</span>
                    <span class="n">ny</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">j</span>
</code></pre></div>
</td></tr></table><p><code>old[ny][nx]</code> should now get us the neighbor's state;
however, there are a couple of (literal) edge cases:</p>
<ul>
<li>The current cell has one of the coordinates 0 (is on the top or left edge).
Due to how list indexing works, the neighbors to the top/left
(coordinate -1) will be cells from the opposite edge of the world.
We don't want this: the world is supposed to be infinite, not wrap around.</li>
<li>The current cell has one of the coordinates <code>size - 1</code>
(is on the bottom or right edge).
We'll get an IndexError when trying to get the bottom/right neighbor.</li>
</ul>
<p>In both cases, we want to know when the current cube is active,
since it's possible one of its out of bounds neighbors should become active:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>41
42
43
44
45
46
47
48
49
50
51</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>                    <span class="k">if</span> <span class="n">nx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ny</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">active_neighbors</span> <span class="o">+=</span> <span class="n">old</span><span class="p">[</span><span class="n">ny</span><span class="p">][</span><span class="n">nx</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
</code></pre></div>
</td></tr></table><section class="admonition note">
<div class="admonition-text">
<p>For now, the exceptions will remain unhandled,
 and we'll make the world bigger by hand when required.
 We <em>could</em> do something else, like catch the exception,
 scale the world by some constant factor, and continue simulating.</p>
</div>
</section>
<p>Having that, we set the cell's new state according to the rules:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>53
54
55
56
57
58</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>            <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                <span class="n">new_active</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">active_neighbors</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_active</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">active_neighbors</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>

            <span class="n">new</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_active</span>
</code></pre></div>
</td></tr></table><p>Let's call that 6 times.
Instead instead of creating a new world on each iteration,
we can reuse the old one from the previous iteration,
since we'd be throwing it away anyway.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>77
78
79
80
81
82
83
84</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">old</span> <span class="o">=</span> <span class="n">world</span>
<span class="n">new</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_size</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_size</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
    <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="o">=</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;after cycle #</span><span class="si">{</span><span class="n">cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">format_2d</span><span class="p">(</span><span class="n">old</span><span class="p">))</span>
</code></pre></div>
</td></tr></table><details>
<summary>Running the script should output this:</summary>
<pre class="code code-container"><code>........
........
...#....
....#...
..###...
........
........
........

after cycle #1
........
........
........
..#.#...
...##...
...#....
........
........

after cycle #2
........
........
........
....#...
..#.#...
...##...
........
........

after cycle #3
........
........
........
...#....
....##..
...##...
........
........

after cycle #4
........
........
........
....#...
.....#..
...###..
........
........

after cycle #5
........
........
........
........
...#.#..
....##..
....#...
........

after cycle #6
........
........
........
........
.....#..
...#.#..
....##..
........
</code></pre>
</details>
<p>A quick visual inspection confirms our simulation is correct.</p>
<section class="admonition note">
<div class="admonition-text">
<p>You may notice that after 4 cycles, we have the initial pattern,
 but moved one cell to the bottom and right;
 this pattern is called a <a href="https://en.wikipedia.org/wiki/Glider_(Conway%27s_Life)">glider</a>.</p>
</div>
</section>
<p>To wrap up, we'll calculate the puzzle answer
(the number of cubes left in the active state after the sixth cycle),
and add a test to make sure we won't break anything later on:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code> 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">world</span> <span class="o">=</span> <span class="n">old</span>

<span class="n">active_cubes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">active</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">world</span> <span class="k">for</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the result is&quot;</span><span class="p">,</span> <span class="n">active_cubes</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">active_cubes</span> <span class="o">==</span> <span class="mi">5</span>
<span class="k">assert</span> <span class="n">world</span> <span class="o">==</span> <span class="n">parse_input</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">........</span>
<span class="s2">........</span>
<span class="s2">........</span>
<span class="s2">........</span>
<span class="s2">.....#..</span>
<span class="s2">...#.#..</span>
<span class="s2">....##..</span>
<span class="s2">........</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><h2 id="cleaning-up">Cleaning up<span class="headerlink"> <a href="#cleaning-up" title="permalink">#</a></span></h2>
<p>Now that our 2D implementation is correct, we can make it more general.</p>
<p>We won't do that straight away, though;
to make it possible to call in multiple ways and generalize incrementally,
we'll split the script into functions.</p>
<section class="admonition tip">
<div class="admonition-text">
<p>Throughout these changes, our test suite should keep passing.</p>
<p>While working on the script, I used <a href="https://eradman.com/entrproject/">entr</a> to re-run it
 automatically on every save:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash"><span></span><code><span class="nb">echo</span> conway-cubes.py <span class="p">|</span> entr -rc python conway-cubes.py
</code></pre></div>
<p>Your editor may have have a &quot;save and run&quot; function;
 if it doesn't, <em>entr</em> is a nifty editor-independent way
 of achieving the same thing.</p>
</div>
</section>
<p>First, let's extract the neighbor-counting logic:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">get_active_neighbors</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">active_neighbors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">i</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">j</span>

            <span class="k">if</span> <span class="n">nx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ny</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">active_neighbors</span> <span class="o">+=</span> <span class="n">world</span><span class="p">[</span><span class="n">ny</span><span class="p">][</span><span class="n">nx</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="n">active_neighbors</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>53
54
55
56
57</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">active_neighbors</span> <span class="o">=</span> <span class="n">get_active_neighbors</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="c1"># ...</span>
</code></pre></div>
</td></tr></table><p>Then, the construction of worlds:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>66
67</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">make_world</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>72</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">world</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>87</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">new</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p>Then, the input copying:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>70
71
72
73
74
75</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">copy_centered_2d</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
    <span class="n">y_offset</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">x_offset</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">dst</span><span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">][</span><span class="n">x</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>84</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">copy_centered_2d</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">world</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p>Finally, let's wrap the whole solution in a function.</p>
<p>Again, to separate logic from presentation,
we'll split this into a generator that yields new states, forever;
it yields the initial state first for convenience:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>78
79
80
81
82
83
84
85
86
87
88</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate_forever</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="n">copy_centered_2d</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">old</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span>
        <span class="k">yield</span> <span class="n">old</span>
</code></pre></div>
</td></tr></table><p>... and a function that drives it for 6 cycles, printing the resulting worlds.</p>
<p>Since we want to use the function for more dimensions,
but don't want to implement formatting for anything except 2D,
we'll make printing optional through the magic of <a href="https://python-patterns.guide/gang-of-four/factory-method/#dodge-use-dependency-injection">dependency injection</a>.</p>
<p>Also, to keep the tests working,
we'll return the final state and the number of active cubes.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code> 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">format_world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">worlds</span> <span class="o">=</span> <span class="n">simulate_forever</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">world</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">worlds</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;after cycle #</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">format_world</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_world</span><span class="p">(</span><span class="n">world</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>

    <span class="n">active_cubes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">active</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">world</span> <span class="k">for</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the result is&quot;</span><span class="p">,</span> <span class="n">active_cubes</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">world</span><span class="p">,</span> <span class="n">active_cubes</span>


<span class="n">world</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">),</span> <span class="n">format_world</span><span class="o">=</span><span class="n">format_2d</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><h2 id="going-multidimensional">Going multidimensional<span class="headerlink"> <a href="#going-multidimensional" title="permalink">#</a></span></h2>
<p>OK, we're ready now:
let's follow <code>simulate_forever</code> and make it work with N dimensions.</p>
<p>First, we'll fix <code>make_world</code>.</p>
<p>Instead of one size argument per dimension,
it will take a single argument, a tuple of sizes.
Using <code>size</code> or <code>sizes</code> as the name might be confusing
(since they are different <em>kinds</em> of sizes);
how about we call it <code>shape</code>?</p>
<p>To handle the arbitrary number of dimensions, <code>make_world</code> will be recursive:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>68
69
70
71
72</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">make_world</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
    <span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">shape</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rest</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">head</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">make_world</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">head</span><span class="p">)]</span>
</code></pre></div>
</td></tr></table><p>We now need to bubble this change up to <code>run</code>.
For convenience, it will keep its <code>size</code>, but get a new <code>dimensions</code> argument,
so we can have an n-dimensional &quot;square&quot; world.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>83
84
85
86</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate_forever</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>96
97
98</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">format_world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">worlds</span> <span class="o">=</span> <span class="n">simulate_forever</span><span class="p">((</span><span class="n">size</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dimensions</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>113</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">world</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">),</span> <span class="n">format_world</span><span class="o">=</span><span class="n">format_2d</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p>Next, input copying. For 2D, the destination was the world itself;
for higher dimensions, the destination is the (2D) plane in the middle
of each higher dimension:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>83
84
85
86
87
88
89
90
91
92</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate_forever</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">make_world</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">copy_dst</span> <span class="o">=</span> <span class="n">old</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">copy_dst</span> <span class="o">=</span> <span class="n">copy_dst</span><span class="p">[(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">copy_centered_2d</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">copy_dst</span><span class="p">)</span>

    <span class="c1"># ...</span>
</code></pre></div>
</td></tr></table><p>Continuing with <code>simulate</code>.
We need a generic version of the nested loop that goes over all the cells.
We'll write a version of <a href="https://docs.python.org/3/library/functions.html#enumerate">enumerate</a> that works with nested lists,
and instead of <em>i, value</em> pairs, yields <em>(..., k, j, i), value</em> pairs:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">ndenumerate</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dimensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">world</span>
        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">dimensions</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dimensions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">world</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">i</span><span class="p">,),</span> <span class="n">value</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">world</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ndenumerate</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">dimensions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">i</span><span class="p">,)</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="n">value</span>
</code></pre></div>
</td></tr></table><section class="admonition note">
<div class="admonition-text">
<p>You may notice we stole the function name <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndenumerate.html">from numpy</a>.
 In the first draft of this article it was called <code>coord_enumerate</code>
 and it generated <em>..., k, j, i, value</em> tuples,
 but I changed it to make things easier for people already familiar with numpy.</p>
<p>Unlike with numpy arrays, we have to infer the number of dimensions,
 since our world doesn't have an explicit shape.</p>
<p>Also unlike the numpy version, ours only works with lists;
 to make it work with other sequences,
 we could use something like:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nb">isinstance</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span>
</code></pre></div>
</div>
</section>
<p>We'll leave <code>get_active_neighbors</code> last, and finish <code>simulate</code> first:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>73
74
75
76
77
78
79
80
81
82
83
84
85</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">coords</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">ndenumerate</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
        <span class="n">active_neighbors</span> <span class="o">=</span> <span class="n">get_active_neighbors</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="o">*</span><span class="nb">reversed</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">new_active</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">active_neighbors</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_active</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">active_neighbors</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span>
        <span class="n">target</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">new_active</span>
</code></pre></div>
</td></tr></table><p><code>run</code> also goes through all the cubes to count the active ones,
so we'll change it to use <code>ndenumerate</code> as well:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>131</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">active_cubes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">active</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">ndenumerate</span><span class="p">(</span><span class="n">world</span><span class="p">))</span>
</code></pre></div>
</td></tr></table><p>Finally, let's do <code>get_active_neighbors</code>.</p>
<p>First, we need to flatten the loop that generates neighbor coordinates.</p>
<p>We could use recursion, like we did with <code>make_world</code> and <code>ndenumerate</code>,
but the standard library already has a tool for this:
<a href="https://docs.python.org/3/library/itertools.html#itertools.product">itertools.product</a> generates the cartesian product of some iterables;
even better, it can generate the product of an iterable with <em>itself</em>.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>1</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>30
31
32</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">make_directions</span><span class="p">(</span><span class="n">dimensions</span><span class="p">):</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">product</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="n">dimensions</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dimensions</span><span class="p">]</span>
</code></pre></div>
</td></tr></table><section class="admonition tip">
<div class="admonition-text">
<p>Even if itertools.product did not have a <code>repeat</code> argument,
 we could still emulate it with argument unpacking:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">product</span><span class="p">(</span><span class="o">*</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="n">dimensions</span><span class="p">)</span>
</code></pre></div>
</div>
</section>
<p>After using <code>make_directions</code>,
and making the neighbor counting parts generic as well,
<code>get_active_neighbors</code> becomes:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">get_active_neighbors</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
    <span class="n">active_neighbors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">offsets</span> <span class="ow">in</span> <span class="n">make_directions</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>

        <span class="n">neighbor_coords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">coord</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">offsets</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">coord</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">neighbor_coords</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="n">coords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">neighbor</span> <span class="o">=</span> <span class="n">world</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">neighbor_coords</span><span class="p">:</span>
                <span class="n">neighbor</span> <span class="o">=</span> <span class="n">neighbor</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="n">coords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">active_neighbors</span> <span class="o">+=</span> <span class="n">neighbor</span>

    <span class="k">return</span> <span class="n">active_neighbors</span>
</code></pre></div>
</td></tr></table><p>The last remaining thing is to fix its call site in <code>simulate</code>:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>83</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>        <span class="n">active_neighbors</span> <span class="o">=</span> <span class="n">get_active_neighbors</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
</code></pre></div>
</td></tr></table><p>We're done!</p>
<h2 id="3d">3D<span class="headerlink"> <a href="#3d" title="permalink">#</a></span></h2>
<p>After 6 cycles with the test input, there should be 112 active cubes:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>159
160</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">active_cubes</span> <span class="o">==</span> <span class="mi">112</span>
</code></pre></div>
</td></tr></table><p>It turns out 8 cubes is not enough:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python Traceback"><span></span><code><span class="x">after cycle #0: ...</span>
<span class="x">after cycle #1: ...</span>
<span class="x">after cycle #2: ...</span>
<span class="x">after cycle #3: ...</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;conway-cubes.py&quot;</span>, line <span class="m">161</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span>
  File <span class="nb">&quot;conway-cubes.py&quot;</span>, line <span class="m">131</span>, in <span class="n">run</span>
    <span class="k">for</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">world</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">worlds</span><span class="p">):</span>
  File <span class="nb">&quot;conway-cubes.py&quot;</span>, line <span class="m">123</span>, in <span class="n">simulate_forever</span>
    <span class="n">simulate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
  File <span class="nb">&quot;conway-cubes.py&quot;</span>, line <span class="m">84</span>, in <span class="n">simulate</span>
    <span class="n">active_neighbors</span> <span class="o">=</span> <span class="n">get_active_neighbors</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
  File <span class="nb">&quot;conway-cubes.py&quot;</span>, line <span class="m">47</span>, in <span class="n">get_active_neighbors</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active on edge: </span><span class="si">{</span><span class="n">coords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gr">RuntimeError</span>: <span class="n">active on edge: (2, 3, 0)</span>
</code></pre></div>
<p>Good thing we're checking for that.
Bumping the world size to 16 fixes it:</p>
<pre class="code code-container"><code>after cycle #0: ...
after cycle #1: ...
after cycle #2: ...
after cycle #3: ...
after cycle #4: ...
after cycle #5: ...
after cycle #6: ...
the result is 112
</code></pre>
<p>Time to plug the puzzle input; I assume they are different for everyone,
so feel free to use yours instead.</p>
<p>At first I got another <code>active on edge</code> error;
since running with the test input already takes about a second,
I increased the world size by smaller increments instead of doubling it;
20 is enough for my input:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>162
163
164
165
166
167
168
169
170
171
172
173</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">INPUT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">.##...#.</span>
<span class="s2">.#.###..</span>
<span class="s2">..##.#.#</span>
<span class="s2">##...#.#</span>
<span class="s2">#..#...#</span>
<span class="s2">#..###..</span>
<span class="s2">.##.####</span>
<span class="s2">..#####.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">INPUT</span><span class="p">))</span>
</code></pre></div>
</td></tr></table><p><code>the result is 386</code>, which unlocks the second part of the problem.</p>
<h2 id="4d">4D<span class="headerlink"> <a href="#4d" title="permalink">#</a></span></h2>
<p>Moving on to even higher dimensions:</p>
<p>The 4D cube count for the test input should be 848:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>175
176
177
178</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">TEST_INPUT</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">active_cubes</span> <span class="o">==</span> <span class="mi">848</span>

<span class="n">_</span><span class="p">,</span> <span class="n">active_cubes</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">INPUT</span><span class="p">))</span>
</code></pre></div>
</td></tr></table><p>... and after 10 seconds the first cycle hasn't ended yet.</p>
<p>Let's add some timings in <code>run</code> before we let this run any further.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>2</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">time</span>
</code></pre></div>
</td></tr></table><table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code>128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150</code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">format_world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">worlds</span> <span class="o">=</span> <span class="n">simulate_forever</span><span class="p">((</span><span class="n">size</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dimensions</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>

    <span class="n">total_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">world</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">worlds</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;after cycle #</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s): &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">format_world</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_world</span><span class="p">(</span><span class="n">world</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>

        <span class="n">total_time</span> <span class="o">+=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">active_cubes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">active</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">ndenumerate</span><span class="p">(</span><span class="n">world</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the result is </span><span class="si">{</span><span class="n">active_cubes</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">world</span><span class="p">,</span> <span class="n">active_cubes</span>
</code></pre></div>
</td></tr></table><section class="admonition note">
<div class="admonition-text">
<p>We use <a href="https://docs.python.org/3/library/time.html#time.perf_counter">time.perf_counter</a> because it is the
 &quot;clock with the highest available resolution to measure a short duration&quot;;
 since the timescales we're dealing with don't probably need it,
 we could have used <a href="https://docs.python.org/3/library/time.html#time.monotonic">time.monotonic</a> (on Unix, they're <a href="https://github.com/python/cpython/blob/ae6cd7cfdab0599139002c526953d907696d9eef/Python/pytime.c#L1056-L1064">actually the same</a>).</p>
<p>In general, you should avoid <a href="https://docs.python.org/3/library/time.html#time.time">time.time</a> for measuring durations,
 because it can skip backward or forward (e.g. <a href="https://en.wikipedia.org/wiki/Daylight_saving_time">daylight saving time</a>),
 or move slower or faster than real time (e.g. <a href="https://en.wikipedia.org/wiki/Leap_second#Workarounds_for_leap_second_problems">leap smearing</a>).</p>
</div>
</section>
<p>After about 1 minute, I get the (correct) result for the test input.</p>
<p>After 2 more minutes, <code>the result is 2276</code>; this is also correct.</p>
<h2 id="conclusions">Conclusions<span class="headerlink"> <a href="#conclusions" title="permalink">#</a></span></h2>
<p>What have we learned?</p>
<p><strong>Sometimes, it's easier to start with a simpler problem,
and iterate towards the real one</strong>:
we did most of the coding for 2D, which was easier to understand and debug;
once we got that general enough, 3D and 4D <em>just worked</em>.</p>
<p><strong>Tests make refactoring quicker.</strong>
Even for &quot;exploratory&quot; coding like this,
when you don't know exactly what the final code will look like,
or even what you're trying to achieve,
some parts &quot;settle&quot; earlier than others;
once that happens,
a simple high-level test allows you to focus on the <em>next thing</em>
without having to constantly check
that stuff that <em>was</em> working is <em>still</em> working.</p>
<p>The 4D simulation is really slow ... <em>exponentially</em> slow.
We'll see at least one way of improving that in a future post.</p>
<section class="footnotes">
<ol>
<li id="fn-1"><p>If you think that's a very conservative assumption, trust your instincts. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>





<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661"
    method="post"
    id="mc-embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"

>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">


        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>



</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
 <a href="/_feed/index.xml">feed</a>
 <a href="/about">about</a>

  2021 lemon24
</footer>


</div>