












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>Running async code from sync in Python asyncio - death and gravity</title>
<meta name="description" content="So, you&#39;re doing some sync stuff. But you also need to do some async stuff, without making *everything* async. Hint: asyncio.Runner will get you at least part of the way there." />


<meta property="og:title" content="Running async code from sync in Python asyncio">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/asyncio-bridge">
<meta property="og:description" content="So, you&#39;re doing some sync stuff. But you also need to do some async stuff, without making *everything* async. Hint: asyncio.Runner will get you at least part of the way there.">



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RY2QR580X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-4RY2QR580X");
</script>



<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Running async code from sync in Python asyncio</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2023-07-29">July 2023</span>
∙ 10 minute read
∙
</small><span class="share-icons">
<a
    class="share-icon pycoders"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/asyncio-bridge&t=Running%20async%20code%20from%20sync%20in%20Python%20asyncio"
>HN</a>
<a
    class="share-icon bluesky"
    href="https://bsky.%61%70%70/intent/compose?text=Running%20async%20code%20from%20sync%20in%20Python%20asyncio%20https%3A//death.andgravity.com/asyncio-bridge"
>Bluesky</a>
<!--
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/asyncio-bridge&title=Running%20async%20code%20from%20sync%20in%20Python%20asyncio"
>Reddit</a>
-->
<a
    class="share-icon linkedin"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/asyncio-bridge"
>linkedin</a>
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Running%20async%20code%20from%20sync%20in%20Python%20asyncio&url=https%3A//death.andgravity.com/asyncio-bridge&via=_andgravity"
>Twitter</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>So, you're doing some sync stuff.</p>
<p>But you also need to do <a class="internal" href="/limit-concurrency">some async stuff</a>,
<strong>without</strong> making <strong>everything async</strong>.</p>
<p>Maybe the sync stuff is an existing application.</p>
<p>Maybe you still want to use <a class="internal" href="/output">your favorite sync library</a>.</p>
<p>Or maybe you need just <a class="external" href="https://twitter.com/_andgravity/status/1678431313332785152" title="as a treat">a little async</a>,
without having to pay the full price.</p>
<p>Of course,
you can run a coroutine with <a class="external" href="https://docs.python.org/3/library/asyncio-runner.html#asyncio.run">asyncio.run()</a>,
and blocking sync code from a coroutine with <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.to_thread">asyncio.to_thread()</a>,
but the former isn't granular enough,
and the latter doesn't solve async code being at the top.</p>
<p>As always, there must be a better way.</p>
<hr />
<p>Maybe something like this?</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">do_stuff</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stuff</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
   <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
       <span class="k">yield</span> <span class="n">n</span>

<span class="n">runner</span> <span class="o">=</span> <span class="n">ThreadRunner</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>  <span class="c1"># 8</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">runner</span><span class="o">.</span><span class="n">wrap_iter</span><span class="p">(</span><span class="n">generate_stuff</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>  <span class="c1"># 0 1 2 3</span>
</code></pre></div>
<!--
```python
session = runner.enter_context(factory=aiohttp.ClientSession)
coroutine = session.get('https://death.andgravity.com/')
with runner.wrap_context(coroutine) as response:
    lines = list(runner.wrap_iter(response.content))
print('got', len(lines), 'lines')  # got 624 lines
```
-->
<p>Now, it would take a long time to fully explore
how you might build up to such a thing
and why you would actually need it...
so that's exactly what we're going to do.</p>
<!--
Now, it would take a long time to fully explore
all the different ways that you would feel this music,
feel this 9 8 groove,
and so that's exactly what we're going to do.
-->
<section class="toc">
<ul>
<li><a href="#but-i-need-to-do-the-thing-more-than-once">But I need to do the thing more than once</a></li>
<li><a href="#but-i-want-a-long-lived-event-loop">But I want a long-lived event loop</a></li>
<li><a href="#but-i-want-a-long-lived-session">But I want a long-lived session</a></li>
<li><a href="#but-i-want-to-do-something-else-during-the-async-stuff">But I want to do something else during the async stuff</a></li>
<li><a href="#but-i-want-to-do-async-stuff-from-multiple-threads">But I want to do async stuff from multiple threads</a></li>
<li><a href="#but-i-don-t-want-to-manage-async-context-managers-by-hand">But I don't want to manage async context managers by hand</a></li>
<li><a href="#but-i-want-to-use-async-iterables">But I want to use async iterables</a></li>
<li><a href="#so-should-you-do-this">So, should you do this?</a></li>
</ul>
</section>
<!-- # Getting started -->
<h2 id="but-i-need-to-do-the-thing-more-than-once">But I need to do the thing more than once<span class="headerlink">&nbsp;<a href="#but-i-need-to-do-the-thing-more-than-once" title="permalink">#</a></span></h2>
<p>To make our example more life-like,
we'll make some requests using <a class="external" href="https://docs.aiohttp.org/">aiohttp</a>.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">do_stuff</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://death.andgravity.com/&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s1">&#39;in loop&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">loop</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<p>We create the session separately,
since we might want to reuse it later on.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">do_stuff</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p><a class="external" href="https://docs.python.org/3/library/asyncio-runner.html#asyncio.run">asyncio.run()</a> allows you to execute a coroutine
in a transient event loop;
it's meant to be the entry point of your program,
and &quot;should ideally only be called once&quot;
– but you <em>can</em> call it multiple times:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">20</span>
<span class="normal">21</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>brigde.py
<span class="go">got 200 in loop 4399589904</span>
<span class="go">got 200 in loop 4386034640</span>
</code></pre></div>
<!-- # Same loop -->
<h2 id="but-i-want-a-long-lived-event-loop">But I want a long-lived event loop<span class="headerlink">&nbsp;<a href="#but-i-want-a-long-lived-event-loop" title="permalink">#</a></span></h2>
<p>Of course,
creating and cleaning up a loop for each call isn't that efficient,
and we might have loop-bound resources that need to live across calls.</p>
<p>With a bit of diving into <a class="external" href="https://docs.python.org/3/library/asyncio-eventloop.html">asyncio guts</a>,
we can manage our own long-lived loop:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">shutdown_asyncgens</span><span class="p">())</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">shutdown_default_executor</span><span class="p">())</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>These are low-level APIs, so a bit of care is needed to use them correctly:</p>
<ul>
<li>We could have used <a class="external" href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.get_event_loop">get_event_loop()</a> to both create and set the loop,
but this behavior was deprecated in Python 3.10.</li>
<li><a class="external" href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.close">loop.close()</a> already schedules executor shutdown,
but does not wait for it to finish;
for predictable behavior,
it's best to wait cleanup tasks explicitly.</li>
</ul>
<p>Anyway, it works – note the loop id:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>brigde.py
<span class="go">got 200 in loop 4509807312</span>
<span class="go">got 200 in loop 4509807312</span>
</code></pre></div>
<!-- ## Runner -->
<p>Thankfully, starting with Python 3.11, <a class="external" href="https://docs.python.org/3/library/asyncio-runner.html#asyncio.Runner">asyncio.Runner</a> makes this much easier:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>

<!-- # Same loop -->
<h2 id="but-i-want-a-long-lived-session">But I want a long-lived session<span class="headerlink">&nbsp;<a href="#but-i-want-a-long-lived-session" title="permalink">#</a></span></h2>
<p>Reusing the loop is not enough, though.</p>
<p>We're  throwing the <a class="external" href="https://docs.aiohttp.org/en/v3.8.4/client_reference.html#client-session">Session</a> away after each request,
and with it the associated connection pool,
which means each request creates a new connection.
Reusing connections can make repeated requests much faster –
most &quot;client&quot; libraries (e.g. <a class="external" href="https://github.com/aio-libs/aiobotocore">aiobotocore</a>) keep a connection pool around
for this reason.</p>
<p>Creating the session outside an async function and passing it in works:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<p>...but with a bunch of warnings:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>brigde.py
<span class="go">.../bridge.py:16: DeprecationWarning: The object should be created within an async function</span>
<span class="go">  session = aiohttp.ClientSession()</span>
<span class="go">got 200 in loop 4570601360</span>
<span class="go">got 200 in loop 4570601360</span>
<span class="go">Unclosed client session</span>
<span class="go">client_session: &lt;aiohttp.client.ClientSession object at 0x10ff01c90&gt;</span>
</code></pre></div>
<p>The first one's easy
– the constructor wants to be called in an async function,
so we write one to call it in
(to pass in constructor arguments, we can use a <a class="external" href="https://docs.python.org/3/library/functools.html#functools.partial">partial()</a>):</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 9</span>
<span class="normal">10</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_async</span><span class="p">(</span><span class="nb">callable</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">callable</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">19</span>
<span class="normal">20</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">call_async</span><span class="p">(</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<p>The second one happens because
we're expected to <code>async session.close()</code> after we're done with it.
But we didn't do that before –
we used the (async) <code>with</code> statement,
the idiomatic way for objects to clean up after themselves.
Since <code>async with</code> is syntactic sugar over
calling the <a class="external" href="https://docs.python.org/3/glossary.html#term-asynchronous-context-manager">asynchronous context manager</a> protocol methods
<a class="external" href="https://snarky.ca/unravelling-the-async-with-statement/">in a specific way</a>,
we can simulate it by doing that:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">call_async</span><span class="p">(</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">))</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<!-- # Threads -->
<h2 id="but-i-want-to-do-something-else-during-the-async-stuff">But I want to do something else during the async stuff<span class="headerlink">&nbsp;<a href="#but-i-want-to-do-something-else-during-the-async-stuff" title="permalink">#</a></span></h2>
<p>OK, we have a long-lived event loop
and a long-lived session.</p>
<p>But when doing async stuff,
we can't do anything else,
because we are busy running the event loop;
and as a consequence of that,
outside of <a class="external" href="https://docs.python.org/3/library/asyncio-runner.html#asyncio.Runner.run">run()</a>
all async stuff is frozen.</p>
<p>So let's use the <em>other</em> way of doing more than one thing at a time,
and call <a class="external" href="https://docs.python.org/3/library/asyncio-runner.html#asyncio.Runner.run">run()</a> from another thread. First, more logging:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">do_stuff</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://death.andgravity.com/&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s1">&#39;in loop&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>brigde.py
<span class="go">got 200 in loop 4538933264 in MainThread</span>
<span class="go">got 200 in loop 4538933264 in MainThread</span>
</code></pre></div>
<!-- ## One thread -->
<p><a id="one-thread"></a>
Next up, the thread stuff –
in actual code, the &quot;do something else&quot; part would happen between
<code>thread.start()</code> and <code>thread.join()</code>.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">do_stuff_in_threads</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">(</span><span class="n">session</span><span class="p">),))</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">call_async</span><span class="p">(</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">))</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">do_stuff_in_threads</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<p>Hey, it works!</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>brigde.py
<span class="go">got 200 in loop 4448024592 in Thread-1 (run)</span>
</code></pre></div>
<!-- ## Two threads -->
<h2 id="but-i-want-to-do-async-stuff-from-multiple-threads">But I want to do async stuff from multiple threads<span class="headerlink">&nbsp;<a href="#but-i-want-to-do-async-stuff-from-multiple-threads" title="permalink">#</a></span></h2>
<p>OK, but does it work from two threads?
This can be the case in an existing application.
Or we can <em>deliberately</em> use threads most of the time,
because they work with normal code,
and only use async as an implementation detail.
Or, we just have one other thread, like above,
but then accidentally call <a class="external" href="https://docs.python.org/3/library/asyncio-runner.html#asyncio.Runner.run">run()</a> from the main thread.</p>
<p>Glad you asked!</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">35</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>        <span class="n">do_stuff_in_threads</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><pre class="code" data-lang="Python Traceback"><span></span><code><span class="x">$ python brigde.py</span>
<span class="x">Exception in thread Thread-2 (run):</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
  File <span class="nb">&quot;.../asyncio/runners.py&quot;</span>, line <span class="m">118</span>, in <span class="n">run</span>
<span class="w">    </span><span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
  File <span class="nb">&quot;.../asyncio/base_events.py&quot;</span>, line <span class="m">629</span>, in <span class="n">run_until_complete</span>
<span class="w">    </span><span class="bp">self</span><span class="o">.</span><span class="n">_check_running</span><span class="p">()</span>
  File <span class="nb">&quot;.../asyncio/base_events.py&quot;</span>, line <span class="m">588</span>, in <span class="n">_check_running</span>
<span class="w">    </span><span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;This event loop is already running&#39;</span><span class="p">)</span>
<span class="gr">RuntimeError</span>: <span class="n">This event loop is already running</span>
<span class="x">got 200 in loop 4544447440 in Thread-1 (run)</span>
<span class="x">got 200 in loop 4544447440 in Thread-1 (run)</span>
</code></pre></div>
<p>Not only did one thread crash,
both coroutines ran in the other thread.
Worse, sometimes only one runs.
In a long-running program with infrequent uses of <a class="external" href="https://docs.python.org/3/library/asyncio-runner.html#asyncio.Runner.run">run()</a>,
we might not even get a hard failure,
but subtle, mysterious bugs. 👻</p>
<p>And why not? The docs have a <a class="external" href="https://docs.python.org/3/library/asyncio-dev.html#concurrency-and-multithreading">Concurrency and Multithreading</a> section that warns:</p>
<blockquote>
<p>Almost all asyncio objects are not thread safe,
which is typically not a problem unless
there is code that works with them from outside of a Task or a callback.</p>
</blockquote>
<p>...and that's exactly what we've been doing.
But the warning comes with a solution:</p>
<blockquote>
<p>To schedule a coroutine object from a different OS thread,
the <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.run_coroutine_threadsafe">run_coroutine_threadsafe()</a> function should be used.<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup></p>
</blockquote>
<p>So, we want a loop running continuously in another thread,
not just when we call <a class="external" href="https://docs.python.org/3/library/asyncio-runner.html#asyncio.Runner.run">run()</a>:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">runner</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span>
<span class="n">loop_created</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_forever</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">runner</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">get_loop</span><span class="p">()</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="n">loop_created</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>

<span class="n">loop_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_forever</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LoopThread&#39;</span><span class="p">)</span>
<span class="n">loop_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">loop_created</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">get_loop</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">coro</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>We have to wait for the loop to be created in its own thread,
otherwise the main thread can race ahead,
create the loop first with its <a class="external" href="https://docs.python.org/3/library/asyncio-runner.html#asyncio.Runner.get_loop">get_loop()</a> call,
and then deadlock when <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.run_coroutine_threadsafe">run_coroutine_threadsafe()</a> is passed
a loop that isn't running yet.</p>
<p>We can go ahead and plug in the new <code>run()</code>,
winding things down after we're done:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">call_async</span><span class="p">(</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">))</span>
    <span class="n">run</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">do_stuff_in_threads</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">run</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
    <span class="n">loop_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>This time, it really works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>brigde.py
<span class="go">got 200 in loop 4444839248 in LoopThread</span>
<span class="go">got 200 in loop 4444839248 in LoopThread</span>
</code></pre></div>
<!-- ## Thread runner -->
<p>Getting that in the right order every time looks tricky, though,
so we should probably do something about it.
Just like <a class="external" href="https://docs.python.org/3/library/asyncio-runner.html#asyncio.Runner">asyncio.Runner</a>,
we'll provide a higher-level API,
and since it already does similar work,
we get to reuse its API design for free:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ThreadRunner</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Runner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_init</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loop</span><span class="p">()</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_init</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span><span class="o">.</span><span class="n">get_loop</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coro</span><span class="p">):</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_lazy_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">loop_created</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">run_forever</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">get_loop</span><span class="p">()</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
                <span class="n">loop_created</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">run_forever</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LoopThread&#39;</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">loop_created</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>This means using it looks <a class="anchor" href="#one-thread">just the same</a>,
which is pretty neat:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">with</span> <span class="n">ThreadRunner</span><span class="p">()</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">call_async</span><span class="p">(</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">))</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">do_stuff_in_threads</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>




<div class="panel inline-panel" >
    <div class="panel-header text-large">
        Liking this so far? Here&#39;s another article you might like:
    </div>
    <div class="panel-body">
        <p><a href="/limit-concurrency">
            Limiting concurrency in Python asyncio: the story of async imap_unordered()
        </a>
    </div>
</div>
<!-- # Context managers -->
<h2 id="but-i-don-t-want-to-manage-async-context-managers-by-hand">But I don't want to manage async context managers by hand<span class="headerlink">&nbsp;<a href="#but-i-don-t-want-to-manage-async-context-managers-by-hand" title="permalink">#</a></span></h2>
<p>If I'm being honest, this whole
&quot;simulate <code>async with</code> by calling the protocol methods&quot;
is getting kinda tedious.
But now we have a high-level API,
so we can extend it with a <em>sync</em> context manager to take care of it for us.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wrap_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">call_async</span><span class="p">(</span><span class="n">factory</span><span class="p">))</span>
        <span class="n">aenter</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span><span class="o">.</span><span class="fm">__aenter__</span>
        <span class="n">aexit</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span><span class="o">.</span><span class="fm">__aexit__</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">aenter</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">value</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">aexit</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())):</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">aexit</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<p>This is the same code as before,
except we're going <a class="external" href="https://docs.python.org/3/reference/compound_stmts.html#async-with">by the book</a> with what gets called when;
see Brett Cannon's <a class="external" href="https://snarky.ca/unravelling-the-async-with-statement/">Unravelling the <code>async with</code> statement</a>
for details.</p>
<p>You use it like so:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">with</span> <span class="n">ThreadRunner</span><span class="p">()</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">runner</span><span class="o">.</span><span class="n">wrap_context</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">do_stuff_in_threads</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<!-- ## Enter context -->
<p>That's good, but we can do better.
Here, we don't really need granular control over the lifetime of the session,
we just want it to live as long as the event loop,
so it would be nice to give users a shorthand for that.<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup>
We can use an <a class="external" href="https://docs.python.org/3/library/contextlib.html#contextlib.ExitStack">ExitStack</a> to enter context managers
on the user's behalf and exit them when the runner is closed.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Runner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span> <span class="o">=</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">ExitStack</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">enter_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_context</span><span class="p">(</span><span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">factory</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loop</span><span class="p">()</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>Now, we just need to do:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">with</span> <span class="n">ThreadRunner</span><span class="p">()</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">)</span>
    <span class="n">do_stuff_in_threads</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<!-- # Iterables -->
<h2 id="but-i-want-to-use-async-iterables">But I want to use async iterables<span class="headerlink">&nbsp;<a href="#but-i-want-to-use-async-iterables" title="permalink">#</a></span></h2>
<p>One final thing:
how would you consume an <a class="external" href="https://docs.python.org/3/glossary.html#term-asynchronous-iterable">asynchronous iterable</a>
like the <a class="external" href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamReader">content of an aiohttp response</a>?
In async code, it would look something like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://death.andgravity.com/&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">async</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="s1">&#39;lines&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Like <code>async with</code>,
<code>async for</code> has its own <a class="external" href="https://docs.python.org/3/glossary.html#term-asynchronous-iterator">protocol</a> we can wrap;
for slightly better error messages,
we'll use the <a class="external" href="https://docs.python.org/3/library/functions.html#aiter">aiter()</a> and <a class="external" href="https://docs.python.org/3/library/functions.html#anext">anext()</a> built-ins
instead of calling the corresponding <a class="external" href="https://docs.python.org/3/glossary.html#term-special-method">special methods</a> directly:</p>
<!--
.. literalinclude:: 50-iter.py
    :lines: 106-
-->
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">wrap_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">aiter</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">anext</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">StopAsyncIteration</span><span class="p">:</span>
                <span class="k">break</span>
</code></pre></div></td></tr></table></div>

<p>You use it like so:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">with</span> <span class="n">ThreadRunner</span><span class="p">()</span> <span class="k">as</span> <span class="n">runner</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">)</span>
    <span class="n">coroutine</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://death.andgravity.com/&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">runner</span><span class="o">.</span><span class="n">wrap_context</span><span class="p">(</span><span class="n">coroutine</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">wrap_iter</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="s1">&#39;lines&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>brigde.py
<span class="go">got 624 lines</span>
</code></pre></div>
<p>And with this, we're done!</p>
<p>Here's <a class="attachment" href="/_file/asyncio-bridge/51-wrap-iter.py">the final version of the code</a>.</p>
<h2 id="so-should-you-do-this">So, should you do this?<span class="headerlink">&nbsp;<a href="#so-should-you-do-this" title="permalink">#</a></span></h2>
<p>I guess?</p>
<p>I used something like this on a &quot;production&quot; project without any problems.</p>
<p>Performance might be an issue if you <code>run()</code> many small tasks,
but the overhead for bigger tasks should be negligible,
especially compared with the cost of doing I/O
(for example, returning an entire HTTP response is likely fine,
wrapping an iterator of lines might not be).</p>
<p>In my case,
I was forced to use an async library that didn't have a sync counterpart,
and the benefit of retaining a mostly sync code base was overwhelming.</p>
<p><strong>Learned something new today?</strong> Share it with others, it really helps! <span class="text-large">
<span class="share-icons">
<a
    class="share-icon pycoders color"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news color"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/asyncio-bridge&t=Running%20async%20code%20from%20sync%20in%20Python%20asyncio"
>HN</a>
<a
    class="share-icon bluesky color"
    href="https://bsky.%61%70%70/intent/compose?text=Running%20async%20code%20from%20sync%20in%20Python%20asyncio%20https%3A//death.andgravity.com/asyncio-bridge"
>Bluesky</a>
<!--
<a
    class="share-icon reddit color"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/asyncio-bridge&title=Running%20async%20code%20from%20sync%20in%20Python%20asyncio"
>Reddit</a>
-->
<a
    class="share-icon linkedin color"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/asyncio-bridge"
>linkedin</a>
<a
    class="share-icon twitter color"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Running%20async%20code%20from%20sync%20in%20Python%20asyncio&url=https%3A//death.andgravity.com/asyncio-bridge&via=_andgravity"
>Twitter</a>
</span>
</span></p>

<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661&SIGNUP=asyncio-bridge"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"
>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">

        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>



<div class="panel inline-panel" >
    <div class="panel-header text-large">
        If you&#39;ve made it this far, you might like:
    </div>
    <div class="panel-body">
        <p><a href="/query-builder-how">
            Write an SQL query builder in 150 lines of Python!
        </a>
    </div>
</div>
<section class="footnotes">
<ol>
<li id="fn-1"><p>Which itself comes with another warning:
<em>to handle signals and to execute subprocesses,
the event loop must be run in the main thread</em>;
this is a sacrifice we're willing to make. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p>It could be argued that it is not ThreadRunner's job to do this,
but remember it exists to make it easy to use async code from sync code,
and this use case is quite common;
also, <a class="external" href="https://click.palletsprojects.com/en/latest/advanced/#managing-resources">there is precedent for this kind of API</a>,
and <em><a class="internal" href="/output#good-libraries-educate">something something copy, something something steal</a></em>. <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>