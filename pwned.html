






<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>Has your password been pwned? Or, how I almost failed to search a 37 GB text file in under 1 millisecond - death and gravity</title>




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Has your password been pwned? Or, how I almost failed to search a 37 GB text file in under 1 millisecond</h1>

<p class="text-gray text-nowrap"><small>
<span class="tooltip" data-tooltip="published on 2022-06-01">June 2022</span>



∙ eight minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<section class="toc">
<ul>
<li><a href="#intro">intro</a></li>
<li><a href="#problem-we-re-lazy-but-paranoid">Problem: we're lazy, but paranoid</a></li>
<li><a href="#problem-no-minimal-plausible-solution">Problem: no minimal plausible solution</a>
<ul>
<li><a href="#imports">Imports</a></li>
<li><a href="#file">File</a></li>
<li><a href="#password">Password</a></li>
<li><a href="#finding-the-hash">Finding the hash</a></li>
<li><a href="#timing-stuff">Timing stuff</a></li>
</ul>
</li>
<li><a href="#problem-it-s-slow">Problem: it's slow</a>
<ul>
<li><a href="#skipping">Skipping</a></li>
</ul>
</li>
<li><a href="#problem-it-needs-tuning-it-s-still-slow">Problem: it needs tuning, it's still slow</a>
<ul>
<li><a href="#advanced-skipping">Advanced skipping</a></li>
<li><a href="#timing">timing</a></li>
</ul>
</li>
<li><a href="#failing-to-get-to-under-1ms">failing to get to under 1ms</a></li>
<li><a href="#getting-to-under-1ms">getting to under 1ms</a></li>
</ul>
</section>
<h2 id="intro">intro<span class="headerlink"> <a href="#intro" title="permalink">#</a></span></h2>
<p>https://haveibeenpwned.com/Passwords</p>
<p>https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/</p>
<p>https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/#cloudflareprivacyandkanonymity</p>
<p>https://api.pwnedpasswords.com/range/5baa6</p>
<p>https://haveibeenpwned.com/API/v3#PwnedPasswords</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>head -n5 pwned.txt
<span class="go">000000005AD76BD555C1D6D771DE417A4B87E4B4:10</span>
<span class="go">00000000A8DAE4228F821FB418F59826079BF368:4</span>
<span class="go">00000000DD7F2A1C68A35673713783CA390C9E93:873</span>
<span class="go">00000001E225B908BAC31C56DB04D892E47536E0:6</span>
<span class="go">00000006BAB7FC3113AA73DE3589630FC08218E7:3</span>
</code></pre></div>
<section class="admonition note">
<p class="admonition-title">relaxed ursid says</p>
<p>bonjour</p>
</section>
<h2 id="problem-we-re-lazy-but-paranoid">Problem: we're lazy, but paranoid<span class="headerlink"> <a href="#problem-we-re-lazy-but-paranoid" title="permalink">#</a></span></h2>
<p>TODO:</p>
<p>We could follow the &quot;how hibp protects...&quot; Link next to the textbox,
and read the article,
and understand how the Kanonimity thing works (indeed, it does protect your privacy),
and even check that the website uses the kanonimity API (it does),
but that's waaay too much work.</p>
<p>So instead, let's scroll down to the Downloading the Pwned Passwords list section,
and download the sha1 pwned passwords list, ordered by hash
(be nice and download the torrent, if you can)
We'll search for the password ourselves,
since that perfectly secure
And can't be too hard</p>
<h2 id="problem-no-minimal-plausible-solution">Problem: no minimal plausible solution<span class="headerlink"> <a href="#problem-no-minimal-plausible-solution" title="permalink">#</a></span></h2>
<p>We'll take an iterative, <a href="https://hintjens.gitbooks.io/scalable-c/content/chapter1.html#problem-what-do-we-do-next">problem-solution</a> approach to this.</p>
<p>At the moment, we don't have <em>any</em> solution, so we'll treat <em>that</em> as our problem.</p>
<h3 id="imports">Imports<span class="headerlink"> <a href="#imports" title="permalink">#</a></span></h3>
<p>First, let's get the imports out of the way:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
</code></pre></div>
</td></tr></table>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>Sorting imports by length looks <em>neat</em>,
 but it can make things hard to find when there's a lot of them;
 maybe sort alphabetically when working with other people.</p>
</section>
<h3 id="file">File<span class="headerlink"> <a href="#file" title="permalink">#</a></span></h3>
<p>Then, we open the file:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">7</span>
<span class="normal">8</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We do it from the beginning, since we want the exception to happen before reading the password – no point in reading it if the file isn't there.</p>
<p>Also, we open the file as binary, since we know it's ASCII, and will likely make searching it faster (no needless decoding); it's &quot;minimal <em>plausible</em> solution&quot;, it doesn't mean we can't do some obvious things.</p>
<h3 id="password">Password<span class="headerlink"> <a href="#password" title="permalink">#</a></span></h3>
<p>Then, get the password:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">()</span>
<span class="n">hexdigest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="k">del</span> <span class="n">password</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;looking for&quot;</span><span class="p">,</span> <span class="n">hexdigest</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We read the password as the second argument to the script,
but if not provided, we prompt for it with <a href="https://docs.python.org/3/library/getpass.html#getpass.getpass">getpass()</a>
– you don't want your <em>actual</em> password in your shell history, right?</p>
<p>After we compute the SHA1 hash of the password, we delete it;
we're not going as far as to <a href="https://en.wikipedia.org/wiki/Zeroisation#Software">zero</a> it<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>,
but it prevents us from accidentally printing it (e.g. in a traceback).</p>
<p>Let's see if it works, by using <code>password</code> as our test password:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="gp">$ </span>python pwned.py pwned.txt
<span class="go">Password:</span>
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
</code></pre></div>
<p>As a sanity check, the shell agrees:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">echo</span> -n password <span class="p">|</span> sha1sum
<span class="go">5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8  -</span>
</code></pre></div>
<h3 id="finding-the-hash">Finding the hash<span class="headerlink"> <a href="#finding-the-hash" title="permalink">#</a></span></h3>
<p>To find the hash, we'll do the simplest thing that could possibly work
– just go through the lines in the file, one by one.
We'll put the logic in a function, since it'll be useful later on.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">find_line</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</td></tr></table>
<p>Then, we just call it to get the line of interest:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

<span class="k">if</span> <span class="n">line</span><span class="p">:</span>
    <span class="n">times</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pwned! seen </span><span class="si">{</span><span class="n">times</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> times before&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not found&quot;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h3 id="timing-stuff">Timing stuff<span class="headerlink"> <a href="#timing-stuff" title="permalink">#</a></span></h3>
<p>Before trying it, let's add a bit of code to measure how long it takes to find the hash:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="hll"><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</span><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="hll"><span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</span></code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">39</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>And here it is:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt <span class="m">127</span>
<span class="go">looking for 008451a05e1e7aa32c75119df950d405265e0904</span>
<span class="go">pwned! seen 2,352 times before</span>
<span class="go">in 0.452512 seconds</span>
</code></pre></div>
<h2 id="problem-it-s-slow">Problem: it's slow<span class="headerlink"> <a href="#problem-it-s-slow" title="permalink">#</a></span></h2>
<p>You may have noticed the password I used above was <code>127</code>;
that's because I was cheating, and I chose a password that starts with <code>00</code>,
quite close to the beginning of the file.</p>
<p>Searching for <code>password</code> takes 86 seconds!</p>
<p>To put a lower bound on the time it takes to go line by line through this file,
let's do so with something written in C:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">time</span> wc -l pwned.txt
<span class="go"> 847223402 pwned.txt</span>

<span class="go">real	1m7.234s</span>
<span class="go">user	0m31.133s</span>
<span class="go">sys	0m16.379s</span>
</code></pre></div>
<!-- old laptop: password: 86s, wc -l: 67s, for line in: 88s -->
<p>There are probably faster implementations of <code>wc -l</code> out there,
but it's unlikely Python can even beat this one; indeed:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">time</span> python3 -c <span class="s1">&#39;for line in open(&quot;pwned.txt&quot;, &quot;rb&quot;): pass&#39;</span>

<span class="go">real	1m28.325s</span>
<span class="go">user	1m10.049s</span>
<span class="go">sys	0m15.577s</span>
</code></pre></div>
<p><a href="https://www.youtube.com/watch?v=UANN2Eu6ZnM&amp;t=438s">There must be a better way.</a></p>
<h3 id="skipping">Skipping<span class="headerlink"> <a href="#skipping" title="permalink">#</a></span></h3>
<p>There's a hint about what that is in the file name: the hashes are <em>ordered</em>.</p>
<p>That means we don't have to check all the lines;
we can repeatedly skip ahead until we're past the hash we're looking for,
go back one step, and only check each line from there.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c1"># print(&quot;jumped to&quot;, (line or b&#39;&lt;eof&gt;&#39;).decode().rstrip())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">old_position</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<p>Since lines are different lengths,
we can't really skip X lines without actually reading them,
but we don't need to;
we just need to be able to skip to the beginning of a line,
and back to where we were before.</p>
<p><a href="https://docs.python.org/3/library/io.html#io.IOBase.seek">seek()</a> changes the position to an <em>offset</em>;
with <code>SEEK_CUR</code>, that's relative to the current position;
with no <em>whence</em> (same as <code>SEEK_SET</code>), that's absolute.</p>
<p>Because seek() might not leave the file at the beginning of a line,
we read and discard the possibly incomplete line,
and look at the one after that.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>File objects are line <a href="https://docs.python.org/3/glossary.html#term-iterator">iterators</a>, so we could've used <a href="https://docs.python.org/3/library/functions.html#next">next()</a> instead:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nb">next</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<p>... but <a href="https://docs.python.org/3/library/io.html#io.IOBase.readline">readline()</a> conveys better what we're doing in this case.</p>
</section>
<p><a href="https://docs.python.org/3/library/io.html#io.IOBase.tell">tell()</a> returns the current stream position,
so we know where to jump back;
we're using it at the beginning too,
because we don't want to assume we start at position 0 (foreshadowing).</p>
<p>Now, we just need to call <code>skip_to_before_line()</code> before <code>find_line()</code>.
If we replace the old <code>find_line()</code> with an enhanced version,
we don't even need to change the calling code</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">find_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>


<span class="hll"><span class="k">def</span> <span class="nf">find_line_linear</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
</span>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</code></pre></div>
</td></tr></table>
<p>It works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.027203 seconds</span>
</code></pre></div>
<p>TODO: Talk about offsets.</p>
<pre class="code code-container"><code>offset (MiB)   time (s)
           1      0.05
           4      0.035
           8      0.030
          16      0.027  &lt;-- sweet spot
          64      0.13
</code></pre>
<p>note: 1 MiB sometimes goes over 2 seconds, likely depending on the OS caches;
ran repeatedly, and used the lowest it settled at</p>
<h2 id="problem-it-needs-tuning-it-s-still-slow">Problem: it needs tuning, it's still slow<span class="headerlink"> <a href="#problem-it-needs-tuning-it-s-still-slow" title="permalink">#</a></span></h2>
<p>While an order of magnitude faster, our solution still has a bunch of issues.</p>
<ol>
<li>The ideal chunk size depends on computer you're running this on.</li>
<li>The run time still increases linearly with file size;
we haven't really solved the problem,
as much as made it smaller by a (large, but) constant factor.</li>
<li>The run time still increases linearly with where the hash is in the file.</li>
<li>It's still kinda slow.</li>
</ol>
<!-- TODO: different video -->
<p><a href="https://www.youtube.com/watch?v=OSGv2VnC0go&amp;t=557s">There must be a better way.</a></p>
<h3 id="advanced-skipping">Advanced skipping<span class="headerlink"> <a href="#advanced-skipping" title="permalink">#</a></span></h3>
<p>To make the &quot;linear&quot; part painfully obvious,
let's uncomment the <code>jumped to</code> line.</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password <span class="p">|</span> grep -o <span class="s1">&#39;jumped to .&#39;</span> <span class="p">|</span> uniq -c
<span class="go"> 139 jumped to 0</span>
<span class="go"> 139 jumped to 1</span>
<span class="go"> 139 jumped to 2</span>
<span class="go"> 139 jumped to 3</span>
<span class="go"> 139 jumped to 4</span>
<span class="go"> 103 jumped to 5</span>
</code></pre></div>
<p>Surely, after we've jumped to <code>0</code> once,
we don't <em>need</em> to do it 138 more times, right?</p>
<p>Instead, we could jump directly to the middle line;
if there at all,
our hash will be in either of the two halves.
Then, we jump to the middle line of that half,
and to the middle line of <em>that</em> half,
and so on,
until we either find our hash,
or the remaining half has no lines.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>If this sounds a lot like <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">binary search</a>, that's because it is.</p>
</section>
<p>As mentioned before, we can't actually jump to a specific line.</p>
<p>But, we can jump ~X bytes to a line
where we know our hash will be in the next X bytes.
For our purposes, that's just as good:
we can jump by half the file size,
then by a quarter, then by an eighth, ...</p>
<p>Doing it takes surprisingly little code:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">//=</span> <span class="mi">2</span>
        <span class="n">skip_to_before_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>


<span class="hll"><span class="k">def</span> <span class="nf">skip_to_before_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span>    <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<p>What remains is to pass the file size along:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="hll"><span class="k">def</span> <span class="nf">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span class="hll">    <span class="n">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="n">find_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="hll"><span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
</span></code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">59</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">size</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>It works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.009559 seconds</span>
<span class="gp">$ </span>python pwned.py pwned.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.000268 seconds</span>
</code></pre></div>
<p>TODO: talk about caches</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password <span class="p">|</span> grep -o <span class="s1">&#39;jumped to .&#39;</span> <span class="p">|</span> uniq -c
<span class="go">   1 jumped to 7</span>
<span class="go">   1 jumped to 3</span>
<span class="go">   1 jumped to 7</span>
<span class="go">   1 jumped to 5</span>
<span class="go">   1 jumped to 4</span>
<span class="go">  39 jumped to 5</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password <span class="p">|</span> grep -o <span class="s1">&#39;jumped to ..&#39;</span> <span class="p">|</span> uniq -c
<span class="go">   1 jumped to 7F</span>
<span class="go">   1 jumped to 3F</span>
<span class="go">   1 jumped to 7F</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 4F</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 57</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 5B</span>
<span class="go">   1 jumped to 59</span>
<span class="go">   1 jumped to 5B</span>
<span class="go">   1 jumped to 5A</span>
<span class="go">  32 jumped to 5B</span>
</code></pre></div>
<h3 id="timing">timing<span class="headerlink"> <a href="#timing" title="permalink">#</a></span></h3>
<div class="highlight code-container"><pre class="code" data-lang="Bash"><span></span><code><span class="k">function</span> average-many <span class="o">{</span>
    <span class="k">for</span> _ <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
        python <span class="nv">$@</span> <span class="k">$(</span> python -c <span class="s1">&#39;import time; print(time.time())&#39;</span> <span class="k">)</span>
    <span class="k">done</span> <span class="se">\</span>
    <span class="p">|</span> grep seconds <span class="se">\</span>
    <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f2 <span class="se">\</span>
    <span class="p">|</span> paste -sd+ - <span class="se">\</span>
    <span class="p">|</span> sed <span class="s1">&#39;s#^#scale=6;(#&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s#$#)/100#&#39;</span> <span class="se">\</span>
    <span class="p">|</span> bc
<span class="o">}</span>
</code></pre></div>
<!-- pyp 'keep("seconds") | whitespace[1] | sum(pp)/len(pp) | f"{p:.6f}"' -->
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.005106</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.004062</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003936</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003992</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003692</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003647</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003704</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003404</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003463</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003453</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003374</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003284</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003274</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003362</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003205</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003237</span>
</code></pre></div>
<p>TODO: talk more about caches (show how it becomes faster and faster)</p>
<h2 id="failing-to-get-to-under-1ms">failing to get to under 1ms<span class="headerlink"> <a href="#failing-to-get-to-under-1ms" title="permalink">#</a></span></h2>
<h2 id="getting-to-under-1ms">getting to under 1ms<span class="headerlink"> <a href="#getting-to-under-1ms" title="permalink">#</a></span></h2>
<pre class="code code-container"><code>(.venv) pwned $ average-many 03-binary-index.py ~/Downloads/pwned.txt index.bin
.003182
(.venv) pwned $ average-many 03-binary-index.py ~/Downloads/pwned.txt index.bin
.002127
(.venv) pwned $ average-many 03-binary-index.py ~/Downloads/pwned.txt index.bin
.001787
(.venv) pwned $ average-many 03-binary-index.py ~/Downloads/pwned.txt index.bin
.001706
(.venv) pwned $ average-many 03-binary-index.py ~/Downloads/pwned.txt index.bin
.001486
(.venv) pwned $ cat index.bin &gt; /dev/null
(.venv) pwned $ cat index.bin &gt; /dev/null
(.venv) pwned $ cat index.bin &gt; /dev/null
(.venv) pwned $ average-many 03-binary-index.py ~/Downloads/pwned.txt index.bin
.000647
</code></pre>
<!-- TODO: fix file to be api only

# bonus: kanon

.. literalinclude:: 03-kanon.py
    :lines: 45-52

.. literalinclude:: 03-kanon.py
    :lines: 55-61
    :emphasize-lines: 2-4,7

.. literalinclude:: 03-kanon.py
    :lines: 72-74
    :emphasize-lines: 2

-->
<section class="footnotes">
<ol>
<li id="fn-1"><p>Which is <a href="https://stackoverflow.com/q/28676177">kinda difficult to do</a> in Python anyway. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>