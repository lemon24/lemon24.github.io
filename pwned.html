






<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>pwned - death and gravity</title>




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">pwned</h1>

<p class="text-gray text-nowrap"><small>
<span class="tooltip" data-tooltip="published on 2022-06-01">June 2022</span>



∙ seven minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<section class="toc">
<ul>
<li><a href="#intro">intro</a></li>
<li><a href="#problem-we-re-paranoid">Problem: we're paranoid</a></li>
<li><a href="#problem-we-re-really-paranoid">Problem: we're really paranoid</a></li>
<li><a href="#problem-no-minimal-plausible-solution">Problem: no minimal plausible solution</a>
<ul>
<li><a href="#imports">Imports</a></li>
<li><a href="#file">File</a></li>
<li><a href="#password">Password</a></li>
<li><a href="#finding-the-hash">Finding the hash</a></li>
<li><a href="#timing-stuff">Timing stuff</a></li>
</ul>
</li>
<li><a href="#problem-it-s-slow">Problem: it's slow</a>
<ul>
<li><a href="#skipping">Skipping</a></li>
</ul>
</li>
<li><a href="#problem-it-needs-tuning">Problem: it needs tuning</a>
<ul>
<li><a href="#advanced-skipping">Advanced skipping</a></li>
</ul>
</li>
<li><a href="#bonus">bonus</a></li>
</ul>
</section>
<h2 id="intro">intro<span class="headerlink"> <a href="#intro" title="permalink">#</a></span></h2>
<p>https://haveibeenpwned.com/Passwords</p>
<p>https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/</p>
<p>https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/#cloudflareprivacyandkanonymity</p>
<p>https://api.pwnedpasswords.com/range/5baa6</p>
<p>https://haveibeenpwned.com/API/v3#PwnedPasswords</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>head -n5 pwned-passwords-sha1-ordered-by-hash-v8.txt
<span class="go">000000005AD76BD555C1D6D771DE417A4B87E4B4:10</span>
<span class="go">00000000A8DAE4228F821FB418F59826079BF368:4</span>
<span class="go">00000000DD7F2A1C68A35673713783CA390C9E93:873</span>
<span class="go">00000001E225B908BAC31C56DB04D892E47536E0:6</span>
<span class="go">00000006BAB7FC3113AA73DE3589630FC08218E7:3</span>
</code></pre></div>
<section class="admonition note">
<p class="admonition-title">relaxed ursid says</p>
<p>bonjour</p>
</section>
<h2 id="problem-we-re-paranoid">Problem: we're paranoid<span class="headerlink"> <a href="#problem-we-re-paranoid" title="permalink">#</a></span></h2>
<h2 id="problem-we-re-really-paranoid">Problem: we're really paranoid<span class="headerlink"> <a href="#problem-we-re-really-paranoid" title="permalink">#</a></span></h2>
<h2 id="problem-no-minimal-plausible-solution">Problem: no minimal plausible solution<span class="headerlink"> <a href="#problem-no-minimal-plausible-solution" title="permalink">#</a></span></h2>
<p>We'll take an iterative, <a href="https://hintjens.gitbooks.io/scalable-c/content/chapter1.html#problem-what-do-we-do-next">problem-solution</a> approach to this.</p>
<p>At the moment, we don't have <em>any</em> solution, so we'll treat <em>that</em> as our problem.</p>
<h3 id="imports">Imports<span class="headerlink"> <a href="#imports" title="permalink">#</a></span></h3>
<p>First, let's get the imports out of the way:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
</code></pre></div>
</td></tr></table>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>Sorting imports by length looks <em>neat</em>,
 but it can make things hard to find when there's a lot of them;
 maybe sort alphabetically when working with other people.</p>
</section>
<h3 id="file">File<span class="headerlink"> <a href="#file" title="permalink">#</a></span></h3>
<p>Then, we open the file:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">7</span>
<span class="normal">8</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We do it from the beginning, since we want the exception to happen before reading the password – no point in reading it if the file isn't there.</p>
<p>Also, we open the file as binary, since we know it's ASCII, and will likely make searching it faster (no needless decoding); it's &quot;minimal <em>plausible</em> solution&quot;, it doesn't mean we can't do some obvious things.</p>
<h3 id="password">Password<span class="headerlink"> <a href="#password" title="permalink">#</a></span></h3>
<p>Then, get the password:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">()</span>
<span class="n">hexdigest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="k">del</span> <span class="n">password</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;looking for&quot;</span><span class="p">,</span> <span class="n">hexdigest</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We read the password as the second argument to the script,
but if not provided, we prompt for it with <a href="https://docs.python.org/3/library/getpass.html#getpass.getpass">getpass()</a>
– you don't want your <em>actual</em> password in your shell history, right?</p>
<p>After we compute the SHA1 hash of the password, we delete it;
we're not going as far as to <a href="https://en.wikipedia.org/wiki/Zeroisation#Software">zero</a> it<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>,
but it prevents us from accidentally printing it (e.g. in a traceback).</p>
<p>Let's see if it works, by using <code>password</code> as our test password:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned-passwords-sha1-ordered-by-hash-v8.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="gp">$ </span>python pwned.py pwned-passwords-sha1-ordered-by-hash-v8.txt
<span class="go">Password:</span>
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
</code></pre></div>
<p>As a sanity check, the shell agrees:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">echo</span> -n password <span class="p">|</span> sha1sum
<span class="go">5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8  -</span>
</code></pre></div>
<h3 id="finding-the-hash">Finding the hash<span class="headerlink"> <a href="#finding-the-hash" title="permalink">#</a></span></h3>
<p>To find the hash, we'll do the simplest thing that could possibly work
– just go through the lines in the file, one by one.
We'll put the logic in a function, since it'll be useful later on.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">find_line</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</td></tr></table>
<p>Then, we just call it to get the line of interest:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

<span class="k">if</span> <span class="n">line</span><span class="p">:</span>
    <span class="n">times</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pwned! seen </span><span class="si">{</span><span class="n">times</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> times before&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not found&quot;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h3 id="timing-stuff">Timing stuff<span class="headerlink"> <a href="#timing-stuff" title="permalink">#</a></span></h3>
<p>Before trying it, let's add a bit of code to measure how long it takes to find the hash:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="hll"><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</span><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="hll"><span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</span></code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">39</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>And here it is:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned-passwords-sha1-ordered-by-hash-v8.txt <span class="m">127</span>
<span class="go">looking for 008451a05e1e7aa32c75119df950d405265e0904</span>
<span class="go">pwned! seen 2,352 times before</span>
<span class="go">in 0.452512 seconds</span>
</code></pre></div>
<h2 id="problem-it-s-slow">Problem: it's slow<span class="headerlink"> <a href="#problem-it-s-slow" title="permalink">#</a></span></h2>
<p>You may have noticed the password I used above was <code>127</code>;
that's because I was cheating, and I chose a password that starts with <code>00</code>,
quite close to the beginning of the file.</p>
<p>Searching for <code>password</code> takes 86 seconds!</p>
<p>To put a lower bound on the time it takes to go line by line through this file,
let's do so with something written in C:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">time</span> wc -l pwned-passwords-sha1-ordered-by-hash-v8.txt
<span class="go"> 847223402 pwned-passwords-sha1-ordered-by-hash-v8.txt</span>

<span class="go">real	1m7.234s</span>
<span class="go">user	0m31.133s</span>
<span class="go">sys	0m16.379s</span>
</code></pre></div>
<!-- old laptop: password: 86s, wc -l: 67s, for line in: 88s -->
<p>There are probably faster implementations of <code>wc -l</code> out there,
but it's unlikely Python can even beat this one; indeed:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">time</span> python3 -c <span class="s1">&#39;for line in open(&quot;pwned-passwords-sha1-ordered-by-hash-v8.txt&quot;, &quot;rb&quot;): pass&#39;</span>

<span class="go">real	1m28.325s</span>
<span class="go">user	1m10.049s</span>
<span class="go">sys	0m15.577s</span>
</code></pre></div>
<p><a href="https://www.youtube.com/watch?v=UANN2Eu6ZnM&amp;t=438s">There must be a better way.</a></p>
<h3 id="skipping">Skipping<span class="headerlink"> <a href="#skipping" title="permalink">#</a></span></h3>
<p>There's a hint about what that is in the file name: the hashes are <em>ordered</em>.</p>
<p>That means we don't have to check all the lines;
we can repeatedly skip ahead until we're past the hash we're looking for,
go back one step, and only check each line from there.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c1"># print(&quot;jumped to&quot;, (line or b&#39;&lt;eof&gt;&#39;).decode().rstrip())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">old_position</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<p>Since files are byte-oriented, and not line-oriented,
we can't really skip X lines, but we don't need to;
we just need to be able to skip to the beginning of a line,
and back to where we were before.</p>
<p><a href="https://docs.python.org/3/library/io.html#io.IOBase.seek">seek()</a> changes the position to an <em>offset</em>;
with <code>SEEK_CUR</code>, that's relative to the current position;
with no <em>whence</em> (same as <code>SEEK_SET</code>), that's absolute.</p>
<p>Because seek() might not leave the file at the beginning of a line,
we read and discard the possibly incomplete line,
and look at the one after that.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>File objects are line <a href="https://docs.python.org/3/glossary.html#term-iterator">iterators</a>, so we could've used <a href="https://docs.python.org/3/library/functions.html#next">next()</a> instead:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nb">next</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<p>... but <a href="https://docs.python.org/3/library/io.html#io.IOBase.readline">readline()</a> conveys better what we're doing in this case.</p>
</section>
<p><a href="https://docs.python.org/3/library/io.html#io.IOBase.tell">tell()</a> returns the current stream position,
so we know where to jump back;
we're using it at the beginning too,
because we don't want to assume we start at position 0 (foreshadowing).</p>
<p>Now, we just need to call <code>skip_to_before_line()</code> before <code>find_line()</code>.
If we replace the old <code>find_line()</code> with an enhanced version,
we don't even need to change the calling code</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">find_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>


<span class="hll"><span class="k">def</span> <span class="nf">find_line_linear</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
</span>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</code></pre></div>
</td></tr></table>
<p>It works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned-passwords-sha1-ordered-by-hash-v8.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.027203 seconds</span>
</code></pre></div>
<p>TODO: Talk about offsets.</p>
<pre class="code code-container"><code>offset (MiB)   time (s)
           1      0.05
           4      0.035
           8      0.030
          16      0.027  &lt;-- sweet spot
          64      0.13
</code></pre>
<p>note: 1 MiB sometimes goes over 2 seconds, likely depending on the OS caches;
ran repeatedly, and used the lowest it settled at</p>
<h2 id="problem-it-needs-tuning">Problem: it needs tuning<span class="headerlink"> <a href="#problem-it-needs-tuning" title="permalink">#</a></span></h2>
<p>While much, much faster, our solution still has a bunch of issues.</p>
<p>First, the ideal chunk size depends on computer you're running this on.</p>
<p>Second, the run time still increases linearly with file size (that is, it's still linear);
we haven't really solved the problem, as much as made it smaller by a constant factor.</p>
<p>Finally, the run time still varies with where the hash is in the file.
While this doesn't really matter if it's fast enough,
it's still an unpleasant property.</p>
<p>TODO: Finally, it's still slow.</p>
<p><a href="https://www.youtube.com/watch?v=OSGv2VnC0go&amp;t=557s">There must be a better way.</a></p>
<h3 id="advanced-skipping">Advanced skipping<span class="headerlink"> <a href="#advanced-skipping" title="permalink">#</a></span></h3>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned-passwords-sha1-ordered-by-hash-v8.txt password <span class="p">|</span> grep -o <span class="s1">&#39;jumped to .&#39;</span> <span class="p">|</span> uniq -c
<span class="go"> 139 jumped to 0</span>
<span class="go"> 139 jumped to 1</span>
<span class="go"> 139 jumped to 2</span>
<span class="go"> 139 jumped to 3</span>
<span class="go"> 139 jumped to 4</span>
<span class="go"> 103 jumped to 5</span>
</code></pre></div>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">//=</span> <span class="mi">2</span>
        <span class="n">skip_to_before_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>


<span class="hll"><span class="k">def</span> <span class="nf">skip_to_before_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span>    <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="hll"><span class="k">def</span> <span class="nf">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span class="hll">    <span class="n">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="n">find_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="hll"><span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
</span></code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">59</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">size</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned-passwords-sha1-ordered-by-hash-v8.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.009559 seconds</span>
<span class="gp">$ </span>python pwned.py pwned-passwords-sha1-ordered-by-hash-v8.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.000268 seconds</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned-passwords-sha1-ordered-by-hash-v8.txt password <span class="p">|</span> grep -o <span class="s1">&#39;jumped to .&#39;</span> <span class="p">|</span> uniq -c
<span class="go">   1 jumped to 7</span>
<span class="go">   1 jumped to 3</span>
<span class="go">   1 jumped to 7</span>
<span class="go">   1 jumped to 5</span>
<span class="go">   1 jumped to 4</span>
<span class="go">  39 jumped to 5</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned-passwords-sha1-ordered-by-hash-v8.txt password <span class="p">|</span> grep -o <span class="s1">&#39;jumped to ..&#39;</span> <span class="p">|</span> uniq -c
<span class="go">   1 jumped to 7F</span>
<span class="go">   1 jumped to 3F</span>
<span class="go">   1 jumped to 7F</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 4F</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 57</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 5B</span>
<span class="go">   1 jumped to 59</span>
<span class="go">   1 jumped to 5B</span>
<span class="go">   1 jumped to 5A</span>
<span class="go">  32 jumped to 5B</span>
</code></pre></div>
<h2 id="bonus">bonus<span class="headerlink"> <a href="#bonus" title="permalink">#</a></span></h2>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">get_line_from_api</span><span class="p">(</span><span class="n">hexdigest</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">requests</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.pwnedpasswords.com/range/&quot;</span> <span class="o">+</span> <span class="n">hexdigest</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">size</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="hll"><span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;:api:&#39;</span><span class="p">:</span>
</span><span class="hll">    <span class="n">get_line</span> <span class="o">=</span> <span class="n">get_line_from_api</span>
</span><span class="hll"><span class="k">else</span><span class="p">:</span>
</span>    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
<span class="hll">    <span class="n">get_line</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">hexdigest</span><span class="p">:</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">size</span><span class="p">)</span>
</span></code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
<span class="hll"><span class="n">line</span> <span class="o">=</span> <span class="n">get_line</span><span class="p">(</span><span class="n">hexdigest</span><span class="p">)</span>
</span><span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<section class="footnotes">
<ol>
<li id="fn-1"><p>Which is <a href="https://stackoverflow.com/q/28676177">kinda difficult to do</a> in Python anyway. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>