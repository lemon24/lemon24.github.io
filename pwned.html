






<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>Has your password been pwned? Or, how I almost failed to search a 37 GB text file in under 1 millisecond - death and gravity</title>




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Has your password been pwned? Or, how I almost failed to search a 37 GB text file in under 1 millisecond</h1>

<p class="text-gray text-nowrap"><small>
<span class="tooltip" data-tooltip="published on 2022-06-01">June 2022</span>



∙ 10 minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<section class="toc">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#downloading-the-file">Downloading the file</a></li>
<li><a href="#problem-no-minimal-plausible-solution">Problem: no minimal plausible solution</a>
<ul>
<li><a href="#imports">Imports</a></li>
<li><a href="#file">File</a></li>
<li><a href="#password">Password</a></li>
<li><a href="#finding-the-hash">Finding the hash</a></li>
<li><a href="#timing-stuff">Timing stuff</a></li>
</ul>
</li>
<li><a href="#problem-it-s-slow">Problem: it's slow</a>
<ul>
<li><a href="#skipping">Skipping</a></li>
</ul>
</li>
<li><a href="#problem-it-needs-tuning-it-s-still-slow">Problem: it needs tuning, it's still slow</a>
<ul>
<li><a href="#advanced-skipping">Advanced skipping</a></li>
<li><a href="#better-timing">Better timing</a></li>
</ul>
</li>
<li><a href="#failing-to-get-to-under-1-millisecond">Failing to get to under 1 millisecond</a>
<ul>
<li><a href="#profile-before-optimizing-profile">Profile before optimizing</a></li>
<li><a href="#proportional-position-heuristic-1-7-ms">Proportional position heuristic (1.7 ms)</a></li>
<li><a href="#index-file-1-2-ms">Index file (1.2 ms)</a></li>
<li><a href="#binary-file-2-6-ms">Binary file (2.6 ms)</a></li>
</ul>
</li>
<li><a href="#getting-to-under-1-millisecond">Getting to under 1 millisecond</a></li>
<li><a href="#bonus-the-k-anonymity-api">Bonus: the k-Anonymity API</a></li>
</ul>
</section>
<h2 id="introduction">Introduction<span class="headerlink"> <a href="#introduction" title="permalink">#</a></span></h2>
<p>So, there's this website, <a href="https://haveibeenpwned.com/">Have I Been Pwned</a>,
that allows you to check if your email has been compromised in a data breach.</p>
<p>It has another section, <a href="https://haveibeenpwned.com/Passwords">Pwned Passwords</a>, that also allow you to check <em>passwords</em>.</p>
<p>But, plugging a password you're actively using
in a random text box on a random website
probably isn't such a good idea, right?</p>
<p>Of course, we <em>could</em> follow the
<a href="https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/">Read more about how HIBP protects the privacy of searched passwords</a>
link above the textbox,
and read the article,
and understand how <a href="https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/#cloudflareprivacyandkanonymity">k-Anonymity</a> works (it does),
and check the website uses the <a href="https://haveibeenpwned.com/API/v3#PwnedPasswords">k-Anonymity API</a> (it does),
but that's waaay too much work.
Of course, we could call the API ourselves,
but where's the fun in that?</p>
<p>Instead, we'll download the password list,
and check for the password <em>offline</em>.</p>
<h2 id="downloading-the-file">Downloading the file<span class="headerlink"> <a href="#downloading-the-file" title="permalink">#</a></span></h2>
<p>Go to the <a href="https://haveibeenpwned.com/Passwords">Pwned Passwords</a>,
scroll down to <em>Downloading the Pwned Passwords list</em>,
and download the SHA-1 ordered by hash file;
be nice and download the torrent, if you can.</p>
<p>The extracted file is a hefty 37 GB:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">pushd</span> ~/Downloads
<span class="gp">$ </span>7zz e pwned-passwords-sha1-ordered-by-hash-v8.7z
<span class="gp">$ </span>ls -l pwned-passwords-sha1-ordered-by-hash-v8.txt
<span class="go">-rw-r--r--  1 lemon  staff  37342268646 Dec  2  2021 pwned-passwords-sha1-ordered-by-hash-v8.txt</span>
<span class="gp">$ </span>ls -lh pwned-passwords-sha1-ordered-by-hash-v8.txt
<span class="go">-rw-r--r--  1 lemon  staff    35G Dec  2  2021 pwned-passwords-sha1-ordered-by-hash-v8.txt</span>
<span class="gp">$ </span><span class="nb">popd</span>
</code></pre></div>
<p>And looks like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>head -n5 ~/Downloads/pwned-passwords-sha1-ordered-by-hash-v8.txt
<span class="go">000000005AD76BD555C1D6D771DE417A4B87E4B4:10</span>
<span class="go">00000000A8DAE4228F821FB418F59826079BF368:4</span>
<span class="go">00000000DD7F2A1C68A35673713783CA390C9E93:873</span>
<span class="go">00000001E225B908BAC31C56DB04D892E47536E0:6</span>
<span class="go">00000006BAB7FC3113AA73DE3589630FC08218E7:3</span>
</code></pre></div>
<p>That is, each line has the format:</p>
<pre class="code code-container"><code>&lt;SHA-1 of the password&gt;:&lt;how many times it appeared in various breaches&gt;
</code></pre>
<p>(See the article for <a href="https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/#theyrestillsha1hashedbutwithsomejunkremoved">why SHA-1</a> and <a href="https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/#eachpasswordnowhasacountnexttoit">why show the counts</a>.)</p>
<p>To make command lines using it shorter, we'll link it in the current directory:</p>
<pre class="code code-container"><code>$ ln -s ~/Downloads/pwned-passwords-sha1-ordered-by-hash-v8.txt pwned.txt
</code></pre>
<h2 id="problem-no-minimal-plausible-solution">Problem: no minimal plausible solution<span class="headerlink"> <a href="#problem-no-minimal-plausible-solution" title="permalink">#</a></span></h2>
<p>We'll take an iterative, <a href="https://hintjens.gitbooks.io/scalable-c/content/chapter1.html#problem-what-do-we-do-next">problem-solution</a> approach to this.</p>
<p>At the moment, we don't have <em>any</em> solution,
so we'll <a href="https://wiki.c2.com/?DoTheSimplestThingThatCouldPossiblyWork">do the simplest thing that could possibly work</a>.</p>
<h3 id="imports">Imports<span class="headerlink"> <a href="#imports" title="permalink">#</a></span></h3>
<p>First, let's get the imports out of the way:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
</code></pre></div>
</td></tr></table>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>Sorting imports by length looks <em>neat</em>,
 but it can make things hard to find when there's a lot of them;
 maybe sort alphabetically when working with other people.</p>
</section>
<h3 id="file">File<span class="headerlink"> <a href="#file" title="permalink">#</a></span></h3>
<p>Then, we open the file:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">7</span>
<span class="normal">8</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We do it from the beginning, since we want the exception to happen before reading the password – no point in reading it if the file isn't there.</p>
<p>Also, we open the file as binary, since we know it's ASCII, and will likely make searching it faster (no needless decoding); it's &quot;minimal <em>plausible</em> solution&quot;, it doesn't mean we can't do some obvious things.</p>
<h3 id="password">Password<span class="headerlink"> <a href="#password" title="permalink">#</a></span></h3>
<p>Then, get the password:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">()</span>
<span class="n">hexdigest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="k">del</span> <span class="n">password</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;looking for&quot;</span><span class="p">,</span> <span class="n">hexdigest</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We read the password as the second argument to the script,
but if not provided, we prompt for it with <a href="https://docs.python.org/3/library/getpass.html#getpass.getpass">getpass()</a>
– you don't want your <em>actual</em> password in your shell history, right?</p>
<p>After we compute the SHA1 hash of the password, we delete it;
we're not going as far as to <a href="https://en.wikipedia.org/wiki/Zeroisation#Software">zero</a> it<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>,
but it prevents us from accidentally printing it (e.g. in a traceback).</p>
<p>Let's see if it works, by using <code>password</code> as our test password:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="gp">$ </span>python pwned.py pwned.txt
<span class="go">Password:</span>
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
</code></pre></div>
<p>As a sanity check, the shell agrees:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">echo</span> -n password <span class="p">|</span> sha1sum
<span class="go">5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8  -</span>
</code></pre></div>
<h3 id="finding-the-hash">Finding the hash<span class="headerlink"> <a href="#finding-the-hash" title="permalink">#</a></span></h3>
<p>To find the hash, we'll do the simplest thing that could possibly work
– just go through the lines in the file, one by one.
We'll put the logic in a function, since it'll be useful later on.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">find_line</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</td></tr></table>
<p>Then, we just call it to get the line of interest:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

<span class="k">if</span> <span class="n">line</span><span class="p">:</span>
    <span class="n">times</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pwned! seen </span><span class="si">{</span><span class="n">times</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> times before&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not found&quot;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h3 id="timing-stuff">Timing stuff<span class="headerlink"> <a href="#timing-stuff" title="permalink">#</a></span></h3>
<p>Before trying it, let's add a bit of code to measure how long it takes to find the hash:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="hll"><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</span><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="hll"><span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</span></code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">39</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>And here it is:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt <span class="m">127</span>
<span class="go">looking for 008451a05e1e7aa32c75119df950d405265e0904</span>
<span class="go">pwned! seen 2,352 times before</span>
<span class="go">in 0.452512 seconds</span>
</code></pre></div>
<h2 id="problem-it-s-slow">Problem: it's slow<span class="headerlink"> <a href="#problem-it-s-slow" title="permalink">#</a></span></h2>
<p>You may have noticed the password I used above was <code>127</code>;
that's because I was cheating, and I chose a password that starts with <code>00</code>,
quite close to the beginning of the file.</p>
<p>On my 2013 laptop, searching for <code>password</code> takes 86 seconds!</p>
<p>To put a lower bound on the time it takes to go line by line through this file,
let's do so with something written in C:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">time</span> wc -l pwned.txt
<span class="go"> 847223402 pwned.txt</span>

<span class="go">real	1m7.234s</span>
<span class="go">user	0m31.133s</span>
<span class="go">sys	0m16.379s</span>
</code></pre></div>
<p>There are <a href="https://chrispenner.ca/posts/wc">probably</a> <a href="https://medium.com/@martinmroz/beating-c-with-120-lines-of-rust-wc-a0db679fe920">faster</a> <a href="https://github.com/expr-fi/fastlwc/">implementations</a> of <code>wc</code> out there,
but it's unlikely Python can even beat this one; indeed:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">time</span> python3 -c <span class="s1">&#39;for line in open(&quot;pwned.txt&quot;, &quot;rb&quot;): pass&#39;</span>

<span class="go">real	1m28.325s</span>
<span class="go">user	1m10.049s</span>
<span class="go">sys	0m15.577s</span>
</code></pre></div>
<p><a href="https://www.youtube.com/watch?v=UANN2Eu6ZnM&amp;t=438s">There must be a better way.</a></p>
<h3 id="skipping">Skipping<span class="headerlink"> <a href="#skipping" title="permalink">#</a></span></h3>
<p>There's a hint about what that is in the file name: the hashes are <em>ordered</em>.</p>
<p>That means we don't have to check all the lines;
we can repeatedly skip ahead until we're past the hash we're looking for,
go back one step, and only check each line from there.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c1"># print(&quot;jumped to&quot;, (line or b&#39;&lt;eof&gt;&#39;).decode().rstrip())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">old_position</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<p>Since lines are different lengths,
we can't really skip X lines without actually reading them,
but we don't need to;
we just need to be able to skip to the beginning of a line,
and back to where we were before.</p>
<p><a href="https://docs.python.org/3/library/io.html#io.IOBase.seek">seek()</a> changes the position to an <em>offset</em>;
with <code>SEEK_CUR</code>, that's relative to the current position;
with no <em>whence</em> (same as <code>SEEK_SET</code>), that's absolute.</p>
<p>Because seek() might not leave the file at the beginning of a line,
we read and discard the possibly incomplete line,
and look at the one after that.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>File objects are line <a href="https://docs.python.org/3/glossary.html#term-iterator">iterators</a>, so we could've used <a href="https://docs.python.org/3/library/functions.html#next">next()</a> instead:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="nb">next</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<p>... but <a href="https://docs.python.org/3/library/io.html#io.IOBase.readline">readline()</a> conveys better what we're doing in this case.</p>
</section>
<p><a href="https://docs.python.org/3/library/io.html#io.IOBase.tell">tell()</a> returns the current stream position,
so we know where to jump back;
we're using it at the beginning too,
because we don't want to assume we start at position 0 (foreshadowing).</p>
<p>Now, we just need to call <code>skip_to_before_line()</code> before <code>find_line()</code>.
If we replace the old <code>find_line()</code> with an enhanced version,
we don't even need to change the calling code</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">find_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>


<span class="hll"><span class="k">def</span> <span class="nf">find_line_linear</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
</span>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</code></pre></div>
</td></tr></table>
<p>It works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.027203 seconds</span>
</code></pre></div>
<p>After running the script with a bunch of values a few times each,
16 MiB seems to be the fastest one; here's a little table:</p>
<pre class="code code-container"><code>offset (MiB)   time (s)
           1      0.05
           4      0.035
           8      0.030
          16      0.027  &lt;-- sweet spot
          32      0.14
</code></pre>
<h2 id="problem-it-needs-tuning-it-s-still-slow">Problem: it needs tuning, it's still slow<span class="headerlink"> <a href="#problem-it-needs-tuning-it-s-still-slow" title="permalink">#</a></span></h2>
<p>While an order of magnitude faster, our solution still has a bunch of issues.</p>
<ol>
<li>The ideal chunk size depends on computer you're running this on.</li>
<li>The run time still increases linearly with file size;
we haven't really solved the problem,
as much as made it smaller by a (large, but) constant factor.</li>
<li>The run time still increases linearly with where the hash is in the file.</li>
<li>It's still kinda slow.</li>
</ol>
<!-- TODO: different video -->
<p><a href="https://www.youtube.com/watch?v=OSGv2VnC0go&amp;t=557s">There must be a better way.</a></p>
<h3 id="advanced-skipping">Advanced skipping<span class="headerlink"> <a href="#advanced-skipping" title="permalink">#</a></span></h3>
<p>To make the &quot;linear&quot; part painfully obvious,
let's uncomment the <code>jumped to</code> line.</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password <span class="p">|</span> grep -o <span class="s1">&#39;jumped to .&#39;</span> <span class="p">|</span> uniq -c
<span class="go"> 139 jumped to 0</span>
<span class="go"> 139 jumped to 1</span>
<span class="go"> 139 jumped to 2</span>
<span class="go"> 139 jumped to 3</span>
<span class="go"> 139 jumped to 4</span>
<span class="go"> 103 jumped to 5</span>
</code></pre></div>
<p>Surely, after we've jumped to <code>0</code> once,
we don't <em>need</em> to do it 138 more times, right?</p>
<p>Instead, we could jump directly to the middle line;
if there at all,
our hash will be in either of the two halves.
Then, we jump to the middle line of that half,
and to the middle line of <em>that</em> half,
and so on,
until we either find our hash,
or the remaining half has no lines.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>If this sounds a lot like <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">binary search</a>, that's because it is.</p>
</section>
<p>As mentioned before, we can't actually jump to a specific line.</p>
<p>But, we can jump ~X bytes to a line
where we know our hash will be in the next X bytes.
For our purposes, that's just as good:
we can jump by half the file size,
then by a quarter, then by an eighth, ...</p>
<p>Doing it takes surprisingly little code:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">//=</span> <span class="mi">2</span>
        <span class="n">skip_to_before_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>


<span class="hll"><span class="k">def</span> <span class="nf">skip_to_before_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span>    <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<p>What remains is to pass the file size along:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="hll"><span class="k">def</span> <span class="nf">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span class="hll">    <span class="n">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="n">find_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="hll"><span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
</span></code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">59</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">size</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>It works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.009559 seconds</span>
<span class="gp">$ </span>python pwned.py pwned.txt password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.000268 seconds</span>
</code></pre></div>
<p>The huge difference between the two times is due to <a href="https://en.wikipedia.org/wiki/Page_cache">OS</a> and/or SSD caches
– on the second run, the (same) parts of the file are likely already in memory.</p>
<p>Anyway, we can look again at the <code>jumped to</code> output:
instead of jumping blindly through the whole file,
we're jumping <em>around</em> the place where our hash is,
with the jumps closer and closer to it.</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password <span class="p">|</span> grep -o <span class="s1">&#39;jumped to .&#39;</span> <span class="p">|</span> uniq -c
<span class="go">   1 jumped to 7</span>
<span class="go">   1 jumped to 3</span>
<span class="go">   1 jumped to 7</span>
<span class="go">   1 jumped to 5</span>
<span class="go">   1 jumped to 4</span>
<span class="go">  39 jumped to 5</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python pwned.py pwned.txt password <span class="p">|</span> grep -o <span class="s1">&#39;jumped to ..&#39;</span> <span class="p">|</span> uniq -c
<span class="go">   1 jumped to 7F</span>
<span class="go">   1 jumped to 3F</span>
<span class="go">   1 jumped to 7F</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 4F</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 57</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 5B</span>
<span class="go">   1 jumped to 59</span>
<span class="go">   1 jumped to 5B</span>
<span class="go">   1 jumped to 5A</span>
<span class="go">  32 jumped to 5B</span>
</code></pre></div>
<p>You may notice we're ending up at the same <code>7F...</code> prefix more than once;
this makes sense –
we're jumping once to a line that's a bit after half the file size,
and then twice to a line that's a bit after a quarter of the file size.
We're not all that concerned about it,
since the second time the data will likely come from the cache.</p>
<h3 id="better-timing">Better timing<span class="headerlink"> <a href="#better-timing" title="permalink">#</a></span></h3>
<p>Given the way caching muddies the waters,
how fast is it <em>really?</em></p>
<p>This shell function runs it one hundred times,
with the current time as the password (so it's always different),
and prints out the average:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash"><span></span><code><span class="k">function</span> average-many <span class="o">{</span>
    <span class="k">for</span> _ <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
        python <span class="nv">$@</span> <span class="k">$(</span> python -c <span class="s1">&#39;import time; print(time.time())&#39;</span> <span class="k">)</span>
    <span class="k">done</span> <span class="se">\</span>
    <span class="p">|</span> grep seconds <span class="se">\</span>
    <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f2 <span class="se">\</span>
    <span class="p">|</span> paste -sd+ - <span class="se">\</span>
    <span class="p">|</span> sed <span class="s1">&#39;s#^#scale=6;(#&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s#$#)/100#&#39;</span> <span class="se">\</span>
    <span class="p">|</span> bc
<span class="o">}</span>
</code></pre></div>
<!-- pyp 'keep("seconds") | whitespace[1] | sum(pp)/len(pp) | f"{p:.6f}"' -->
<details>
<summary>
Running it a few times,
it starts at 5 ms,
but then settles around 3.1 ms.
</summary>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.005152</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.004186</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003980</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003745</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003426</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003528</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003475</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003321</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003216</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003398</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003328</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003006</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003232</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003119</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003177</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003098</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt
<span class="go">.003125</span>
</code></pre></div>
</details>
<p>Again, this is due to caching; the more often we run it,
the more likely it is the pages at half, quarters, eights, sixteenths etc.
of the file size will already be in memory,
and the road to any line starts through some of those positions.</p>
<h2 id="failing-to-get-to-under-1-millisecond">Failing to get to under 1 millisecond<span class="headerlink"> <a href="#failing-to-get-to-under-1-millisecond" title="permalink">#</a></span></h2>
<p>When I started writing this,
this was supposed to be the end;
this was really supposed to be a short one.</p>
<p>I wave my hands, <em>get a 2021 laptop,</em> and a miracle happens.
It's <a href="https://qntm.org/destro">far enough into the totally unpredictable future</a>, now,
that it takes <em>under 1 millisecond</em> to search for any password.
I can do anything I want.</p>
<!--
I wave my hands, and a miracle happens.
It's far enough into the totally unpredictable future, now,
that you can completely destroy a rocky planet.
You can do anything you want.
-->
<hr />
<p>And now that we've arrived at this point,
let's spend a moment to ponder the arbitrary nature of 1 millisecond.</p>
<!--
And now that you have arrived at this point,
spend a moment to ponder the arbitrary nature of 1 millisecond
given its dependency on the current year
and the choice of your particular hardware.
-->
<p>Nah, fuck it, <strong>it has to work on the old laptop</strong>, the one I'm writing this on.</p>
<p>So yeah, here's a bunch of stuff that didn't work.</p>
<h3 id="profile-before-optimizing-profile"><a href="http://wiki.c2.com/?ProfileBeforeOptimizing">Profile before optimizing</a><span class="headerlink"> <a href="#profile-before-optimizing-profile" title="permalink">#</a></span></h3>
<p>TODO: ...</p>
<h3 id="proportional-position-heuristic-1-7-ms">Proportional position heuristic (1.7 ms)<span class="headerlink"> <a href="#proportional-position-heuristic-1-7-ms" title="permalink">#</a></span></h3>
<p>TODO: ...</p>
<p>TODO: talk about how caching, show timings for 02 seek()</p>
<h3 id="index-file-1-2-ms">Index file (1.2 ms)<span class="headerlink"> <a href="#index-file-1-2-ms" title="permalink">#</a></span></h3>
<p>TODO: ... <code>1.2 ms @ 2**15 (first try), 0.9 ms @ 2**13 !!!</code></p>
<p>TODO: if we lower chunk size, file gets bigger, makes index search slower</p>
<h3 id="binary-file-2-6-ms">Binary file (2.6 ms)<span class="headerlink"> <a href="#binary-file-2-6-ms" title="permalink">#</a></span></h3>
<p>TODO: ...</p>
<h2 id="getting-to-under-1-millisecond">Getting to under 1 millisecond<span class="headerlink"> <a href="#getting-to-under-1-millisecond" title="permalink">#</a></span></h2>
<p>TODO: ...</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>average-many pwned.py pwned.txt index.bin
<span class="go">.003182</span>
<span class="gp">$ </span>cat index.bin &gt; /dev/null
<span class="gp">$ </span>cat index.bin &gt; /dev/null
<span class="gp">$ </span>cat index.bin &gt; /dev/null
<span class="gp">$ </span>average-many pwned.py pwned.txt index.bin
<span class="go">.000653</span>
<span class="gp">$ </span>average-many pwned.py pwned.txt index.bin
<span class="go">.000641</span>
</code></pre></div>
<h2 id="bonus-the-k-anonymity-api">Bonus: the k-Anonymity API<span class="headerlink"> <a href="#bonus-the-k-anonymity-api" title="permalink">#</a></span></h2>
<p>TODO: ...</p>
<!-- TODO: fix file to be api only

.. literalinclude:: 03-kanon.py
    :lines: 45-52

.. literalinclude:: 03-kanon.py
    :lines: 55-61
    :emphasize-lines: 2-4,7

.. literalinclude:: 03-kanon.py
    :lines: 72-74
    :emphasize-lines: 2

https://api.pwnedpasswords.com/range/5baa6

https://haveibeenpwned.com/API/v3#PwnedPasswords

-->
<section class="footnotes">
<ol>
<li id="fn-1"><p>Which is <a href="https://stackoverflow.com/q/28676177">kinda difficult to do</a> in Python anyway. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>