












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>Has your password been pwned? Or, how I almost failed to search a 37 GB text file in under 1 millisecond (in Python) - death and gravity</title>
<meta name="description" content="... in which we check if your password has been compromised in many inconvenient ways, in a tale of destruction, obsession, and self-discovery." />


<meta property="og:title" content="Has your password been pwned? Or, how I almost failed to search a 37 GB text file in under 1 millisecond (in Python)">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/pwned">
<meta property="og:description" content="... in which we check if your password has been compromised in many inconvenient ways, in a tale of destruction, obsession, and self-discovery.">



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RY2QR580X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-4RY2QR580X");
</script>



<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Has your password been pwned? Or, how I almost failed to search a 37 GB text file in under 1 millisecond (in Python)</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2022-12-13">December 2022</span>
∙ 19 minute read
∙
</small><span class="share-icons">
<a
    class="share-icon pycoders"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/pwned&t=Has%20your%20password%20been%20pwned%3F%20Or%2C%20how%20I%20almost%20failed%20to%20search%20a%2037%C2%A0GB%20text%20file%20in%20under%201%C2%A0millisecond%20%28in%20Python%29"
>HN</a>
<a
    class="share-icon bluesky"
    href="https://bsky.%61%70%70/intent/compose?text=Has%20your%20password%20been%20pwned%3F%20Or%2C%20how%20I%20almost%20failed%20to%20search%20a%2037%C2%A0GB%20text%20file%20in%20under%201%C2%A0millisecond%20%28in%20Python%29%20https%3A//death.andgravity.com/pwned"
>Bluesky</a>
<!--
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/pwned&title=Has%20your%20password%20been%20pwned%3F%20Or%2C%20how%20I%20almost%20failed%20to%20search%20a%2037%C2%A0GB%20text%20file%20in%20under%201%C2%A0millisecond%20%28in%20Python%29"
>Reddit</a>
-->
<a
    class="share-icon linkedin"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/pwned"
>linkedin</a>
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Has%20your%20password%20been%20pwned%3F%20Or%2C%20how%20I%20almost%20failed%20to%20search%20a%2037%C2%A0GB%20text%20file%20in%20under%201%C2%A0millisecond%20%28in%20Python%29&url=https%3A//death.andgravity.com/pwned&via=_andgravity"
>Twitter</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>So, there's this website, <a class="external" href="https://haveibeenpwned.com/">Have I Been Pwned</a>,
where you can check if your email address has appeared in a data breach.</p>
<p>There's also a <a class="external" href="https://haveibeenpwned.com/Passwords">Pwned Passwords</a> section for passwords
... but, typing your password on a random website
probably isn't such a great idea, right?</p>
<p>Of course, you could
read about <a class="external" href="https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/">how HIBP protects the privacy of searched passwords</a>,
and understand how <a class="external" href="https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/#cloudflareprivacyandkanonymity">k-Anonymity</a> works,
and check that the website uses the <a class="external" href="https://haveibeenpwned.com/API/v3#PwnedPasswords">k-Anonymity API</a>,
but that's waaay too much work.</p>
<p>Of course, you could use the API yourself,
but where's the fun in that?</p>
<p>Instead, we'll do it the hard way –
we'll check passwords <strong>offline</strong>.</p>
<p>And we're not stopping until it's <strong>fast</strong>.</p>
<section class="toc">
<ul>
<li><a href="#the-pwned-passwords-list">The Pwned Passwords list</a></li>
<li><a href="#a-minimal-plausible-solution">A minimal plausible solution</a></li>
<li><a href="#problem-it-s-slow">Problem: it's slow</a>
<ul>
<li><a href="#skipping">Skipping</a></li>
</ul>
</li>
<li><a href="#problem-it-needs-tuning-it-s-still-slow">Problem: it needs tuning, it's still slow</a>
<ul>
<li><a href="#binary-skipping">Binary skipping</a></li>
<li><a href="#better-timing">Better timing</a></li>
</ul>
</li>
<li><a href="#failing-to-get-to-under-1-millisecond">Failing to get to under 1&nbsp;millisecond</a>
<ul>
<li><a href="#profile-before-optimizing-profile">Profile before optimizing</a></li>
<li><a href="#position-heuristic">Position heuristic</a></li>
<li><a href="#index-file">Index file</a></li>
<li><a href="#binary-file">Binary file</a></li>
</ul>
</li>
<li><a href="#getting-to-under-1-millisecond">Getting to under 1 millisecond</a>
<ul>
<li><a href="#generating-the-index">Generating the index</a></li>
<li><a href="#using-the-index">Using the index</a></li>
<li><a href="#i-heard-you-like-indexes-the-end">I heard you like indexes (the end)</a></li>
</ul>
</li>
<li><a href="#bonus-better-data-structures">Bonus: better data structures</a></li>
</ul>
</section>
<h2 id="the-pwned-passwords-list">The Pwned Passwords list<span class="headerlink">&nbsp;<a href="#the-pwned-passwords-list" title="permalink">#</a></span></h2>
<p>OK, first we need the password list.</p>
<p>Go to <a class="external" href="https://haveibeenpwned.com/Passwords">Pwned Passwords</a>,
scroll to <em>Downloading the Pwned Passwords list</em>,
and download the SHA-1 ordered-by-hash file –
be nice and use the torrent, if you can.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>You can also use the <a class="external" href="https://www.troyhunt.com/downloading-pwned-passwords-hashes-with-the-hibp-downloader/">downloader</a> to get an updated version of the file,
 but that didn't exist when I started writing this.</p>
</section>
<p>The archive extracts to a 37 GB text file:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">pushd</span><span class="w"> </span>~/Downloads
<span class="gp">$ </span>stat<span class="w"> </span>-f<span class="w"> </span>%z<span class="w"> </span>pwned-passwords-sha1-ordered-by-hash-v8.7z
<span class="go">16257755606</span>
<span class="gp">$ </span>7zz<span class="w"> </span>e<span class="w"> </span>pwned-passwords-sha1-ordered-by-hash-v8.7z
<span class="gp">$ </span>stat<span class="w"> </span>-f<span class="w"> </span>%z<span class="w"> </span>pwned-passwords-sha1-ordered-by-hash-v8.txt
<span class="go">37342268646</span>
<span class="gp">$ </span><span class="nb">popd</span>
</code></pre></div>
<p>... that looks like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>head<span class="w"> </span>-n5<span class="w"> </span>~/Downloads/pwned-passwords-sha1-ordered-by-hash-v8.txt
<span class="go">000000005AD76BD555C1D6D771DE417A4B87E4B4:10</span>
<span class="go">00000000A8DAE4228F821FB418F59826079BF368:4</span>
<span class="go">00000000DD7F2A1C68A35673713783CA390C9E93:873</span>
<span class="go">00000001E225B908BAC31C56DB04D892E47536E0:6</span>
<span class="go">00000006BAB7FC3113AA73DE3589630FC08218E7:3</span>
</code></pre></div>
<p>Each line has the format:</p>
<pre class="code code-container"><code>&lt;SHA-1 of the password&gt;:&lt;times it appeared in various breaches&gt;
</code></pre>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>For more details:
 <a class="external" href="https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/#theyrestillsha1hashedbutwithsomejunkremoved">why hash the passwords</a>, and
 <a class="external" href="https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/#eachpasswordnowhasacountnexttoit">why include a count</a>.</p>
</section>
<p>To make commands shorter, we link the file in the current directory:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>ln<span class="w"> </span>-s<span class="w"> </span>~/Downloads/pwned-passwords-sha1-ordered-by-hash-v8.txt<span class="w"> </span>pwned.txt
</code></pre></div>
<h2 id="a-minimal-plausible-solution">A minimal plausible solution<span class="headerlink">&nbsp;<a href="#a-minimal-plausible-solution" title="permalink">#</a></span></h2>
<p>We'll take an iterative, <a class="external" href="https://hintjens.gitbooks.io/scalable-c/content/chapter1.html#problem-what-do-we-do-next">problem-solution</a> approach to this.
But since right now we don't have <em>any</em> solution,
we start with <a class="external" href="https://wiki.c2.com/?DoTheSimplestThingThatCouldPossiblyWork">the simplest thing that could possibly work</a>.</p>
<!-- ## Imports -->
<p>First, we get the imports out of the way:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</code></pre></div></td></tr></table></div>

<!-- ## File -->
<p>Then, we open the file:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">7</span>
<span class="normal">8</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>Opening the file in binary mode makes searching a bit faster,
as it skips needless decoding.
By opening it early,
we get free error checking
– no point in reading the password if the file isn't there.</p>
<!-- ## Password -->
<p>Next, the password:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">()</span>
<span class="n">hexdigest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="k">del</span> <span class="n">password</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;looking for&quot;</span><span class="p">,</span> <span class="n">hexdigest</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>We either take the password as the second argument to the script,
or read it with <a class="external" href="https://docs.python.org/3/library/getpass.html#getpass.getpass">getpass()</a>,
so real passwords don't remain in the shell history.
After computing its hash, we delete it;
we don't go as far as to <a class="external" href="https://en.wikipedia.org/wiki/Zeroisation#Software">zero</a>‍<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup> it,
but at least we avoid accidental printing.</p>
<p>Let's see if it works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="gp">$ </span>python<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt
<span class="go">Password:</span>
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
</code></pre></div>
<p><code>sha1sum</code> seems to agree:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span>password<span class="w"> </span><span class="p">|</span><span class="w"> </span>sha1sum
<span class="go">5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8  -</span>
</code></pre></div>
<!-- ## Finding the hash -->
<p>To find the hash, we go through the file line by line –
remember, simplest thing that could possibly work.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_line</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>

<p>If a line was found, we print the count:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

<span class="k">if</span> <span class="n">line</span><span class="p">:</span>
    <span class="n">times</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pwned! seen </span><span class="si">{</span><span class="n">times</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> times before&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not found&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<!-- ## Timing stuff -->
<p>Finally, let's add some timing code:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">39</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>And, it works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>blocking
<span class="go">looking for 000085013a02852372159cb94101b99ccaec59e1</span>
<span class="go">pwned! seen 587 times before</span>
<span class="go">in 0.002070 seconds</span>
</code></pre></div>
<p><a class="attachment" href="/_file/pwned/00-linear.py">The code so far.</a></p>
<h2 id="problem-it-s-slow">Problem: it's slow<span class="headerlink">&nbsp;<a href="#problem-it-s-slow" title="permalink">#</a></span></h2>
<p>You may have noticed I switched from <code>password</code> to <code>blocking</code>.
That's because I deliberately
chose a password whose hash is at the beginning of the file.</p>
<p>On my 2013 laptop, <code>password</code> actually takes <strong>86 seconds</strong>!</p>
<p>To put a lower bound on the time it takes to go through the file:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">time</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;for line in open(&quot;pwned.txt&quot;, &quot;rb&quot;): pass&#39;</span>

<span class="go">real	1m28.325s</span>
<span class="go">user	1m10.049s</span>
<span class="go">sys	0m15.577s</span>
<span class="gp">$ </span><span class="nb">time</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="w"> </span>pwned.txt
<span class="go"> 847223402 pwned.txt</span>

<span class="go">real	0m51.729s</span>
<span class="go">user	0m27.908s</span>
<span class="go">sys	0m12.119s</span>
</code></pre></div>
<p><a class="external" href="https://www.youtube.com/watch?v=UANN2Eu6ZnM&amp;t=438s">There must be a better way.</a></p>
<h3 id="skipping">Skipping<span class="headerlink">&nbsp;<a href="#skipping" title="permalink">#</a></span></h3>
<p>There's a hint in the file name: the hashes are ordered.</p>
<p>That means we don't <em>have</em> to check all the lines.
We can skip ahead repeatedly until we're past the hash,
go back one step, and only check each line from there.</p>
<p>Lines are different lengths,
so we can't skip exactly X lines without reading them.
But we don't need to,
any line that's a reasonable amount ahead will do.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c1"># print(&quot;jumped to&quot;, (line or b&#39;&lt;eof&gt;&#39;).decode().rstrip())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">&gt;=</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">old_position</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>So we just <a class="external" href="https://docs.python.org/3/library/io.html#io.IOBase.seek">seek()</a> ahead a set number of bytes.
Since that might not leave us at the start of a line,
we discard the incomplete line,
and use the next one.</p>
<!--
If we can still skip ahead,
we remember the [current position][tell],
so we can return to it if needed.
-->
<p>Finally, we wrap the original <code>find_line()</code> to do the skipping:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">find_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>


<span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">find_line_linear</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
</span>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</code></pre></div></td></tr></table></div>

<p>It works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.027203 seconds</span>
</code></pre></div>
<p>To find the magic 16M offset, I had to try a bunch values:</p>
<pre class="code code-container"><code>offset (MiB)   time (s)
           1      0.05
           4      0.035
           8      0.030
          16      0.027  &lt;-- sweet spot
          32      0.14
</code></pre>
<p><a class="attachment" href="/_file/pwned/01-linear-skip.py">The code so far.</a></p>
<h2 id="problem-it-needs-tuning-it-s-still-slow">Problem: it needs tuning, it's still slow<span class="headerlink">&nbsp;<a href="#problem-it-needs-tuning-it-s-still-slow" title="permalink">#</a></span></h2>
<p>While three orders of magnitude faster, we still have a bunch of issues:</p>
<ol>
<li>The ideal offset depends on the computer you're running this on.</li>
<li>The run time still increases linearly with file size –
we haven't really solved the problem,
as much as made it smaller by a (large, but) constant factor.</li>
<li>The run time still increases linearly with where the hash is in the file.</li>
<li>It's still kinda slow. ¯\_(ツ)_/¯</li>
</ol>
<p><a class="external" href="https://www.youtube.com/watch?v=OSGv2VnC0go&amp;t=557s">There must be a better way.</a></p>
<h3 id="binary-skipping">Binary skipping<span class="headerlink">&nbsp;<a href="#binary-skipping" title="permalink">#</a></span></h3>
<p>To make the &quot;linear&quot; part painfully obvious,
uncomment the <code>jumped to</code> line.</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>password<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;jumped to .&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c
<span class="go"> 139 jumped to 0</span>
<span class="go"> 139 jumped to 1</span>
<span class="go"> 139 jumped to 2</span>
<span class="go"> 139 jumped to 3</span>
<span class="go"> 139 jumped to 4</span>
<span class="go"> 103 jumped to 5</span>
</code></pre></div>
<p>Surely, after we've jumped to <code>0</code> once,
we don't <em>need</em> to do it 138 more times, right?</p>
<p>We could jump directly to a line in the middle of the file;
if there at all,
the hash will be in either of the halves.
We could then jump to the middle of that half,
and to the middle of <em>that</em> half,
and so on,
until we either find the hash
or there's nowhere left to jump.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>If that sounds a lot like <a class="external" href="https://en.wikipedia.org/wiki/Binary_search_algorithm">binary search</a>, that's because it is
 – it's just not wearing its regular array clothing.</p>
</section>
<p>And most of the work is already done:
we can jump to a line at most X bytes from where the hash should be,
we only need to do it repeatedly,
in smaller and smaller fractions of the file size:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">//=</span> <span class="mi">2</span>
        <span class="n">skip_to_before_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>


<span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">skip_to_before_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span>    <span class="n">old_position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>The only thing left is to get the file size:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">skip_to_before_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">find_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<!--

.. note:: Fun fact

    I initially used `os.stat(path).st_size` for this,
    and passing `file.fileno()` instead of the path would've worked too.

    But, the `seek(0, os.SEEK_END)` + `tell()` trick I discovered
    by trying to get [ChatGPT] to write the code for this article
    from a description of the problem alone
    (it got as far as the linear solution!).

    I swear everything else in this article was generated by a human.

    ...

    Written. Written by a human.

    [ChatGPT]: https://en.wikipedia.org/wiki/ChatGPT

-->
<p>It works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.009559 seconds</span>
<span class="gp">$ </span>python<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>password
<span class="go">looking for 5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</span>
<span class="go">pwned! seen 9,545,824 times before</span>
<span class="go">in 0.000268 seconds</span>
</code></pre></div>
<p>The huge time difference is due to <a class="external" href="https://en.wikipedia.org/wiki/Page_cache">operating system and/or disk caches</a>
– on the second run, the same parts of the file are likely already in memory.</p>
<p>Anyway, look again at the <code>jumped to</code> output:
instead of jumping blindly through the whole file,
now we're jumping <em>around</em> the hash,
getting closer and closer to it.</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>password<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;jumped to .&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c
<span class="go">   1 jumped to 7</span>
<span class="go">   1 jumped to 3</span>
<span class="go">   1 jumped to 7</span>
<span class="go">   1 jumped to 5</span>
<span class="go">   1 jumped to 4</span>
<span class="go">  39 jumped to 5</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>password<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;jumped to ..&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c
<span class="go">   1 jumped to 7F</span>
<span class="go">   1 jumped to 3F</span>
<span class="go">   1 jumped to 7F</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 4F</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 57</span>
<span class="go">   1 jumped to 5F</span>
<span class="go">   1 jumped to 5B</span>
<span class="go">   1 jumped to 59</span>
<span class="go">   1 jumped to 5B</span>
<span class="go">   1 jumped to 5A</span>
<span class="go">  32 jumped to 5B</span>
</code></pre></div>
<p>Notice we land on the same <code>7F...</code> prefix twice;
this makes sense –
we skip ahead by half the file size,
then back,
then ahead two times by a quarter.
Caching allows us to not care about that.</p>
<p><a class="attachment" href="/_file/pwned/02-binary-search.py">The code so far.</a></p>
<h3 id="better-timing">Better timing<span class="headerlink">&nbsp;<a href="#better-timing" title="permalink">#</a></span></h3>
<p>Given the way caching muddies the waters,
how fast is it <em>really?</em></p>
<p>This function averages a hundred runs,
each with a different password:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash"><span></span><code><span class="k">function</span><span class="w"> </span>average-many<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>_<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..100<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span>python<span class="w"> </span><span class="nv">$@</span><span class="w"> </span><span class="k">$(</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;import time; print(time.time())&#39;</span><span class="w"> </span><span class="k">)</span>
<span class="w">    </span><span class="k">done</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>seconds<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f2<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-sd+<span class="w"> </span>-<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s#^#scale=6;(#&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s#$#)/100#&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>bc
<span class="o">}</span>
</code></pre></div>

<details>
<summary>
After a few repeats, the average time settles around 3 ms.
</summary>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="k">for</span><span class="w"> </span>_<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..20<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>average-many<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="p">;</span><span class="w"> </span><span class="k">done</span>
<span class="go">.004802</span>
<span class="go">.003904</span>
<span class="go">.004088</span>
<span class="go">.003486</span>
<span class="go">.003451</span>
<span class="go">.003476</span>
<span class="go">.003414</span>
<span class="go">.003442</span>
<span class="go">.003169</span>
<span class="go">.003297</span>
<span class="go">.002931</span>
<span class="go">.003077</span>
<span class="go">.003092</span>
<span class="go">.003011</span>
<span class="go">.002980</span>
<span class="go">.003147</span>
<span class="go">.003112</span>
<span class="go">.002942</span>
<span class="go">.002984</span>
<span class="go">.002934</span>
</code></pre></div>
</details>
<p>Again, this is due to caching:
the more we run the script,
the more likely it is that
the pages at {half, quarters, eights, sixteenths, ...} of the file size
are already in memory
– and the path to any line starts with a subset of those.</p>
<hr />
<p>And, we're done.</p>
<p><a class="external" href="https://qntm.org/destro">I wave my hands</a>, get a 2020 laptop, and a miracle happens.
It's far enough into the totally unpredictable future, now,
that you can search any password in under 1 millisecond.
You can do anything you want.</p>
<!--
I wave my hands, and a miracle happens.
It's far enough into the totally unpredictable future, now,
that you can completely destroy a rocky planet.
You can do anything you want.
-->
<p><a class="external" href="https://youtu.be/0twDETh6QaI?t=1787">So, there we go.</a>
Wasn't that an interesting story?
That's the end of the article.</p>
<p>Don't look at the scroll bar.
Don't worry about it.</p>
<p>If you came here to
check your password,
you can go.</p>
<!--
If you came here to
find a somewhat inconvenient way of checking if your password has been compromised,
you can go.
-->
<p>Subscribe on the way out if you'd like, but take care :)</p>
<p>Go solve <a class="internal" href="/conway-cubes">Advent of Code</a> or something.</p>
<p>I'm just chilling out.</p>
<!--
I'll go chill out.
-->
<p>See ya.</p>
<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661&SIGNUP=pwned"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"
>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">

        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>
<h2 id="failing-to-get-to-under-1-millisecond">Failing to get to under 1 millisecond<span class="headerlink">&nbsp;<a href="#failing-to-get-to-under-1-millisecond" title="permalink">#</a></span></h2>
<p>I swear this was supposed to be the end.
This really was supposed to be a short one.</p>
<p>Here's a quote from a friend of mine,
that chronologically should be way later into the article,
but makes a great summary for what follows:</p>
<blockquote>
<p>And now that you have arrived at this point,
spend a moment to ponder the arbitrary nature of 1 millisecond
given its dependency on the current year
and the choice of your particular hardware.</p>
<p>After that moment, continue celebrating.</p>
</blockquote>
<p>Nah, fuck it, it has to take less than 1 millisecond <strong>on the old laptop</strong>.</p>
<p>... so yeah, here's a bunch of stuff that didn't work.</p>



<div class="panel inline-panel" >
    <div class="panel-header text-large">
        Liking this so far? Here&#39;s another article you might like:
    </div>
    <div class="panel-body">
        <p><a href="/stdlib">
            Learn by reading code: Python standard library design decisions explained
        </a>
    </div>
</div>
<h3 id="profile-before-optimizing-profile"><a class="external" href="http://wiki.c2.com/?ProfileBeforeOptimizing">Profile before optimizing</a><span class="headerlink">&nbsp;<a href="#profile-before-optimizing-profile" title="permalink">#</a></span></h3>
<p>With the obvious improvements out of the way,
it's probably a good time to stop and
<a class="internal" href="/fast-conway-cubes#intro-to-profiling">find out where time is being spent</a>.</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>-m<span class="w"> </span>cProfile<span class="w"> </span>-s<span class="w"> </span>cumulative<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span><span class="w"> </span>date<span class="w"> </span><span class="k">)</span><span class="s2">&quot;</span>
<span class="go">looking for 3960626a8c59fe927d3cf2e991d67f4c505ae198</span>
<span class="go">not found</span>
<span class="go">in 0.004902 seconds</span>
<span class="go">         1631 function calls (1614 primitive calls) in 0.010 seconds</span>

<span class="go">   Ordered by: cumulative time</span>

<span class="go">   ncalls  tottime  percall  cumtime  percall filename:lineno(function)</span>
<span class="go">      ...</span>
<span class="go">        1    0.000    0.000    0.005    0.005 02-binary-search.py:8(find_line)</span>
<span class="go">        1    0.000    0.000    0.005    0.005 02-binary-search.py:22(skip_to_before_line)</span>
<span class="go">       28    0.000    0.000    0.005    0.000 02-binary-search.py:28(skip_to_before_line_linear)</span>
<span class="go">       86    0.004    0.000    0.004    0.000 {method &#39;readline&#39; of &#39;_io.BufferedReader&#39; objects}</span>
<span class="go">      ...</span>
<span class="go">       71    0.000    0.000    0.000    0.000 {method &#39;seek&#39; of &#39;_io.BufferedReader&#39; objects}</span>
<span class="go">      ...</span>
<span class="go">       44    0.000    0.000    0.000    0.000 {method &#39;tell&#39; of &#39;_io.BufferedReader&#39; objects}</span>
<span class="go">      ...</span>
</code></pre></div>
<p>From the output above, we learn that:</p>
<ul>
<li>Most of the time is spent in <a class="external" href="https://docs.python.org/3/library/io.html#io.IOBase.readline">readline()</a> calls.</li>
<li>Both <a class="external" href="https://docs.python.org/3/library/io.html#io.IOBase.seek">seek()</a> and <a class="external" href="https://docs.python.org/3/library/io.html#io.IOBase.tell">tell()</a> calls are basically free.</li>
</ul>
<p><a class="external" href="https://docs.python.org/3/library/io.html#io.IOBase.readline">readline()</a> is <a class="external" href="https://github.com/python/cpython/blob/3.10/Modules/_io/bufferedio.c#L1070-L1178">implemented in C</a>,
so there's not much we can change there.</p>
<p>What we <em>can</em> change, however, is how often we call it.</p>
<hr />
<p>Another thing of interest is how much individual <a class="external" href="https://docs.python.org/3/library/io.html#io.IOBase.readline">readline()</a> calls take.</p>
<p>In <code>skip_to_before_line_linear()</code>:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;jumped to&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="ow">or</span> <span class="sa">b</span><span class="s1">&#39;&lt;eof&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span>
              <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">*</span><span class="mi">1000000</span><span class="si">:</span><span class="s2">4.0f</span><span class="si">}</span><span class="s2"> us&quot;</span><span class="p">,</span>
              <span class="sa">f</span><span class="s2">&quot;at offset </span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span><span class="si">:</span><span class="s2">16,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<details>
<summary>
The output is pretty enlightening:
</summary>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>asdf
<span class="go">looking for 3da541559918a808c2402bba5012f6c60b27661c</span>
<span class="go">jumped to 7FF9E in   10 us at offset   18,671,134,394  &lt;-- 1/2 file size</span>
<span class="go">jumped to 3FF89 in    4 us at offset    9,335,567,234  &lt;-- 1/4 file size</span>
<span class="go">jumped to 1FFBA in    3 us at offset    4,667,783,663  &lt;-- 1/8 file size</span>
<span class="go">jumped to 3FF89 in    3 us at offset    9,335,567,322  &lt;-- 1/4 file size</span>
<span class="go">jumped to 2FFA4 in    5 us at offset    7,001,675,508</span>
<span class="go">jumped to 3FF89 in    4 us at offset    9,335,567,366  &lt;-- 1/4 file size</span>
<span class="go">jumped to 37F98 in    4 us at offset    8,168,621,453</span>
<span class="go">jumped to 3FF89 in    3 us at offset    9,335,567,410  &lt;-- 1/4 file size</span>
<span class="go">jumped to 3BF94 in    3 us at offset    8,752,094,477</span>
<span class="go">jumped to 3FF89 in    2 us at offset    9,335,567,498  &lt;-- 1/4 file size</span>
<span class="go">jumped to 3DF8E in    3 us at offset    9,043,831,007</span>
<span class="go">jumped to 3CF90 in    3 us at offset    8,897,962,782</span>
<span class="go">jumped to 3DF8E in    2 us at offset    9,043,831,095</span>
<span class="go">jumped to 3D790 in    3 us at offset    8,970,896,964</span>
<span class="go">jumped to 3DF8E in    2 us at offset    9,043,831,139</span>
<span class="go">jumped to 3DB90 in  253 us at offset    9,007,364,072</span>
<span class="go">jumped to 3D990 in  206 us at offset    8,989,130,552</span>
<span class="go">jumped to 3DB90 in    6 us at offset    9,007,364,160</span>
<span class="go">jumped to 3DA8F in  270 us at offset    8,998,247,402  &lt;-- page 2,196,837</span>
<span class="go">jumped to 3DA0F in  189 us at offset    8,993,689,007</span>
<span class="go">jumped to 3DA8F in    5 us at offset    8,998,247,446  &lt;-- page 2,196,837</span>
<span class="go">jumped to 3DA4F in  212 us at offset    8,995,968,274</span>
<span class="go">jumped to 3DA8F in    5 us at offset    8,998,247,534  &lt;-- page 2,196,837</span>
<span class="go">jumped to 3DA6F in  266 us at offset    8,997,107,921</span>
<span class="go">jumped to 3DA5F in  203 us at offset    8,996,538,139</span>
<span class="go">jumped to 3DA57 in  195 us at offset    8,996,253,241</span>
<span class="go">jumped to 3DA53 in  197 us at offset    8,996,110,772</span>
<span class="go">jumped to 3DA57 in    6 us at offset    8,996,253,285</span>
<span class="go">jumped to 3DA55 in  193 us at offset    8,996,182,045</span>
<span class="go">jumped to 3DA54 in  178 us at offset    8,996,146,471</span>
<span class="go">jumped to 3DA54 in  189 us at offset    8,996,128,666</span>
<span class="go">jumped to 3DA54 in  191 us at offset    8,996,119,760  &lt;-- page 2,196,318</span>
<span class="go">jumped to 3DA54 in   32 us at offset    8,996,128,710</span>
<span class="go">jumped to 3DA54 in    5 us at offset    8,996,124,259</span>
<span class="go">jumped to 3DA54 in   10 us at offset    8,996,122,057  &lt;-- page 2,196,318</span>
<span class="go">jumped to 3DA54 in    4 us at offset    8,996,120,955  &lt;-- page 2,196,318</span>
<span class="go">jumped to 3DA54 in    4 us at offset    8,996,120,382  &lt;-- page 2,196,318</span>
<span class="go">jumped to 3DA54 in    9 us at offset    8,996,120,112  &lt;-- page 2,196,318</span>
<span class="go">jumped to 3DA54 in    1 us at offset    8,996,120,470  &lt;-- page 2,196,318</span>
<span class="go">jumped to 3DA54 in    1 us at offset    8,996,120,338  &lt;-- page 2,196,318</span>
<span class="go">pwned! seen 324,774 times before</span>
<span class="go">in 0.003654 seconds</span>
</code></pre></div>
</details>
<p>Half the reads are pretty fast:</p>
<ul>
<li>In the beginning, because searches start with the same few pages.</li>
<li>At the end, because searches end on the same page.</li>
<li>All reads of any page, after the first.</li>
</ul>
<p>So, it's those reads in the middle that we need to get rid of.</p>
<h3 id="position-heuristic">Position heuristic<span class="headerlink">&nbsp;<a href="#position-heuristic" title="permalink">#</a></span></h3>
<p>In theory, the output of a good hash function
<a class="external" href="https://en.wikipedia.org/wiki/Hash_function#Uniformity">should be uniformly distributed</a>.</p>
<p>This means that with a bit of math,
we can estimate where a hash would be
–
a hash that's ~1/5 in the range of all possible hashes
should be at ~1/5 of the file.</p>
<p>Here's a tiny example:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">digest</span> <span class="o">=</span> <span class="s1">&#39;5b&#39;</span>  <span class="c1"># 1-byte hash (2 hex digits)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>    <span class="c1"># 1000-byte long file</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">int_digest</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">digest</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>  <span class="c1"># == 91</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">int_end</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">**</span> <span class="nb">len</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span>   <span class="c1"># == 0xff + 1 == 256</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">int_digest</span> <span class="o">/</span> <span class="n">int_end</span><span class="p">)</span>
<span class="go">355</span>
</code></pre></div>
<p>We can do this once,
and then binary search a safety interval around that position.
Alas,
this only gets rid of the fast jumps at the beginning of the binary search,
and for some reason,
it ends up being slightly slower than binary search alone.
(<a class="attachment" href="/_file/pwned/80-proportional-position-lite.py">code</a>)</p>
<p>We can also narrow down around the estimated position iteratively,
making the interval smaller by a constant factor each time.
This seems to work:
a factor of 1000 yields 1.7 ms,
and a factor of 8000 yields 1.2 ms,
both in 2 steps.
(<a class="attachment" href="/_file/pwned/80-proportional-position.py">code</a>)</p>
<p>However, it has deeper issues:</p>
<ul>
<li>Having arbitrary start/end offsets complicates the code quite a bit.</li>
<li>I don't know how to reliably determine the factor.<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup></li>
<li>I don't know how to prove it's correct,<sup class="footnote-ref" id="fnref-3"><a href="#fn-3">3</a></sup>
especially for smaller intervals,
where the hashes are less uniform.
To be honest, I don't think it <em>can</em> be 100% correct,
and I don't know how to estimate how correct it is.</li>
</ul>
<p>Anyway, <a class="external" href="https://peps.python.org/pep-0020/">if the implementation is hard to explain, it's a bad idea</a>.</p>
<h3 id="index-file">Index file<span class="headerlink">&nbsp;<a href="#index-file" title="permalink">#</a></span></h3>
<p>An arbitrary self-imposed restriction I had was that
any solution should mostly use the original passwords list,
with little to no preparation.</p>
<p>By relaxing this a bit,
and going through the file once,
we can build an index like:</p>
<pre class="code code-container"><code>&lt;SHA-1 of the password&gt;:&lt;offset in file&gt;
</code></pre>
<p>... that we can then search with <code>skip_to_before_line()</code>.</p>
<p>Of course, we won't include all the hashes
–
by including lines a few kilobytes apart from each other,
we can seek directly to within a few kilobytes in the big file.</p>
<p>The only thing left to figure out is how much &quot;a few kilobytes&quot; is.</p>
<p>After my endless harping about caching and pages,
the answer should be obvious: one page size (<a class="external" href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/ManagingMemory/Articles/AboutMemory.html#//apple_ref/doc/uid/20001880-99100-TPXREF113">4K</a>).
And this actually gets us <strong>0.8 ms</strong>!
But back when I wrote the code,
that hadn't really sunk in,
so after getting 1.2 ms with a 32K distance, I moved on.</p>
<p>Code: <a class="attachment" href="/_file/pwned/81-index.py">pwned.py</a>, <a class="attachment" href="/_file/pwned/81-generate-index.py">generate-index.py</a>.</p>
<h3 id="binary-file">Binary file<span class="headerlink">&nbsp;<a href="#binary-file" title="permalink">#</a></span></h3>
<p>Already on the additional file slippery slope,
I converted the list to binary,
mostly to make it smaller – smaller file, fewer reads.</p>
<p>I packed each line into 24 bytes:</p>
<pre class="code code-container"><code>| binary hash (20 bytes) | count (4 bytes) |
</code></pre>
<p>This halved the file, but only lowered the runtime to a modest 2.6 ms.</p>
<p>More importantly, it made the code much, much simpler:
because items are fixed size,
you <em>can</em> know where the Nth item is,
so I was able to use <a class="external" href="https://docs.python.org/3/library/bisect.html">bisect</a> for the binary search.</p>
<p>Code: <a class="attachment" href="/_file/pwned/82-binary.py">pwned.py</a>, <a class="attachment" href="/_file/pwned/82-convert-to-binary.py">convert-to-binary.py</a>.</p>
<!-- TODO FIXME

## Aside: mmap

Mentioning this mainly because I'm not the only one that thought of it.

As a low hanging fruit, I though of [mmap()]-ing the file.
Sadly, this was roughly twice as slow as normal file,
both for the text and the binary file.

Another thing that might help is [fadvise()],
but that's not available on macOS.

[mmap()]: https://docs.python.org/3/library/mmap.html
[fadvise()]: https://linux.die.net/man/2/posix_fadvise

-->
<h2 id="getting-to-under-1-millisecond">Getting to under 1 millisecond<span class="headerlink">&nbsp;<a href="#getting-to-under-1-millisecond" title="permalink">#</a></span></h2>
<p>OK, what now? This is what we have so far:</p>
<ul>
<li>The position heuristic kinda (maybe?) works,
but is hard to reason about.</li>
<li>The index file gets us there, but barely,
and the index is pretty big.</li>
<li>The binary file isn't much faster,
and it creates a huge file.
But, less code!</li>
</ul>
<p>I don't know what to do with the first one, but I think we can combine the last two.</p>
<h3 id="generating-the-index">Generating the index<span class="headerlink">&nbsp;<a href="#generating-the-index" title="permalink">#</a></span></h3>
<p>Let's start with the script I made for the text index:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">buffer</span>
<span class="n">outf</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">12</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>The output looks like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>generate-index.py<span class="w"> </span>&lt;<span class="w"> </span>pwned.txt<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n5
<span class="go">000000005AD76BD555C1D6D771DE417A4B87E4B4:0</span>
<span class="go">00000099A4D3034E14DF60EF50799F695C27C0EC:4157</span>
<span class="go">00000172E8E1D1BD54AC23B3F9AB4383F291CA17:8312</span>
<span class="go">000002C8F808A7DB504BBC3C711BE8A8D508C0F9:12453</span>
<span class="go">0000047139578F13D70DD96BADD425C372DB64A9:16637</span>
</code></pre></div>
<p>We need to pack that into bytes.</p>
<p>A hash takes 20 bytes.
But,
we only need slightly more than 3 bytes (6 hex digits)
to distinguish between the index lines:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>generate-index.py<span class="w"> </span>&lt;<span class="w"> </span>pwned.txt<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-c-6<span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c<span class="w"> </span><span class="p">|</span><span class="w"> </span>head
<span class="go">   2 000000</span>
<span class="go">   1 000001</span>
<span class="go">   1 000002</span>
<span class="go">   1 000004</span>
<span class="go">   1 000005</span>
<span class="go">   1 000007</span>
<span class="go">   1 000008</span>
<span class="go">   1 00000A</span>
<span class="go">   1 00000B</span>
<span class="go">   1 00000C</span>
</code></pre></div>
<p>To represent all the offsets in the file,
we need <code>log2(35G) / 8 = 4.39...</code> bytes,
which results in a total of 9 bytes
(maybe even 8, if we mess with individual bits).</p>
<p>Let's make it future-proof:
6 bytes for the hash buys at least 55 trillion lines
(2.4 petabyte files), and
6 bytes for the offset buys 0.28 petabyte files.</p>
<!--
>>> size = 37342268646
>>> lines = 847223402
>>> size/lines
44.0760589920532
>>> lines * 256**2
55523632873472
>>> f"{lines * 256**2:,}"
'55,523,632,873,472'
>>> f"{lines * 256**2 * (size/lines):,}"
'2,447,262,917,984,256.0'
>>> f"{ 256**6 :,}"
'281,474,976,710,656'
-->
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="n">digest</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">digest</span><span class="o">.</span><span class="n">decode</span><span class="p">())[:</span><span class="mi">6</span><span class="p">])</span>
    <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<p>If you look at the text index,
you'll notice the offsets are 4K + ~50 bytes apart;
this results in sometimes having to read 2 pages,
because not all pages have an index entry.
Let's fix that by reading the first whole line after a 4K boundary instead:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">16</span>
<span class="normal">17</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">((</span><span class="n">pos</span> <span class="o">//</span> <span class="mi">4096</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>OK, we're done:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="nb">time</span><span class="w"> </span>python<span class="w"> </span>generate-index.py<span class="w"> </span>&lt;<span class="w"> </span>pwned.txt<span class="w"> </span>&gt;<span class="w"> </span>index.bin

<span class="go">real	1m2.729s</span>
<span class="go">user	0m34.292s</span>
<span class="go">sys	0m21.392s</span>
</code></pre></div>
<h3 id="using-the-index">Using the index<span class="headerlink">&nbsp;<a href="#using-the-index" title="permalink">#</a></span></h3>
<p>We start with a skeleton that's functionally identical
to the <a class="anchor" href="#a-minimal-plausible-solution">naive</a> script.
The only difference is that I've added stubs
for passing and using the index:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">skip_to_before_line_index</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">find_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">23</span>
<span class="normal">24</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">skip_to_before_line_index</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">index_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">index</span> <span class="o">=</span> <span class="o">...</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">43</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">index</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<details>
<summary>
The whole skeleton, if you want to see it:
</summary>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bisect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">skip_to_before_line_index</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">find_line_linear</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_line_linear</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">skip_to_before_line_index</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="o">...</span>


<span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>

<span class="n">index_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">index</span> <span class="o">=</span> <span class="o">...</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">()</span>
<span class="n">hexdigest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="k">del</span> <span class="n">password</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;looking for&quot;</span><span class="p">,</span> <span class="n">hexdigest</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">find_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">hexdigest</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">index</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="k">if</span> <span class="n">line</span><span class="p">:</span>
    <span class="n">times</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pwned! seen </span><span class="si">{</span><span class="n">times</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> times before&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not found&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</details>
<p>As mentioned before,
we'll use the standard library <a class="external" href="https://docs.python.org/3/library/bisect.html">bisect</a> module
to search the index.</p>
<p>We <em>could</em> read the entire index in memory,
as a list of 12-byte <a class="external" href="https://docs.python.org/3/library/stdtypes.html#bytes">bytes</a>.
But that would still be slow, even if outside the current timing code,
and memory usage would increase with the size of the file.</p>
<p>Fortunately,
<a class="external" href="https://docs.python.org/3/library/bisect.html">bisect</a> doesn't only work with lists,
it works with any <a class="external" href="https://docs.python.org/3/glossary.html#term-sequence">sequence</a>
– that is, any object that can pretend to be a list.
So we'll build our own,
by implementing the two required<sup class="footnote-ref" id="fnref-4"><a href="#fn-4">4</a></sup> special methods.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BytesArray</span><span class="p">:</span>

    <span class="n">item_size</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
</code></pre></div></td></tr></table></div>

<p>We can go ahead and plug it in:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">38</span>
<span class="normal">39</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">index_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">BytesArray</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">index_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<p>The first special method is <a class="external" href="https://docs.python.org/3/reference/datamodel.html#object.__getitem__">__getitem__()</a>, for <code>a[i]</code>:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_size</span><span class="p">)</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># out of bounds</span>
        <span class="k">return</span> <span class="n">buffer</span>
</code></pre></div></td></tr></table></div>

<p>The second special method is <a class="external" href="https://docs.python.org/3/reference/datamodel.html#object.__len__">__len__()</a>, for <code>len(a)</code>:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_size</span>
</code></pre></div></td></tr></table></div>

<p>Using the index becomes straightforward:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">skip_to_before_line_index</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">item_prefix</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">decode</span><span class="p">())[:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">find_lt</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">item_prefix</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">6</span><span class="p">:],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_lt</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>

<p>We get the first 6 bytes of the hash,
find the rightmost value less than that,
extract the offset from it,
and seek to there.
<code>find_lt()</code> comes from <a class="external" href="https://docs.python.org/3/library/bisect.html">bisect</a>'s recipes for <a class="external" href="https://docs.python.org/3/library/bisect.html#searching-sorted-lists">searching sorted lists</a>.</p>
<p>And we're done:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>average-many<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>index.bin
<span class="go">.002546</span>
</code></pre></div>
<p>Huh? ... that's unexpected...</p>
<p>Oh.</p>
<p>I said we won't read the index in memory.
But we <em>can</em> force it into the cache
by reading it a bunch of times:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span><span class="k">for</span><span class="w"> </span>_<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..10<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>cat<span class="w"> </span>index.bin<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">done</span>
</code></pre></div>
<p>Finally:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>average-many<span class="w"> </span>pwned.py<span class="w"> </span>pwned.txt<span class="w"> </span>index.bin
<span class="go">.000421</span>
</code></pre></div>
<p>Code: <a class="attachment" href="/_file/pwned/11-binary-index.py">pwned.py</a>, <a class="attachment" href="/_file/pwned/10-generate-index.py">generate-index.py</a>.</p>
<h3 id="i-heard-you-like-indexes-the-end">I heard you like indexes (the end)<span class="headerlink">&nbsp;<a href="#i-heard-you-like-indexes-the-end" title="permalink">#</a></span></h3>
<p>Hmmm... isn't that cold start bugging you?
If we make an index for the big index,
we get 1.2 ms from a cold start.
Maybe another smaller index can take us to below 1 ms?</p>
<p>...</p>
<p>Just kidding, this is it, this really is the end.</p>
<p>And now, let's take that moment to ponder:</p>
<table class="table">
<thead>
<tr>
  <th>method</th>
  <th style="text-align:right">statements</th>
  <th style="text-align:right">time (ms, order of magnitude)</th>
</tr>
</thead>
<tbody>
<tr>
  <td>linear</td>
  <td style="text-align:right">29</td>
  <td style="text-align:right">100,000</td>
</tr>
<tr>
  <td>linear+skip</td>
  <td style="text-align:right">42</td>
  <td style="text-align:right">100</td>
</tr>
<tr>
  <td>binary search</td>
  <td style="text-align:right">49</td>
  <td style="text-align:right">10</td>
</tr>
<tr>
  <td>binary index</td>
  <td style="text-align:right">59 (72)</td>
  <td style="text-align:right">1</td>
</tr>
</tbody>
</table>
<p>For twice the code, it's 5 orders of magnitude faster!
I'm deliberately not counting bisect or the OS cache here,
beacuse that's the point, they're basically free.</p>
<p>Turns out, you can get pretty far with just <em>a few</em> tricks.</p>
<hr />
<p>That's it for now.</p>
<p><strong>Learned something new today?</strong> Share it with others, it really helps! <span class="text-large">
<span class="share-icons">
<a
    class="share-icon pycoders color"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news color"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/pwned&t=Has%20your%20password%20been%20pwned%3F%20Or%2C%20how%20I%20almost%20failed%20to%20search%20a%2037%C2%A0GB%20text%20file%20in%20under%201%C2%A0millisecond%20%28in%20Python%29"
>HN</a>
<a
    class="share-icon bluesky color"
    href="https://bsky.%61%70%70/intent/compose?text=Has%20your%20password%20been%20pwned%3F%20Or%2C%20how%20I%20almost%20failed%20to%20search%20a%2037%C2%A0GB%20text%20file%20in%20under%201%C2%A0millisecond%20%28in%20Python%29%20https%3A//death.andgravity.com/pwned"
>Bluesky</a>
<!--
<a
    class="share-icon reddit color"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/pwned&title=Has%20your%20password%20been%20pwned%3F%20Or%2C%20how%20I%20almost%20failed%20to%20search%20a%2037%C2%A0GB%20text%20file%20in%20under%201%C2%A0millisecond%20%28in%20Python%29"
>Reddit</a>
-->
<a
    class="share-icon linkedin color"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/pwned"
>linkedin</a>
<a
    class="share-icon twitter color"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Has%20your%20password%20been%20pwned%3F%20Or%2C%20how%20I%20almost%20failed%20to%20search%20a%2037%C2%A0GB%20text%20file%20in%20under%201%C2%A0millisecond%20%28in%20Python%29&url=https%3A//death.andgravity.com/pwned&via=_andgravity"
>Twitter</a>
</span>
</span></p>




<div class="panel inline-panel" >
    <div class="panel-header text-large">
        If you&#39;ve made it this far, you might like:
    </div>
    <div class="panel-body">
        <p><a href="/query-builder-how">
            Write an SQL query builder in 150 lines of Python!
        </a>
    </div>
</div>
<h2 id="bonus-better-data-structures">Bonus: better data structures<span class="headerlink">&nbsp;<a href="#bonus-better-data-structures" title="permalink">#</a></span></h2>
<p>As always, a specialized data structure can solve a problem better.</p>
<p>In <a class="external" href="https://scotthelme.co.uk/sketchy-pwned-passwords/">Sketchy Pwned Passwords</a>,
Scott Helme manages to &quot;pack&quot; the entire passwords list
into a 1.5G in-memory <a class="external" href="https://en.wikipedia.org/wiki/Count%E2%80%93min_sketch">count-min sketch</a>,
which can then be queried in 1 microsecond.
And, if you don't care about the counts,
<a class="external" href="https://scotthelme.co.uk/when-pwned-passwords-bloom/">a plain Bloom filter</a> can even take you to 0.1 µs!
(There is a trade-off, and it's that it takes 11 hours to create either.)</p>
<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661&SIGNUP=pwned"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"
>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">

        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>
<!--

# Bonus: the k-Anonymity API

<!-- TODO: fix file to be api only

.. literalinclude:: 03-kanon.py
    :lines: 45-52

.. literalinclude:: 03-kanon.py
    :lines: 55-61
    :emphasize-lines: 2-4,7

.. literalinclude:: 03-kanon.py
    :lines: 72-74
    :emphasize-lines: 2

https://api.pwnedpasswords.com/range/5baa6

https://haveibeenpwned.com/API/v3#PwnedPasswords

-->
<section class="footnotes">
<ol>
<li id="fn-1"><p>It's <a class="external" href="https://stackoverflow.com/q/28676177">kinda difficult</a> to do in Python anyway. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p>Something like <code>(size / 4096) ** (1 / int(log(size, 4096)))</code>, maybe? <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-3"><p>I mean, I did cross-check it with other solutions
for a few thousand values, and it <em>seems</em> correct,
but that's not proof. <a href="#fnref-3" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-4"><p>We're only implementing the parts of the protocol that <code>bisect</code> uses.</p>
<p>For the full protocol,
<a class="external" href="https://docs.python.org/3/reference/datamodel.html#object.__getitem__">__getitem__()</a> would need to implement
negative indexes and slicing.
For more, free sequence methods, inherit <a class="external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence">collections.abc.Sequence</a>.</p>
<p>Interestingly, the class will work in a <code>for</code> loop
without an <a class="external" href="https://docs.python.org/3/reference/datamodel.html#object.__iter__">__iter__()</a> method.
That's because there are actually two iteration protocols:
an older one, using __getitem__(),
and a newer one, <a class="external" href="https://peps.python.org/pep-0234/">added in Python 2.1</a>,
using __iter__() and __next__().
For details on the logic,
see <a class="external" href="https://snarky.ca/unravelling-for-statements/#iter-iterable-">Unravelling <code>for</code> statements</a>. <a href="#fnref-4" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>