






<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />







<title>query-builder-how - death and gravity</title>




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">query-builder-how</h1>

<p class="text-gray"><small>
<span>2021-08-08</span>



âˆ™ 11 minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>part of a series etc.</p>
<p>a walk-through: we'll rewrite the query builder from scratch, incrementally,
looking at various things.</p>
<details>
<summary>Contents</summary>
<section class="toc">
<ul>
<li><a href="#what-are-we-trying-to-build">what are we trying to build?</a></li>
<li><a href="#trade-offs">trade-offs</a></li>
<li><a href="#data-representation">data representation</a></li>
<li><a href="#a-minimal-plausible-solution">a minimal plausible solution</a>
<ul>
<li><a href="#class">class</a></li>
<li><a href="#adding-stuff">adding stuff</a></li>
<li><a href="#printing-stuff">printing stuff</a></li>
<li><a href="#test">test</a></li>
</ul>
</li>
<li><a href="#separators">separators</a></li>
<li><a href="#aliases">aliases</a>
<ul>
<li><a href="#more-data-representation">more data representation</a></li>
<li><a href="#output">output</a></li>
</ul>
</li>
<li><a href="#subqueries">subqueries</a>
<ul>
<li><a href="#add-is-subquery">add is_subquery</a></li>
<li><a href="#set-is-subquery">set is_subquery</a></li>
<li><a href="#use-is-subquery">use is_subquery</a></li>
</ul>
</li>
<li><a href="#joins">joins</a>
<ul>
<li><a href="#add-keyword-option">add keyword option</a></li>
<li><a href="#set-keyword">set keyword</a></li>
<li><a href="#use-keyword">use keyword</a></li>
</ul>
</li>
<li><a href="#distinct">distinct</a>
<ul>
<li><a href="#add-flaglist">add flaglist</a></li>
<li><a href="#set-flag">set flag</a></li>
<li><a href="#use-flag">use flag</a></li>
</ul>
</li>
<li><a href="#more-tests">more tests</a></li>
<li><a href="#more-init">more init</a></li>
<li><a href="#wrapping-up">wrapping up</a></li>
</ul>
</section>
</details>
<h2 id="what-are-we-trying-to-build">what are we trying to build?<span class="headerlink"> <a href="#what-are-we-trying-to-build" title="permalink">#</a></span></h2>
<p>TBD: an example</p>
<h2 id="trade-offs">trade-offs<span class="headerlink"> <a href="#trade-offs" title="permalink">#</a></span></h2>
<ul>
<li>little customization; there's exactly one user for this, no need for API flourishes</li>
<li>some error checking; exceptions for most errors, but it doesn't matter what kind, they're only for indicating programming bugs (should never bubble up to the end user)</li>
<li>only cover the <a href="/own-query-builder#requirements-and-existing-libraries">known requirements</a></li>
<li>only support SQLite syntax</li>
</ul>
<h2 id="data-representation">data representation<span class="headerlink"> <a href="#data-representation" title="permalink">#</a></span></h2>
<p>As mentioned in the <a href="/own-query-builder#the-first-prototype">previous article</a>,
my prototype query builder was based on the idea that
<em>queries can be represented as plain data structures</em>.</p>
<p>Looking at a query, a more or less natural representation may come to mind:</p>
<div class="highlight code-container"><pre class="code" data-lang="SQL"><span></span><code><span class="k">SELECT</span>
    <span class="n">one</span><span class="p">,</span>
    <span class="n">two</span>
<span class="k">FROM</span>
    <span class="k">table</span>
<span class="k">WHERE</span>
    <span class="n">condition</span> <span class="k">AND</span>
    <span class="n">another</span><span class="o">-</span><span class="n">condition</span>
</code></pre></div>
<p>See it?</p>
<p>It's a dict with a list of strings for each clause:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="p">{</span>
    <span class="s1">&#39;SELECT&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;one&#39;</span><span class="p">,</span>
        <span class="s1">&#39;two&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">&#39;FROM&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;table&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">&#39;WHERE&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">,</span>
        <span class="s1">&#39;another-condition&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">}</span>
</code></pre></div>
<p>Let's start from this model, and build ourselves a query builder.</p>
<p>note: this is a linear story, going only through what worked;
there other possible implemenations,
some of which I did take and then changed my mind on</p>
<h2 id="a-minimal-plausible-solution">a minimal plausible solution<span class="headerlink"> <a href="#a-minimal-plausible-solution" title="permalink">#</a></span></h2>
<h3 id="class">class<span class="headerlink"> <a href="#class" title="permalink">#</a></span></h3>
<p>We start by adding a class:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Query</span><span class="p">:</span>

    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;WITH&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;FROM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;WHERE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GROUP BY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HAVING&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ORDER BY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LIMIT&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>as mentioned in the previous article, we don't want to work with the underlying data structure; we want <code>query.SELECT('one', 'two')</code> instead of <code>query['SELECT'].extend(['one', 'two'])</code></li>
<li>no customization in the constructor, for now; if we need more clauses, we can add them to <code>keywords</code> directly</li>
<li>not subclassing dict, to keep the API tight</li>
<li>we build the dict upfront; this means we can use the dict order directly (py36+, insertion order), and we get some free error checking (<code>data[keyword]</code> for the wrong keyword )</li>
<li>we could use dataclasses, but most of the time the repr() is too long to be useful, and we don't need any other magic methods</li>
</ul>
<h3 id="adding-stuff">adding stuff<span class="headerlink"> <a href="#adding-stuff" title="permalink">#</a></span></h3>
<p>Next, we add code to add stuff:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_clean_up</span><span class="p">(</span><span class="n">thing</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<ul>
<li><p><code>add()</code> appends all its arguments to the list corresponding to <code>keyword</code></p>
<ul>
<li>note <code>self.data[keyword]</code> (free keyerror for bad keywords)</li>
<li>upfront decision: we clean everything up and make as many choices here; this allows the part that generates the output to not care about any of that, and ensures error checking happens as early as possible (when building the query, not when converting it to a string)</li>
<li>we return self, to allow for chaining (<code>query.add(...).add(...)</code>)</li>
<li>add() is also an escape hatch for when we want to use a &quot;clause&quot; that's not a python identifier</li>
</ul>
</li>
<li><p><code>__getattr__()</code> fabricates &quot;methods&quot; on the fly</p>
<ul>
<li>we make a stylistic choice, and require all keywords to be uppercase (<code>query.GROUP_BY()</code>, not <code>query.group_by()</code>)<ul>
<li>makes it clearer to the user these are special methods</li>
<li>it also has the benfit of us not having to avoid shadowing dunder methods like <code>__deepcopy__</code></li>
<li>we don't bother raising AttributeError explicitly, we just let getattr() do it for us</li>
</ul>
</li>
<li><code>__getattr__()</code> gets called for attributes that don't exist</li>
<li>we return a <code>KEYWORD(*args)</code> callable by wrapping add() in a <code>partial</code><ul>
<li>we could save the partial on the object (<code>setattr(self, name.replace('_', ' '), functools(...)</code>); this would side-step <code>__getattr__()</code> on subsequent calls, and return the stored partial; premature optimization</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="printing-stuff">printing stuff<span class="headerlink"> <a href="#printing-stuff" title="permalink">#</a></span></h3>
<p>Finally, we turn the thing back into a string:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">default_separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">_indent</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>to get an SQL string, the user calls <code>str(query)</code>, which ends up calling <code>__str__</code> on our object<ul>
<li>instead of doing everything in <code>__str__</code>, we farm most of the work to <code>_lines()</code>, which generates output lines; the main benefit of this is that it allows us to write <code>yield line</code> instead of <code>rv.append(line)</code>; a second benefit is that we could, in theory, pass it directly to an open file's writelines() method, and never have to build a whole string (although we won't actually need this); same goes for subqueries</li>
<li>we also split the output for each clause into <code>_lines_keyword()</code>, since we'll add more stuff over time, and they're both gonna get more complicated (I initially left everything in _lines(), and had to refactor afterwards)</li>
<li>because we may want to change how indenting happens, we make it a method using a partial</li>
</ul>
</li>
<li>we store the separator as a class attribute, both to document what it is, and in case it ever needs to be overridden</li>
</ul>
<h3 id="test">test<span class="headerlink"> <a href="#test" title="permalink">#</a></span></h3>
<p>For a minimal thing, we're mostly done.</p>
<p>To make sure we don't break stuff that works in the future, we add a basic test:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="separators">separators<span class="headerlink"> <a href="#separators" title="permalink">#</a></span></h2>
<p>At this point, the WHERE output doesn't really make sense:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">))</span>
<span class="go">WHERE</span>
<span class="go">    a,</span>
<span class="go">    b</span>
</code></pre></div>
<p>We fix this by special-casing the separators for a few clauses,
and storing them as a class attribute.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">separators</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">WHERE</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span> <span class="n">HAVING</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
<span class="hll">                <span class="k">try</span><span class="p">:</span>
</span><span class="hll">                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
</span><span class="hll">                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span class="hll">                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>
</span><span class="hll">
</span>            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<p>We could've used defaultdict and gotten rid of <code>default_separator</code>,
but then we'd have to remember that the non-comma separators need a space â€“ <code>' AND'</code>;
it's clearer to put this directly in code.</p>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
</span>    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="hll"><span class="sd">        WHERE</span>
</span><span class="hll"><span class="sd">            where-one AND</span>
</span><span class="hll"><span class="sd">            where-two</span>
</span><span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="aliases">aliases<span class="headerlink"> <a href="#aliases" title="permalink">#</a></span></h2>
<p>One of the requirements is making it possible to implement on top of our builder
<a href="/query-builder-why#intermission-scrolling-window-queries">scrolling window queries</a>.</p>
<p>For this to happen, that code needs to be able to introspect
the aliases we use in SELECT, so it can use them in the generated WHERE condition.</p>
<p>The output of the following looks OK, but to extract <code>alias</code> programmatically,
we'd need to parse <code>column AS alias</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;column AS alias&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SELECT&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="go">&#39;column AS alias&#39;</span>
</code></pre></div>
<p>Passing a pair of strings when we want an aliased column seems like an acceptable thing.
Since the column expression might be quite long,
we'll make the alias the first thing in the pair.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">),</span> <span class="s1">&#39;two&#39;</span><span class="p">))</span>
<span class="go">SELECT</span>
<span class="go">    one AS alias,</span>
<span class="go">    two</span>
</code></pre></div>
<h3 id="more-data-representation">more data representation<span class="headerlink"> <a href="#more-data-representation" title="permalink">#</a></span></h3>
<p>As mentioned earlier, we'll store the data in cleaned up and standard form,
so the output code doesn't have to care about that.
A 2-tuple seems like a decent choice.</p>
<p>Here we depart a tiny bit from plain data structures:
to make the code easier to read,
we'll use a named tuple instead of a plain tuple.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_arg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid arg: </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">_clean_up</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
</code></pre></div>
</td></tr></table>
<p>Conveniently, this also gives us a place where to convert the string-or-pair,
in the form of the <code>from_arg()</code> alternate constructor.
We could've made it a stand-alone function,
but this makes clearer what's being returned.</p>
<section class="admonition note">
<div class="admonition-text">
<p>Note that we use an empty string to mean &quot;no alias&quot;.
 In general, it's a good idea to distinguish this kind of absence by using None,
 since the empty string may be a valid input,
 and None can prevent some bugs â€“ e.g. you can't concatenate None to a string.
 Here, we know an empty string cannot be a valid alias, so we don't bother.</p>
</div>
</section>
<p>Using it is just a one-line change to <code>add()</code>:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
<span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<h3 id="output">output<span class="headerlink"> <a href="#output" title="permalink">#</a></span></h3>
<p>On output, we have two concerns:</p>
<ol>
<li>there may or may not be an alias</li>
<li>the order differs:
 you have <code>select expr as column-alias</code>,
 but you have <code>with table-name as (stmt)</code>
 (we treat the CTE table name as an alias)</li>
</ol>
<p>We can model this with mostly-empty <a href="https://docs.python.org/3/library/collections.html#collections.defaultdict">defaultdict</a>s:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">formats</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{value}</span><span class="s1">&#39;</span><span class="p">),</span>
        <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{value}</span><span class="s1"> AS </span><span class="si">{alias}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">WITH</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{alias}</span><span class="s1"> AS </span><span class="si">{value}</span><span class="s1">&#39;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>To choose between &quot;has alias&quot; and &quot;doesn't have alias&quot;,
we take advantage of True and False being equal to 1 and 0
(this may be to clever for our own good, but eh).</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

<span class="hll">            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
</span><span class="hll">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
<span class="hll">        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
</span>        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="hll"><span class="sd">            select-two AS alias</span>
</span><span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="subqueries">subqueries<span class="headerlink"> <a href="#subqueries" title="permalink">#</a></span></h2>
<h3 id="add-is-subquery">add is_subquery<span class="headerlink"> <a href="#add-is-subquery" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="hll">    <span class="n">is_subquery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span>
    <span class="nd">@classmethod</span>
<span class="hll">    <span class="k">def</span> <span class="nf">from_arg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid arg: </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="hll">        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">_clean_up</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></code></pre></div>
</td></tr></table>
<h3 id="set-is-subquery">set is_subquery<span class="headerlink"> <a href="#set-is-subquery" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">28</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">subquery_keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;WITH&#39;</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

<span class="hll">        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
</span><span class="hll">            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">
</span>        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
<span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<h3 id="use-is-subquery">use is_subquery<span class="headerlink"> <a href="#use-is-subquery" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
<span class="hll">            <span class="n">value</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">value</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">is_subquery</span><span class="p">:</span>
</span><span class="hll">                <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">)&#39;</span>
</span><span class="hll">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
</span><span class="hll">
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
<span class="hll">        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
</span>        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="hll"><span class="sd">        WITH</span>
</span><span class="hll"><span class="sd">            alias AS (</span>
</span><span class="hll"><span class="sd">                with</span>
</span><span class="hll"><span class="sd">            )</span>
</span><span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="joins">joins<span class="headerlink"> <a href="#joins" title="permalink">#</a></span></h2>
<h3 id="add-keyword-option">add keyword option<span class="headerlink"> <a href="#add-keyword-option" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="hll">    <span class="n">keyword</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span>    <span class="n">is_subquery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
</td></tr></table>
<h3 id="set-keyword">set keyword<span class="headerlink"> <a href="#set-keyword" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">fake_keywords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">JOIN</span><span class="o">=</span><span class="s1">&#39;FROM&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="hll">        <span class="n">keyword</span><span class="p">,</span> <span class="n">fake_keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_fakes</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
</span>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="hll">        <span class="k">if</span> <span class="n">fake_keyword</span><span class="p">:</span>
</span><span class="hll">            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">fake_keyword</span><span class="p">)</span>
</span>        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>

<span class="hll">    <span class="k">def</span> <span class="nf">_resolve_fakes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">real</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_keywords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">keyword</span><span class="p">:</span>
</span><span class="hll">                <span class="k">return</span> <span class="n">real</span><span class="p">,</span> <span class="n">keyword</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">keyword</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</span></code></pre></div>
</td></tr></table>
<h3 id="use-keyword">use keyword<span class="headerlink"> <a href="#use-keyword" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="hll">            <span class="n">grouped</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span class="hll">            <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
</span><span class="hll">                <span class="n">grouped</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
</span><span class="hll">            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span>
    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

<span class="hll">            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">is_subquery</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">)&#39;</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>

<span class="hll">            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">:</span>
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
</span>        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            alias AS (</span>
<span class="sd">                with</span>
<span class="sd">            )</span>
<span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="hll"><span class="sd">        JOIN</span>
</span><span class="hll"><span class="sd">            join</span>
</span><span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="distinct">distinct<span class="headerlink"> <a href="#distinct" title="permalink">#</a></span></h2>
<h3 id="add-flaglist">add flaglist<span class="headerlink"> <a href="#add-flaglist" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">117</span>
<span class="normal">118</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_FlagList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="n">flag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">31</span>
<span class="normal">32</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_FlagList</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">}</span>
</span></code></pre></div>
</td></tr></table>
<h3 id="set-flag">set flag<span class="headerlink"> <a href="#set-flag" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">30</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">flag_keywords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SELECT</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DISTINCT&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL&#39;</span><span class="p">})</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">keyword</span><span class="p">,</span> <span class="n">fake_keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_fakes</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
<span class="hll">        <span class="n">keyword</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_flags</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
</span>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

<span class="hll">        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
</span><span class="hll">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2"> already has flag: </span><span class="si">{</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>
</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">fake_keyword</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">fake_keyword</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_resolve_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_keywords</span><span class="p">[</span><span class="n">prefix</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid flag for </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">flag</span>
        <span class="k">return</span> <span class="n">keyword</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</code></pre></div>
</td></tr></table>
<h3 id="use-flag">use flag<span class="headerlink"> <a href="#use-flag" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

<span class="hll">            <span class="k">if</span> <span class="n">things</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">things</span><span class="o">.</span><span class="n">flag</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span class="hll">            <span class="k">else</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
                <span class="n">grouped</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">SELECT_DISTINCT</span><span class="p">(</span><span class="s1">&#39;select-three&#39;</span><span class="p">)</span>
</span>    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            alias AS (</span>
<span class="sd">                with</span>
<span class="sd">            )</span>
<span class="hll"><span class="sd">        SELECT DISTINCT</span>
</span><span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias,</span>
<span class="hll"><span class="sd">            select-three</span>
</span><span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        JOIN</span>
<span class="sd">            join</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="more-tests">more tests<span class="headerlink"> <a href="#more-tests" title="permalink">#</a></span></h2>
<details>
<summary>long tests</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">6</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="more-init">more init<span class="headerlink"> <a href="#more-init" title="permalink">#</a></span></h2>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">_FlagList</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">separators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">separators</span> <span class="o">=</span> <span class="n">separators</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_init</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">({</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]},</span> <span class="p">{</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="s1">&#39;OR&#39;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        (</span>
<span class="sd">            one OR</span>
<span class="sd">            two OR</span>
<span class="sd">            three</span>
<span class="sd">        )</span>

<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="wrapping-up">wrapping up<span class="headerlink"> <a href="#wrapping-up" title="permalink">#</a></span></h2>
<p><a href="/_file/query-builder-how/07-more-init/builder.py">final thing</a></p>













</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
âˆ™ <a href="/_feed/index.xml">feed</a>
âˆ™ <a href="/about">about</a>

âˆ™ Â© 2021 lemon24



</footer>


</div>