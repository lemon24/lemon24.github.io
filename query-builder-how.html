






<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />







<title>query-builder-how - death and gravity</title>




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">query-builder-how</h1>

<p class="text-gray"><small>
<span>2021-08-08</span>



âˆ™ eight minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<section class="toc">
<ul>
<li><a href="#begin">begin</a>
<ul>
<li><a href="#class">class</a></li>
<li><a href="#adding-stuff">adding stuff</a></li>
<li><a href="#printing-stuff">printing stuff</a></li>
<li><a href="#test">test</a></li>
</ul>
</li>
<li><a href="#separators">separators</a>
<ul>
<li><a href="#test-1">test</a></li>
</ul>
</li>
<li><a href="#aliases">aliases</a>
<ul>
<li><a href="#add-thing">add thing</a></li>
<li><a href="#create-thing">create thing</a></li>
<li><a href="#output-thing">output thing</a></li>
<li><a href="#test-2">test</a></li>
</ul>
</li>
<li><a href="#subqueries">subqueries</a>
<ul>
<li><a href="#add-is-subquery">add is_subquery</a></li>
<li><a href="#set-is-subquery">set is_subquery</a></li>
<li><a href="#use-is-subquery">use is_subquery</a></li>
<li><a href="#test-3">test</a></li>
</ul>
</li>
<li><a href="#joins">joins</a>
<ul>
<li><a href="#add-keyword-option">add keyword option</a></li>
<li><a href="#set-keyword">set keyword</a></li>
<li><a href="#use-keyword">use keyword</a></li>
<li><a href="#test-4">test</a></li>
</ul>
</li>
<li><a href="#distinct">distinct</a>
<ul>
<li><a href="#add-flaglist">add flaglist</a></li>
<li><a href="#set-flag">set flag</a></li>
<li><a href="#use-flag">use flag</a></li>
<li><a href="#test-5">test</a></li>
</ul>
</li>
<li><a href="#more-tests">more tests</a></li>
<li><a href="#more-init">more init</a></li>
<li><a href="#wrapping-up">wrapping up</a></li>
</ul>
</section>
<h2 id="begin">begin<span class="headerlink"> <a href="#begin" title="permalink">#</a></span></h2>
<h3 id="class">class<span class="headerlink"> <a href="#class" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>
<span class="k">class</span> <span class="nc">Query</span><span class="p">:</span>

    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;WITH&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;FROM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;WHERE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GROUP BY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HAVING&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ORDER BY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LIMIT&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h3 id="adding-stuff">adding stuff<span class="headerlink"> <a href="#adding-stuff" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>


<span class="k">def</span> <span class="nf">_clean_up</span><span class="p">(</span><span class="n">thing</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">1</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">functools</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
</code></pre></div>
</td></tr></table>
<h3 id="printing-stuff">printing stuff<span class="headerlink"> <a href="#printing-stuff" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">2</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">textwrap</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">default_separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">_indent</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h3 id="test">test<span class="headerlink"> <a href="#test" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>

<span class="kn">from</span> <span class="nn">builder</span> <span class="kn">import</span> <span class="n">Query</span>


<span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="separators">separators<span class="headerlink"> <a href="#separators" title="permalink">#</a></span></h2>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">separators</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">WHERE</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span> <span class="n">HAVING</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
<span class="hll">                <span class="k">try</span><span class="p">:</span>
</span><span class="hll">                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
</span><span class="hll">                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span class="hll">                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>
</span><span class="hll">
</span>            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<h3 id="test-1">test<span class="headerlink"> <a href="#test-1" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
</span>    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="hll"><span class="sd">        WHERE</span>
</span><span class="hll"><span class="sd">            where-one AND</span>
</span><span class="hll"><span class="sd">            where-two</span>
</span><span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="aliases">aliases<span class="headerlink"> <a href="#aliases" title="permalink">#</a></span></h2>
<h3 id="add-thing">add thing<span class="headerlink"> <a href="#add-thing" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">3</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_arg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid arg: </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">_clean_up</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
</code></pre></div>
</td></tr></table>
<h3 id="create-thing">create thing<span class="headerlink"> <a href="#create-thing" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
<span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<h3 id="output-thing">output thing<span class="headerlink"> <a href="#output-thing" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">3</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">formats</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{value}</span><span class="s1">&#39;</span><span class="p">),</span>
        <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{value}</span><span class="s1"> AS </span><span class="si">{alias}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">WITH</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{alias}</span><span class="s1"> AS </span><span class="si">{value}</span><span class="s1">&#39;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

<span class="hll">            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
</span><span class="hll">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<h3 id="test-2">test<span class="headerlink"> <a href="#test-2" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
<span class="hll">        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
</span>        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="hll"><span class="sd">            select-two AS alias</span>
</span><span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="subqueries">subqueries<span class="headerlink"> <a href="#subqueries" title="permalink">#</a></span></h2>
<h3 id="add-is-subquery">add is_subquery<span class="headerlink"> <a href="#add-is-subquery" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="hll">    <span class="n">is_subquery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span>
    <span class="nd">@classmethod</span>
<span class="hll">    <span class="k">def</span> <span class="nf">from_arg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid arg: </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="hll">        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">_clean_up</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></code></pre></div>
</td></tr></table>
<h3 id="set-is-subquery">set is_subquery<span class="headerlink"> <a href="#set-is-subquery" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">28</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">subquery_keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;WITH&#39;</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

<span class="hll">        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
</span><span class="hll">            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">
</span>        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
<span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<h3 id="use-is-subquery">use is_subquery<span class="headerlink"> <a href="#use-is-subquery" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
<span class="hll">            <span class="n">value</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">value</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">is_subquery</span><span class="p">:</span>
</span><span class="hll">                <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">)&#39;</span>
</span><span class="hll">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
</span><span class="hll">
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<h3 id="test-3">test<span class="headerlink"> <a href="#test-3" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
<span class="hll">        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
</span>        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="hll"><span class="sd">        WITH</span>
</span><span class="hll"><span class="sd">            alias AS (</span>
</span><span class="hll"><span class="sd">                with</span>
</span><span class="hll"><span class="sd">            )</span>
</span><span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="joins">joins<span class="headerlink"> <a href="#joins" title="permalink">#</a></span></h2>
<h3 id="add-keyword-option">add keyword option<span class="headerlink"> <a href="#add-keyword-option" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="hll">    <span class="n">keyword</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span>    <span class="n">is_subquery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
</td></tr></table>
<h3 id="set-keyword">set keyword<span class="headerlink"> <a href="#set-keyword" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">fake_keywords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">JOIN</span><span class="o">=</span><span class="s1">&#39;FROM&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="hll">        <span class="n">keyword</span><span class="p">,</span> <span class="n">fake_keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_fakes</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
</span>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="hll">        <span class="k">if</span> <span class="n">fake_keyword</span><span class="p">:</span>
</span><span class="hll">            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">fake_keyword</span><span class="p">)</span>
</span>        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>

<span class="hll">    <span class="k">def</span> <span class="nf">_resolve_fakes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">real</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_keywords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">keyword</span><span class="p">:</span>
</span><span class="hll">                <span class="k">return</span> <span class="n">real</span><span class="p">,</span> <span class="n">keyword</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">keyword</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</span></code></pre></div>
</td></tr></table>
<h3 id="use-keyword">use keyword<span class="headerlink"> <a href="#use-keyword" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="hll">            <span class="n">grouped</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span class="hll">            <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
</span><span class="hll">                <span class="n">grouped</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
</span><span class="hll">            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span>
    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

<span class="hll">            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">is_subquery</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">)&#39;</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>

<span class="hll">            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">:</span>
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<h3 id="test-4">test<span class="headerlink"> <a href="#test-4" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
</span>        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            alias AS (</span>
<span class="sd">                with</span>
<span class="sd">            )</span>
<span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="hll"><span class="sd">        JOIN</span>
</span><span class="hll"><span class="sd">            join</span>
</span><span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="distinct">distinct<span class="headerlink"> <a href="#distinct" title="permalink">#</a></span></h2>
<h3 id="add-flaglist">add flaglist<span class="headerlink"> <a href="#add-flaglist" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">117</span>
<span class="normal">118</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_FlagList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="n">flag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">31</span>
<span class="normal">32</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_FlagList</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">}</span>
</span></code></pre></div>
</td></tr></table>
<h3 id="set-flag">set flag<span class="headerlink"> <a href="#set-flag" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">30</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">flag_keywords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SELECT</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DISTINCT&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL&#39;</span><span class="p">})</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">keyword</span><span class="p">,</span> <span class="n">fake_keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_fakes</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
<span class="hll">        <span class="n">keyword</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_flags</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
</span>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

<span class="hll">        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
</span><span class="hll">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2"> already has flag: </span><span class="si">{</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>
</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">fake_keyword</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">fake_keyword</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_resolve_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_keywords</span><span class="p">[</span><span class="n">prefix</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid flag for </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">flag</span>
        <span class="k">return</span> <span class="n">keyword</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</code></pre></div>
</td></tr></table>
<h3 id="use-flag">use flag<span class="headerlink"> <a href="#use-flag" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

<span class="hll">            <span class="k">if</span> <span class="n">things</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">things</span><span class="o">.</span><span class="n">flag</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span class="hll">            <span class="k">else</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
                <span class="n">grouped</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h3 id="test-5">test<span class="headerlink"> <a href="#test-5" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">SELECT_DISTINCT</span><span class="p">(</span><span class="s1">&#39;select-three&#39;</span><span class="p">)</span>
</span>    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            alias AS (</span>
<span class="sd">                with</span>
<span class="sd">            )</span>
<span class="hll"><span class="sd">        SELECT DISTINCT</span>
</span><span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias,</span>
<span class="hll"><span class="sd">            select-three</span>
</span><span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        JOIN</span>
<span class="sd">            join</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="more-tests">more tests<span class="headerlink"> <a href="#more-tests" title="permalink">#</a></span></h2>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from</span>
<span class="sd">        JOIN</span>
<span class="sd">            join</span>
<span class="sd">        WHERE</span>
<span class="sd">            where</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_query_complicated</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test a complicated query:</span>

<span class="sd">    * order between different keywords does not matter</span>
<span class="sd">    * arguments of repeated calls get appended, with the order preserved</span>
<span class="sd">    * SELECT can receive 2-tuples</span>
<span class="sd">    * WHERE and HAVING arguments are separated by AND</span>
<span class="sd">    * JOIN arguments are separated by the keyword, and come after plain FROM</span>
<span class="sd">    * no-argument keywords have no effect, unless they are flags</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">()</span>
        <span class="o">.</span><span class="n">OUTER_JOIN</span><span class="p">(</span><span class="s1">&#39;outer join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">LIMIT</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">()</span>
        <span class="o">.</span><span class="n">ORDER_BY</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">HAVING</span><span class="p">(</span><span class="s1">&#39;having&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">((</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;expr&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">GROUP_BY</span><span class="p">(</span><span class="s1">&#39;group by&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="s1">&#39;four&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;another from&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">ORDER_BY</span><span class="p">(</span><span class="s1">&#39;third&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">OUTER_JOIN</span><span class="p">(</span><span class="s1">&#39;another outer join&#39;</span><span class="p">)</span>
        <span class="c1"># this isn&#39;t technically valid</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">(</span><span class="s1">&#39;first cte&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">GROUP_BY</span><span class="p">(</span><span class="s1">&#39;another group by&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">HAVING</span><span class="p">(</span><span class="s1">&#39;another having&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;fancy&#39;</span><span class="p">,</span> <span class="s1">&#39;second cte&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;another join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;another where&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">NATURAL_JOIN</span><span class="p">(</span><span class="s1">&#39;natural join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">()</span>
        <span class="o">.</span><span class="n">SELECT_DISTINCT</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            (</span>
<span class="sd">                first cte</span>
<span class="sd">            ),</span>
<span class="sd">            fancy AS (</span>
<span class="sd">                second cte</span>
<span class="sd">            )</span>
<span class="sd">        SELECT DISTINCT</span>
<span class="sd">            one,</span>
<span class="sd">            expr AS two,</span>
<span class="sd">            three,</span>
<span class="sd">            four</span>
<span class="sd">        FROM</span>
<span class="sd">            from,</span>
<span class="sd">            another from</span>
<span class="sd">        OUTER JOIN</span>
<span class="sd">            outer join</span>
<span class="sd">        JOIN</span>
<span class="sd">            join</span>
<span class="sd">        OUTER JOIN</span>
<span class="sd">            another outer join</span>
<span class="sd">        JOIN</span>
<span class="sd">            another join</span>
<span class="sd">        NATURAL JOIN</span>
<span class="sd">            natural join</span>
<span class="sd">        WHERE</span>
<span class="sd">            where AND</span>
<span class="sd">            another where</span>
<span class="sd">        GROUP BY</span>
<span class="sd">            group by,</span>
<span class="sd">            another group by</span>
<span class="sd">        HAVING</span>
<span class="sd">            having AND</span>
<span class="sd">            another having</span>
<span class="sd">        ORDER BY</span>
<span class="sd">            first,</span>
<span class="sd">            second,</span>
<span class="sd">            third</span>
<span class="sd">        LIMIT</span>
<span class="sd">            limit</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="more-init">more init<span class="headerlink"> <a href="#more-init" title="permalink">#</a></span></h2>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">_FlagList</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">separators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">separators</span> <span class="o">=</span> <span class="n">separators</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_init</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">({</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]},</span> <span class="p">{</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="s1">&#39;OR&#39;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        (</span>
<span class="sd">            one OR</span>
<span class="sd">            two OR</span>
<span class="sd">            three</span>
<span class="sd">        )</span>

<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="wrapping-up">wrapping up<span class="headerlink"> <a href="#wrapping-up" title="permalink">#</a></span></h2>
<p><a href="/_file/query-builder-how/07-more-init/builder.py">final thing</a></p>













</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
âˆ™ <a href="/_feed/index.xml">feed</a>
âˆ™ <a href="/about">about</a>

âˆ™ Â© 2021 lemon24



</footer>


</div>