






<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />







<title>query-builder-how - death and gravity</title>




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">query-builder-how</h1>

<p class="text-gray"><small>
<span>2021-08-08</span>



âˆ™ 16 minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>part of a series etc.</p>
<p>a walk-through: we'll rewrite the query builder from scratch, incrementally,
looking at various things.</p>
<details>
<summary>Contents</summary>
<section class="toc">
<ul>
<li><a href="#what-are-we-trying-to-build">what are we trying to build?</a></li>
<li><a href="#trade-offs">trade-offs</a></li>
<li><a href="#data-representation">data representation</a></li>
<li><a href="#a-minimal-plausible-solution">a minimal plausible solution</a>
<ul>
<li><a href="#class">class</a></li>
<li><a href="#adding-stuff">adding stuff</a></li>
<li><a href="#printing-stuff">printing stuff</a></li>
<li><a href="#test">test</a></li>
</ul>
</li>
<li><a href="#separators">separators</a></li>
<li><a href="#aliases">aliases</a></li>
<li><a href="#subqueries">subqueries</a></li>
<li><a href="#joins">joins</a></li>
<li><a href="#distinct">distinct</a></li>
<li><a href="#more-tests">more tests</a></li>
<li><a href="#more-init">more init</a></li>
<li><a href="#features-that-didn-t-make-the-cut">features that didn't make the cut</a></li>
<li><a href="#wrapping-up">wrapping up</a></li>
</ul>
</section>
</details>
<h2 id="what-are-we-trying-to-build">what are we trying to build?<span class="headerlink"> <a href="#what-are-we-trying-to-build" title="permalink">#</a></span></h2>
<p>TBD: an example</p>
<h2 id="trade-offs">trade-offs<span class="headerlink"> <a href="#trade-offs" title="permalink">#</a></span></h2>
<ul>
<li>little customization; there's exactly one user for this, no need for API flourishes</li>
<li>some error checking; exceptions for most errors, but it doesn't matter what kind, they're only for indicating programming bugs (should never bubble up to the end user)</li>
<li>only cover the <a href="/own-query-builder#requirements-and-existing-libraries">known requirements</a></li>
<li>only support SQLite syntax</li>
</ul>
<h2 id="data-representation">data representation<span class="headerlink"> <a href="#data-representation" title="permalink">#</a></span></h2>
<p>As mentioned in the <a href="/own-query-builder#the-first-prototype">previous article</a>,
my prototype query builder was based on the idea that
<em>queries can be represented as plain data structures</em>.</p>
<p>Looking at a query, a more or less natural representation may come to mind:</p>
<div class="highlight code-container"><pre class="code" data-lang="SQL"><span></span><code><span class="k">SELECT</span>
    <span class="n">one</span><span class="p">,</span>
    <span class="n">two</span>
<span class="k">FROM</span>
    <span class="k">table</span>
<span class="k">WHERE</span>
    <span class="n">condition</span> <span class="k">AND</span>
    <span class="n">another</span><span class="o">-</span><span class="n">condition</span>
</code></pre></div>
<p>See it?</p>
<p>It's a dict with a list of strings for each clause:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="p">{</span>
    <span class="s1">&#39;SELECT&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;one&#39;</span><span class="p">,</span>
        <span class="s1">&#39;two&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">&#39;FROM&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;table&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">&#39;WHERE&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">,</span>
        <span class="s1">&#39;another-condition&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">}</span>
</code></pre></div>
<p>Let's start from this model, and build ourselves a query builder.</p>
<p>note: this is a linear story, going only through what worked;
there other possible implemenations,
some of which I did take and then changed my mind on</p>
<h2 id="a-minimal-plausible-solution">a minimal plausible solution<span class="headerlink"> <a href="#a-minimal-plausible-solution" title="permalink">#</a></span></h2>
<h3 id="class">class<span class="headerlink"> <a href="#class" title="permalink">#</a></span></h3>
<p>We start by adding a class:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Query</span><span class="p">:</span>

    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;WITH&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;FROM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;WHERE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GROUP BY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HAVING&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ORDER BY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LIMIT&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>as mentioned in the previous article, we don't want to work with the underlying data structure; we want <code>query.SELECT('one', 'two')</code> instead of <code>query['SELECT'].extend(['one', 'two'])</code></li>
<li>no customization in the constructor, for now; if we need more clauses, we can add them to <code>keywords</code> directly</li>
<li>not subclassing dict, to keep the API tight</li>
<li>we build the dict upfront; this means we can use the dict order directly (py36+, insertion order), and we get some free error checking (<code>data[keyword]</code> for the wrong keyword )</li>
<li>we could use dataclasses, but most of the time the repr() is too long to be useful, and we don't need any other magic methods</li>
</ul>
<h3 id="adding-stuff">adding stuff<span class="headerlink"> <a href="#adding-stuff" title="permalink">#</a></span></h3>
<p>Next, we add code to add stuff:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_clean_up</span><span class="p">(</span><span class="n">thing</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<ul>
<li><p><code>add()</code> appends all its arguments to the list corresponding to <code>keyword</code></p>
<ul>
<li>note <code>self.data[keyword]</code> (free keyerror for bad keywords)</li>
<li>upfront decision: we clean everything up and make as many choices here; this allows the part that generates the output to not care about any of that, and ensures error checking happens as early as possible (when building the query, not when converting it to a string); I initially didnt' do this</li>
<li>we return self, to allow for chaining (<code>query.add(...).add(...)</code>)</li>
<li>add() is also an escape hatch for when we want to use a &quot;clause&quot; that's not a python identifier</li>
</ul>
</li>
<li><p><code>__getattr__()</code> fabricates &quot;methods&quot; on the fly</p>
<ul>
<li>this is a form of metaprogramming</li>
<li>we make a stylistic choice, and require all keywords to be uppercase (<code>query.GROUP_BY()</code>, not <code>query.group_by()</code>)<ul>
<li>makes it clearer to the user these are special methods</li>
<li>it also has the benfit of us not having to avoid shadowing dunder methods like <code>__deepcopy__</code></li>
<li>we don't bother raising AttributeError explicitly, we just let getattr() do it for us</li>
</ul>
</li>
<li><code>__getattr__()</code> gets called for attributes that don't exist</li>
<li>we return a <code>KEYWORD(*args)</code> callable by wrapping add() in a <code>partial</code><ul>
<li>we could save the partial on the object (<code>setattr(self, name.replace('_', ' '), functools(...)</code>); this would side-step <code>__getattr__()</code> on subsequent calls, and return the stored partial; premature optimization</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="printing-stuff">printing stuff<span class="headerlink"> <a href="#printing-stuff" title="permalink">#</a></span></h3>
<p>Finally, we turn the thing back into a string:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">default_separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">_indent</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>to get an SQL string, the user calls <code>str(query)</code>, which ends up calling <code>__str__</code> on our object<ul>
<li>instead of doing everything in <code>__str__</code>, we farm most of the work to <code>_lines()</code>, which generates output lines; the main benefit of this is that it allows us to write <code>yield line</code> instead of <code>rv.append(line)</code>; a second benefit is that we could, in theory, pass it directly to an open file's writelines() method, and never have to build a whole string (although we won't actually need this); same goes for subqueries</li>
<li>we also split the output for each clause into <code>_lines_keyword()</code>, since we'll add more stuff over time, and they're both gonna get more complicated (I initially left everything in _lines(), and had to refactor afterwards)</li>
<li>because we may want to change how indenting happens, we make it a method using a partial</li>
</ul>
</li>
<li>we store the separator as a class attribute, both to document what it is, and in case it ever needs to be overridden</li>
</ul>
<h3 id="test">test<span class="headerlink"> <a href="#test" title="permalink">#</a></span></h3>
<p>For a minimal thing, we're mostly done.</p>
<p>To make sure we don't break stuff that works in the future, we add a basic test:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="separators">separators<span class="headerlink"> <a href="#separators" title="permalink">#</a></span></h2>
<p>At this point, the WHERE output doesn't really make sense:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">))</span>
<span class="go">WHERE</span>
<span class="go">    a,</span>
<span class="go">    b</span>
</code></pre></div>
<p>We fix this by special-casing the separators for a few clauses,
and storing them as a class attribute.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">separators</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">WHERE</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span> <span class="n">HAVING</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
<span class="hll">                <span class="k">try</span><span class="p">:</span>
</span><span class="hll">                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
</span><span class="hll">                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span class="hll">                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>
</span><span class="hll">
</span>            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<p>We could've used defaultdict and gotten rid of <code>default_separator</code>,
but then we'd have to remember that the non-comma separators need a space â€“ <code>' AND'</code>;
it's clearer to put this directly in code.</p>
<p>Also, we could've put the special separator on a new line (<code>'one\nAND two'</code> vs. <code>'one AND\ntwo'</code>).
While this is recommended by some <a href="https://docs.telemetry.mozilla.org/concepts/sql_style.html#boolean-at-the-beginning-of-line">style guides</a>,
it makes the code a bit more complicated for little benefit, <!-- TODO link -->
and (maybe) makes it less obvious that AND is just another separator.</p>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
</span>    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="hll"><span class="sd">        WHERE</span>
</span><span class="hll"><span class="sd">            where-one AND</span>
</span><span class="hll"><span class="sd">            where-two</span>
</span><span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="aliases">aliases<span class="headerlink"> <a href="#aliases" title="permalink">#</a></span></h2>
<p>One of the requirements is making it possible to implement on top of our builder
<a href="/query-builder-why#intermission-scrolling-window-queries">scrolling window queries</a>.</p>
<p>For this to happen, that code needs to be able to introspect
the aliases we use in SELECT, so it can use them in the generated WHERE condition.</p>
<p>The output of the following looks OK, but to extract <code>alias</code> programmatically,
we'd need to parse <code>column AS alias</code>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;column AS alias&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SELECT&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="go">&#39;column AS alias&#39;</span>
</code></pre></div>
<p>Passing a pair of strings when we want an aliased column seems like an acceptable thing.
Since the column expression might be quite long,
we'll make the alias the first thing in the pair.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">),</span> <span class="s1">&#39;two&#39;</span><span class="p">))</span>
<span class="go">SELECT</span>
<span class="go">    one AS alias,</span>
<span class="go">    two</span>
</code></pre></div>
<p>As mentioned earlier, we'll store the data in cleaned up and standard form,
so the output code doesn't have to care about that.
A 2-tuple seems like a decent choice.</p>
<p>Here we depart a tiny bit from plain data structures:
to make the code easier to read,
we'll use a named tuple instead of a plain tuple.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_arg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid arg: </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">_clean_up</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
</code></pre></div>
</td></tr></table>
<p>Conveniently, this also gives us a place where to convert the string-or-pair,
in the form of the <code>from_arg()</code> alternate constructor.
We could've made it a stand-alone function,
but this makes clearer what's being returned.</p>
<section class="admonition note">
<div class="admonition-text">
<p>Note that we use an empty string to mean &quot;no alias&quot;.
 In general, it's a good idea to distinguish this kind of absence by using None,
 since the empty string may be a valid input,
 and None can prevent some bugs â€“ e.g. you can't concatenate None to a string.
 Here, we know an empty string cannot be a valid alias, so we don't bother.</p>
</div>
</section>
<p>Using it is just a one-line change to <code>add()</code>:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
<span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<p>On output, we have two concerns:</p>
<ol>
<li>there may or may not be an alias</li>
<li>the order differs:
 you have <code>select expr as column-alias</code>,
 but you have <code>with table-name as (stmt)</code>
 (we treat the CTE table name as an alias)</li>
</ol>
<p>We can model this with mostly-empty <a href="https://docs.python.org/3/library/collections.html#collections.defaultdict">defaultdict</a>s with per-clause format strings:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">formats</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{value}</span><span class="s1">&#39;</span><span class="p">),</span>
        <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{value}</span><span class="s1"> AS </span><span class="si">{alias}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">WITH</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{alias}</span><span class="s1"> AS </span><span class="si">{value}</span><span class="s1">&#39;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>To choose between &quot;has alias&quot; and &quot;doesn't have alias&quot;,
we take advantage of True and False being equal to 1 and 0
(this may be to clever for our own good, but eh).</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

<span class="hll">            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
</span><span class="hll">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
<span class="hll">        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
</span>        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="hll"><span class="sd">            select-two AS alias</span>
</span><span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="subqueries">subqueries<span class="headerlink"> <a href="#subqueries" title="permalink">#</a></span></h2>
<p>Currently, WITH is a little broken:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;table-name&#39;</span><span class="p">,</span> <span class="s1">&#39;SELECT 1&#39;</span><span class="p">)))</span>
<span class="go">WITH</span>
<span class="go">    table-name AS SELECT 1</span>
</code></pre></div>
<p>Since common table expressions always have the select statement paranthesized,
we'd like to have it out of the box as well;
also, it should be indented properly:</p>
<pre class="code code-container"><code>WITH
    table-name AS (
        SELECT 1
    )
</code></pre>
<p>A simple way of handling this is to change the WITH format string to
<code>'{alias} AS (\n{indented_value}\n)'</code>,
where <code>indented_value</code> is the value, but indented.</p>
<!-- TODO: link to old version -->
<p>This kinda works, but is somewhat limited in usefulness;
for instance, we can't build something like this on top:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">FROM</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;SELECT 1&#39;</span><span class="p">),</span> <span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>Instead, let's refining our model about values,
and indicate something is a subquery using a flag:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="hll">    <span class="n">is_subquery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span>
    <span class="nd">@classmethod</span>
<span class="hll">    <span class="k">def</span> <span class="nf">from_arg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid arg: </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="hll">        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">_clean_up</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></code></pre></div>
</td></tr></table>
<p>We can then decide decide if a clause always has subqueries,
and set it accordingly:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">28</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">subquery_keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;WITH&#39;</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

<span class="hll">        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
</span><span class="hll">            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">
</span>        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
<span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<p>Using it for output is also straightforward:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
<span class="hll">            <span class="n">value</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">value</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">is_subquery</span><span class="p">:</span>
</span><span class="hll">                <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">)&#39;</span>
</span><span class="hll">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
</span><span class="hll">
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
<span class="hll">        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
</span>        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="hll"><span class="sd">        WITH</span>
</span><span class="hll"><span class="sd">            alias AS (</span>
</span><span class="hll"><span class="sd">                with</span>
</span><span class="hll"><span class="sd">            )</span>
</span><span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="joins">joins<span class="headerlink"> <a href="#joins" title="permalink">#</a></span></h2>
<p>One clause that's missing is JOIN.
And it's important, needing to change your mind about what you're selecting from
<a href="/query-builder-why#composition-and-reuse">happens quite often</a>.</p>
<p>JOIN is a bit more complicated,
mostly because it has different forms â€“ JOIN, LEFT JOIN, etc.;
for SQLite, there are at least 10 supported variations.</p>
<p>I initially handled it by special-casing the keyword,
considering any keyword that contained <code>JOIN</code> a separate keyword.
This has a few drawbacks, though;
aside from making the code somewhat complicated,
it reorders some of the tables:
<code>query.JOIN('a').LEFT_JOIN('b').JOIN('c')</code>
resulted in
<code>JOIN a JOIN b LEFT JOIN c</code>.</p>
<!-- TODO: link to old version -->
<p>A better solution is to continue refining our model about values.</p>
<p>If you look at these railroad diagrams for the SELECT statement,
you may notice that the table-or-subquery followed by comma in FROM
is actually a subset of the table-or-subquery followed by join-operator in join-clause.
That is, for SQLite, a comma is just another join operator.</p>
<figure class="figure">
<figcaption class="figure-caption text-center text-small">
<p><a href="https://www.sqlite.org/syntax/select-core.html">select-core</a> (from clause)</p>
</figcaption>
<p><img class="img-responsive" src="/_file/query-builder-how/select-core.svg" alt="select-core" /></p>
</figure>
<figure class="figure">
<figcaption class="figure-caption text-center text-small">
<p><a href="https://www.sqlite.org/syntax/join-clause.html">join-clause</a></p>
</figcaption>
<p><img class="img-responsive" src="/_file/query-builder-how/join-clause.svg" alt="join-clause" /></p>
</figure>
<figure class="figure">
<figcaption class="figure-caption text-center text-small">
<p><a href="https://www.sqlite.org/syntax/join-operator.html">join-operator</a></p>
</figcaption>
<p><img class="img-responsive" src="/_file/query-builder-how/join-operator.svg" alt="join-operator" /></p>
</figure>
<p>Put the other way around, a join operator is just another separator,
so we can model it as such.</p>
<p>First, let's record which join operator a value has:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="hll">    <span class="n">keyword</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span>    <span class="n">is_subquery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">fake_keywords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">JOIN</span><span class="o">=</span><span class="s1">&#39;FROM&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="hll">        <span class="n">keyword</span><span class="p">,</span> <span class="n">fake_keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_fakes</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
</span>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="hll">        <span class="k">if</span> <span class="n">fake_keyword</span><span class="p">:</span>
</span><span class="hll">            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">fake_keyword</span><span class="p">)</span>
</span>        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>

<span class="hll">    <span class="k">def</span> <span class="nf">_resolve_fakes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">real</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_keywords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">keyword</span><span class="p">:</span>
</span><span class="hll">                <span class="k">return</span> <span class="n">real</span><span class="p">,</span> <span class="n">keyword</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">keyword</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</span></code></pre></div>
</td></tr></table>
<p>We could've probably just hardcoded this in <code>add()</code>
(<code>if 'JOIN' in keyword: ...</code>),
but doing it like this maybe makes it easier to see at a glance that
&quot;JOIN is a fake FROM&quot;.</p>
<p>Using <code>keyword</code> as a separator is relatively straightforward:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="hll">            <span class="n">grouped</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span class="hll">            <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
</span><span class="hll">                <span class="n">grouped</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
</span><span class="hll">            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span>
    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

<span class="hll">            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">is_subquery</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">)&#39;</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>

<span class="hll">            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">:</span>
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
</span>        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            alias AS (</span>
<span class="sd">                with</span>
<span class="sd">            )</span>
<span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="hll"><span class="sd">        JOIN</span>
</span><span class="hll"><span class="sd">            join</span>
</span><span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="distinct">distinct<span class="headerlink"> <a href="#distinct" title="permalink">#</a></span></h2>
<p>The final adjustment to our model is to support SELECT DISTINCT.</p>
<p>DISTINCT (or ALL) is like a flag that applies to the whole clause.
We'll model it just like that:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">117</span>
<span class="normal">118</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_FlagList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="n">flag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">31</span>
<span class="normal">32</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_FlagList</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">}</span>
</span></code></pre></div>
</td></tr></table>
<p>Since most of the time we're OK with the default value of <code>flag</code>,
we don't bother setting it as an instance variable in <code>__init__</code>;
instead, we just set it as a class variable;
setting <code>flag</code> on an instance will then shadow the class variable.</p>
<p>We set the flag based on a known list of keywords for each clause;
like with fake keywords, we pull the flag &quot;parsing&quot; logic into a separate method:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">30</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">flag_keywords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SELECT</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DISTINCT&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL&#39;</span><span class="p">})</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">keyword</span><span class="p">,</span> <span class="n">fake_keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_fakes</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
<span class="hll">        <span class="n">keyword</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_flags</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
</span>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

<span class="hll">        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
</span><span class="hll">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2"> already has flag: </span><span class="si">{</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>
</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">fake_keyword</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">fake_keyword</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_resolve_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_keywords</span><span class="p">[</span><span class="n">prefix</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid flag for </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">flag</span>
        <span class="k">return</span> <span class="n">keyword</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</code></pre></div>
</td></tr></table>
<p>Using the flag for output is again straightforward:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

<span class="hll">            <span class="k">if</span> <span class="n">things</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">things</span><span class="o">.</span><span class="n">flag</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span class="hll">            <span class="k">else</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
                <span class="n">grouped</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">SELECT_DISTINCT</span><span class="p">(</span><span class="s1">&#39;select-three&#39;</span><span class="p">)</span>
</span>    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            alias AS (</span>
<span class="sd">                with</span>
<span class="sd">            )</span>
<span class="hll"><span class="sd">        SELECT DISTINCT</span>
</span><span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias,</span>
<span class="hll"><span class="sd">            select-three</span>
</span><span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        JOIN</span>
<span class="sd">            join</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="more-tests">more tests<span class="headerlink"> <a href="#more-tests" title="permalink">#</a></span></h2>
<p>Since now our test is not really simple anymore, we split it in two:
one with a really simple query, and one with a really complicated query.</p>
<details>
<summary>long tests</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from</span>
<span class="sd">        JOIN</span>
<span class="sd">            join</span>
<span class="sd">        WHERE</span>
<span class="sd">            where</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_query_complicated</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test a complicated query:</span>

<span class="sd">    * order between different keywords does not matter</span>
<span class="sd">    * arguments of repeated calls get appended, with the order preserved</span>
<span class="sd">    * SELECT can receive 2-tuples</span>
<span class="sd">    * WHERE and HAVING arguments are separated by AND</span>
<span class="sd">    * JOIN arguments are separated by the keyword, and come after plain FROM</span>
<span class="sd">    * no-argument keywords have no effect, unless they are flags</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">()</span>
        <span class="o">.</span><span class="n">OUTER_JOIN</span><span class="p">(</span><span class="s1">&#39;outer join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">LIMIT</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">()</span>
        <span class="o">.</span><span class="n">ORDER_BY</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">HAVING</span><span class="p">(</span><span class="s1">&#39;having&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">((</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;expr&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">GROUP_BY</span><span class="p">(</span><span class="s1">&#39;group by&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="s1">&#39;four&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;another from&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">ORDER_BY</span><span class="p">(</span><span class="s1">&#39;third&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">OUTER_JOIN</span><span class="p">(</span><span class="s1">&#39;another outer join&#39;</span><span class="p">)</span>
        <span class="c1"># this isn&#39;t technically valid</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">(</span><span class="s1">&#39;first cte&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">GROUP_BY</span><span class="p">(</span><span class="s1">&#39;another group by&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">HAVING</span><span class="p">(</span><span class="s1">&#39;another having&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;fancy&#39;</span><span class="p">,</span> <span class="s1">&#39;second cte&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;another join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;another where&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">NATURAL_JOIN</span><span class="p">(</span><span class="s1">&#39;natural join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">()</span>
        <span class="o">.</span><span class="n">SELECT_DISTINCT</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            (</span>
<span class="sd">                first cte</span>
<span class="sd">            ),</span>
<span class="sd">            fancy AS (</span>
<span class="sd">                second cte</span>
<span class="sd">            )</span>
<span class="sd">        SELECT DISTINCT</span>
<span class="sd">            one,</span>
<span class="sd">            expr AS two,</span>
<span class="sd">            three,</span>
<span class="sd">            four</span>
<span class="sd">        FROM</span>
<span class="sd">            from,</span>
<span class="sd">            another from</span>
<span class="sd">        OUTER JOIN</span>
<span class="sd">            outer join</span>
<span class="sd">        JOIN</span>
<span class="sd">            join</span>
<span class="sd">        OUTER JOIN</span>
<span class="sd">            another outer join</span>
<span class="sd">        JOIN</span>
<span class="sd">            another join</span>
<span class="sd">        NATURAL JOIN</span>
<span class="sd">            natural join</span>
<span class="sd">        WHERE</span>
<span class="sd">            where AND</span>
<span class="sd">            another where</span>
<span class="sd">        GROUP BY</span>
<span class="sd">            group by,</span>
<span class="sd">            another group by</span>
<span class="sd">        HAVING</span>
<span class="sd">            having AND</span>
<span class="sd">            another having</span>
<span class="sd">        ORDER BY</span>
<span class="sd">            first,</span>
<span class="sd">            second,</span>
<span class="sd">            third</span>
<span class="sd">        LIMIT</span>
<span class="sd">            limit</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="more-init">more init<span class="headerlink"> <a href="#more-init" title="permalink">#</a></span></h2>
<p>Finally, we get to the last feature:
I'd like to be able to reuse the cleanup and indent logic
to write paranthesized lists.</p>
<p>Good thing the constructor doesn't do anything yet,
and we can add such conveniences there:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">_FlagList</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">separators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">separators</span> <span class="o">=</span> <span class="n">separators</span>
</code></pre></div>
</td></tr></table>
<p>Using it looks like:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Query</span><span class="p">({</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]},</span> <span class="n">separators</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="s1">&#39;OR&#39;</span><span class="p">}))</span>
<span class="go">(</span>
<span class="go">    one OR</span>
<span class="go">    two</span>
<span class="go">)</span>
</code></pre></div>
<p>We could've required the <code>data</code> argument to have the same structure as the attribute;
however, that's quite verbose to write,
and I'd have to instantiate <code>_Thing</code>s and clean up strings myself;
that's nor very <em>convenient</em>.</p>
<p>Instead, we take it to mean &quot;here's some strings to be <code>add()</code>-ed for these keywords&quot;.</p>
<p>Note that is we ever do want to set the entire datastructure, we still can, with a tiny detour:
<code>q = Query(); q.data.update(...)</code>.</p>
<details>
<summary>We mark our progress in the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_init</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">({</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]},</span> <span class="p">{</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="s1">&#39;OR&#39;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        (</span>
<span class="sd">            one OR</span>
<span class="sd">            two OR</span>
<span class="sd">            three</span>
<span class="sd">        )</span>

<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="features-that-didn-t-make-the-cut">features that didn't make the cut<span class="headerlink"> <a href="#features-that-didn-t-make-the-cut" title="permalink">#</a></span></h2>
<p>https://github.com/lemon24/reader/blob/2.0/src/reader/_sql_utils.py#L9-L63</p>
<ul>
<li>UNIONs</li>
<li>INSERT/UPDATE/DELETE</li>
<li>using arbitrary strings as subqueries</li>
<li>using Query objects as arguments directly, without having to convert them explicitly to strings</li>
</ul>
<h2 id="wrapping-up">wrapping up<span class="headerlink"> <a href="#wrapping-up" title="permalink">#</a></span></h2>
<p><a href="/_file/query-builder-how/07-more-init/builder.py">final thing</a></p>













</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
âˆ™ <a href="/_feed/index.xml">feed</a>
âˆ™ <a href="/about">about</a>

âˆ™ Â© 2021 lemon24



</footer>


</div>