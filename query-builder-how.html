






<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />







<title>Write an SQL query builder in 150 lines of Python! - death and gravity</title>


<meta name="description" content="This is the fourth article in a series about writing my own SQL query builder. Today, we&#39;ll rewrite it from scratch, explore API design, learn when to be lazy, and look at worse and better ways of doing things – all in 150 lines of Python!" />



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RY2QR580X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-4RY2QR580X");
</script>



<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Write an SQL query builder in 150 lines of Python!</h1>

<p class="text-gray text-nowrap"><small>
<span class="tooltip" data-tooltip="published on 2021-08-20">August 2021</span>



∙ 20 minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p><strong><a href="/own-query-builder">Previously</a></strong></p>
<p>This is the fourth article <a href="/query-builder">in a series</a> about
writing an SQL query builder for my feed <a href="https://github.com/lemon24/reader">reader</a> library.</p>
<p>Today, we'll dive into the code by <strong>rewriting it from scratch</strong>.</p>
<p>Think of it as part walk-through, part tutorial;
along the way, we'll explore:</p>
<ul>
<li><strong>API design</strong></li>
<li>knowing <strong>when to be lazy</strong></li>
<li><strong>worse</strong> and <strong>better</strong> ways of doing things</li>
</ul>
<p>As you read this, keep in mind it is a story, thus <em>linear</em> by necessity.
Development was decidedly <em>not</em> so:
I tried things out, I changed my mind multiple times,
and I <a href="https://programmingisterrible.com/post/176657481103/repeat-yourself-do-more-than-one-thing-and">rewrote everything</a> once.
Even now, there are other equally-good or better implementations;
this one is simply <em>good enough</em>.</p>
<details>
<summary>Contents</summary>
<section class="toc">
<ul>
<li><a href="#what-are-we-trying-to-build">What are we trying to build?</a>
<ul>
<li><a href="#trade-offs">Trade-offs</a></li>
</ul>
</li>
<li><a href="#a-minimal-plausible-solution">A minimal plausible solution</a>
<ul>
<li><a href="#data-representation">Data representation</a></li>
<li><a href="#classes">Classes</a></li>
<li><a href="#adding-things">Adding things</a></li>
<li><a href="#output">Output</a></li>
<li><a href="#tests">Tests</a></li>
</ul>
</li>
<li><a href="#separators">Separators</a></li>
<li><a href="#aliases">Aliases</a></li>
<li><a href="#subqueries">Subqueries</a></li>
<li><a href="#joins">Joins</a></li>
<li><a href="#distinct">Distinct</a></li>
<li><a href="#more-tests">More tests</a></li>
<li><a href="#more-init">More init</a></li>
<li><a href="#bonus-things-that-didn-t-make-the-cut">Bonus: things that didn't make the cut</a>
<ul>
<li><a href="#insert-update-delete">Insert / update / delete</a></li>
<li><a href="#arbitrary-strings-as-subqueries">Arbitrary strings as subqueries</a></li>
<li><a href="#query-objects-as-subqueries">Query objects as subqueries</a></li>
<li><a href="#union-intersect-except">Union / intersect / except</a></li>
</ul>
</li>
</ul>
</section>
</details>
<h2 id="what-are-we-trying-to-build">What are we trying to build?<span class="headerlink"> <a href="#what-are-we-trying-to-build" title="permalink">#</a></span></h2>
<p>We want a way of building SQL strings that takes care of formatting:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
<span class="go">&lt;builder.Query object at 0x7fc953e60640&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="go">SELECT</span>
<span class="go">    one</span>
<span class="go">FROM</span>
<span class="go">    table</span>
</code></pre></div>
<p>... and allows us to add parts incrementally:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;condition&#39;</span><span class="p">)</span>
<span class="go">&lt;builder.Query object at 0x7fc953e60640&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="go">SELECT</span>
<span class="go">    one,</span>
<span class="go">    two</span>
<span class="go">FROM</span>
<span class="go">    table</span>
<span class="go">WHERE</span>
<span class="go">    condition</span>
</code></pre></div>
<p>While not required,
I recommend reading the previous articles
to get a better idea of <a href="/query-builder-why">the problem we're trying to solve</a>,
and <a href="/own-query-builder#background">the context we're solving it in</a>.</p>
<p>In short, whatever we build <a href="/own-query-builder#requirements-and-existing-libraries">should</a>:</p>
<ul>
<li>support SELECT with conditional WITH, WHERE, ORDER BY, JOIN etc.</li>
<li>expose the names of the result columns (for scrolling window queries)</li>
<li>be easy to use, understand and maintain</li>
</ul>
<section class="admonition attention">
<p class="admonition-title">Attention</p>
<p>This query builder is not directly comparable with that of an ORM.
 Instead, it is an alternative to building <em>plain SQL</em> strings by hand.</p>
<p><strong>The caveats that apply to plain SQL apply to it as well:</strong>
 Using user-supplied values directly in an SQL query
 exposes you to <a href="https://en.wikipedia.org/wiki/SQL_injection">SQL injection</a> attacks.
 Instead, use <a href="https://en.wikipedia.org/wiki/SQL_injection#Parameterized_statements">parametrized queries</a> whenever possible,
 and <a href="https://en.wikipedia.org/wiki/SQL_injection#Escaping">escaping</a> only as a last resort.</p>
</section>
<h3 id="trade-offs">Trade-offs<span class="headerlink"> <a href="#trade-offs" title="permalink">#</a></span></h3>
<p>Our solution does not exist in a void;
it exists to be used by my feed <a href="https://github.com/lemon24/reader">reader</a> library.</p>
<p>Notably, we're <em>not</em> making a general-purpose library with external users
whose needs we're trying to anticipate;
there's exactly one user with a pretty well-defined use case,
and strict backwards compatibility is not necessary.</p>
<p>This allows us to make some upfront decisions to help with maintainability:</p>
<ul>
<li>No needless customization. We can change the code directly if we need to.</li>
<li>No other features except the known requirements.
We can add new ones when we need them.</li>
<li>No effort to support other syntax than SQLite.</li>
<li>No extensive testing.
We can rely on the exising comprehensive functional tests.</li>
<li>No SQL validation. The database does this already.<ul>
<li>However, it would be nice to get at least a little error checking.
No need for custom exceptions, any kind is acceptable –
they should come up only during development and testing anyway.</li>
</ul>
</li>
</ul>
<h2 id="a-minimal-plausible-solution">A minimal plausible solution<span class="headerlink"> <a href="#a-minimal-plausible-solution" title="permalink">#</a></span></h2>
<h3 id="data-representation">Data representation<span class="headerlink"> <a href="#data-representation" title="permalink">#</a></span></h3>
<p>As mentioned <a href="/own-query-builder#the-first-prototype">before</a>,
my prototype was based on the idea that
<em>queries can be represented as plain data structures</em>.</p>
<p>Looking at a nicely formatted query,
a natural representation may reveal itself:</p>
<div class="highlight code-container"><pre class="code" data-lang="SQL"><span></span><code><span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">one</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">two</span><span class="w"></span>
<span class="k">FROM</span><span class="w"></span>
<span class="w">    </span><span class="k">table</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"></span>
<span class="w">    </span><span class="n">condition</span><span class="w"> </span><span class="k">AND</span><span class="w"></span>
<span class="w">    </span><span class="n">another</span><span class="o">-</span><span class="n">condition</span><span class="w"></span>
</code></pre></div>
<p>See it?</p>
<p>It's a mapping with a list of strings for each clause:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="p">{</span>
    <span class="s1">&#39;SELECT&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;one&#39;</span><span class="p">,</span>
        <span class="s1">&#39;two&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">&#39;FROM&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;table&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">&#39;WHERE&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">,</span>
        <span class="s1">&#39;another-condition&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">}</span>
</code></pre></div>
<p>Let's use this as our starting model, and make ourselves a query builder.</p>
<h3 id="classes">Classes<span class="headerlink"> <a href="#classes" title="permalink">#</a></span></h3>
<p>We start with a class:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Query</span><span class="p">:</span>

    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;WITH&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;FROM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;WHERE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GROUP BY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HAVING&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ORDER BY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LIMIT&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>We use a class because most of the time
we don't want to interact with the underlying data structure,
since it's more likely to change.
We're not subclassing <a href="https://docs.python.org/3/library/stdtypes.html#mapping-types-dict">dict</a>,
since that would unintentionally expose its methods (and thus, behavior),
and we may need those names for something else.</p>
<p>Also, a class allows us to reduce verbosity:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="c1"># we want</span>
<span class="n">query</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
<span class="c1"># not</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;SELECT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">])</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;FROM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
</code></pre></div>
<p>We use class variables for &quot;static&quot; data
instead of hardcoding or module variables
so it's easy to override (more on that later).</p>
<p>We don't customize anything in <code>__init__()</code> fow now;
if we need more clauses, we can add them to <code>keywords</code> directly.
Adding all known keywords to <code>data</code> upfront gets us free error checking:
<code>data[keyword]</code> raises KeyError for unknown keywords.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>Unless specified otherwise,
 I'll use <em>clause</em> and <em>keyword</em> to mean &quot;item in <code>self.data</code>&quot;,
 not &quot;SQL clause or keyword in general&quot;.</p>
</section>
<p>We could use <a href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a>,
but of the generated magic methods, we'd only use <code>__repr__()</code>,
and its output would be too long to be useful anyway.</p>
<h3 id="adding-things">Adding things<span class="headerlink"> <a href="#adding-things" title="permalink">#</a></span></h3>
<p>Next, we add code for adding string fragments to each clause:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_clean_up</span><span class="p">(</span><span class="n">thing</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<p><code>add()</code> is roughly equivalent to <code>data[keyword]​.extend(args)</code>.</p>
<p>The main difference is that
we dedent the arguments and remove trailing whitespace.
This is intentional:
we clean everything up and make as many choices when <em>adding things</em>,
so we don't have to care about that when <em>generating output</em>,
and so error checking happens as early as possible.</p>
<p>Also, <code>add()</code> returns <code>self</code> to enable <a href="https://en.wikipedia.org/wiki/Method_chaining">method chaining</a>: <code>query​.add(...)​.add(...)</code>.</p>
<hr />
<p><a href="https://docs.python.org/3/reference/datamodel.html#object.__getattr__"><code>__getattr__()</code></a> is called when an attribute does not exist,
and allows us to return <em>something</em> instead of getting the default AttributeError.</p>
<p>What we return is a <code>KEYWORD(*args)</code> callable made on the fly
by wrapping <code>add()</code> in a <a href="https://docs.python.org/3/library/functools.html#functools.partial">partial</a>;
a <a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">closure</a> capturing <code>name</code> would be functionally equivalent.</p>
<p>Requiring the keywords to be uppercase is a stylistic choice,
but does have advantages:
it signals to the reader these are special &quot;methods&quot;,
and avoids shadowing dunder methods like <code>__deepcopy__()</code> without extra checks.</p>
<p>To indicate the attribute really doesn't exist,
we need to raise AttributeError;
we let <a href="https://docs.python.org/3/library/functions.html#getattr">getattr()</a> do it for us
(the parent <a href="https://docs.python.org/3/library/functions.html#object">object</a> doesn't have a custom <code>__getattr__()</code>).</p>
<p>We <em>could</em> store the partial on the instance,
which would side-step <code>__getattr__()</code> on subsequent calls,
so we only make one partial per keyword;
we could do it in <code>__init__()</code>, and not use <code>__getattr__()</code> at all;
we could even use <a href="https://docs.python.org/3/library/functools.html#functools.partialmethod">partialmethod</a>,
so there's only one per keyword per class!
Or we can do nothing – they're likely premature optimization,
and what we're doing now is more flexible anyway.</p>
<hr />
<p>I said error checking happens as early as possible;
that's <em>almost</em> true:
if you look carefully at the code,
you may notice <code>query​.ESLECT</code> doesn't raise an exception
until called – <code>query​.ESLECT()</code>.</p>
<p>Doing most of the work in <code>add()</code> does have some benefits, though:
we can use it with <a href="https://docs.python.org/3/library/functools.html#functools.partial">partial</a> and get chaining for free,
and it's an escape hatch for when we want
to use a &quot;keyword&quot; that's not a Python identifier
(this will be useful later).</p>
<h3 id="output">Output<span class="headerlink"> <a href="#output" title="permalink">#</a></span></h3>
<p>Finally, we turn the query into SQL:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">default_separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">_indent</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>The only output API is <a href="https://docs.python.org/3/library/functions.html#func-str">str()</a>;
being the standard way of turning objects into strings in Python,
it requires zero effort to learn.</p>
<p><code>str(query)</code> calls <code>__str__</code>, which delegates to <code>_lines()</code>.
We use a generator mainly because it allows us to write
<code>yield line</code> instead of <code>rv.append(line)</code>,
making for somewhat cleaner code.</p>
<p>Another benefit of a generator is that it's lazy,
so we can pass it around
without having to build intermediary lists in memory;
for example, to a file's <a href="https://docs.python.org/3/library/io.html#io.IOBase.writelines">writelines()</a> method,
or in <code>yield from</code> in another generator
(e.g. for nested subqueries).
We don't need it here,
but it's useful when generating a lot of values.</p>
<p>We split the logic for individual clauses into <code>_lines_keyword()</code>,
because we'll keep adding stuff to it.
(I initially left everything in <code>_lines()</code>,
and refactored when things got too complicated;
no need to do that now.)</p>
<p>Since we'll want to indent things in the same way in more than one place,
we make it a static &quot;method&quot; using <a href="https://docs.python.org/3/library/functools.html#functools.partial">partial</a>.</p>
<p>You may notice we're not sorting the clauses in any way;
dicts guarantee insertion order in Python 3.6+<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>,
and we built <code>data</code> from <code>keywords</code>, so the order is preserved.</p>
<h3 id="tests">Tests<span class="headerlink"> <a href="#tests" title="permalink">#</a></span></h3>
<p>Let's add a simple test to make sure we don't break already working stuff:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We'll keep adding to it with each feature.</p>
<hr />
<p>For a minimal solution, we are done. We've &quot;spent&quot; 62 lines, or 38 statements.</p>
<p>The code so far:
<a href="/_file/query-builder-how/00-begin/builder.py">builder.py</a>,
<a href="/_file/query-builder-how/00-begin/test_builder.py">test_builder.py</a>.</p>
<h2 id="separators">Separators<span class="headerlink"> <a href="#separators" title="permalink">#</a></span></h2>
<p>At this point, WHERE doesn't really make sense:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">))</span>
<span class="go">WHERE</span>
<span class="go">    a,</span>
<span class="go">    b</span>
</code></pre></div>
<p>We fix it by special-casing separators for a few clauses:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">separators</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">WHERE</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span> <span class="n">HAVING</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
<span class="hll">                <span class="k">try</span><span class="p">:</span>
</span><span class="hll">                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
</span><span class="hll">                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span class="hll">                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>
</span><span class="hll">
</span>            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<p>We could've used <a href="https://docs.python.org/3/library/collections.html#collections.defaultdict">defaultdict</a> instead of using <code>default_separator</code>,
but then we'd have to remember non-comma separators need a space: <code>' AND'</code>;
putting it in code means we don't have to remember anything.</p>
<p>Also, we could've put the separator on a new line:
<code>'one\n​AND​ ​two'</code> vs. <code>'one​ ​AND\n​two'</code>.
While slightly <a href="https://docs.telemetry.mozilla.org/concepts/sql_style.html#boolean-at-the-beginning-of-line">better style</a>,
it makes code more complicated for little benefit,
and makes it less obvious that AND is just another separator.</p>
<details>
<summary>We add WHERE to the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
</span>    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="hll"><span class="sd">        WHERE</span>
</span><span class="hll"><span class="sd">            where-one AND</span>
</span><span class="hll"><span class="sd">            where-two</span>
</span><span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<p>The code so far:
<a href="/_file/query-builder-how/01-separators/builder.py">builder.py</a>,
<a href="/_file/query-builder-how/01-separators/test_builder.py">test_builder.py</a>.</p>
<h2 id="aliases">Aliases<span class="headerlink"> <a href="#aliases" title="permalink">#</a></span></h2>
<p>One of the requirements is that it should be possible to implement
<a href="/query-builder-why#intermission-scrolling-window-queries">scrolling window queries</a>
on top.
For this, code needs to get the result column names
– the SELECT expressions <em>or</em> their aliases –
and add them to a generated WHERE condition.</p>
<p>Parsing the result column is straightforward only for simple cases:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span>
<span class="gp">... </span>  <span class="s1">&#39;column&#39;</span><span class="p">,</span>
<span class="gp">... </span>  <span class="s1">&#39;column AS alias&#39;</span><span class="p">,</span>
<span class="gp">... </span>  <span class="s1">&#39;column as alias&#39;</span><span class="p">,</span>
<span class="gp">... </span>  <span class="s1">&#39;(SELECT column FROM table AS another-table)&#39;</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39; AS &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SELECT&#39;</span><span class="p">]]</span>
<span class="go">[&#39;column&#39;, &#39;alias&#39;, &#39;column as alias&#39;, &#39;another-table)&#39;]</span>
</code></pre></div>
<p>An acceptable compromise is using pairs of strings for aliased columns.
Since the column expression might be quite long,
we'll make the alias the first thing in the pair.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">),</span> <span class="s1">&#39;two&#39;</span><span class="p">))</span>
<span class="go">SELECT</span>
<span class="go">    one AS alias,</span>
<span class="go">    two</span>
</code></pre></div>
<p>As mentioned earlier,
we store everything in a standard way
to keep output code simpler.
A plain 2-tuple is a decent choice,
but a <a href="https://docs.python.org/3/glossary.html#term-named-tuple">named tuple</a> is more readable.</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_arg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid arg: </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">_clean_up</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
</code></pre></div>
</td></tr></table>
<p>Conveniently, this gives us a place where to convert the string-or-pair:
the <code>from_arg()</code> alternate constructor.
We could've made it a stand-alone function,
but this way it's easier to see what type is being returned.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that we use an empty string to mean &quot;no alias&quot;.
 In general, it's a good idea to distinguish this kind of absence by using None,
 since the empty string may be a valid input,
 and None can prevent some bugs – e.g. you can't concatenate None to a string.
 Here, an empty string cannot be a valid alias, and we use format strings,
 so we don't bother.</p>
</section>
<p>Using it is just a one-line change to <code>add()</code>:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
<span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<p>On output, we have two concerns:</p>
<ol>
<li>there may or may not be an alias</li>
<li>the order differs depending on the keyword:
 you have <code>SELECT expr AS column-alias</code>,
 but <code>WITH table-name AS (stmt)</code>
 (we treat the CTE table name as an alias)</li>
</ol>
<p>We can model this with mostly-empty <a href="https://docs.python.org/3/library/collections.html#collections.defaultdict">defaultdict</a>s with per-clause format strings:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">formats</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{value}</span><span class="s1">&#39;</span><span class="p">),</span>
        <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{value}</span><span class="s1"> AS </span><span class="si">{alias}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">WITH</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{alias}</span><span class="s1"> AS </span><span class="si">{value}</span><span class="s1">&#39;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>... and choose the right defaultdict using the alias's boolean value:<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup></p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

<span class="hll">            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
</span><span class="hll">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We add an aliased expression to the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
<span class="hll">        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
</span>        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="hll"><span class="sd">            select-two AS alias</span>
</span><span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<p>The code so far:
<a href="/_file/query-builder-how/02-aliases/builder.py">builder.py</a>,
<a href="/_file/query-builder-how/02-aliases/test_builder.py">test_builder.py</a>.</p>
<h2 id="subqueries">Subqueries<span class="headerlink"> <a href="#subqueries" title="permalink">#</a></span></h2>
<p>Currently, WITH is still a little broken:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;table-name&#39;</span><span class="p">,</span> <span class="s1">&#39;SELECT 1&#39;</span><span class="p">)))</span>
<span class="go">WITH</span>
<span class="go">    table-name AS SELECT 1</span>
</code></pre></div>
<p>Since common table expressions always have the SELECT statement paranthesized,
we'd like to have it out of the box, with proper indentation:</p>
<div class="highlight code-container"><pre class="code" data-lang="SQL"><span></span><code><span class="k">WITH</span><span class="w"></span>
<span class="w">    </span><span class="k">table</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>A simple way of handling this is to change the WITH format string to
<code>'{alias} AS (\n{indented}\n)'</code>,
where <code>indented</code> is the value, but indented.<sup class="footnote-ref" id="fnref-3"><a href="#fn-3">3</a></sup></p>
<p>This kinda works, but is limited in usefulness;
for instance, we can't easily build something like this on top:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">FROM</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;SELECT 1&#39;</span><span class="p">),</span> <span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>Instead, let's keep refining our model,
and use a flag to mark subqueries:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="hll">    <span class="n">is_subquery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span>
    <span class="nd">@classmethod</span>
<span class="hll">    <span class="k">def</span> <span class="nf">from_arg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid arg: </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="hll">        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_clean_up</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">_clean_up</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></code></pre></div>
</td></tr></table>
<p>We can then check if a clause always has subqueries,
and set the flag accordingly:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">28</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">subquery_keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;WITH&#39;</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

<span class="hll">        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
</span><span class="hll">            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">
</span>        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
<span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<p>Using it for output is just an extra if:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">value</span>
<span class="hll">            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">is_subquery</span><span class="p">:</span>
</span><span class="hll">                <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">)&#39;</span>
</span>            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We add WITH to our test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
<span class="hll">        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
</span>        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="hll"><span class="sd">        WITH</span>
</span><span class="hll"><span class="sd">            alias AS (</span>
</span><span class="hll"><span class="sd">                with</span>
</span><span class="hll"><span class="sd">            )</span>
</span><span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<p>The code so far:
<a href="/_file/query-builder-how/03-subqueries/builder.py">builder.py</a>,
<a href="/_file/query-builder-how/03-subqueries/test_builder.py">test_builder.py</a>.</p>
<h2 id="joins">Joins<span class="headerlink"> <a href="#joins" title="permalink">#</a></span></h2>
<p>One clause that's entirely missing is JOIN.
And it's important, changing your mind about what you're selecting from
<a href="/query-builder-why#composition-and-reuse">happens quite often</a>.</p>
<p>JOIN is a bit more complicated,
mostly because it has different forms – JOIN, LEFT JOIN and so on;
SQLite supports at least 10 variations.</p>
<p>I initially treated any keyword containing <code>JOIN</code> as a separate keyword,
and <a href="https://github.com/lemon24/reader/blob/1.11/src/reader/_sql_utils.py#L97-L103">dealt with it during output</a>.
This has a few drawbacks, though;
aside from making the code more complicated,
it reorders the tables:
<code>query​.JOIN('a')​.LEFT_JOIN('b')​.JOIN('c')</code>
results in <code>JOIN a JOIN c LEFT JOIN b</code>.</p>
<p>A better solution is to refine our model even further.</p>
<p>Take a look at these railroad diagrams for the SELECT statement:</p>
<figure class="figure">
<img class="img-responsive" src="/_file/query-builder-how/select-core.svg" alt="select-core (FROM clause)" /><figcaption class="figure-caption text-center text-small">
<a href="https://www.sqlite.org/syntax/select-core.html">select-core</a> (FROM clause)
</figcaption>
</figure>

<figure class="figure">
<img class="img-responsive" src="/_file/query-builder-how/join-clause.svg" alt="join-clause" /><figcaption class="figure-caption text-center text-small">
<a href="https://www.sqlite.org/syntax/join-clause.html">join-clause</a>
</figcaption>
</figure>

<figure class="figure">
<img class="img-responsive" src="/_file/query-builder-how/join-operator.svg" alt="join-operator" /><figcaption class="figure-caption text-center text-small">
<a href="https://www.sqlite.org/syntax/join-operator.html">join-operator</a>
</figcaption>
</figure>

<p>You may notice <code>table-or-subquery</code> followed by <code>,</code> in FROM
is actually a subset of <code>table-or-subquery</code> followed by <code>join-operator</code> in <code>join-clause</code>.
That is, for SQLite, a comma is just another join operator.</p>
<p>Put the other way around, <em>a join operator is just another separator</em>.</p>
<p>Because our separators come <em>after</em> things, not before,
we'll model join operators separately, as <em>fake keywords</em>
(that is, not used to index into <code>data</code>).</p>
<p>First, let's set them:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_Thing</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="hll">    <span class="n">keyword</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span>    <span class="n">is_subquery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">fake_keywords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">JOIN</span><span class="o">=</span><span class="s1">&#39;FROM&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="hll">        <span class="n">keyword</span><span class="p">,</span> <span class="n">fake_keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_fakes</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
</span>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="hll">        <span class="k">if</span> <span class="n">fake_keyword</span><span class="p">:</span>
</span><span class="hll">            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">fake_keyword</span><span class="p">)</span>
</span>        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>

<span class="hll">    <span class="k">def</span> <span class="nf">_resolve_fakes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">real</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_keywords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">keyword</span><span class="p">:</span>
</span><span class="hll">                <span class="k">return</span> <span class="n">real</span><span class="p">,</span> <span class="n">keyword</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">keyword</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</span></code></pre></div>
</td></tr></table>
<p>We could've probably just hardcoded this in <code>add()</code>
(<code>if 'JOIN' in keyword: ...</code>),
but doing it like this makes it easier to see at a glance that
&quot;JOIN is a fake FROM&quot;.</p>
<p>Using <code>keyword</code> as a separator is relatively straightforward:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="hll">            <span class="n">grouped</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span class="hll">            <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
</span><span class="hll">                <span class="n">grouped</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
</span><span class="hll">            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span>
    <span class="k">def</span> <span class="nf">_lines_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">things</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>

<span class="hll">            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">)][</span><span class="n">keyword</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">thing</span><span class="o">.</span><span class="n">is_subquery</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">)&#39;</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">thing</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>

<span class="hll">            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">:</span>
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_separator</span>

            <span class="k">yield</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<p>Since FROM always comes before JOIN,
we make sure to output the real ones first.</p>
<details>
<summary>We add a JOIN to the test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
</span>        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            alias AS (</span>
<span class="sd">                with</span>
<span class="sd">            )</span>
<span class="sd">        SELECT</span>
<span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias</span>
<span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="hll"><span class="sd">        JOIN</span>
</span><span class="hll"><span class="sd">            join</span>
</span><span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<p>The code so far:
<a href="/_file/query-builder-how/04-join/builder.py">builder.py</a>,
<a href="/_file/query-builder-how/04-join/test_builder.py">test_builder.py</a>.</p>
<h2 id="distinct">Distinct<span class="headerlink"> <a href="#distinct" title="permalink">#</a></span></h2>
<p>The final model change is to support SELECT DISTINCT.</p>
<p>DISTINCT and ALL are flags that apply to the whole clause;
we'll model them as such:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">117</span>
<span class="normal">118</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">_FlagList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="n">flag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">31</span>
<span class="normal">32</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_FlagList</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">}</span>
</span></code></pre></div>
</td></tr></table>
<p>Since most of the time we're OK with the default <code>flag</code>,
we don't bother setting it in <code>__init__</code>,
and use a class variable instead.
If we need to customize it,
we can set <code>flag</code> on the instance, shadowing the class variable.</p>
<p>A <code>__repr__</code> showing the flag would be nice,
but it'd only be useful during debugging, so we skip it as well.</p>
<p>We set the flag based on a known set for each clause;
like with fake keywords, we pull the &quot;parsing&quot; logic into a separate method:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">30</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="n">flag_keywords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SELECT</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DISTINCT&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL&#39;</span><span class="p">})</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">keyword</span><span class="p">,</span> <span class="n">fake_keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_fakes</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
<span class="hll">        <span class="n">keyword</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_flags</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
</span>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

<span class="hll">        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
</span><span class="hll">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2"> already has flag: </span><span class="si">{</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="hll">            <span class="n">target</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>
</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">fake_keyword</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">fake_keyword</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery_keywords</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Thing</span><span class="o">.</span><span class="n">from_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_resolve_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_keywords</span><span class="p">[</span><span class="n">prefix</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid flag for </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">flag</span>
        <span class="k">return</span> <span class="n">keyword</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</code></pre></div>
</td></tr></table>
<p>Using it for output is again straightforward:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="nf">_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">things</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span><span class="p">:</span>
                <span class="k">continue</span>

<span class="hll">            <span class="k">if</span> <span class="n">things</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">things</span><span class="o">.</span><span class="n">flag</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span class="hll">            <span class="k">else</span><span class="p">:</span>
</span><span class="hll">                <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
                <span class="n">grouped</span><span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">keyword</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines_keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<details>
<summary>We add a SELECT DISTINCT to our test.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select-one&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;select-two&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from-one&#39;</span><span class="p">,</span> <span class="s1">&#39;from-two&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where-one&#39;</span><span class="p">,</span> <span class="s1">&#39;where-two&#39;</span><span class="p">)</span>
<span class="hll">        <span class="o">.</span><span class="n">SELECT_DISTINCT</span><span class="p">(</span><span class="s1">&#39;select-three&#39;</span><span class="p">)</span>
</span>    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            alias AS (</span>
<span class="sd">                with</span>
<span class="sd">            )</span>
<span class="hll"><span class="sd">        SELECT DISTINCT</span>
</span><span class="sd">            select-one,</span>
<span class="sd">            select-two AS alias,</span>
<span class="hll"><span class="sd">            select-three</span>
</span><span class="sd">        FROM</span>
<span class="sd">            from-one,</span>
<span class="sd">            from-two</span>
<span class="sd">        JOIN</span>
<span class="sd">            join</span>
<span class="sd">        WHERE</span>
<span class="sd">            where-one AND</span>
<span class="sd">            where-two</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<p>The code so far:
<a href="/_file/query-builder-how/05-distinct/builder.py">builder.py</a>,
<a href="/_file/query-builder-how/05-distinct/test_builder.py">test_builder.py</a>.</p>
<h2 id="more-tests">More tests<span class="headerlink"> <a href="#more-tests" title="permalink">#</a></span></h2>
<p>Our only test isn't all that simple anymore;
maybe it's time to split it in two:
one with a really simple query, and one with a really complicated query.</p>
<details>
<summary>... something like this.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_simple</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        SELECT</span>
<span class="sd">            select</span>
<span class="sd">        FROM</span>
<span class="sd">            from</span>
<span class="sd">        JOIN</span>
<span class="sd">            join</span>
<span class="sd">        WHERE</span>
<span class="sd">            where</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_query_complicated</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test a complicated query:</span>

<span class="sd">    * order between different keywords does not matter</span>
<span class="sd">    * arguments of repeated calls get appended, with the order preserved</span>
<span class="sd">    * SELECT can receive 2-tuples</span>
<span class="sd">    * WHERE and HAVING arguments are separated by AND</span>
<span class="sd">    * JOIN arguments are separated by the keyword, and come after plain FROM</span>
<span class="sd">    * no-argument keywords have no effect, unless they are flags</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Query</span><span class="p">()</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">()</span>
        <span class="o">.</span><span class="n">OUTER_JOIN</span><span class="p">(</span><span class="s1">&#39;outer join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">LIMIT</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">()</span>
        <span class="o">.</span><span class="n">ORDER_BY</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">HAVING</span><span class="p">(</span><span class="s1">&#39;having&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">((</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;expr&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">GROUP_BY</span><span class="p">(</span><span class="s1">&#39;group by&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">(</span><span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="s1">&#39;four&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;another from&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;where&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">ORDER_BY</span><span class="p">(</span><span class="s1">&#39;third&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">OUTER_JOIN</span><span class="p">(</span><span class="s1">&#39;another outer join&#39;</span><span class="p">)</span>
        <span class="c1"># this isn&#39;t technically valid</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">(</span><span class="s1">&#39;first cte&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">GROUP_BY</span><span class="p">(</span><span class="s1">&#39;another group by&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">HAVING</span><span class="p">(</span><span class="s1">&#39;another having&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WITH</span><span class="p">((</span><span class="s1">&#39;fancy&#39;</span><span class="p">,</span> <span class="s1">&#39;second cte&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">JOIN</span><span class="p">(</span><span class="s1">&#39;another join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">WHERE</span><span class="p">(</span><span class="s1">&#39;another where&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">NATURAL_JOIN</span><span class="p">(</span><span class="s1">&#39;natural join&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">SELECT</span><span class="p">()</span>
        <span class="o">.</span><span class="n">SELECT_DISTINCT</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        WITH</span>
<span class="sd">            (</span>
<span class="sd">                first cte</span>
<span class="sd">            ),</span>
<span class="sd">            fancy AS (</span>
<span class="sd">                second cte</span>
<span class="sd">            )</span>
<span class="sd">        SELECT DISTINCT</span>
<span class="sd">            one,</span>
<span class="sd">            expr AS two,</span>
<span class="sd">            three,</span>
<span class="sd">            four</span>
<span class="sd">        FROM</span>
<span class="sd">            from,</span>
<span class="sd">            another from</span>
<span class="sd">        OUTER JOIN</span>
<span class="sd">            outer join</span>
<span class="sd">        JOIN</span>
<span class="sd">            join</span>
<span class="sd">        OUTER JOIN</span>
<span class="sd">            another outer join</span>
<span class="sd">        JOIN</span>
<span class="sd">            another join</span>
<span class="sd">        NATURAL JOIN</span>
<span class="sd">            natural join</span>
<span class="sd">        WHERE</span>
<span class="sd">            where AND</span>
<span class="sd">            another where</span>
<span class="sd">        GROUP BY</span>
<span class="sd">            group by,</span>
<span class="sd">            another group by</span>
<span class="sd">        HAVING</span>
<span class="sd">            having AND</span>
<span class="sd">            another having</span>
<span class="sd">        ORDER BY</span>
<span class="sd">            first,</span>
<span class="sd">            second,</span>
<span class="sd">            third</span>
<span class="sd">        LIMIT</span>
<span class="sd">            limit</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<p>The code so far:
<a href="/_file/query-builder-how/06-more-tests/builder.py">builder.py</a>,
<a href="/_file/query-builder-how/06-more-tests/test_builder.py">test_builder.py</a>.</p>
<h2 id="more-init">More init<span class="headerlink"> <a href="#more-init" title="permalink">#</a></span></h2>
<p>One last feature:
I'd like to reuse the formatting logic for paranthesized lists.</p>
<p>Good thing <code>__init__</code> doesn't take any arguments yet:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">_FlagList</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">separators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">separators</span> <span class="o">=</span> <span class="n">separators</span>
</code></pre></div>
</td></tr></table>
<p>Using it looks like:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Query</span><span class="p">({</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]},</span> <span class="n">separators</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="s1">&#39;OR&#39;</span><span class="p">}))</span>
<span class="go">(</span>
<span class="go">    one OR</span>
<span class="go">    two</span>
<span class="go">)</span>
</code></pre></div>
<p>We could have required <code>data</code> to have the same structure as the attribute;
however, it would be too verbose to use,
and I'd have to do all the clean up myself;
that's not very <em>convenient</em>.
Instead, we make it mean
&quot;<code>add()</code> these strings for these keywords&quot;.<sup class="footnote-ref" id="fnref-4"><a href="#fn-4">4</a></sup></p>
<details>
<summary>We add a separate test for the fancy <code>__init__</code>.</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_query_init</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">({</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]},</span> <span class="p">{</span><span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="s1">&#39;OR&#39;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">        (</span>
<span class="sd">            one OR</span>
<span class="sd">            two OR</span>
<span class="sd">            three</span>
<span class="sd">        )</span>

<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<hr />
<p>OK, now we're really done. We've spent 148 lines, or 101 statements.</p>
<p>The final version:
<a href="/_file/query-builder-how/07-more-init/builder.py">builder.py</a>,
<a href="/_file/query-builder-how/07-more-init/test_builder.py">test_builder.py</a>.</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>Since the code in this article is essentially <a href="https://github.com/lemon24/reader/blob/15121f667a6f2e388f0072a3fcd715f533883899/src/reader/_sql_utils.py">the reader one</a>,
 but without type annotations,
 feel free to use it under the same BSD 3-Clause <a href="https://github.com/lemon24/reader/blob/15121f667a6f2e388f0072a3fcd715f533883899/LICENSE">license</a>.</p>
</section>
<hr />
<!-- TODO: wrapping up / conclusion section -->
<p>That's it for now. :)</p>
<p><strong>Learned something new today?</strong> Share this with others, it really helps!</p>
<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661&SIGNUP=query-builder-how"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"
>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">

        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>
<h2 id="bonus-things-that-didn-t-make-the-cut">Bonus: things that didn't make the cut<span class="headerlink"> <a href="#bonus-things-that-didn-t-make-the-cut" title="permalink">#</a></span></h2>
<p>When talking about <a href="#trade-offs">trade-offs</a>,
I said we'll only add features as needed;
this may seem a bit handwavy –
how can I tell adding them won't make the code explode?</p>
<p>Because I <em>did</em> add them;
that's what <a href="/own-query-builder#the-second-prototype">prototyping</a> was for.
But since they weren't actually used, I removed them –
there's no point in them <a href="https://en.wikipedia.org/wiki/Software_rot#Unused_code">rotting away</a>.</p>
<p>Here's how you'd go about implementing a few of them.</p>
<h3 id="insert-update-delete">Insert / update / delete<span class="headerlink"> <a href="#insert-update-delete" title="permalink">#</a></span></h3>
<p>Make them flag keywords, to support the <code>OR ABORT/FAIL/...</code> variants.</p>
<p>To make VALUES bake in the parentheses, set its <code>format</code> to <code>({value})</code>.
That's to add one values tuple at a time.</p>
<p>To add one column at a time, we could do this:</p>
<ul>
<li>allow <code>add()</code>ing INSERT with arbitrary flags</li>
<li>make <code>INSERT('column', into='table')</code>
a synonym of <code>add('INSERT INTO table', 'column')</code></li>
<li>classify INSERT and VALUES as <code>parens_keywords</code>
– like <code>subquery_keywords</code>, but they apply once per keyword, not per value</li>
</ul>
<p>It'd look like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="c1"># first insert sets flag</span>
<span class="n">query</span><span class="o">.</span><span class="n">INSERT</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="n">into</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">VALUES</span><span class="p">(</span><span class="s1">&#39;:one&#39;</span><span class="p">)</span>
<span class="c1"># later we just add stuff</span>
<span class="n">query</span><span class="o">.</span><span class="n">INSERT</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">VALUES</span><span class="p">(</span><span class="s1">&#39;:two&#39;</span><span class="p">)</span>
</code></pre></div>
<h3 id="arbitrary-strings-as-subqueries">Arbitrary strings as subqueries<span class="headerlink"> <a href="#arbitrary-strings-as-subqueries" title="permalink">#</a></span></h3>
<p>Allow setting <code>add(..., is_subquery=True)</code>; you'd then do:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">query</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;subquery&#39;</span><span class="p">,</span> <span class="n">is_subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">query</span><span class="o">.</span><span class="n">FROM</span><span class="p">(</span><span class="s1">&#39;not subquery&#39;</span><span class="p">)</span>
</code></pre></div>
<h3 id="query-objects-as-subqueries">Query objects as subqueries<span class="headerlink"> <a href="#query-objects-as-subqueries" title="permalink">#</a></span></h3>
<p>Using Query objects as subqueries
without having to convert them explicitly to strings
would allow changing them <em>after</em> being <code>add()</code>ed.</p>
<p>To do it, we just need to allow <code>_Thing.value</code> to be a Query,
and override its <code>is_subquery</code> based on an <a href="https://docs.python.org/3/library/functions.html#isinstance">isinstance()</a> check.</p>
<h3 id="union-intersect-except">Union / intersect / except<span class="headerlink"> <a href="#union-intersect-except" title="permalink">#</a></span></h3>
<p>This one goes a bit meta:</p>
<ul>
<li>add a &quot;virtual&quot; COMPOUND keyword</li>
<li>add a new <code>compound(keyword)</code> method,
which moves everything except WITH and ORDER BY to a subquery,
and appends the subquery to <code>data['COMPOUND']</code> with the appropriate fake keyword</li>
<li>make <code>__getattr__</code> return a <code>compound()</code> partial for compound keywords</li>
<li>special-case COMPOUND in <code>_lines()</code></li>
</ul>
<section class="footnotes">
<ol>
<li id="fn-1"><p>The guaranteed insertion order was actually added
to the language specification in 3.7,
but in 3.6 both CPython and PyPy had it as an implementation detail. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p>This works because <code>False == 0</code> and <code>True == 1</code>, and is likely too clever. <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-3"><p>That's <a href="https://github.com/lemon24/reader/blob/44d1f9af31dcb5bed80b4d798206bd02ae59d127/src/reader/_sql_utils.py#L77-L83">what I did initially</a>. <a href="#fnref-3" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-4"><p>An alternate constructor or a subclass might have been a better choice here.
We'll fix it if we need <code>__init__</code> for something else. ¯\_(ツ)_/¯ <a href="#fnref-4" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>










<hr>
<p>This is part of a series:</p>

<ul>


<li>
    <a href="/query-builder">SQL query builder in 150 lines of Python</a>



<li>
    <a href="/query-builder-why">Why use an SQL query builder in the first place?</a>



<li>
    <a href="/own-query-builder">Why I wrote my own SQL query builder (in Python)</a>



<li>
    <a href="/query-builder-how">Write an SQL query builder in 150 lines of Python!</a> <small class="text-gray">(this article)</small>


</ul>





</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>