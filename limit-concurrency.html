












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>Limiting concurrency in Python asyncio: the story of async imap_unordered() - death and gravity</title>
<meta name="description" content="So, you&#39;re doing some async stuff, repeatedly, hundreds of thousands of times. How do you *not* do it all at once? Hint: asyncio.Semaphore is not always the best way, despite what Stack Overflow may tell you ;)" />


<meta property="og:title" content="Limiting concurrency in Python asyncio: the story of async imap_unordered()">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/limit-concurrency">
<meta property="og:description" content="So, you&#39;re doing some async stuff, repeatedly, hundreds of thousands of times. How do you *not* do it all at once? Hint: asyncio.Semaphore is not always the best way, despite what Stack Overflow may tell you ;)">



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RY2QR580X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-4RY2QR580X");
</script>



<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Limiting concurrency in Python asyncio: the story of async imap_unordered()</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2023-03-27">March 2023</span>
∙ 13 minute read
∙
</small><span class="share-icons">
<a
    class="share-icon pycoders"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/limit-concurrency&t=Limiting%20concurrency%20in%20Python%20asyncio%3A%20the%20story%20of%20async%20imap_unordered%28%29"
>HN</a>
<a
    class="share-icon bluesky"
    href="https://bsky.%61%70%70/intent/compose?text=Limiting%20concurrency%20in%20Python%20asyncio%3A%20the%20story%20of%20async%20imap_unordered%28%29%20https%3A//death.andgravity.com/limit-concurrency"
>Bluesky</a>
<!--
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/limit-concurrency&title=Limiting%20concurrency%20in%20Python%20asyncio%3A%20the%20story%20of%20async%20imap_unordered%28%29"
>Reddit</a>
-->
<a
    class="share-icon linkedin"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/limit-concurrency"
>linkedin</a>
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Limiting%20concurrency%20in%20Python%20asyncio%3A%20the%20story%20of%20async%20imap_unordered%28%29&url=https%3A//death.andgravity.com/limit-concurrency&via=_andgravity"
>Twitter</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>So, you're doing some async stuff, repeatedly, many times.</p>
<p>Like, <strong>hundreds of thousands of times</strong>.</p>
<p>Maybe you're scraping some data.</p>
<p>Maybe it's more complicated
– you're calling an API,
and then passing the result to another one,
and then saving the result of that.</p>
<p>Either way, it's a good idea to <em>not</em> do it all at once.
For one, it's not polite to the services you're calling.
For another, it'll load everything in memory, <em>all at once</em>.</p>
<p>In <strong>sync</strong> code,
you might use a <a class="external" href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing.dummy">thread pool</a> and <a class="external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool.imap_unordered">imap_unordered()</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">dummy</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">,</span> <span class="n">things_to_do</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>

<p>Here, concurrency is limited by the fixed number of threads.</p>
<p>But what about <strong>async</strong> code?
In this article,
we'll look at a few ways of limiting concurrency in asycio,
and find out which one is best.</p>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>No, it's not <a class="anchor" href="#asyncio-semaphore">Semaphore</a>,
despite what Stack Overflow may tell you.</p>
</section>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you're in a hurry – it's <a class="anchor" href="#asyncio-wait">wait()</a>.</p>
</section>
<details class="toc" open>
<summary>Contents</summary>
<ul>
<li><a href="#getting-started">Getting started</a></li>
<li><a href="#asyncio-gather">asyncio.gather()</a></li>
<li><a href="#asyncio-semaphore">asyncio.Semaphore</a></li>
<li><a href="#asyncio-as-completed">asyncio.as_completed()</a></li>
<li><a href="#asyncio-queue">asyncio.Queue</a></li>
<li><a href="#aside-backpressure">Aside: backpressure</a></li>
<li><a href="#asyncio-wait">asyncio.wait()</a></li>
<li><a href="#async-iterables">Async iterables</a></li>
<li><a href="#bonus-exceptions">Bonus: exceptions</a></li>
<li><a href="#bonus-better-decorators">Bonus: better decorators?</a></li>
</ul>
</details>
<h2 id="getting-started">Getting started<span class="headerlink">&nbsp;<a href="#getting-started" title="permalink">#</a></span></h2>
<p>In order to try things out more easily,
we'll start with a test harness of sorts.</p>
<!--
<details>
<summary>Imports:</summary>

.. literalinclude:: mo_00_serial.py
    :lines: 1-5

</details>
-->

<p>Our <code>async map_unordered()</code> behaves pretty much like <a class="external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool.imap_unordered">imap_unordered()</a>
– it takes a coroutine function and an iterable of arguments,
and runs the resulting awaitables <code>limit</code> at a time:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map_unordered</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">aws</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>The actual running is done by <code>limit_concurrency()</code>.
For now, we run them one by one
(we'll get back to this later on):</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">aws</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aw</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">yield</span> <span class="k">await</span> <span class="n">aw</span>
</code></pre></div></td></tr></table></div>

<p>To simulate work being done,
we just <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.sleep">sleep()</a>:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">do_stuff</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="mi">1</span> <span class="o">/</span> <span class="n">i</span>  <span class="c1"># raises ZeroDivisionError for i == 0</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span>
</code></pre></div></td></tr></table></div>

<p>Putting it all together,
we get a <code>map_unordered.py LIMIT TIME...</code> script that does stuff in parallel,
printing timings as we get each result:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">map_unordered</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">: done&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">async_main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">limit</span><span class="p">),</span> <span class="n">timeout</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>... like so:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span>
<span class="go">0.0: done</span>
<span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2
<span class="go">0.1: 0.1</span>
<span class="go">0.3: 0.2</span>
<span class="go">0.3: done</span>
</code></pre></div>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you need a refresher on lower level <a class="external" href="https://docs.python.org/3/library/asyncio.html">asyncio</a> stuff related to waiting,
check out Hynek Schlawack's excellent
<a class="external" href="https://hynek.me/articles/waiting-in-asyncio/">Waiting in asyncio</a>.</p>
</section>
<h2 id="asyncio-gather">asyncio.gather()<span class="headerlink">&nbsp;<a href="#asyncio-gather" title="permalink">#</a></span></h2>
<p>In the <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#running-tasks-concurrently">Running Tasks Concurrently</a> section of the asyncio docs,
we find <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.gather">asyncio.gather()</a>,
which runs awaitables concurrently and returns their results.</p>
<p>We can use it to run <code>limit</code>-sized batches:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">aws</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>

<p>This seems to work:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2
<span class="go">0.2: 0.1</span>
<span class="go">0.2: 0.2</span>
<span class="go">0.2: done</span>
</code></pre></div>
<p>... except:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">0.2: 0.1</span>
<span class="go">0.2: 0.2</span>
<span class="go">0.4: 0.2</span>
<span class="go">0.4: 0.1</span>
<span class="go">0.4: done</span>
</code></pre></div>
<p>... those should fit in 0.3 seconds:</p>
<div class="highlight code-container"><pre class="code" data-lang="Text only"><span></span><code>| sleep(.1) |       sleep(.2)       |
|       sleep(.2)       | sleep(.1) |
</code></pre></div>
<p>... but we're waiting for the entire batch to finish,
even if some tasks finish earlier:</p>
<div class="highlight code-container"><pre class="code" data-lang="Text only"><span></span><code>| sleep(.1) |...........|       sleep(.2)       |
|       sleep(.2)       | sleep(.1) |...........|
</code></pre></div>
<h2 id="asyncio-semaphore">asyncio.Semaphore<span class="headerlink">&nbsp;<a href="#asyncio-semaphore" title="permalink">#</a></span></h2>
<p>Screw the docs, too much to read;
after some googling,
the first few Stack Overflow answers all point to <a class="external" href="https://docs.python.org/3/library/asyncio-sync.html#asyncio.Semaphore">asyncio.Semaphore</a>.</p>
<p>Like its <a class="external" href="https://docs.python.org/3/library/threading.html#threading.Semaphore">threading counterpart</a>,
we can use it to limit
how many times the body of a <code>with</code> block is entered in parallel:</p>
<!--
```python
sem = asyncio.Semaphore(10)

# ... later
async with sem:
    # no more than 10 times in parallel
```

Sounds about what we're looking for:
-->

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="n">aw</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">aw</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">aws</span><span class="p">)):</span>
        <span class="k">yield</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>

<p>This works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">0.3: 0.1</span>
<span class="go">0.3: 0.2</span>
<span class="go">0.3: 0.2</span>
<span class="go">0.3: 0.1</span>
<span class="go">0.3: done</span>
</code></pre></div>
<p>... except, because <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.gather">gather()</a> takes a sequence,
we end up consuming the entire <code>aws</code> iterable
before <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.gather">gather()</a> is even called.
Let's highlight this:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">on_iter_end</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">x</span>
    <span class="n">callback</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="n">timeout</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">on_iter_end</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iter end&quot;</span><span class="p">))</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">async_main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">limit</span><span class="p">),</span> <span class="n">timeout</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<p>As expected:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">iter end</span>
<span class="go">0.3: 0.1</span>
<span class="go">0.3: 0.2</span>
<span class="go">0.3: 0.2</span>
<span class="go">0.3: 0.1</span>
<span class="go">0.3: done</span>
</code></pre></div>
<p>For small iterables, this is fine,
but for bigger ones,
creating all the tasks upfront without running them
might cause memory issues.
Also, if the iterable is lazy (e.g. it comes from a paginated API),
we only start work after it's all consumed in memory,
instead processing it in a streaming fashion.</p>
<h2 id="asyncio-as-completed">asyncio.as_completed()<span class="headerlink">&nbsp;<a href="#asyncio-as-completed" title="permalink">#</a></span></h2>
<p>At a glance, <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.as_completed">asyncio.as_completed()</a> might do what we need
– it takes an iterable of awaitables, runs them concurrently,
and returns an iterator of coroutines that
&quot;can be awaited to get the earliest next result
from the iterable of the remaining awaitables&quot;.</p>
<p>Sadly, <a class="external" href="https://github.com/python/cpython/blob/3.11/Lib/asyncio/tasks.py#L557">it still consumes the iterable right away</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">as_completed</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="o">...</span>  <span class="c1"># set-up</span>
    <span class="n">todo</span> <span class="o">=</span> <span class="p">{</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">fs</span><span class="p">)}</span>
    <span class="o">...</span>  <span class="c1"># actual logic</span>
</code></pre></div>
<p>But there's another, subtler issue.</p>
<p><a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.as_completed">as_completed()</a> has no limits of its own
– it's up to us to limit how fast we feed it awaitables.
Presumably, we could wrap the input iterable
into a generator that yields awaitables
only if enough results came out the other end,
and waits otherwise.</p>
<p>However, due to <a class="external" href="https://peps.python.org/pep-3156/#waiting-for-multiple-coroutines">historical</a> <a class="external" href="https://peps.python.org/pep-0525/#support-for-asynchronous-iteration-protocol">reasons</a>,
as_completed() takes a plain-old-<em>sync</em>-iterator
– we cannot <code>await</code> anything in its (sync) <a class="external" href="https://docs.python.org/3/library/stdtypes.html#iterator.__next__">__next__()</a>,
and sync waiting of any kind would block (and possibly deadlock)
the entire event loop.</p>
<p>So, no <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.as_completed">as_completed()</a> for you.</p>
<!--

.. literalinclude:: mo_30_as_completed.py
    :lines: 13-21

```console
$ python map_unordered.py 2 .1 .2 .2 .1
iter end
0.3: 0.1
0.3: 0.2
0.3: 0.2
0.3: 0.1
0.3: done
```

-->

<h2 id="asyncio-queue">asyncio.Queue<span class="headerlink">&nbsp;<a href="#asyncio-queue" title="permalink">#</a></span></h2>
<p>Speaking of threading counterparts,
how would you implement <a class="external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool.imap_unordered">imap_unordered()</a>
if there was no Pool? Queues, of course!</p>
<p>And <a class="external" href="https://docs.python.org/3/library/asyncio.html">asyncio</a> has its own <a class="external" href="https://docs.python.org/3/library/asyncio-queue.html#asyncio.Queue">Queue</a>,
which you use in pretty much the same way:
start <code>limit</code> worker tasks that loop forever,
each pulling awaitables, awaiting them,
and putting the results into a queue.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">aws</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">ndone</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">worker</span><span class="p">():</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="k">break</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="kc">True</span><span class="p">,</span> <span class="k">await</span> <span class="n">aw</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="kc">False</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">break</span>

    <span class="n">worker_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">limit</span><span class="p">)]</span>

    <span class="k">while</span> <span class="n">ndone</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">rv</span>
        <span class="k">elif</span> <span class="n">rv</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">rv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndone</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>

<p>The iterable is exhausted before the last &quot;batch&quot; starts:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span>.3<span class="w"> </span>.3<span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">0.1: 0.1</span>
<span class="go">0.2: 0.2</span>
<span class="go">0.4: 0.3</span>
<span class="go">0.5: 0.3</span>
<span class="go">iter end</span>
<span class="go">0.6: 0.1</span>
<span class="go">0.6: 0.2</span>
<span class="go">0.6: done</span>
</code></pre></div>
<p>I was going to work up to this in a few steps,
but I'll just point out three common bugs
this type of code might have (that apply to threads too).</p>
<details>
<summary>
First,
we could increment <code>ndone</code> from the worker,
but this makes <code>await queue.get()</code> hang forever for empty iterables,
since workers never get to run by the time we get to it;
because there's no other await, it's not even a race condition.
</summary>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">aws</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">ndone</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">worker</span><span class="p">():</span>
        <span class="k">nonlocal</span> <span class="n">ndone</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="n">ndone</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">break</span>

            <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="k">await</span> <span class="n">aw</span><span class="p">)</span>

    <span class="n">worker_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">limit</span><span class="p">)]</span>

    <span class="k">while</span> <span class="n">ndone</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">yield</span> <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span>
<span class="go">iter end</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">  ...</span>
<span class="go">asyncio.exceptions.TimeoutError</span>
</code></pre></div>
</details>

<p>The solution is to signal the worker is done in-band,
by putting a <a class="internal" href="/sentinels#what-s-a-sentinel-and-why-do-i-need-one">sentinel</a> on the queue.
I guess a good rule of thumb
is that you want a put() for each get() without a timeout.<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup></p>
<!--
```console
$ python map_unordered.py 2
iter end
0.0: done
```
-->

<details>
<summary>
Second,
you have to catch all exceptions;
otherwise,
the worker gets killed,
and <code>get()</code> waits forever for a sentinel that will never come.
</summary>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">aws</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">ndone</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">done</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">worker</span><span class="p">():</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="k">await</span> <span class="n">aw</span><span class="p">)</span>

    <span class="n">worker_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">limit</span><span class="p">)]</span>

    <span class="k">while</span> <span class="n">ndone</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">ndone</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">yield</span> <span class="n">rv</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span><span class="m">0</span><span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">0.1: 0.1</span>
<span class="go">0.2: 0.2</span>
<span class="go">0.4: 0.2</span>
<span class="go">iter end</span>
<span class="go">0.5: 0.1</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">  ...</span>
<span class="go">asyncio.exceptions.TimeoutError</span>
<span class="go">Task exception was never retrieved</span>
<span class="go">future: &lt;Task finished name=&#39;Task-3&#39; coro=&lt;limit_concurrency.&lt;locals&gt;.worker() done, defined at map_unordered.py:20&gt; exception=ZeroDivisionError(&#39;float division by zero&#39;)&gt;</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">  ...</span>
<span class="go">ZeroDivisionError: float division by zero</span>
</code></pre></div>
</details>

<!--
```console
$ python map_unordered.py 2 .1 .2 0 .2 .1
0.1: 0.1
Traceback (most recent call last):
  ...
ZeroDivisionError: float division by zero
```
-->

<p>Finally, our input iterator is synchronous (for now),
so no other task can run during <code>next(aws)</code>.
But if it were async,
any number of tasks could <code>await anext(aws)</code> in parallel,
leading to <a class="external" href="https://stackoverflow.com/a/46858792">concurrency issues</a>.
The fix is the same as with threads:
either protect that call with a <a class="external" href="https://docs.python.org/3/library/asyncio-sync.html#asyncio.Lock">Lock</a>,
or feed awaitables to workers through an input queue.</p>
<p>Anyway, no need to worry about any of that – a better solution awaits.</p>
<h2 id="aside-backpressure">Aside: backpressure<span class="headerlink">&nbsp;<a href="#aside-backpressure" title="permalink">#</a></span></h2>
<p>At this point, we're technically done
– the queue solution does everything
<a class="external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool.imap_unordered">Pool.​imap_unordered()</a> does.</p>
<p>So much so, that, <a class="external" href="https://bugs.python.org/issue40110">like imap_unordered()</a>,
it lacks <a class="external" href="https://medium.com/@jayphelps/backpressure-explained-the-flow-of-data-through-software-2350b3e77ce7">backpressure</a>:
when code consuming results from <code>map_unordered()</code>
cannot keep up with the tasks producing them,
the results accumulate in the internal queue,
with potentially infinite memory usage.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">dummy</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got result&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">0</span>
<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
<span class="go">got result</span>
<span class="go">got result</span>
<span class="go">got result</span>
<span class="go">got result</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_print</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;(async)&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">async</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">map_unordered</span><span class="p">(</span><span class="n">async_print</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got result&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">0 (async)</span>
<span class="go">1 (async)</span>
<span class="go">2 (async)</span>
<span class="go">3 (async)</span>
<span class="go">got result</span>
<span class="go">got result</span>
<span class="go">got result</span>
<span class="go">got result</span>
</code></pre></div>
<p>To fix this, we make the queue bounded,
so that workers block while the queue is full.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">15</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="n">queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">async</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">map_unordered</span><span class="p">(</span><span class="n">async_print</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got result&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">0 (async)</span>
<span class="go">1 (async)</span>
<span class="go">2 (async)</span>
<span class="go">got result</span>
<span class="go">3 (async)</span>
<span class="go">got result</span>
<span class="go">4 (async)</span>
<span class="go">got result</span>
<span class="go">got result</span>
<span class="go">got result</span>
</code></pre></div>
<p>Alas, we can't do the same thing for
<a class="external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool.imap_unordered">Pool.​imap_unordered()</a>
because don't have access to its queue,
but that's a story for another time.</p>
<!--

# asyncio.Queue, redux

.. literalinclude:: mo_45_queue_as_completed.py
    :lines: 13-35

```console
$ python map_unordered.py 2 .1 .2 .2 .1
iter end
0.1: 0.1
0.2: 0.2
0.2: 0.2
0.2: 0.1
0.2: done
```

( ≖_≖)

Everything runs at once...


as_completed() yields the coroutines before they are actually finished:

> Each coroutine returned can be awaited to get the earliest next result from the iterable of the remaining awaitables.

That is, the waiting happens when you `await` them.

This is unlike the original, not-async as_completed() from concurrent.futures:

https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.as_completed

.. literalinclude:: sync_as_completed.py
    :lines: 1-

```console
$ python sync_as_completed.py
0.1
0.2
0.3
0.3
```

Note there's no `future.result()` call here; unlike the async version, the wait happens *inside* the as_completed() iterator.


---

If only there was some other way to wait tasks, also inspired by the concurrent.futures API, that actually blocks until they're done.

https://docs.python.org/3/library/asyncio-task.html#asyncio.wait

.. literalinclude:: mo_46_queue_wait.py
    :lines: 26-27

```console
$ python map_unordered.py 2 .1 .2 .2 .1
0.1: 0.1
0.2: 0.2
iter end
0.3: 0.1
0.3: 0.2
0.3: done
```

-->

<h2 id="asyncio-wait">asyncio.wait()<span class="headerlink">&nbsp;<a href="#asyncio-wait" title="permalink">#</a></span></h2>
<p>Pretending we're using threads works,
but it's not all that idiomatic.</p>
<p>If only there was some sort of low level, <a class="external" href="https://linux.die.net/man/2/select">select()</a>-like primitive
taking a set of tasks
and blocking until at least one of them finishes.
And of course there is
– we've been purposefully avoiding it this entire time –
it's <a class="external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.wait">asyncio.wait()</a>, and it does exactly that.</p>
<p>By default, it waits until all tasks are completed,
which isn't much better than <a class="anchor" href="#asyncio-gather">gather()</a>.</p>
<p>But, with <code>return_when=​FIRST_COMPLETED</code>,
it waits until <em>at least one</em> task is completed.
We can use this to keep a <code>limit</code>-sized set of running tasks
updated with new tasks as soon as the old ones finish:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">aws</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
    <span class="n">aws_ended</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">pending</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">pending</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">aws_ended</span><span class="p">:</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">aws_ended</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="n">aws_ended</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pending</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">aw</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pending</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
            <span class="n">pending</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span>
        <span class="p">)</span>
        <span class="k">while</span> <span class="n">done</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">done</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>We change <code>limit_concurrency()</code> to yield awaitables instead of results,
so it's more symmetric – awaitables in, awaitables out.
<code>map_unordered()</code> then becomes an async generator function,
instead of a sync function returning an async generator.
This is functionally the same,
but does make it a bit more self-documenting.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">map_unordered</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">aws</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="k">yield</span> <span class="k">await</span> <span class="n">task</span>
</code></pre></div></td></tr></table></div>

<p>This implementation has all the properties that the Queue one has:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">0.1: 0.1</span>
<span class="go">0.2: 0.2</span>
<span class="go">0.3: 0.1</span>
<span class="go">0.3: 0.2</span>
<span class="go">iter end</span>
<span class="go">0.3: done</span>
</code></pre></div>
<p>... and backpressure too:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">async</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">map_unordered</span><span class="p">(</span><span class="n">async_print</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got result&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">0 (async)</span>
<span class="go">got result</span>
<span class="go">1 (async)</span>
<span class="go">got result</span>
<span class="go">2 (async)</span>
<span class="go">got result</span>
<span class="go">3 (async)</span>
<span class="go">got result</span>
</code></pre></div>



<div class="panel inline-panel" >
    <div class="panel-header text-large">
        Liking this so far? Here&#39;s another article you might like:
    </div>
    <div class="panel-body">
        <p><a href="/asyncio-bridge">
            Running async code from sync code in Python
        </a>
    </div>
</div>
<h2 id="async-iterables">Async iterables<span class="headerlink">&nbsp;<a href="#async-iterables" title="permalink">#</a></span></h2>
<p>OK, but what if we pass <code>map_unordered()</code>
an <a class="external" href="https://docs.python.org/3/glossary.html#term-asynchronous-iterable">asynchronous iterable</a>?
We are talking about async stuff, after all.</p>
<p>This opens up a whole looking-glass world of async iteration:
instead of <a class="external" href="https://docs.python.org/3/library/functions.html#iter">iter()</a> you have <a class="external" href="https://docs.python.org/3/library/functions.html#aiter">aiter()</a>,
instead of <a class="external" href="https://docs.python.org/3/library/functions.html#next">next()</a> you have <a class="external" href="https://docs.python.org/3/library/functions.html#anext">anext()</a>,
some of them you await, some you don't...
Thankfully,
we can support both
without making things much worse.</p>
<p>And we don't need to be particularly smart about it either;
we can just feed the current code an async iterable from <code>main()</code>,
and punch our way through the exceptions:</p>
<!-- as_async_iter -->

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">as_async_iter</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>

<!-- args = as_async_iter... -->

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="n">args</span> <span class="o">=</span> <span class="n">on_iter_end</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iter end&quot;</span><span class="p">))</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">as_async_iter</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">async_main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">limit</span><span class="p">),</span> <span class="n">timeout</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<hr />
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">Traceback (most recent call last):</span>
<span class="go">  ...</span>
<span class="go">  File &quot;map_unordered.py&quot;, line 9, in map_unordered</span>
<span class="go">    aws = map(func, iterable)</span>
<span class="go">TypeError: &#39;async_generator&#39; object is not iterable</span>
</code></pre></div>
<p><a class="external" href="https://docs.python.org/3/library/functions.html#map">map()</a> doesn't work with async iterables,
so we use a <a class="external" href="https://docs.python.org/3/glossary.html#term-generator-expression">generator expression</a> instead.</p>
<!-- map_unordered -->

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">map_unordered</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">aws</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">aws</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">async</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="k">yield</span> <span class="k">await</span> <span class="n">task</span>
</code></pre></div></td></tr></table></div>

<p>In true <a class="external" href="https://docs.python.org/3/glossary.html#term-EAFP">easier to ask for forgiveness than permission</a> style,
we handle the exception from <a class="external" href="https://docs.python.org/3/library/functions.html#map">map()</a> instead of, say,
checking if <code>aws</code> is an instance of <a class="external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Iterable">collections.​abc.​Iterable</a>.</p>
<p>We could wrap <code>aws</code> to always be an async iterable,
but <code>limit_concurrency()</code> is useful on it its own,
so it's better to support both.</p>
<hr />
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">Traceback (most recent call last):</span>
<span class="go">  ...</span>
<span class="go">  File &quot;map_unordered.py&quot;, line 19, in limit_concurrency</span>
<span class="go">    aws = iter(aws)</span>
<span class="go">TypeError: &#39;async_generator&#39; object is not iterable</span>
</code></pre></div>
<p>For async iterables, we need to use <a class="external" href="https://docs.python.org/3/library/functions.html#aiter">aiter()</a>:</p>
<!-- aiter(aws) -->

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">aws</span> <span class="o">=</span> <span class="nb">aiter</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
        <span class="n">is_async</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">aws</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
        <span class="n">is_async</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>

<hr />
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">Traceback (most recent call last):</span>
<span class="go">  ...</span>
<span class="go">  File &quot;map_unordered.py&quot;, line 32, in limit_concurrency</span>
<span class="go">    aw = next(aws)</span>
<span class="go">TypeError: &#39;async_generator&#39; object is not an iterator</span>
</code></pre></div>
<p>... and <a class="external" href="https://docs.python.org/3/library/functions.html#anext">anext()</a>:</p>
<!-- anext(aws) -->

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">aws_ended</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">anext</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_async</span> <span class="k">else</span> <span class="nb">next</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopAsyncIteration</span> <span class="k">if</span> <span class="n">is_async</span> <span class="k">else</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="n">aws_ended</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pending</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">aw</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<p>... which unlike <a class="external" href="https://docs.python.org/3/library/functions.html#aiter">aiter()</a>, has to be awaited.</p>
<hr />
<details>
<summary>Here's <code>limit_concurrency()</code> in its entire glory:</summary>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">limit_concurrency</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">aws</span> <span class="o">=</span> <span class="nb">aiter</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
        <span class="n">is_async</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">aws</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
        <span class="n">is_async</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">aws_ended</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">pending</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">pending</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">aws_ended</span><span class="p">:</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">aws_ended</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">anext</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_async</span> <span class="k">else</span> <span class="nb">next</span><span class="p">(</span><span class="n">aws</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopAsyncIteration</span> <span class="k">if</span> <span class="n">is_async</span> <span class="k">else</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="n">aws_ended</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pending</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">aw</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pending</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
            <span class="n">pending</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span>
        <span class="p">)</span>
        <span class="k">while</span> <span class="n">done</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">done</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

</details>

<p>Not as clean as before, but it gets the job done:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">0.1: 0.1</span>
<span class="go">0.2: 0.2</span>
<span class="go">0.3: 0.1</span>
<span class="go">0.3: 0.2</span>
<span class="go">iter end</span>
<span class="go">0.3: done</span>
</code></pre></div>
<hr />
<p>Anyway, that's it for now.
Here's <a class="attachment" href="/_file/limit-concurrency/mo_60_async_iter.py">the final version of the code</a>.</p>
<p><strong>Learned something new today?</strong> Share it with others, it really helps! <span class="text-large">
<span class="share-icons">
<a
    class="share-icon pycoders color"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news color"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/limit-concurrency&t=Limiting%20concurrency%20in%20Python%20asyncio%3A%20the%20story%20of%20async%20imap_unordered%28%29"
>HN</a>
<a
    class="share-icon bluesky color"
    href="https://bsky.%61%70%70/intent/compose?text=Limiting%20concurrency%20in%20Python%20asyncio%3A%20the%20story%20of%20async%20imap_unordered%28%29%20https%3A//death.andgravity.com/limit-concurrency"
>Bluesky</a>
<!--
<a
    class="share-icon reddit color"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/limit-concurrency&title=Limiting%20concurrency%20in%20Python%20asyncio%3A%20the%20story%20of%20async%20imap_unordered%28%29"
>Reddit</a>
-->
<a
    class="share-icon linkedin color"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/limit-concurrency"
>linkedin</a>
<a
    class="share-icon twitter color"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Limiting%20concurrency%20in%20Python%20asyncio%3A%20the%20story%20of%20async%20imap_unordered%28%29&url=https%3A//death.andgravity.com/limit-concurrency&via=_andgravity"
>Twitter</a>
</span>
</span></p>

<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661&SIGNUP=limit-concurrency"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"
>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">

        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>



<div class="panel inline-panel" >
    <div class="panel-header text-large">
        If you&#39;ve made it this far, you might like:
    </div>
    <div class="panel-body">
        <p><a href="/output">
            Why you should still read the docs
        </a>
    </div>
</div>
<h2 id="bonus-exceptions">Bonus: exceptions<span class="headerlink">&nbsp;<a href="#bonus-exceptions" title="permalink">#</a></span></h2>
<p>OK, so what about exceptions?</p>
<p>A lot of times,
you still want to do the rest of the things,
even if one fails.
Also, you probably want to know <em>which</em> one failed,
but the <code>map_unordered()</code> results are not in order,
so how could you tell?</p>
<p>The most flexible solution is to let the user handle it
just like they would with
<a class="external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool.imap_unordered">Pool.​imap_unordered()</a> –
by decorating the original function.
Here's one way of doing it:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">return_args_and_exceptions</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_return_args_and_exceptions</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_return_args_and_exceptions</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">e</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code>    <span class="n">wrapped</span> <span class="o">=</span> <span class="n">return_args_and_exceptions</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">map_unordered</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><pre class="code" data-lang="Bash Session"><span></span><code><span class="gp">$ </span>python<span class="w"> </span>map_unordered.py<span class="w"> </span><span class="m">2</span><span class="w"> </span>.1<span class="w"> </span>.2<span class="w"> </span><span class="m">0</span><span class="w"> </span>.2<span class="w"> </span>.1
<span class="go">0.1: 0.1 -&gt; 0.1</span>
<span class="go">0.1: 0.0 -&gt; float division by zero</span>
<span class="go">0.2: 0.2 -&gt; 0.2</span>
<span class="go">0.3: 0.2 -&gt; 0.2</span>
<span class="go">0.3: 0.1 -&gt; 0.1</span>
<span class="go">iter end</span>
<span class="go">0.3: done</span>
</code></pre></div>
<h2 id="bonus-better-decorators">Bonus: better decorators?<span class="headerlink">&nbsp;<a href="#bonus-better-decorators" title="permalink">#</a></span></h2>
<p>Finally, here's a cool thing I learned from the <a class="external" href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio-pass-keywords">asyncio docs</a>.</p>
<p>When writing decorators,
you can use <a class="external" href="https://docs.python.org/3/library/functools.html#functools.partial">partial()</a> to bind the decorated function to an existing wrapper,
instead of always returning a new one.
The result is a more descriptive <a class="external" href="https://docs.python.org/3/library/functions.html#repr">representation</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">return_args_and_exceptions</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">)</span>
<span class="go">functools.partial(&lt;function _return_args_and_exceptions at 0x10647fd80&gt;, &lt;function do_stuff at 0x10647d8a0&gt;)</span>
</code></pre></div>
<p>Compare with the traditional version:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">return_args_and_exceptions</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="o">...</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">return_args_and_exceptions</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">)</span>
<span class="go">&lt;function return_args_and_exceptions.&lt;locals&gt;.wrapper at 0x103993560&gt;</span>
</code></pre></div>
<section class="footnotes">
<ol>
<li id="fn-1"><p>Does this have a fancy, academic name? <a class="internal" href="/about#contact">Do let me know!</a> <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>