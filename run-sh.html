<!doctype html>

<meta name="viewport" content="width=device-width" />


<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />






<title>Using a Makefile with .PHONY-only targets? Use a run.sh script instead
 - death and gravity</title>


<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RY2QR580X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-4RY2QR580X");
</script>



<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1>Using a Makefile with .PHONY-only targets? Use a run.sh script instead
</h1>

<p class="text-gray"><small>





</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>I recently discovered a neat pattern:</p>
<p>When you have a Makefile that only has <code>.PHONY</code> targets,
you can <em>turn it into a shell script with functions</em>,
and dispatch to them by adding <code>&quot;$@&quot;</code> at the end.</p>
<p>It makes things easier to read and write,
allows passing arguments to the &quot;targets&quot;
and reuse both inside and outside the script.</p>
<p>This is not my idea, but I think it's quite cool,
and thought others might too.
Here's <a href="http://www.oilshell.org/blog/2020/02/good-parts-sketch.html#semi-automation-with-runsh-scripts">the article that sold me on it</a>;
it discusses the benefits in more detail,
and links to other projects that use it.</p>
<h2 id="why-have-a-makefile-in-the-first-place">Why have a Makefile in the first place?<span class="headerlink"> <a href="#why-have-a-makefile-in-the-first-place" title="permalink">#</a></span></h2>
<p>I've been using a Makefile in my <a href="https://github.com/lemon24/reader">Python feed reader library</a>
to have convenient shortcuts for common development stuff:
install dependencies, run tests, etc.
In time, I ended up using some of the targets in CI,
and mentioning them in the developer docs.</p>
<p>(I originally took this pattern from Flask,
although they stopped using it after 1.0.)</p>
<p>Here's an abridged version to give you a taste (<a href="https://github.com/lemon24/reader/blob/1.16/Makefile">full Makefile here</a>):</p>
<div class="highlight code-container"><pre class="code" data-lang="Makefile"><span></span><code><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">test</span> <span class="n">typing</span>

<span class="nf">test</span><span class="o">:</span>
    pytest --runslow

<span class="c"># mypy does not work on pypy as of January 2020</span>
<span class="nf">typing</span><span class="o">:</span>
    <span class="nb">test</span> <span class="nv">$$</span><span class="o">(</span> python -c <span class="s1">&#39;import sys; print(sys.implementation.name)&#39;</span> <span class="o">)</span> <span class="o">=</span> pypy <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;mypy does not work on pypy, doing nothing&quot;</span> <span class="se">\</span>
    <span class="o">||</span> mypy --strict src
</code></pre></div>
<p>For me, this has two main downsides:</p>
<ul>
<li>It makes it harder to write full-featured shell scripts;
it is <em>possible</em>, but the result tends to be <a href="https://unix.stackexchange.com/a/270799">less readable</a>.</li>
<li>There's no way to pass arguments to the targets,
for example to call <code>pytest -v</code> while also getting 
the &quot;default&quot; <code>--runslow</code> option
(in this case, I could have used the <a href="https://docs.pytest.org/en/stable/reference.html#confval-addopts"><code>addopts</code></a> config key –
but I don't want to <em>force</em> everyone to use it,
I just want to show the <em>recommended</em> way of doing it).</li>
</ul>
<h2 id="enter-run-sh">Enter run.sh<span class="headerlink"> <a href="#enter-run-sh" title="permalink">#</a></span></h2>
<p>Instead, we could write that as a shell script:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash"><span></span><code><span class="ch">#!/bin/bash</span>

<span class="k">function</span> <span class="nb">test</span> <span class="o">{</span>
    pytest --runslow <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="k">function</span> typing <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">impl</span><span class="o">=</span><span class="k">$(</span> python -c <span class="s1">&#39;import sys; print(sys.implementation.name)&#39;</span> <span class="k">)</span>

    <span class="c1"># mypy does not work on pypy as of January 2020</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$impl</span> <span class="o">==</span> pypy <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;mypy does not work on pypy, doing nothing&quot;</span>
        <span class="k">return</span>
    <span class="k">fi</span>

    mypy --strict src <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</code></pre></div>
<p>The <code>$@</code> at the end dispatches the script arguments to a function
(so <code>./run.sh test</code> calls <code>test</code>);
the <code>$@</code> in <code>test</code> passes the remaining arguments along
(so <code>./run.sh test -v</code> ends up running <code>pytest --runslow -v</code>).</p>
<h2 id="why-i-think-it-s-cool">Why I think it's cool<span class="headerlink"> <a href="#why-i-think-it-s-cool" title="permalink">#</a></span></h2>
<h3 id="executable-documentation">Executable documentation<span class="headerlink"> <a href="#executable-documentation" title="permalink">#</a></span></h3>
<p>A script is a simple way of documenting project-specific development tools
– with a bit of care, it becomes <em>executable documentation;</em>
this is a huge benefit that's highlighted in the original article as well.</p>
<p>I'm strongly considering adding more comments to my <code>run.sh</code>,
and including it directly in the developer docs,
<em>instead</em> of the written documentation.</p>
<p>Most commands are self-evident,
and if you want to run something in a different way,
you can copy-paste it directly into a terminal
(arguably more difficult to do with a Makefile).
Hell, you can even source it if you're using a compatible shell,
and have a sort of &quot;project shell&quot;.</p>
<h3 id="reusability">Reusability<span class="headerlink"> <a href="#reusability" title="permalink">#</a></span></h3>
<p>Let's look at an example.
I run coverage in three ways:</p>
<ul>
<li>for development, with HTML reports and <a href="https://coverage.readthedocs.io/en/coverage-5.5/contexts.html">contexts</a> (&quot;who tests what&quot;)</li>
<li>for testing across Python versions/interpreters, with <a href="https://tox.readthedocs.io/en/latest/">tox</a>;
contexts could be useful, but they increase run time</li>
<li>for continuous integration<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>; contexts are not needed</li>
</ul>
<p>All cases should fail if coverage for specific modules is below 100%.</p>
<p>run.sh made it possible to skip contexts when running under tox/CI,
which reduced CI run time by 10-30%.
Also, it avoids duplicating some <a href="https://github.com/lemon24/reader/blob/1.16/Makefile#L14-L17">pretty hairy commands</a>.</p>
<p>Now, the developer-facing <code>coverage-all</code> command looks like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash"><span></span><code><span class="k">function</span> coverage-all <span class="o">{</span>
    coverage-run --cov-context<span class="o">=</span><span class="nb">test</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
    coverage-report --show-contexts
<span class="o">}</span>
</code></pre></div>
<p>... the tox.ini commands look like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="INI"><span></span><code><span class="k">[testenv]</span>
<span class="na">commands</span> <span class="o">=</span> <span class="s">./run.sh coverage-run --cov-append</span>

<span class="k">[testenv:coverage-report]</span>
<span class="na">commands</span> <span class="o">=</span> <span class="s">./run.sh coverage-report</span>

<span class="k">[testenv:typing]</span>
<span class="na">commands</span> <span class="o">=</span> <span class="s">./run.sh typing</span>
</code></pre></div>
<p>... and CI calls a function that looks like this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash"><span></span><code><span class="k">function</span> ci-run <span class="o">{</span>
    coverage-run <span class="o">&amp;&amp;</span> coverage-report <span class="o">&amp;&amp;</span> typing
<span class="o">}</span>
</code></pre></div>
<hr />
<p>This reusability extends to using the functions <em>anywhere</em> commands are expected:</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash"><span></span><code>timeout <span class="m">5</span> ./run.py myfunction
</code></pre></div>
<p>... including inside the script itself
(the original article calls this <a href="http://www.oilshell.org/blog/2020/02/good-parts-sketch.html#the-0-dispatch-pattern-solves-three-important-problems"><code>$0</code>-dispatch</a>):</p>
<div class="highlight code-container"><pre class="code" data-lang="Bash"><span></span><code><span class="k">function</span> typing-dev <span class="o">{</span>
    find src -name <span class="s1">&#39;*.py&#39;</span> <span class="p">|</span> entr -cdr <span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">&quot;</span> typing <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="o">}</span>
</code></pre></div>
<p>Here, <code>entr</code> takes a command (and its arguments),
and runs it every time a Python file in <code>src</code> changes.
Note that we use <code>$0</code> to dispatch to the script's <code>typing</code> &quot;target&quot;.</p>
<hr />
<p>You can find reader's <a href="https://github.com/lemon24/reader/blob/master/run.sh">full run.sh here</a>; 
in addition to the things above, it has:</p>
<ul>
<li>more complex examples,</li>
<li>a workaround to make <code>$0</code>-dispatch work
when called with <code>bash run.sh</code>, and</li>
<li>a wrapper for using <a href="http://eradman.com/entrproject/">entr</a> with <code>git ls-files</code>,
based on <a href="https://jvns.ca/blog/2020/06/28/entr/#restart-every-time-a-new-file-is-added-entr-d">this pattern</a> from Julia Evans.</li>
</ul>
<hr />
<p>That's it for now.</p>
<p>Found this useful? Consider sharing it wherever you share stuff, it really helps! :)</p>
<p>Have questions? <a href="/about#contact">Send me an email.</a></p>
<section class="footnotes">
<ol>
<li id="fn-1"><p>I could probably use tox for CI as well, like <a href="https://github.com/pallets/flask/blob/2.0.0rc1/.github/workflows/tests.yaml#L53">Flask does</a> lately. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>













</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24
</footer>


</div>