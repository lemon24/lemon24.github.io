












<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />

<link rel="icon" href="/_static/xo-system-icon.svg">
<link rel="apple-touch-icon" href="/_static/xo-system-icon.svg">







<title>Dealing with YAML with arbitrary tags in Python - death and gravity</title>
<meta name="description" content="... in which we use PyYAML to safely read and write YAML with any tags, in a way that&#39;s as straightforward as interacting with built-in types." />


<meta property="og:title" content="Dealing with YAML with arbitrary tags in Python">
<meta property="og:site_name" content="death and gravity">
<meta property="og:type" content="article">
<meta property="og:url" content="https://death.andgravity.com/any-yaml">
<meta property="og:description" content="... in which we use PyYAML to safely read and write YAML with any tags, in a way that&#39;s as straightforward as interacting with built-in types.">



<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RY2QR580X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-4RY2QR580X");
</script>



<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">Dealing with YAML with arbitrary tags in Python</h1>

<p class="text-gray text-nowrap">



<small>
<span class="tooltip" data-tooltip="published on 2022-01-23">January 2022</span>
∙ 10 minute read
∙
</small><span class="share-icons">
<a
    class="share-icon pycoders"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/any-yaml&t=Dealing%20with%20YAML%20with%20arbitrary%20tags%20in%20Python"
>HN</a>
<a
    class="share-icon bluesky"
    href="https://bsky.%61%70%70/intent/compose?text=Dealing%20with%20YAML%20with%20arbitrary%20tags%20in%20Python%20https%3A//death.andgravity.com/any-yaml"
>Bluesky</a>
<!--
<a
    class="share-icon reddit"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/any-yaml&title=Dealing%20with%20YAML%20with%20arbitrary%20tags%20in%20Python"
>Reddit</a>
-->
<a
    class="share-icon linkedin"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/any-yaml"
>linkedin</a>
<a
    class="share-icon twitter"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Dealing%20with%20YAML%20with%20arbitrary%20tags%20in%20Python&url=https%3A//death.andgravity.com/any-yaml&via=_andgravity"
>Twitter</a>
</span>


</p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>... in which we use <a class="external" href="https://github.com/yaml/pyyaml">PyYAML</a> to <em>safely</em> read and write YAML with <em>any</em> tags,
in a way that's as straightforward as interacting with built-in types.</p>
<p>If you're in a hurry,
you can find the code <a class="anchor" href="#conclusion">at the end</a>.</p>
<details class="toc">
<summary>Contents</summary>
<ul>
<li><a href="#why-is-this-useful">Why is this useful?</a></li>
<li><a href="#a-note-on-pyyaml-extensibility">A note on PyYAML extensibility</a></li>
<li><a href="#preserving-tags">Preserving tags</a>
<ul>
<li><a href="#constructing-unknown-objects">Constructing unknown objects</a></li>
<li><a href="#a-better-wrapper">A better wrapper</a></li>
<li><a href="#representing-tagged-objects">Representing tagged objects</a></li>
</ul>
</li>
<li><a href="#unhashable-keys">Unhashable keys</a>
<ul>
<li><a href="#constructing-pairs">Constructing pairs</a></li>
<li><a href="#representing-pairs">Representing pairs</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#bonus-hashable-wrapper">Bonus: hashable wrapper</a></li>
<li><a href="#bonus-broken-yaml">Bonus: broken YAML</a></li>
</ul>
</details>
<h2 id="why-is-this-useful">Why is this useful?<span class="headerlink">&nbsp;<a href="#why-is-this-useful" title="permalink">#</a></span></h2>
<p>People mostly use YAML as a friendlier alternative to JSON<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>,
but it can do way more.</p>
<p>Among others, it can <em>natively</em> represent user-defined and native data structures.</p>
<p>Say you need to read <em>(or write)</em> an AWS CloudFormation <a class="external" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/quickref-ec2.html">template</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="YAML"><span></span><code><span class="nt">EC2Instance</span><span class="p">:</span>
<span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::EC2::Instance</span>
<span class="w">  </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ImageId</span><span class="p">:</span><span class="w"> </span><span class="kt">!FindInMap</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">      </span><span class="nv">AWSRegionArch2AMI</span><span class="p p-Indicator">,</span>
<span class="w">      </span><span class="kt">!Ref</span><span class="w"> </span><span class="s">&#39;AWS::Region&#39;</span><span class="p p-Indicator">,</span>
<span class="w">      </span><span class="kt">!FindInMap</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">AWSInstanceType2Arch</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="nv">InstanceType</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Arch</span><span class="p p-Indicator">],</span>
<span class="w">    </span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">InstanceType</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InstanceType</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
<span class="gr">yaml.constructor.ConstructorError</span>: <span class="n">could not determine a constructor for the tag &#39;!FindInMap&#39;</span>
<span class="x">  in &quot;&lt;unicode string&gt;&quot;, line 4, column 14:</span>
<span class="x">        ImageId: !FindInMap [</span>
<span class="x">                 ^</span>
</code></pre></div>
<p>... or, you need to <em>safely</em> read untrusted YAML
that represents Python objects:</p>
<div class="highlight code-container"><pre class="code" data-lang="YAML"><span></span><code><span class="kt">!!python/object/new:module.Class</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> attribute</span><span class="p">:</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="p p-Indicator">}</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w"> </span><span class="c">...</span>
<span class="gr">yaml.constructor.ConstructorError</span>: <span class="n">could not determine a constructor for the tag &#39;tag:yaml.org,2002:python/object/new:module.Class&#39;</span>
<span class="x">  in &quot;&lt;unicode string&gt;&quot;, line 1, column 1:</span>
<span class="x">    !!python/object/new:module.Class ...</span>
<span class="x">    ^</span>
</code></pre></div>
<section class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Historically, <code>yaml.load(thing)</code> was <strong>unsafe</strong> for <strong>untrusted data</strong>,
because it allowed <strong>running arbitrary code</strong>.
Consider using <code>safe_load()</code> instead.</p>
 <details>
 <summary>Details.</summary>

<p>For example, you could do this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;!!python/object/new:os.system [echo WOOSH. YOU HAVE been compromised]&quot;</span><span class="p">)</span>
<span class="go">WOOSH. YOU HAVE been compromised</span>
<span class="go">0</span>
</code></pre></div>
<p>There were a bunch of <a class="external" href="https://www.cvedetails.com/vulnerability-list/vendor_id-13115/Pyyaml.html">CVEs</a> about it.</p>
<p>To address the issue, <code>load()</code> requires an explicit <code>Loader</code> since PyYAML 6.
Also, version 5 added two new functions and corresponding loaders:</p>
<ul>
<li><code>full_load()</code> resolves all tags except those known to be unsafe
(note that this was broken before 5.4, and thus vulnerable)</li>
<li><code>unsafe_load()</code> resolves all tags, even those known to be unsafe
(the old <code>load()</code> behavior)</li>
</ul>
<p><code>safe_load()</code> resolves only basic tags, remaining the safest.</p>
 </details>

</section>
<hr />
<p>Can I just get the data, without it being turned into objects?</p>
<p>You can! The YAML spec <a class="external" href="https://yaml.org/spec/1.2.2/#334-available-tags">says</a>:</p>
<blockquote>
<p>In a given processing environment, there need not be an available native type corresponding to a given tag. If a node’s tag is unavailable, a YAML processor will not be able to construct a native data structure for it. In this case, <strong>a complete representation may still be composed</strong> and an application may wish to use this representation directly.</p>
</blockquote>
<p>And PyYAML obliges:</p>
<!--

text = """\
one: !myscalar string
two: !mysequence [1, 2]
"""
-->

<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s2">one: !myscalar string</span>
<span class="gp">... </span><span class="s2">two: !mysequence [1, 2]</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="go">MappingNode(</span>
<span class="go">    tag=&#39;tag:yaml.org,2002:map&#39;,</span>
<span class="go">    value=[</span>
<span class="go">        (</span>
<span class="go">            ScalarNode(tag=&#39;tag:yaml.org,2002:str&#39;, value=&#39;one&#39;),</span>
<span class="go">            ScalarNode(tag=&#39;!myscalar&#39;, value=&#39;string&#39;),</span>
<span class="go">        ),</span>
<span class="go">        (</span>
<span class="go">            ScalarNode(tag=&#39;tag:yaml.org,2002:str&#39;, value=&#39;two&#39;),</span>
<span class="go">            SequenceNode(</span>
<span class="go">                tag=&#39;!mysequence&#39;,</span>
<span class="go">                value=[</span>
<span class="go">                    ScalarNode(tag=&#39;tag:yaml.org,2002:int&#39;, value=&#39;1&#39;),</span>
<span class="go">                    ScalarNode(tag=&#39;tag:yaml.org,2002:int&#39;, value=&#39;2&#39;),</span>
<span class="go">                ],</span>
<span class="go">            ),</span>
<span class="go">        ),</span>
<span class="go">    ],</span>
<span class="go">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>
<span class="go">one: !myscalar &#39;string&#39;</span>
<span class="go">two: !mysequence [1, 2]</span>
</code></pre></div>
<p>... the spec didn't say the representation has to be concise. ¯\_(ツ)_/¯</p>
<p>Here's how YAML processing works, to give you an idea what we're looking at:</p>
<figure class="figure" id="yaml-processing-overview-diagram">
<img class="img-responsive" src="/_file/any-yaml/overview2.svg" alt="YAML Processing Overview Diagram" /><figcaption class="figure-caption text-center text-small">
<a class="external" href="https://yaml.org/spec/1.2.2/#31-processes">YAML Processing Overview</a>
</figcaption>
</figure>

<p>The output of <code>compose()</code> above is the representation (node graph).</p>
<p>From that, <code>safe_load()</code> does its best to construct objects,
but it can't do anything for tags it doesn't know about.</p>
<hr />
<p>There must be a better way!</p>
<p>Thankfully, the spec also <a class="external" href="https://yaml.org/spec/1.2.2/#332-resolved-tags">says</a>:</p>
<blockquote>
<p>That said, tag resolution is specific to the application. YAML processors should therefore provide <strong>a mechanism allowing the application to override and expand</strong> these default tag resolution rules.</p>
</blockquote>
<p>We'll use this mechanism to convert tagged nodes to almost-native types,
while preserving the tags.</p>
<h2 id="a-note-on-pyyaml-extensibility">A note on PyYAML extensibility<span class="headerlink">&nbsp;<a href="#a-note-on-pyyaml-extensibility" title="permalink">#</a></span></h2>
<p>PyYAML is a bit unusual.</p>
<p>For each processing direction, you have a corresponding Loader/Dumper class.</p>
<p>For each processing step,
you can add callbacks,
stored in class-level registries.</p>
<p>The callbacks are method-like –
they receive the Loader/Dumper as the first argument:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">Dice</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Dice&#39;</span><span class="p">,</span> <span class="s1">&#39;a b&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dice_representer</span><span class="p">(</span><span class="n">dumper</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dumper</span><span class="o">.</span><span class="n">represent_scalar</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;!dice&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">d</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>

<span class="n">yaml</span><span class="o">.</span><span class="n">Dumper</span><span class="o">.</span><span class="n">add_representer</span><span class="p">(</span><span class="n">Dice</span><span class="p">,</span> <span class="n">dice_representer</span><span class="p">)</span>
</code></pre></div>
<p>You may notice the <code>add_...()</code> methods modify the class in-place,
for <em>everyone</em>,
which isn't necessarily great;
imagine getting a Dice from <code>safe_load()</code>,
when you were expecting only built-in types.</p>
<p>We can avoid this by subclassing,
since the registry is copied from the parent.
Note that because of how <a class="external" href="https://github.com/yaml/pyyaml/blob/6.0/lib/yaml/representer.py#L65-L69">copying is implemented</a>,
registries from two direct parents are <em>not</em> merged –
you only get the registry of the first parent in the <a class="external" href="https://docs.python.org/3/glossary.html#term-method-resolution-order">MRO</a>.</p>
<hr />
<p>So, we'll start by subclassing SafeLoader/Dumper:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Loader</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">SafeLoader</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Dumper</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">SafeDumper</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>

<h2 id="preserving-tags">Preserving tags<span class="headerlink">&nbsp;<a href="#preserving-tags" title="permalink">#</a></span></h2>
<h3 id="constructing-unknown-objects">Constructing unknown objects<span class="headerlink">&nbsp;<a href="#constructing-unknown-objects" title="permalink">#</a></span></h3>
<p>For now, we can use named tuples for objects with unknown tags,
since <a class="internal" href="/namedtuples#the-data-is-naturally-a-tuple">they are naturally</a>
tag/value pairs:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Tagged</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">object</span>
</code></pre></div></td></tr></table></div>
<p>Tag or no tag, all YAML nodes are either a scalar, a sequence, or a mapping.
For unknown tags, we delegate construction to the loader's default constructors,
and wrap the resulting value:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">construct_undefined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">ScalarNode</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_scalar</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">SequenceNode</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_sequence</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">MappingNode</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_mapping</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;unexpected node: </span><span class="si">{</span><span class="n">node</span><span class="si">!r}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">Tagged</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="n">Loader</span><span class="o">.</span><span class="n">add_constructor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">construct_undefined</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>Constructors are registered by tag, with None meaning &quot;unknown&quot;.</p>
<p>Things look much better already:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
<span class="go">{</span>
<span class="go">    &#39;one&#39;: Tagged(tag=&#39;!myscalar&#39;, value=&#39;string&#39;),</span>
<span class="go">    &#39;two&#39;: Tagged(tag=&#39;!mysequence&#39;, value=[1, 2]),</span>
<span class="go">}</span>
</code></pre></div>
<h3 id="a-better-wrapper">A better wrapper<span class="headerlink">&nbsp;<a href="#a-better-wrapper" title="permalink">#</a></span></h3>
<p>That's nice,
but every time we use any value,
we have to check if it's tagged,
and then go through <code>value</code> if is:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">one</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">one</span><span class="o">.</span><span class="n">tag</span>
<span class="go">&#39;!myscalar&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">one</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="go">&#39;STRING&#39;</span>
</code></pre></div>
<p>We could <em>subclass</em> the Python types corresponding to core YAML tags
(str, list, and so on),
and add a <code>tag</code> attribute to each.
We could subclass most of them, anyway
– neither <code>bool</code> nor <code>NoneType</code> <em>can</em> be subclassed.</p>
<p>Or, we could <em>wrap</em> tagged objects
in a class with the same interface,
that delegates method calls and attribute access to the wrapee,
with a <code>tag</code> attribute on top.</p>
<section class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This is known as the <a class="external" href="https://python-patterns.guide/gang-of-four/decorator-pattern/">decorator pattern</a> design pattern
(not to be confused with Python <a class="external" href="https://docs.python.org/3/glossary.html#term-decorator">decorators</a>).
<a class="internal" href="/caching-methods#but-i-don-t-instantiate-the-client">Caching and retrying methods dynamically</a>
is another interesting use for it.</p>
</section>
<p>Doing this naively entails writing one wrapper per type,
with one wrapper method per method and one property per attribute.
That's even worse than subclassing!</p>
<p>There must be a better way!</p>
<hr />
<p>Of course, this is Python, so there is.</p>
<p>We can use an object proxy instead (also known as &quot;dynamic wrapper&quot;).
While <a class="external" href="https://python-patterns.guide/gang-of-four/decorator-pattern/#caveat-wrapping-doesnt-actually-work">they're not perfect</a> in general,
the one <a class="external" href="https://wrapt.readthedocs.io/en/latest/wrappers.html#object-proxy">wrapt</a> provides is damn near perfect enough<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup>:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Tagged</span><span class="p">(</span><span class="n">wrapt</span><span class="o">.</span><span class="n">ObjectProxy</span><span class="p">):</span>

    <span class="c1"># tell wrapt to set the attribute on the proxy, not the wrapped object</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__wrapped__</span><span class="si">!r}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
<span class="go">{</span>
<span class="go">    &#39;one&#39;: Tagged(&#39;!myscalar&#39;, &#39;string&#39;),</span>
<span class="go">    &#39;two&#39;: Tagged(&#39;!mysequence&#39;, [1, 2]),</span>
<span class="go">}</span>
</code></pre></div>
<p>The proxy behaves identically to the proxied object:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">one</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">one</span><span class="o">.</span><span class="n">tag</span>
<span class="go">&#39;!myscalar&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">one</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="go">&#39;STRING&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">one</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
<span class="go">&#39;str&#39;</span>
</code></pre></div>
<p>...up to and including fancy things like <a class="external" href="https://docs.python.org/3/library/functions.html#isinstance">isinstance()</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">Tagged</span><span class="p">)</span>
<span class="go">True</span>
</code></pre></div>
<p>And <em>now</em> you don't have to care about tags if you don't want to.</p>
<h3 id="representing-tagged-objects">Representing tagged objects<span class="headerlink">&nbsp;<a href="#representing-tagged-objects" title="permalink">#</a></span></h3>
<p>The trip back is exactly the same,
but much shorter:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">represent_tagged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Tagged</span><span class="p">),</span> <span class="n">data</span>
    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">represent_data</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">__wrapped__</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">tag</span>
    <span class="k">return</span> <span class="n">node</span>

<span class="n">Dumper</span><span class="o">.</span><span class="n">add_representer</span><span class="p">(</span><span class="n">Tagged</span><span class="p">,</span> <span class="n">represent_tagged</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>Representers are registered by type.</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">),</span> <span class="n">Dumper</span><span class="o">=</span><span class="n">Dumper</span><span class="p">))</span>
<span class="go">!hello &#39;world&#39;</span>
</code></pre></div>
<hr />
<details>
<summary>Let's mark the occasion with some tests.</summary>

<p>Since we still have stuff to do, we parametrize the tests from the start.</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">BASIC_TEXT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">one: !myscalar string</span>
<span class="s2">two: !mymapping</span>
<span class="s2">  three: !mysequence [1, 2]</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">BASIC_DATA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;one&#39;</span><span class="p">:</span> <span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!myscalar&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">),</span>
    <span class="s1">&#39;two&#39;</span><span class="p">:</span> <span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!mymapping&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;three&#39;</span><span class="p">:</span> <span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!mysequence&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])}),</span>
<span class="p">}</span>

<span class="n">DATA</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">BASIC_TEXT</span><span class="p">,</span> <span class="n">BASIC_DATA</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></td></tr></table></div>

<p>Loading works:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;text, data&#39;</span><span class="p">,</span> <span class="n">DATA</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span> <span class="o">==</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>

<p>And dumping works:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">DATA</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_roundtrip</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span> <span class="o">==</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Dumper</span><span class="o">=</span><span class="n">Dumper</span><span class="p">),</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>... but only for known types:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_dump_error</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">representer</span><span class="o">.</span><span class="n">RepresenterError</span><span class="p">):</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">object</span><span class="p">(),</span> <span class="n">Dumper</span><span class="o">=</span><span class="n">Dumper</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</details>

<h2 id="unhashable-keys">Unhashable keys<span class="headerlink">&nbsp;<a href="#unhashable-keys" title="permalink">#</a></span></h2>
<p>Let's try <a class="external" href="https://pyyaml.org/wiki/PyYAMLDocumentation#block-mappings">an example</a> from the PyYAML documentation:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s2">? !!python/tuple [0,0]</span>
<span class="gp">... </span><span class="s2">: The Hero</span>
<span class="gp">... </span><span class="s2">? !!python/tuple [1,0]</span>
<span class="gp">... </span><span class="s2">: Treasure</span>
<span class="gp">... </span><span class="s2">? !!python/tuple [1,1]</span>
<span class="gp">... </span><span class="s2">: The Dragon</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>
<!--

[^7]: For this specific example, we could've used `yaml.FullLoader`,
  which does support tuples,
  but that doesn't really address the root of the problem.

-->

<p>This is supposed to result in something like:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">unsafe_load</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="go">{(0, 0): &#39;The Hero&#39;, (1, 0): &#39;Treasure&#39;, (1, 1): &#39;The Dragon&#39;}</span>
</code></pre></div>
<p>Instead, we get:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">unhashable type: &#39;list&#39;</span>
</code></pre></div>
<p>That's because the keys are tagged lists, and neither type is <a class="external" href="https://docs.python.org/3/glossary.html#term-hashable">hashable</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;!!python/tuple [0,0]&quot;</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
<span class="go">Tagged(&#39;tag:yaml.org,2002:python/tuple&#39;, [0, 0])</span>
</code></pre></div>
<p>This limitation comes from how Python dicts are implemented,<sup class="footnote-ref" id="fnref-3"><a href="#fn-3">3</a></sup>
not from YAML;
quoting from the <a class="external" href="https://yaml.org/spec/1.2.2/#mapping">spec</a> again:</p>
<blockquote>
<p>The content of a mapping node is an unordered set of key/value node pairs, with the restriction that each of the keys is unique. <strong>YAML places no further restrictions on the nodes.</strong> In particular, <strong>keys may be arbitrary nodes</strong>, the same node may be used as the value of several key/value pairs and a mapping could even contain itself as a key or a value.</p>
</blockquote>
<h3 id="constructing-pairs">Constructing pairs<span class="headerlink">&nbsp;<a href="#constructing-pairs" title="permalink">#</a></span></h3>
<p>What now?</p>
<p>Same strategy as before: wrap the things we can't handle.</p>
<p>Specifically,
whenever we have a mapping with unhashable keys,
we return a list of pairs instead.
To tell it apart from plain lists,
we use a subclass:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Pairs</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>

<p>Again, we let the loader do most of the work:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">construct_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_pairs</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Pairs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="n">Loader</span><span class="o">.</span><span class="n">construct_mapping</span> <span class="o">=</span> <span class="n">construct_mapping</span>
<span class="n">Loader</span><span class="o">.</span><span class="n">add_constructor</span><span class="p">(</span><span class="s1">&#39;tag:yaml.org,2002:map&#39;</span><span class="p">,</span> <span class="n">Loader</span><span class="o">.</span><span class="n">construct_mapping</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>We set <code>construct_mapping</code> so that any other Loader constructor
wanting to make a mapping gets to use it
(like our own <code>construct_undefined()</code> above).
Don't be fooled by the assignment,
it's a method like any other<sup class="footnote-ref" id="fnref-4"><a href="#fn-4">4</a></sup>
...but we're changing the class from outside anyway,
so it's best to stay consistent.</p>
<p>Note that overriding <code>construct_mapping()</code> is not enough:
we have to register the constructor explictly,
otherwise SafeDumper's <code>construct_mapping()</code> will be used
(since that's what was in the registry before).</p>
<section class="admonition note">
<p class="admonition-title">Note</p>
<p>In case you're wondering,
this feature is orthogonal from handling unknown tags;
we could have used different classes for them.
However, as mentioned before,
the constructor registry breaks multiple inheritance,
so we couldn't use the two features <em>together</em>.</p>
</section>
<p>Anyway, it works:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
<span class="go">Pairs(</span>
<span class="go">    [</span>
<span class="go">        (Tagged(&#39;tag:yaml.org,2002:python/tuple&#39;, [0, 0]), &#39;The Hero&#39;),</span>
<span class="go">        (Tagged(&#39;tag:yaml.org,2002:python/tuple&#39;, [1, 0]), &#39;Treasure&#39;),</span>
<span class="go">        (Tagged(&#39;tag:yaml.org,2002:python/tuple&#39;, [1, 1]), &#39;The Dragon&#39;),</span>
<span class="go">    ]</span>
<span class="go">)</span>
</code></pre></div>
<h3 id="representing-pairs">Representing pairs<span class="headerlink">&nbsp;<a href="#representing-pairs" title="permalink">#</a></span></h3>
<p>Like before, the trip back is short and uneventful:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">represent_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Pairs</span><span class="p">),</span> <span class="n">data</span>
    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">represent_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span>

<span class="n">Dumper</span><span class="o">.</span><span class="n">add_representer</span><span class="p">(</span><span class="n">Pairs</span><span class="p">,</span> <span class="n">represent_pairs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Pairs</span><span class="p">([([],</span> <span class="s1">&#39;one&#39;</span><span class="p">)]),</span> <span class="n">Dumper</span><span class="o">=</span><span class="n">Dumper</span><span class="p">))</span>
<span class="go">[]: one</span>
</code></pre></div>
<hr />
<details>
<summary>Let's test this more thoroughly.</summary>

<p>Because the tests are parametrized, we just need to add more data:</p>
<div class="highlight code-container"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></code></pre></div></td><td class="code"><div><pre class="code" data-lang="Python"><span></span><code><span class="n">UNHASHABLE_TEXT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">[0,0]: one</span>
<span class="s2">!key </span><span class="si">{0: 1}</span><span class="s2">: {[]: !value three}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">UNHASHABLE_DATA</span> <span class="o">=</span> <span class="n">Pairs</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;one&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!key&#39;</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">Pairs</span><span class="p">([([],</span> <span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!value&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">))])),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">DATA</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">BASIC_TEXT</span><span class="p">,</span> <span class="n">BASIC_DATA</span><span class="p">),</span>
<span class="hll">    <span class="p">(</span><span class="n">UNHASHABLE_TEXT</span><span class="p">,</span> <span class="n">UNHASHABLE_DATA</span><span class="p">),</span>
</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>

</details>

<h2 id="conclusion">Conclusion<span class="headerlink">&nbsp;<a href="#conclusion" title="permalink">#</a></span></h2>
<p>YAML is extensible by design.
I hope that besides what it says on the tin,
this article shed some light on how to customize PyYAML for your own purposes,
and that you've learned at least one new Python thing.</p>
<p>You can get the code <a class="attachment" href="/_file/any-yaml/any_yaml.py">here</a>,
and the tests <a class="attachment" href="/_file/any-yaml/test_any_yaml.py">here</a>.</p>
<p><strong>Learned something new today?</strong> Share it with others, it really helps! <span class="text-large">
<span class="share-icons">
<a
    class="share-icon pycoders color"
    href="https://pycoders.com/submissions"
    target="_blank"
>PyCoder's Weekly</a>
<a
    class="share-icon hacker-news color"
    href="https://news.ycombinator.%63%6f%6d/submitlink?u=https%3A//death.andgravity.com/any-yaml&t=Dealing%20with%20YAML%20with%20arbitrary%20tags%20in%20Python"
>HN</a>
<a
    class="share-icon bluesky color"
    href="https://bsky.%61%70%70/intent/compose?text=Dealing%20with%20YAML%20with%20arbitrary%20tags%20in%20Python%20https%3A//death.andgravity.com/any-yaml"
>Bluesky</a>
<!--
<a
    class="share-icon reddit color"
    href="https://www.reddit.%63%6f%6d/%73%75%62%6d%69%74?url=https%3A//death.andgravity.com/any-yaml&title=Dealing%20with%20YAML%20with%20arbitrary%20tags%20in%20Python"
>Reddit</a>
-->
<a
    class="share-icon linkedin color"
    href="https://www.linkedin.%63%6f%6d/sharing/share-offsite/?url=https%3A//death.andgravity.com/any-yaml"
>linkedin</a>
<a
    class="share-icon twitter color"
    href="https://twitter.%63%6f%6d/%73%68%61%72%65?text=Dealing%20with%20YAML%20with%20arbitrary%20tags%20in%20Python&url=https%3A//death.andgravity.com/any-yaml&via=_andgravity"
>Twitter</a>
</span>
</span></p>

<form
    action="https://gmail.us7.list-manage.com/subscribe/post?u=9909b0e978d8d8d941bd3c8dc&amp;id=c61d63d661&SIGNUP=any-yaml"
    method="post"
    id="embedded-subscribe-form"
    name="mc-embedded-subscribe-form"
    target="_blank"
    novalidate
    class="panel subscribe-form"
>
    <div class="panel-header text-large">

        Want to know when new articles come out?

    </div>
    <div class="panel-body">

        <p>Drop your email in the box below and I'll send new stuff straight to your inbox!</p>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="text" name="FNAME" id="mce-FNAME"
            class="form-input input-lg"
            placeholder="Your first name"
        >
        </div>

        <div class="form-group col-6 col-xs-12 col-md-9">
        <input type="email" name="EMAIL" id="mce-EMAIL"
            class="form-input input-lg"
            placeholder="Your email address"
        >
        </div>

        <!-- bot prevention-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9909b0e978d8d8d941bd3c8dc_c61d63d661" tabindex="-1" value=""></div>

    </div>
    <div class="panel-footer">

        <div class="form-group">
        <input type="submit"  name="subscribe" id="mc-embedded-subscribe"
            class="btn btn-primary btn-lg"
            value="Subscribe"
        >
        </div>

    </div>

</form>
<h2 id="bonus-hashable-wrapper">Bonus: hashable wrapper<span class="headerlink">&nbsp;<a href="#bonus-hashable-wrapper" title="permalink">#</a></span></h2>
<p>You may be asking, why not make the wrapper hashable?</p>
<p>Most unhashable (data) objects are that for a reason: because they're mutable.</p>
<p>We have two options:</p>
<ul>
<li><p>Make the wrapper hash change with the content.
This this will break dictionaries in strange and unexpected ways
(and other things too) –
the language <a class="external" href="https://docs.python.org/3/reference/datamodel.html#object.__hash__">requires</a> mutable objects to be unhashable.</p>
</li>
<li><p>Make the wrapper hash <em>not</em> change with the content,
and wrappers equal only to themselves –
that's what user-defined classes do by default anyway.</p>
<p>This works, but it's not very useful,
because equal values don't compare equal anymore
(<code>data != load(dump(data))</code>).
Also, it means you can only get things from a dict
if you already have the object used as key:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">Hashable</span><span class="p">([</span><span class="mi">1</span><span class="p">]):</span> <span class="s1">&#39;one&#39;</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">[</span><span class="n">Hashable</span><span class="p">([</span><span class="mi">1</span><span class="p">])]</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
<span class="gr">KeyError</span>: <span class="n">Hashable([1])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="go">&#39;one&#39;</span>
</code></pre></div>
<p>I'd file this under &quot;strange and unexpected&quot; too.</p>
<p>(You can find the code for the example above <a class="attachment" href="/_file/any-yaml/hashable_wrapper.py">here</a>.)</p>
</li>
</ul>
<h2 id="bonus-broken-yaml">Bonus: broken YAML<span class="headerlink">&nbsp;<a href="#bonus-broken-yaml" title="permalink">#</a></span></h2>
<p>We can venture even farther, into arguably broken YAML.
Let's look at some examples.</p>
<p>First, there are undefined <a class="external" href="https://yaml.org/spec/1.2.2/#6822-tag-prefixes">tag prefixes</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;!m!xyz x&quot;</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
<span class="gr">yaml.parser.ParserError</span>: <span class="n">while parsing a node</span>
<span class="x">found undefined tag handle &#39;!m!&#39;</span>
<span class="x">  in &quot;&lt;unicode string&gt;&quot;, line 1, column 1:</span>
<span class="x">    !m!xyz x</span>
<span class="x">    ^</span>
</code></pre></div>
<p>A valid version:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s2">%TAG !m! !my-</span>
<span class="gp">... </span><span class="s2">---</span>
<span class="gp">... </span><span class="s2">!m!xyz x</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
<span class="go">Tagged(&#39;!my-xyz&#39;, &#39;x&#39;)</span>
</code></pre></div>
<p>Second, there are undefined <a class="external" href="https://yaml.org/spec/1.2.2/#71-alias-nodes">aliases</a>:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;two: *anchor&quot;</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
<span class="gr">yaml.composer.ComposerError</span>: <span class="n">found undefined alias &#39;anchor&#39;</span>
<span class="x">  in &quot;&lt;unicode string&gt;&quot;, line 1, column 6:</span>
<span class="x">    two: *anchor</span>
<span class="x">         ^</span>
</code></pre></div>
<p>A valid version:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s2">one: &amp;anchor [1]</span>
<span class="gp">... </span><span class="s2">two: *anchor</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
<span class="go">{&#39;one&#39;: [1], &#39;two&#39;: [1]}</span>
</code></pre></div>
<p>It's likely possible to handle these in a way similar to how we handled undefined tags,
but we'd have to go deeper –
the exceptions hint to which
<a class="anchor" href="#yaml-processing-overview-diagram">processing step</a>
to look at.</p>
<p>Since I haven't actually encountered them in real life, we'll &quot;save them for later&quot; :)</p>
<section class="footnotes">
<ol>
<li id="fn-1"><p>Of which YAML is actually a superset. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p><a class="external" href="https://www.python.org/dev/peps/pep-0020/">Timothy 20:9</a>. <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-3"><p>Using a <em>hash</em> table. For nice explanation of how it all works,
complete with a pure-Python implementation,
check out Raymond Hettinger's talk
<a class="external" href="https://www.youtube.com/watch?v=npw4s1QTmPg">Modern Python Dictionaries: A confluence of a dozen great ideas</a>
(<a class="external" href="https://gist.github.com/gerrymanoim/3519567d6afae5361032c032e0cc44f2">code</a>). <a href="#fnref-3" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-4"><p>Almost. The zero argument form of <a class="external" href="https://docs.python.org/3/library/functions.html#super">super()</a> won't work
for methods defined outside of a class definition,
but we're not using it here. <a href="#fnref-4" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>








</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>