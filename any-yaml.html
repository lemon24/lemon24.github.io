






<!doctype html>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/_static/spectre.css">
<link rel="stylesheet" href="/_static/pygments.css">
<link rel="stylesheet" href="/_static/style.css">

<link rel="alternate" type="application/atom+xml" title="Atom feed" href="/_feed/index.xml" />







<title>any-yaml - death and gravity</title>




<script>
/* https://css-tricks.com/the-trick-to-viewport-units-on-mobile/ */
function set_vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
/* we do it once, now, *and* on every resize */
set_vh();
window.addEventListener('resize', set_vh);
</script>





<div class="main container grid-lg">


<header>
<nav>
<ul class="breadcrumb">

<li class="breadcrumb-item">
    <a href="/">death and gravity</a>
</li>

</ul>
</nav>

<h1 class="heading-noindex">any-yaml</h1>

<p class="text-gray"><small>
<span>2021-12-15</span>



∙ six minute read


</small></p>






</header>


<main class="content columns">
<div class="column col-sm-12 col-md-10 col-8">

<p>... in which we use PyYAML to <em>safely</em> read and write YAML with <em>any</em> tags,
in a way that's as straightforward as interacting with built-in types.</p>
<p>TODO: also, a short explanation on how to extend PyYAML: #a-note-on-pyyaml-extensibility</p>
<!-- If you're in a hurry, you can find the final version of the code at the end. -->
<!--
https://www.google.com/search?q=custom+yaml+parser+python
# yaml: could not determine a constructor for the tag
# yaml: while constructing a mapping found unhashable key
-->
<details>
<summary>Contents</summary>
<section class="toc">
<ul>
<li><a href="#why-is-this-useful">Why is this useful?</a></li>
<li><a href="#a-note-on-pyyaml-extensibility">A note on PyYAML extensibility</a></li>
<li><a href="#preserving-tags">preserving tags</a>
<ul>
<li><a href="#tagged-wrapper">tagged wrapper</a></li>
<li><a href="#wrapping-unknown-objects">wrapping unknown objects</a></li>
<li><a href="#representing-tagged-objects">representing tagged objects</a></li>
</ul>
</li>
<li><a href="#unhashable-keys">unhashable keys</a>
<ul>
<li><a href="#pairs-object">pairs object</a></li>
<li><a href="#handling-mappings-with-unhashable-keys">handling mappings with unhashable keys</a></li>
<li><a href="#representing-pairs">representing pairs</a></li>
</ul>
</li>
<li><a href="#conclusion">conclusion</a></li>
<li><a href="#bonus-hashable-wrapper">bonus: hashable wrapper</a></li>
<li><a href="#bonus-others-things-not-so-easy-to-do">bonus: others things not so easy to do</a></li>
</ul>
</section>
</details>
<h2 id="why-is-this-useful">Why is this useful?<span class="headerlink"> <a href="#why-is-this-useful" title="permalink">#</a></span></h2>
<p>Although YAML is mostly used as a friendlier alternative to JSON<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>,
it can do way more.</p>
<p>Among others, it can represent user-defined and native data structures.</p>
<p>Say you need to read <em>(or write)</em> an AWS Cloud Formation <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/quickref-ec2.html">template</a>
that uses local, application-specific tags:</p>
<div class="highlight code-container"><pre class="code" data-lang="YAML"><span></span><code><span class="nt">EC2Instance</span><span class="p">:</span>
  <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::EC2::Instance</span>
  <span class="nt">Properties</span><span class="p">:</span>
    <span class="nt">ImageId</span><span class="p">:</span> <span class="kt">!FindInMap</span> <span class="p p-Indicator">[</span>
      <span class="nv">AWSRegionArch2AMI</span><span class="p p-Indicator">,</span>
      <span class="kt">!Ref</span> <span class="s">&#39;AWS::Region&#39;</span><span class="p p-Indicator">,</span>
      <span class="kt">!FindInMap</span> <span class="p p-Indicator">[</span><span class="nv">AWSInstanceType2Arch</span><span class="p p-Indicator">,</span> <span class="kt">!Ref</span> <span class="nv">InstanceType</span><span class="p p-Indicator">,</span> <span class="nv">Arch</span><span class="p p-Indicator">],</span>
    <span class="p p-Indicator">]</span>
    <span class="nt">InstanceType</span><span class="p">:</span> <span class="kt">!Ref</span> <span class="l l-Scalar l-Scalar-Plain">InstanceType</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">yaml.constructor.ConstructorError</span>: <span class="n">could not determine a constructor for the tag &#39;!FindInMap&#39;</span>
<span class="go">  in &quot;&lt;unicode string&gt;&quot;, line 4, column 14:</span>
<span class="go">        ImageId: !FindInMap [</span>
<span class="go">                 ^</span>
</code></pre></div>
<section class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Historically, <code>yaml.load(stream)</code> was <strong>unsafe</strong> for <strong>untrusted data</strong>,
 because it allowed <strong>running arbitrary code</strong>.
 Consider using use <code>safe_load()</code> instead.</p>
 <details>
 <summary>Details.</summary>
<p>For example, you could do this:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;!!python/object/new:os.system [echo WOOSH. YOU HAVE been compromised]&quot;</span><span class="p">)</span>
<span class="go">WOOSH. YOU HAVE been compromised</span>
<span class="go">0</span>
</code></pre></div>
<p>There were a bunch of <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-13115/Pyyaml.html">CVEs</a> about it.</p>
<p>To address the issue, <code>load()</code> requires an explicit <code>Loader</code> since PyYAML 6.
 Also, version 5 added two new functions and corresponding loaders:</p>
<ul>
<li><code>full_load()</code> resolves all tags except those known to be unsafe
(note that this was broken before 5.4, and thus vulnerable)</li>
<li><code>unsafe_load()</code> resolves all tags, even those known to be unsafe
(the old <code>load()</code> behavior)</li>
</ul>
<p><code>safe_load()</code> resolves only basic tags, remaining the safest.</p>
 </details>
</section>
<p>... or, you need to <em>safely</em> read untrusted YAML
that represents native Python objects with global tags:</p>
<div class="highlight code-container"><pre class="code" data-lang="YAML"><span></span><code><span class="kt">!!python/object/new:module.Class</span> <span class="p p-Indicator">{</span><span class="nt"> attribute</span><span class="p">:</span> <span class="nv">value</span> <span class="p p-Indicator">}</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
 <span class="c">...</span>
<span class="gr">yaml.constructor.ConstructorError</span>: <span class="n">could not determine a constructor for the tag &#39;tag:yaml.org,2002:python/object/new:module.Class&#39;</span>
<span class="go">  in &quot;&lt;unicode string&gt;&quot;, line 1, column 1:</span>
<span class="go">    !!python/object/new:module.Class ...</span>
<span class="go">    ^</span>
</code></pre></div>
<hr />
<p>Can I just have the data, then?</p>
<p>Yes! The YAML spec <a href="https://yaml.org/spec/1.2.2/#334-available-tags">says</a>:</p>
<blockquote>
<p>In a given processing environment, there need not be an available native type corresponding to a given tag. If a node’s tag is unavailable, a YAML processor will not be able to construct a native data structure for it. In this case, <em>a complete representation may still be composed</em> and an application may wish to use this representation directly.</p>
</blockquote>
<p>And PyYAML obliges:</p>
<!--

text = """\
one: !myscalar string
two: !mysequence [1, 2]
"""
-->
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s2">one: !myscalar string</span>
<span class="gp">... </span><span class="s2">two: !mysequence [1, 2]</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="go">MappingNode(</span>
<span class="go">    tag=&#39;tag:yaml.org,2002:map&#39;,</span>
<span class="go">    value=[</span>
<span class="go">        (</span>
<span class="go">            ScalarNode(tag=&#39;tag:yaml.org,2002:str&#39;, value=&#39;one&#39;),</span>
<span class="go">            ScalarNode(tag=&#39;!myscalar&#39;, value=&#39;string&#39;),</span>
<span class="go">        ),</span>
<span class="go">        (</span>
<span class="go">            ScalarNode(tag=&#39;tag:yaml.org,2002:str&#39;, value=&#39;two&#39;),</span>
<span class="go">            SequenceNode(</span>
<span class="go">                tag=&#39;!mysequence&#39;,</span>
<span class="go">                value=[</span>
<span class="go">                    ScalarNode(tag=&#39;tag:yaml.org,2002:int&#39;, value=&#39;1&#39;),</span>
<span class="go">                    ScalarNode(tag=&#39;tag:yaml.org,2002:int&#39;, value=&#39;2&#39;),</span>
<span class="go">                ],</span>
<span class="go">            ),</span>
<span class="go">        ),</span>
<span class="go">    ],</span>
<span class="go">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>
<span class="go">one: !myscalar &#39;string&#39;</span>
<span class="go">two: !mysequence [1, 2]</span>
</code></pre></div>
<p>... the spec didn't say it has to be concise. ¯\_(ツ)_/¯</p>
<p>Here's how YAML processing works, to give you an idea what we're looking at:</p>
<figure class="figure">
<figcaption class="figure-caption text-center text-small">
<p><a href="https://yaml.org/spec/1.2.2/#31-processes">YAML Processing Overview</a></p>
</figcaption>
<p><img class="img-responsive" src="/_file/any-yaml/overview2.svg" alt="YAML Processing Overview Diagram" /></p>
</figure>
<p>The output of <code>compose()</code> above is the representation (node graph).</p>
<p><code>safe_load()</code> does its best to construct native data structures,
but can't do it for things it doesn't know about.</p>
<hr />
<p>There must be a better way!</p>
<p>Thankfully, the spec also <a href="https://yaml.org/spec/1.2.2/#332-resolved-tags">says</a>:</p>
<blockquote>
<p>That said, tag resolution is specific to the application. YAML processors should therefore provide <em>a mechanism allowing the application to override and expand</em> these default tag resolution rules.</p>
</blockquote>
<p>We'll use this mechanism to convert everything to almost-native types,
but keep the tag for things with custom ones.</p>
<h2 id="a-note-on-pyyaml-extensibility">A note on PyYAML extensibility<span class="headerlink"> <a href="#a-note-on-pyyaml-extensibility" title="permalink">#</a></span></h2>
<p>PyYAML is a bit unusual.</p>
<p>For each processing direction, you have a corresponding Loader/Dumper class.</p>
<p>For each processing step,
you can register callbacks using their <code>add_...()</code> methods<sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup>,
which get stored in class-level registries.</p>
<p>The callbacks are method-like –
they receive the Loader/Dumper as the first argument:</p>
<div class="highlight code-container"><pre class="code" data-lang="Python"><span></span><code><span class="n">Dice</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Dice&#39;</span><span class="p">,</span> <span class="s1">&#39;a b&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dice_representer</span><span class="p">(</span><span class="n">dumper</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dumper</span><span class="o">.</span><span class="n">represent_scalar</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;!dice&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">d</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>

<span class="n">yaml</span><span class="o">.</span><span class="n">Dumper</span><span class="o">.</span><span class="n">add_representer</span><span class="p">(</span><span class="n">Dice</span><span class="p">,</span> <span class="n">dice_representer</span><span class="p">)</span>
</code></pre></div>
<p>You may notice the <code>add_...()</code> methods modify the classes for <em>everyone</em>.</p>
<p>That's not necessarily desirable –
imagine calling <code>safe_load()</code>,
expecting to only get built-in types,
and getting a Dice.</p>
<p>We can avoid it by subclassing,
since the registry is copied from the parent.
Note that because of how <a href="https://github.com/yaml/pyyaml/blob/6.0/lib/yaml/representer.py#L65-L69">copying is implemented</a>,
registries from two direct parents are <em>not</em> merged –
you only get the registry of the first parent in the <a href="https://docs.python.org/3/glossary.html#term-method-resolution-order">MRO</a>.</p>
<p>So, let's start with some subclasses:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="kn">import</span> <span class="nn">yaml</span>


<span class="k">class</span> <span class="nc">Loader</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">SafeLoader</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Dumper</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">SafeDumper</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>
</td></tr></table>
<h2 id="preserving-tags">preserving tags<span class="headerlink"> <a href="#preserving-tags" title="permalink">#</a></span></h2>
<h3 id="tagged-wrapper">tagged wrapper<span class="headerlink"> <a href="#tagged-wrapper" title="permalink">#</a></span></h3>
<p>use wrapt proxy to add an extra attribute to any object</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Tagged</span><span class="p">(</span><span class="n">wrapt</span><span class="o">.</span><span class="n">ObjectProxy</span><span class="p">):</span>

    <span class="c1"># needed to set the attribute on the proxy and not the wrapped object</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__wrapped__</span><span class="si">!r}</span><span class="s2">)&quot;</span>
</code></pre></div>
</td></tr></table>
<p>the proxy behaves identical to the proxied object
(including things like isinstance()!),
with two differences:</p>
<ul>
<li>the proxy has a <code>tag</code> attribute</li>
<li>the repr()</li>
</ul>
<h3 id="wrapping-unknown-objects">wrapping unknown objects<span class="headerlink"> <a href="#wrapping-unknown-objects" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">construct_undefined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ScalarNode</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_scalar</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">SequenceNode</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_sequence</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">MappingNode</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_mapping</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;unexpected node: </span><span class="si">{</span><span class="n">node</span><span class="si">!r}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">Tagged</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="n">Loader</span><span class="o">.</span><span class="n">add_constructor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">construct_undefined</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>TODO example</p>
<h3 id="representing-tagged-objects">representing tagged objects<span class="headerlink"> <a href="#representing-tagged-objects" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">represent_undefined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Tagged</span><span class="p">),</span> <span class="n">data</span>
    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">represent_data</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">__wrapped__</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">tag</span>
    <span class="k">return</span> <span class="n">node</span>

<span class="n">Dumper</span><span class="o">.</span><span class="n">add_representer</span><span class="p">(</span><span class="n">Tagged</span><span class="p">,</span> <span class="n">represent_undefined</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>TODO example</p>
<hr />
<details>
<summary>TESTS</summary>
<p>data:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">BASIC_TEXT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">one: !myscalar string</span>
<span class="s2">two: !mymapping</span>
<span class="s2">  three: !mysequence [1, 2]</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">BASIC_DATA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;one&#39;</span><span class="p">:</span> <span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!myscalar&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">),</span>
    <span class="s1">&#39;two&#39;</span><span class="p">:</span> <span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!mymapping&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;three&#39;</span><span class="p">:</span> <span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!mysequence&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])}),</span>
<span class="p">}</span>

<span class="n">DATA</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">BASIC_TEXT</span><span class="p">,</span> <span class="n">BASIC_DATA</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>
</td></tr></table>
<p>loading:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;text, data&#39;</span><span class="p">,</span> <span class="n">DATA</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span> <span class="o">==</span> <span class="n">data</span>
</code></pre></div>
</td></tr></table>
<p>dumping:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">DATA</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_roundtrip</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span> <span class="o">==</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Dumper</span><span class="o">=</span><span class="n">Dumper</span><span class="p">),</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>not dumping:</p>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">test_dump_error</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">representer</span><span class="o">.</span><span class="n">RepresenterError</span><span class="p">):</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">object</span><span class="p">(),</span> <span class="n">Dumper</span><span class="o">=</span><span class="n">Dumper</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="unhashable-keys">unhashable keys<span class="headerlink"> <a href="#unhashable-keys" title="permalink">#</a></span></h2>
<h3 id="pairs-object">pairs object<span class="headerlink"> <a href="#pairs-object" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">class</span> <span class="nc">Pairs</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div>
</td></tr></table>
<h3 id="handling-mappings-with-unhashable-keys">handling mappings with unhashable keys<span class="headerlink"> <a href="#handling-mappings-with-unhashable-keys" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">construct_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_pairs</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Pairs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="n">Loader</span><span class="o">.</span><span class="n">construct_mapping</span> <span class="o">=</span> <span class="n">construct_mapping</span>
<span class="n">Loader</span><span class="o">.</span><span class="n">add_constructor</span><span class="p">(</span><span class="s1">&#39;tag:yaml.org,2002:map&#39;</span><span class="p">,</span> <span class="n">Loader</span><span class="o">.</span><span class="n">construct_mapping</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We also set Loader.construct_mapping so construct_undefined can take advantage of it too.
It's a method, we could've put it in the Loader class definition, but we'll keep the style.</p>
<p>TODO example</p>
<p>TODO: mixins would be nice</p>
<p>TODO: note that overrideing construct mapping is not enough, we must register explicitly (otherwise we get SafeDumper.construct_mapping)</p>
<h3 id="representing-pairs">representing pairs<span class="headerlink"> <a href="#representing-pairs" title="permalink">#</a></span></h3>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="k">def</span> <span class="nf">represent_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Pairs</span><span class="p">),</span> <span class="n">data</span>
    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">represent_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span>

<span class="n">Dumper</span><span class="o">.</span><span class="n">add_representer</span><span class="p">(</span><span class="n">Pairs</span><span class="p">,</span> <span class="n">represent_pairs</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>TODO example</p>
<hr />
<details>
<summary>TESTS</summary>
<table class="highlighttable code-container"><tr><td class="linenos"><div class="linenodiv"><pre class="code"><code><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></code></pre></div></td><td class="code"><div class="highlight"><pre class="code" data-lang="Python"><span></span><code><span class="n">UNHASHABLE_TEXT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">[0,0]: one</span>
<span class="s2">!key </span><span class="si">{0: 1}</span><span class="s2">: {[]: !value three}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">UNHASHABLE_DATA</span> <span class="o">=</span> <span class="n">Pairs</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;one&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!key&#39;</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">Pairs</span><span class="p">([([],</span> <span class="n">Tagged</span><span class="p">(</span><span class="s1">&#39;!value&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">))])),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">DATA</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">BASIC_TEXT</span><span class="p">,</span> <span class="n">BASIC_DATA</span><span class="p">),</span>
<span class="hll">    <span class="p">(</span><span class="n">UNHASHABLE_TEXT</span><span class="p">,</span> <span class="n">UNHASHABLE_DATA</span><span class="p">),</span>
</span><span class="p">]</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="conclusion">conclusion<span class="headerlink"> <a href="#conclusion" title="permalink">#</a></span></h2>
<p>TODO</p>
<h2 id="bonus-hashable-wrapper">bonus: hashable wrapper<span class="headerlink"> <a href="#bonus-hashable-wrapper" title="permalink">#</a></span></h2>
<p>TODO</p>
<h2 id="bonus-others-things-not-so-easy-to-do">bonus: others things not so easy to do<span class="headerlink"> <a href="#bonus-others-things-not-so-easy-to-do" title="permalink">#</a></span></h2>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="s2">&quot;!x!aaa x&quot;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">ParserError</span>: <span class="n">while parsing a node</span>
<span class="go">found undefined tag handle &#39;!x!&#39;</span>
<span class="go">  in &quot;&lt;unicode string&gt;&quot;, line 1, column 1:</span>
<span class="go">    !x!aaa x</span>
<span class="go">    ^</span>
</code></pre></div>
<div class="highlight code-container"><pre class="code" data-lang="Python console session"><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">yaml</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="s2">&quot;key: *alias&quot;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">ComposerError</span>: <span class="n">found undefined alias &#39;alias&#39;</span>
<span class="go">  in &quot;&lt;unicode string&gt;&quot;, line 1, column 6:</span>
<span class="go">    key: *alias</span>
<span class="go">         ^</span>
</code></pre></div>
<section class="footnotes">
<ol>
<li id="fn-1"><p>And actually is a superset of JSON. <a href="#fnref-1" class="footnote"><sup>[return]</sup></a></p></li>
<li id="fn-2"><p>There are also corresponding <code>yaml.add_...()</code> top-level functions,
which by default act on <code>yaml.Loader/Dumper</code>. <a href="#fnref-2" class="footnote"><sup>[return]</sup></a></p></li>
</ol>
</section>













</div>
</main>


<footer class="footer">
<p class="text-gray">
<a href="/">home</a>
∙ <a href="/_feed/index.xml">feed</a>
∙ <a href="/about">about</a>

∙ © 2021 lemon24



</footer>


</div>